<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joan 6 E-Ink Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    
    <script>
        // 1. NATYCHMIASTOWE ≈ÅADOWANIE MOTYWU (Bez mrugania)
        (function() {
            try {
                const savedTheme = localStorage.getItem('joan_theme') || 'light';
                if (savedTheme === 'dark') {
                    document.documentElement.classList.add('dark-mode');
                }
            } catch(e) {}
        })();
    </script>

    <style>
        /* 2. ZMIENNE CSS (Gwarancja dzia≈Çania motyw√≥w) */
        :root {
            --bg-body: #e0e0e0;
            --bg-container: #ffffff;
            --bg-section: #fafafa;
            --bg-input: #ffffff;
            --text-main: #333333;
            --border: #dddddd;
            --accent: #d32f2f;
            --highlight: #e3f2fd;
            --preview-bg: #f0f0f0;
        }
        
        html.dark-mode {
            --bg-body: #121212;
            --bg-container: #1e1e1e;
            --bg-section: #252525;
            --bg-input: #2c2c2c;
            --text-main: #e0e0e0;
            --border: #444444;
            --accent: #ff5252;
            --highlight: #0d47a1;
            --preview-bg: #000000;
        }

        body { font-family: 'Roboto', sans-serif; background-color: var(--bg-body); color: var(--text-main); padding: 20px; transition: background 0.3s; }
        .container { max-width: 1300px; margin: 0 auto; background: var(--bg-container); padding: 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        .header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border); padding-bottom: 15px; margin-bottom: 20px; }
        h1 { color: var(--accent); margin: 0; }
        
        .controls button { padding: 8px 12px; cursor: pointer; border: 1px solid var(--border); background: var(--bg-section); color: var(--text-main); border-radius: 4px; font-weight: bold; }
        .controls button.active { background: var(--accent); color: white; border-color: var(--accent); }

        .section { background: var(--bg-section); padding: 20px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 20px; }
        .section-title { font-size: 1.2em; font-weight: bold; border-bottom: 2px solid var(--accent); display: inline-block; margin-bottom: 15px; }

        .add-widget-box { background: var(--highlight); padding: 20px; border-radius: 8px; border: 1px solid var(--accent); transition: 0.3s; }
        .add-widget-box.editing { border: 3px solid #ff9800; }

        .flex-row { display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 15px; }
        .flex-col { flex: 1; min-width: 140px; }
        
        label { display: block; font-weight: bold; font-size: 0.85em; margin-bottom: 5px; color: var(--text-main); }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--border); background: var(--bg-input); color: var(--text-main); border-radius: 4px; box-sizing: border-box; }

        .btn { padding: 10px 20px; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; text-transform: uppercase; color: white; }
        .btn-add { background: #4caf50; width: 100%; }
        .btn-gen { background: var(--accent); width: 100%; font-size: 18px; }
        .btn-cancel { background: #757575; }
        .btn-row { background: #2196f3; margin-top: 10px; }

        /* PREVIEW E-INK STYLE */
        .preview-area { background: var(--preview-bg); padding: 20px; border: 2px solid var(--border); border-radius: 8px; overflow-x: auto; min-height: 200px; }
        
        .eink-row { display: flex; gap: 8px; margin-bottom: 10px; padding: 10px; border: 1px dashed #777; min-height: 130px; align-items: center; position: relative; }
        .row-label { position: absolute; top: -8px; left: 5px; font-size: 10px; background: var(--bg-body); padding: 0 5px; color: var(--text-main); }

        .eink-widget {
            background: #FFFFFF; border: 3px solid #000000; color: #000000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 5px; box-sizing: border-box; cursor: pointer; position: relative;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.2); transition: transform 0.1s;
            flex-shrink: 0;
        }
        .eink-widget:hover { transform: translateY(-2px); z-index: 10; border-color: var(--accent); }
        .eink-widget.editing { border: 3px dashed #ff9800; transform: scale(1.02); }

        .ew-title { font-weight: 900; font-size: 13px; text-align: center; width: 100%; line-height: 1.1; margin-bottom: 5px; white-space: normal; }
        .ew-icon { font-size: 36px; }
        .ew-state { font-weight: 900; font-size: 12px; text-transform: uppercase; border: 2px solid #000; padding: 1px 5px; margin-top: 5px; }
        
        .ew-del { position: absolute; top: -8px; right: -8px; background: red; color: white; width: 20px; height: 20px; border-radius: 50%; text-align: center; line-height: 20px; font-weight: bold; display: none; }
        .eink-widget:hover .ew-del { display: block; }

        .icon-preview { font-size: 30px; display: flex; align-items: center; justify-content: center; width: 40px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-row">
            <h1>Joan 6 Generator</h1>
            <div class="controls">
                <button type="button" onclick="toggleTheme()" id="btn-theme">üåô</button>
                <button type="button" onclick="setLang('pl')" id="btn-pl" class="active">PL</button>
                <button type="button" onclick="setLang('en')" id="btn-en">EN</button>
            </div>
        </div>

        <div class="section" id="import-section">
            <details>
                <summary style="cursor: pointer; font-weight: bold;">üìÇ Import / Eksport Kodu</summary>
                <textarea id="import-code" style="height: 150px; margin-top:10px;" placeholder="Wklej kod .dash tutaj..."></textarea>
                <button type="button" class="btn btn-row" onclick="importYaml()" style="width: auto; margin-top: 10px;">Wczytaj Kod</button>
            </details>
        </div>

        <form method="POST" id="main-form">
            <input type="hidden" name="title" value="JoanDashboard">
            <input type="hidden" name="ui_language" id="input-lang" value="pl">
            
            <div class="add-widget-box" id="editor-box">
                <div class="section-title" id="editor-title" data-i18n="sec_add">Dodaj Widget</div>
                
                <div class="flex-row">
                    <div class="flex-col">
                        <label data-i18n="lbl_type">Typ</label>
                        <select id="w-type" onchange="toggleInputs()">
                            <option value="switch">Switch / Light</option>
                            <option value="cover">Cover / Gate</option>
                            <option value="sensor">Sensor</option>
                            <option value="binary_sensor">Binary Sensor</option>
                            <option value="lock">Lock</option>
                            <option value="person">Person</option>
                            <option value="media_player">Media Player</option>
                            <option value="climate">Climate</option>
                            <option value="navigate">Navigate</option>
                            <option value="label">Label</option>
                            <option value="clock">Clock</option>
                            <option value="spacer">Spacer</option>
                        </select>
                    </div>
                    <div class="flex-col" id="grp-entity">
                        <label data-i18n="lbl_entity">Encja (Home Assistant)</label>
                        <input list="entity-list" id="w-id" placeholder="np. light.salon" oninput="runSmartLogic(this.value)" autocomplete="off">
                        <datalist id="entity-list">
                            {% for e in entities %}
                            <option value="{{ e.id }}" data-dclass="{{ e.attributes.device_class or '' }}" data-name="{{ e.attributes.friendly_name or '' }}"></option>
                            {% endfor %}
                        </datalist>
                    </div>
                    <div class="flex-col hidden" id="grp-nav">
                        <label data-i18n="lbl_dash">Nazwa Dashboardu</label>
                        <input type="text" id="w-dash" placeholder="np. main" oninput="autoNameNav()">
                    </div>
                    <div class="flex-col">
                        <label data-i18n="lbl_name">Tytu≈Ç</label>
                        <input type="text" id="w-name">
                    </div>
                </div>

                <div class="flex-row">
                    <div class="flex-col">
                        <label data-i18n="lbl_size">Rozmiar</label>
                        <select id="w-size">
                            <option value="(1x1)">1x1 (Ma≈Çy)</option>
                            <option value="(2x1)">2x1 (Standard)</option>
                            <option value="(2x2)">2x2 (Du≈ºy)</option>
                            <option value="(3x1)">3x1 (Szeroki)</option>
                            <option value="(1x2)">1x2 (Wysoki)</option>
                            <option value="(3x2)">3x2 (Ogromny)</option>
                        </select>
                    </div>
                    <div class="flex-col">
                        <label data-i18n="lbl_icon">Ikona</label>
                        <div style="display:flex; align-items:center; gap:5px;">
                            <i id="preview-icon" class="mdi mdi-help-circle-outline icon-preview"></i>
                            <input type="text" id="w-icon" oninput="updateIconPreview()">
                        </div>
                    </div>
                    <div class="flex-col">
                        <label>Ikona ON</label>
                        <input type="text" id="w-icon-on" oninput="updateIconPreview()">
                    </div>
                    <div class="flex-col">
                        <label>Ikona OFF</label>
                        <input type="text" id="w-icon-off" oninput="updateIconPreview()">
                    </div>
                </div>

                <div class="flex-row">
                    <button type="button" class="btn btn-add" id="btn-submit" onclick="saveWidget()" data-i18n="btn_add">+ DODAJ</button>
                    <button type="button" class="btn btn-cancel hidden" id="btn-cancel" onclick="cancelEdit()" data-i18n="btn_cancel">ANULUJ</button>
                </div>
            </div>

            <div class="section">
                <div class="section-title" data-i18n="sec_preview">PodglƒÖd (Kliknij by edytowaƒá)</div>
                <div class="preview-area" id="preview-container"></div>
                <button type="button" class="btn btn-row" onclick="addRow()" data-i18n="btn_row">+ Dodaj Wiersz</button>
            </div>

            <input type="hidden" name="layout_data_json" id="layout_json">
            <button type="button" class="btn btn-gen" onclick="submitData()" data-i18n="btn_gen">GENERUJ KOD</button>
        </form>

        {% if generated_yaml %}
        <div class="section">
            <h3>Wynik YAML:</h3>
            <textarea class="output" style="height:400px;" readonly>{{ generated_yaml }}</textarea>
        </div>
        {% endif %}
    </div>

    <script>
        // --- 1. DANE I ZMIENNE ---
        const entitiesData = {{ entities | tojson | safe }};
        let rows = [[]]; // Start with 1 empty row
        let editIdx = null; // {r, w}
        let blockSmart = false; // Blokada automatyki przy imporcie/edycji
        let currentLang = 'pl';

        const TRANSLATIONS = {
            pl: {
                sec_add: "Dodaj Widget", sec_edit: "Edytuj Widget", sec_preview: "PodglƒÖd",
                lbl_type: "Typ", lbl_entity: "Encja", lbl_name: "Tytu≈Ç", lbl_size: "Rozmiar", 
                lbl_icon: "Ikona", lbl_dash: "Nazwa Dashboardu",
                btn_add: "+ DODAJ", btn_update: "ZAPISZ ZMIANY", btn_cancel: "ANULUJ", 
                btn_row: "+ Dodaj Wiersz", btn_gen: "GENERUJ KOD",
                // Opcje select
                opt_switch: "Prze≈ÇƒÖcznik / ≈öwiat≈Ço", opt_cover: "Roleta", opt_sensor: "Sensor", 
                opt_media: "Media", opt_climate: "Klimat", opt_nav: "Nawigacja", opt_spacer: "Odstƒôp"
            },
            en: {
                sec_add: "Add Widget", sec_edit: "Edit Widget", sec_preview: "Preview",
                lbl_type: "Type", lbl_entity: "Entity", lbl_name: "Title", lbl_size: "Size", 
                lbl_icon: "Icon", lbl_dash: "Dashboard Name",
                btn_add: "+ ADD", btn_update: "SAVE CHANGES", btn_cancel: "CANCEL", 
                btn_row: "+ Add Row", btn_gen: "GENERATE CODE",
                // Select options
                opt_switch: "Switch / Light", opt_cover: "Cover", opt_sensor: "Sensor", 
                opt_media: "Media", opt_climate: "Climate", opt_nav: "Navigation", opt_spacer: "Spacer"
            }
        };

        const SMART_MAP = {
            'light': { type: 'switch', size: '(2x1)', iconOn: 'mdi-lightbulb-on', iconOff: 'mdi-lightbulb-outline' },
            'switch': { type: 'switch', size: '(2x1)', iconOn: 'mdi-toggle-switch', iconOff: 'mdi-toggle-switch-off' },
            'cover': { type: 'cover', size: '(2x1)', iconOn: 'mdi-window-shutter-open', iconOff: 'mdi-window-shutter' },
            'binary_sensor': { type: 'binary_sensor', size: '(1x1)', iconOn: 'mdi-checkbox-marked-circle', iconOff: 'mdi-checkbox-blank-circle-outline' },
            'sensor': { type: 'sensor', size: '(1x1)', icon: 'mdi-eye' },
            'media_player': { type: 'media_player', size: '(2x2)', icon: '' },
            'climate': { type: 'climate', size: '(2x2)', icon: '' },
            'lock': { type: 'lock', size: '(2x1)', iconOn: 'mdi-lock-open', iconOff: 'mdi-lock' }
        };

        // --- 2. FUNKCJE POMOCNICZE (NA G√ìRZE) ---

        function setLang(lang) {
            currentLang = lang;
            document.getElementById('input-lang').value = lang;
            document.getElementById('btn-pl').className = lang === 'pl' ? 'active' : '';
            document.getElementById('btn-en').className = lang === 'en' ? 'active' : '';
            
            const t = TRANSLATIONS[lang];
            // T≈Çumaczenie etykiet
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.innerText = t[key];
            });
            
            // Od≈õwie≈º przycisk submit (bo zmienia tekst w zale≈ºno≈õci od trybu)
            const btn = document.getElementById('btn-submit');
            btn.innerText = editIdx ? t.btn_update : t.btn_add;
            
            renderPreview();
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark-mode');
            localStorage.setItem('joan_theme', isDark ? 'dark' : 'light');
            document.getElementById('btn-theme').innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        function formatTitle(id) {
            if(!id) return "";
            if(id.startsWith('navigate.')) return id.replace('navigate.','').toUpperCase();
            return id.split('.').pop().replace(/_/g, ' ').toUpperCase();
        }

        function updateIconPreview() {
            const i1 = document.getElementById('w-icon').value;
            const i2 = document.getElementById('w-icon-on').value;
            const i3 = document.getElementById('w-icon-off').value;
            const final = i1 || i2 || i3 || 'mdi-help-circle-outline';
            document.getElementById('preview-icon').className = `mdi ${final} icon-preview`;
        }

        function toggleInputs() {
            const type = document.getElementById('w-type').value;
            const isNav = type === 'navigate';
            const isSpacer = type === 'spacer';
            
            document.getElementById('grp-entity').style.display = (isNav || isSpacer) ? 'none' : 'block';
            document.getElementById('grp-nav').style.display = isNav ? 'block' : 'none';
            document.getElementById('grp-nav').classList.toggle('hidden', !isNav);
        }

        // --- 3. SMART LOGIC ---

        function runSmartLogic(val) {
            if (blockSmart) return; // Nie psuj importu!
            
            const id = val.toLowerCase();
            if (id.length < 3) return;

            // Pobierz dane z datalist (device_class)
            const option = document.querySelector(`#entity-list option[value="${val}"]`);
            const dClass = option ? option.getAttribute('data-dclass') : '';
            const domain = id.split('.')[0];

            // Domy≈õlna konfiguracja
            let conf = SMART_MAP[domain] || { type: 'sensor', size: '(1x1)', icon: 'mdi-eye' };

            // Ulepszenia na podstawie device_class
            if (dClass === 'garage') conf = SMART_MAP['garage'];
            if (dClass === 'door') conf = { type: 'binary_sensor', size: '(1x1)', iconOn: 'mdi-door-open', iconOff: 'mdi-door-closed' };
            if (dClass === 'battery') conf.icon = 'mdi-battery';
            if (dClass === 'temperature') conf.icon = 'mdi-thermometer';

            // Ustaw pola formularza
            document.getElementById('w-type').value = conf.type;
            document.getElementById('w-size').value = conf.size;
            
            // Ustaw tytu≈Ç je≈õli pusty
            const nameField = document.getElementById('w-name');
            if(!nameField.value) nameField.value = formatTitle(id);

            // Ustaw ikony
            document.getElementById('w-icon').value = conf.icon || '';
            document.getElementById('w-icon-on').value = conf.iconOn || '';
            document.getElementById('w-icon-off').value = conf.iconOff || '';

            toggleInputs();
            updateIconPreview();
        }

        function autoNameNav() {
            if(blockSmart) return;
            const val = document.getElementById('w-dash').value;
            document.getElementById('w-name').value = val.toUpperCase();
        }

        // --- 4. CRUD & RENDER ---

        function saveWidget() {
            const w = {
                type: document.getElementById('w-type').value,
                id: document.getElementById('w-id').value,
                dash: document.getElementById('w-dash').value,
                name: document.getElementById('w-name').value,
                size: document.getElementById('w-size').value,
                icon: document.getElementById('w-icon').value,
                icon_on: document.getElementById('w-icon-on').value,
                icon_off: document.getElementById('w-icon-off').value
            };

            if(w.type === 'navigate') w.id = 'navigate.' + w.dash;
            if(w.type === 'spacer') w.id = 'spacer';

            if(editIdx) {
                rows[editIdx.r][editIdx.w] = w;
                cancelEdit();
            } else {
                rows[rows.length-1].push(w);
                // Wyczy≈õƒá formularz po dodaniu, aby Smart dzia≈Ça≈Ç dla kolejnego
                clearForm();
            }
            renderPreview();
        }

        function editWidget(r, w) {
            blockSmart = true; // ZABLOKUJ SMART przy edycji
            editIdx = {r, w};
            const data = rows[r][w];

            document.getElementById('editor-box').classList.add('editing');
            document.getElementById('btn-cancel').classList.remove('hidden');
            document.getElementById('editor-title').innerText = TRANSLATIONS[currentLang].sec_edit;
            document.getElementById('btn-submit').innerText = TRANSLATIONS[currentLang].btn_update;

            document.getElementById('w-type').value = data.type;
            toggleInputs();

            if(data.type === 'navigate') {
                document.getElementById('w-dash').value = data.id.replace('navigate.', '');
            } else {
                document.getElementById('w-id').value = data.id;
            }

            document.getElementById('w-name').value = data.name;
            document.getElementById('w-size').value = data.size || '(1x1)';
            document.getElementById('w-icon').value = data.icon || '';
            document.getElementById('w-icon-on').value = data.icon_on || '';
            document.getElementById('w-icon-off').value = data.icon_off || '';
            
            updateIconPreview();
            
            // Odblokuj Smart dopiero po chwili (≈ºeby zdarzenia oninput nie nadpisa≈Çy)
            setTimeout(() => blockSmart = false, 500);
        }

        function cancelEdit() {
            editIdx = null;
            blockSmart = false;
            document.getElementById('editor-box').classList.remove('editing');
            document.getElementById('btn-cancel').classList.add('hidden');
            document.getElementById('editor-title').innerText = TRANSLATIONS[currentLang].sec_add;
            document.getElementById('btn-submit').innerText = TRANSLATIONS[currentLang].btn_add;
            clearForm();
        }

        function clearForm() {
            document.getElementById('w-id').value = '';
            document.getElementById('w-name').value = '';
            document.getElementById('w-icon').value = '';
            document.getElementById('w-icon-on').value = '';
            document.getElementById('w-icon-off').value = '';
            updateIconPreview();
        }

        function deleteWidget(r, w, e) {
            e.stopPropagation();
            rows[r].splice(w, 1);
            if(editIdx && editIdx.r === r && editIdx.w === w) cancelEdit();
            renderPreview();
        }

        function addRow() {
            rows.push([]);
            renderPreview();
        }

        function renderPreview() {
            const container = document.getElementById('preview-container');
            container.innerHTML = '';

            rows.forEach((row, rI) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'eink-row';
                
                const label = document.createElement('div');
                label.className = 'row-label';
                label.innerText = `ROW ${rI + 1}`;
                rowDiv.appendChild(label);

                row.forEach((w, wI) => {
                    const div = document.createElement('div');
                    div.className = 'eink-widget';
                    if(editIdx && editIdx.r === rI && editIdx.w === wI) div.classList.add('editing');

                    // SKALOWANIE PODGLƒÑDU (Base 115px, Margin 8px)
                    let cols = 1, rw = 1;
                    if(w.size) {
                        const parts = w.size.replace(/[()]/g, '').split('x');
                        cols = parseInt(parts[0]);
                        rw = parseInt(parts[1]);
                    }
                    
                    const width = (cols * 115) + ((cols - 1) * 8);
                    const height = (rw * 115) + ((rw - 1) * 8);
                    
                    div.style.width = width + 'px';
                    div.style.height = height + 'px';

                    if(w.type === 'spacer') {
                        div.style.border = '1px dashed #aaa';
                        div.style.boxShadow = 'none';
                        div.style.opacity = '0.5';
                    } else {
                        const icon = w.icon || w.icon_on || 'mdi-cube-outline';
                        div.innerHTML = `
                            <div class="ew-title">${w.name || w.id}</div>
                            <i class="mdi ${icon} ew-icon"></i>
                            <div class="ew-state">${w.type}</div>
                            <div class="ew-del" onclick="deleteWidget(${rI}, ${wI}, event)">X</div>
                        `;
                    }
                    
                    div.onclick = () => editWidget(rI, wI);
                    rowDiv.appendChild(div);
                });
                container.appendChild(rowDiv);
            });
        }

        function submitData() {
            document.getElementById('layout_json').value = JSON.stringify(rows);
            document.getElementById('main-form').submit();
        }

        // --- 5. IMPORT LOGIC (PROSTY PARSER) ---
        function importYaml() {
            const text = document.getElementById('import-code').value;
            if(!text) return;
            
            blockSmart = true; // Stop smart logic
            
            const lines = text.split('\n');
            const newRows = [];
            let currentRow = [];
            let inLayout = false;
            
            // Bardzo prosty parser - szuka linii w sekcji layout:
            lines.forEach(line => {
                const tr = line.trim();
                if(tr.startsWith('layout:')) { inLayout = true; return; }
                if(inLayout && tr.startsWith('-')) {
                    // To jest wiersz layoutu
                    const content = tr.substring(1).trim(); // usu≈Ñ my≈õlnik
                    const widgets = content.split(',').map(s => s.trim());
                    
                    const rowData = [];
                    widgets.forEach(wStr => {
                        let id = wStr;
                        let size = '(1x1)';
                        // WyciƒÖgnij rozmiar (2x1)
                        const sizeMatch = wStr.match(/\(\d+x\d+\)/);
                        if(sizeMatch) {
                            size = sizeMatch[0];
                            id = wStr.replace(size, '').trim();
                        }
                        
                        // Spr√≥buj znale≈∫ƒá definicjƒô w tek≈õcie (proste regexy)
                        // Szukamy np:  light.salon:\n  title: "Salon"
                        // To jest uproszczone, w produkcji lepiej u≈ºyƒá js-yaml
                        let type = 'switch';
                        let name = id;
                        let icon = '';
                        
                        if(id === 'spacer') { type = 'spacer'; }
                        else if(id.startsWith('navigate.')) { type = 'navigate'; }
                        else if(id.startsWith('sensor.')) { type = 'sensor'; }
                        
                        // Tworzymy obiekt widgetu
                        rowData.push({
                            id: id,
                            type: type,
                            size: size,
                            name: name, // W prawdziwym parserze wyciƒÖgnƒôliby≈õmy z sekcji definicji
                            icon: icon
                        });
                    });
                    newRows.push(rowData);
                }
                // Koniec sekcji layout (nowa sekcja bez wciƒôcia)
                if(inLayout && tr.length > 0 && !tr.startsWith('-') && !tr.startsWith(' ')) {
                    inLayout = false;
                }
            });
            
            if(newRows.length > 0) {
                rows = newRows;
                renderPreview();
                alert("Wczytano uk≈Çad (Uwaga: Import jest uproszczony, nazwy/ikony mogƒÖ wymagaƒá poprawy)");
            } else {
                alert("Nie znaleziono sekcji layout:");
            }
            
            setTimeout(() => blockSmart = false, 1000);
        }

        // INIT
        setLang('pl');
        renderPreview();
    </script>
</body>
</html>
