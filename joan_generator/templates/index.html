<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joan 6 E-Ink Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #e0e0e0;
            --container-bg: #ffffff;
            --text-color: #333;
            --border-color: #ddd;
            --accent-color: #d32f2f;
            --input-bg: #fff;
            --section-bg: #fafafa;
            --preview-bg: #f0f0f0;
            --link-bg: #ffffff;
            --link-color: #0056b3;
            --link-border: #bee5eb;
        }

        body.dark-mode {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --border-color: #333;
            --accent-color: #ff5252;
            --input-bg: #2c2c2c;
            --section-bg: #252525;
            --preview-bg: #121212;
            --link-bg: rgba(0,0,0,0.3);
            --link-color: #80d8ff;
            --link-border: #37474f;
        }

        body { font-family: 'Roboto', sans-serif; background-color: var(--bg-color); color: var(--text-color); padding: 20px; transition: background-color 0.3s; }
        .container { max-width: 1200px; margin: 0 auto; background: var(--container-bg); padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: background-color 0.3s; }
        
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--border-color); padding-bottom: 15px; }
        h1 { color: var(--accent-color); margin: 0; font-size: 24px; }
        
        .controls { display: flex; gap: 10px; align-items: center; }
        .lang-switch button, .theme-switch button { padding: 8px 12px; border: 1px solid var(--border-color); background: var(--section-bg); color: var(--text-color); cursor: pointer; border-radius: 4px; font-weight: bold; }
        .lang-switch button.active { background: var(--accent-color); color: white; border-color: var(--accent-color); }

        .status-bar { padding: 10px; margin-bottom: 20px; border-radius: 4px; text-align: center; font-weight: bold; }
        
        .section { margin-bottom: 30px; border: 1px solid var(--border-color); padding: 20px; border-radius: 8px; background: var(--section-bg); }
        .section-title { font-size: 1.2em; font-weight: bold; color: var(--text-color); margin-bottom: 15px; border-bottom: 2px solid var(--accent-color); display: inline-block; }
        
        .import-box { background: #fff3e0; border: 1px solid #ffe0b2; color: #000; display: none; }
        body.dark-mode .import-box { background: #3e2723; border-color: #5d4037; color: #fff; }
        .import-box.visible { display: block; }

        .add-widget-box { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #2196f3; color: #000; transition: background 0.3s; }
        body.dark-mode .add-widget-box { background: #0d47a1; border-color: #1565c0; color: #fff; }
        .add-widget-box.editing { background: #fff8e1; border-color: #ffc107; border: 2px solid #ffc107; }
        body.dark-mode .add-widget-box.editing { background: #3e2723; border-color: #ffb300; }

        .flex-row { display: flex; gap: 15px; align-items: flex-end; margin-bottom: 10px; flex-wrap: wrap; }
        .flex-col { flex: 1; min-width: 150px; }
        
        label { display: block; margin-top: 10px; font-weight: bold; font-size: 0.9em; margin-bottom: 5px; color: var(--text-color); }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; background: var(--input-bg); color: var(--text-color); }

        .icon-preview-box { width: 42px; height: 42px; background: #fff; border: 1px solid #ccc; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #333; margin-bottom: 1px; }

        .btn { padding: 10px 20px; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; text-transform: uppercase; }
        .btn-primary { background-color: var(--accent-color); color: white; width: 100%; font-size: 18px; margin-top: 20px; }
        .btn-add { background-color: #4caf50; color: white; width: 100%; }
        .btn-update { background-color: #ff9800; color: white; width: 100%; }
        .btn-cancel { background-color: #9e9e9e; color: white; margin-left: 10px; }
        .btn-row { background-color: #2196f3; color: white; margin-top: 10px; }
        .btn-import { background-color: #ff9800; color: white; margin-bottom: 10px; }
        .btn-remove-row { font-size: 10px; padding: 5px; margin-left: auto; background-color: #757575; color: white; }

        /* PREVIEW AREA */
        .preview-area { background-color: var(--preview-bg); padding: 24px; border-radius: 8px; border: 2px solid var(--border-color); overflow-x: auto; min-height: 220px; }
        
        .eink-row { 
            display: flex; gap: 12px; margin-bottom: 12px; padding: 18px 12px; 
            border: 2px dashed #999; background: transparent; border-radius: 6px; 
            align-items: center; position: relative; min-height: 120px; cursor: pointer;
        }
        .eink-row:hover { border-color: #2196f3; }
        .eink-row.active { border-color: #2196f3; background: rgba(33, 150, 243, 0.08); }
        
        .eink-widget {
            background-color: #FFFFFF; border: 2px solid #000; color: #000; 
            display: flex; flex-direction: column; align-items: center; justify-content: space-between;
            padding: 8px 4px; box-sizing: border-box; position: relative; cursor: pointer; 
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1); flex-shrink: 0;
            transition: transform 0.1s;
            border-radius: 6px;
            min-width: 100px; /* Zabezpieczenie przed znikniÄ™ciem */
        }
        .eink-widget:hover { transform: translateY(-2px); box-shadow: 4px 4px 8px rgba(0,0,0,0.2); z-index: 5; }
        .eink-widget.being-edited { border: 3px solid #ff9800; transform: scale(1.03); z-index: 10; }

        .ew-title { font-size: 12px; font-weight: 700; text-align: center; width: 100%; white-space: normal; overflow: hidden; line-height: 1.2; min-height: 30px; padding: 0 4px; display: flex; align-items: center; justify-content: center; }
        .ew-icon { font-size: 32px; }
        .ew-state { font-size: 11px; font-weight: 700; text-transform: uppercase; min-height: 18px; display: flex; align-items: center; }
        
        .ew-edit-overlay { position: absolute; top:0; left:0; right:0; bottom:0; background: rgba(33, 150, 243, 0.15); display:none; pointer-events: none;}
        .eink-widget:hover .ew-edit-overlay { display: block; }

        .ew-delete { position: absolute; top: 4px; right: 4px; background: red; color: white; width: 20px; height: 20px; text-align: center; line-height: 20px; font-size: 12px; display: none; z-index: 20; border-radius: 4px; }
        .eink-widget:hover .ew-delete { display: block; }

        textarea.output { width: 100%; height: 500px; font-family: monospace; background: #263238; color: #eceff1; border: none; padding: 15px; border-radius: 4px; }
        .hidden { display: none !important; }
        
        /* RESULT INSTRUCTIONS */
        .file-path-info { 
            background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; padding: 20px; margin-bottom: 20px; border-radius: 6px; font-family: monospace; font-size: 16px; line-height: 1.6;
        }
        body.dark-mode .file-path-info { background-color: #263238; color: #eceff1; border-color: #37474f; }
        
        .file-path-info strong { font-size: 1.3em; display: block; margin-top: 15px; color: #004085; }
        body.dark-mode .file-path-info strong { color: #90caf9; }
        .file-path-info strong:first-child { margin-top: 0; }
        
        .file-path-info code { 
            background: rgba(255,255,255,0.6); padding: 5px 10px; border-radius: 4px; font-weight: bold; color: #d63384; display: block; margin-top: 5px; word-break: break-all;
        }
        body.dark-mode .file-path-info code { background: rgba(0,0,0,0.3); color: #f48fb1; }
        
        /* POPRAWKA KOLORU LINKU W CIEMNYM MOTYWIE */
        .file-path-info a { 
            background: var(--link-bg); padding: 5px 10px; border-radius: 4px; font-weight: bold; color: var(--link-color); text-decoration: none; display: block; margin-top: 5px; word-break: break-all; border: 1px solid var(--link-border); font-size: 18px;
        }
        .file-path-info a:hover { text-decoration: underline; background-color: #fff; }
        body.dark-mode .file-path-info a:hover { background-color: #444; }

    </style>
</head>
<body>
    <div class="container">
        <div class="header-row">
            <h1>Joan 6 E-Ink Generator</h1>
            <div class="controls">
                <div class="theme-switch">
                    <button type="button" onclick="toggleTheme()" id="btn-theme">ðŸŒ™</button>
                </div>
                <div class="lang-switch">
                    <button type="button" onclick="setLang('pl')" id="btn-pl" class="active">PL</button>
                    <button type="button" onclick="setLang('en')" id="btn-en">EN</button>
                </div>
            </div>
        </div>

        {% if entities %}
            <div class="status-bar" style="background: #d4edda; color: #155724;">
                <span data-i18n="status_ok">âœ“ PoÅ‚Ä…czono z Home Assistant</span> ({{ entities|length }})
            </div>
        {% else %}
            <div class="status-bar" style="background: #f8d7da; color: #721c24;">
                <span data-i18n="status_error">âš  Brak poÅ‚Ä…czenia z API. SprawdÅº token.</span>
            </div>
        {% endif %}

        <!-- IMPORT SECTION -->
        <button type="button" class="btn btn-import" onclick="toggleImport()">
            <span data-i18n="btn_import_toggle">ðŸ“‚ Importuj / Edytuj Kod</span>
        </button>
        <div id="import-area" class="section import-box">
            <h4 style="margin-top:0" data-i18n="header_paste_code">Wklej kod pliku .dash tutaj:</h4>
            <textarea id="import-code" style="height: 150px; background: #fff; color: #000;" placeholder="title: Moj Dashboard..."></textarea>
            <button type="button" class="btn btn-add" style="margin-top: 10px;" onclick="importYaml()">
                <span data-i18n="btn_load_dash">Wczytaj Dashboard</span>
            </button>
        </div>

        <form method="POST" id="main-form">
            <input type="hidden" name="ui_language" id="ui_language" value="pl">
            <input type="hidden" name="ui_theme" id="ui_theme" value="light">
            
            <div class="section">
                <div class="section-title" data-i18n="sec_settings">1. Ustawienia</div>
                <div class="flex-row">
                    <div class="flex-col">
                        <label data-i18n="dash_title">TytuÅ‚ Dashboardu (Nazwa pliku)</label>
                        <input type="text" name="title" id="dash-title" value="JoanDashboard">
                    </div>
                </div>
            </div>

            <!-- ADD / EDIT WIDGET BOX -->
            <div class="add-widget-box" id="widget-form-box">
                <h4 style="margin-top:0" id="form-header" data-i18n="sec_add">2. Dodaj Widget</h4>
                
                <div class="flex-row">
                    <div class="flex-col">
                        <label data-i18n="label_type">Typ Widgetu</label>
                        <select id="new-widget-type" onchange="toggleInputs()">
                            <option value="switch">Switch / Light</option>
                            <option value="navigate">Navigate / Dashboard Button</option>
                            <option value="sensor">Sensor</option>
                            <option value="binary_sensor">Binary Sensor</option>
                            <option value="cover">Cover / Gate</option>
                            <option value="media_player">Media Player</option>
                            <option value="climate">Climate</option>
                            <option value="script">Script</option>
                            <option value="label">Label (Text)</option>
                        </select>
                    </div>
                    
                    <div class="flex-col" id="group-entity">
                        <label data-i18n="label_entity">Wybierz EncjÄ™ (Home Assistant)</label>
                        <input list="entities-list" id="new-entity-id" placeholder="np. light.salon..." oninput="megaAutoConfig()">
                        <datalist id="entities-list">
                            {% for entity in entities %}
                            <option value="{{ entity.id }}">{{ entity.id }}</option>
                            {% endfor %}
                        </datalist>
                    </div>

                    <div class="flex-col hidden" id="group-nav">
                        <label data-i18n="label_dashboard">Nazwa pliku dashboardu</label>
                        <input type="text" id="new-dashboard-name" placeholder="np. joan3 (bez .dash)">
                    </div>

                    <div class="flex-col">
                        <label data-i18n="label_name">TytuÅ‚ na ekranie</label>
                        <input type="text" id="new-widget-name" placeholder="np. Kuchnia">
                    </div>
                </div>
                
                <div class="flex-row" style="margin-top: 10px; align-items: flex-end;">
                    <div class="flex-col" style="max-width: 150px;">
                        <label data-i18n="label_size">Rozmiar</label>
                        <select id="new-widget-size">
                            <option value="">DomyÅ›lny (2x1)</option>
                            <option value="(1x1)">1x1 (MaÅ‚y)</option>
                            <option value="(2x1)">2x1 (Standard)</option>
                            <option value="(2x2)">2x2 (DuÅ¼y)</option>
                            <option value="(3x1)">3x1 (Szeroki)</option>
                            <option value="(1x2)">1x2 (Wysoki)</option>
                            <option value="(3x2)">3x2 (Bardzo duÅ¼y)</option>
                        </select>
                    </div>

                    <div style="width: 50px;">
                        <label data-i18n="label_preview">PodglÄ…d</label>
                        <div class="icon-preview-box">
                            <i id="icon-preview-i" class="mdi mdi-help-circle-outline"></i>
                        </div>
                    </div>
                    
                    <div class="flex-col">
                        <label data-i18n="label_icon">Ikona</label>
                        <input list="icons-list" id="new-widget-icon" placeholder="np. mdi-home" oninput="updateIconPreview()">
                        <datalist id="icons-list"></datalist>
                    </div>
                    
                    <div class="flex-col" style="display:flex; align-items: flex-end;">
                        <button type="button" id="btn-action" class="btn btn-add" onclick="saveWidget()">
                            <span data-i18n="btn_add">+ DODAJ DO WIERSZA</span>
                        </button>
                        <button type="button" id="btn-cancel" class="btn btn-cancel hidden" onclick="cancelEdit()">
                            <span data-i18n="btn_cancel">Anuluj</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- PodglÄ…d -->
            <div class="section">
                <div class="section-title" data-i18n="sec_preview">3. PodglÄ…d Dashboardu (Kliknij, aby edytowaÄ‡)</div>
                <div id="rows-container" class="preview-area"></div>
                <button type="button" class="btn btn-row" onclick="addNewRow()">
                    <span data-i18n="btn_new_row">+ Dodaj Nowy Wiersz</span>
                </button>
            </div>

            <input type="hidden" name="layout_data_json" id="layout_data_json">
            <button type="button" class="btn btn-primary" onclick="submitForm()">
                <span data-i18n="btn_generate">GENERUJ KOD .DASH</span>
            </button>
        </form>

        {% if generated_yaml %}
        <div class="section">
            <h3 data-i18n="sec_code">TwÃ³j kod YAML:</h3>
            
            <div class="file-path-info">
                <strong data-i18n="info_step1">1. Zapisz kod w pliku:</strong>
                <code id="path-code">\\IP_HA\addon_configs\appdaemon\dashboards\{{ filename }}</code>
                
                <strong data-i18n="info_step2">2. Uruchom ponownie AppDaemon i sprawdÅº dashboard:</strong>
                <a href="#" id="dashboard-link" target="_blank">http://IP_HA:5050/{{ dash_name }}</a>
            </div>

            <textarea class="output" readonly>{{ generated_yaml }}</textarea>
        </div>
        {% endif %}
    </div>

    <script>
        const entitiesData = {{ entities | tojson }};
        let currentLang = 'pl';
        let rows = [];
        let activeRowIndex = 0;
        let editingIndices = null; 
        let importedDefsMap = {}; 

        function formatNameFromId(id) {
            if (!id) return "";
            const last = id.includes('.') ? id.split('.').pop() : id;
            return last.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function resolveImportedTitle(id) {
            if (importedDefsMap[id] && importedDefsMap[id].title) return importedDefsMap[id].title;
            const shortId = id.split('.').pop();
            if (importedDefsMap[shortId] && importedDefsMap[shortId].title) return importedDefsMap[shortId].title;
            for(let key in importedDefsMap) {
                if(importedDefsMap[key].entity === id && importedDefsMap[key].title) return importedDefsMap[key].title;
            }
            return '';
        }

        function setLang(lang) {
            currentLang = lang;
            localStorage.setItem('joan_lang', lang);
            document.getElementById('ui_language').value = lang;
            document.getElementById('btn-pl').className = lang === 'pl' ? 'active' : '';
            document.getElementById('btn-en').className = lang === 'en' ? 'active' : '';
            refreshUIText();
            renderRows();
        }

        function refreshUIText() {
            const dict = {
                pl: {
                    sec_settings: "1. Ustawienia", sec_add: "2. Dodaj Widget", sec_edit: "2. Edytuj Widget", 
                    sec_preview: "3. PodglÄ…d Dashboardu (Kliknij, aby edytowaÄ‡)", sec_code: "TwÃ³j kod YAML:",
                    dash_title: "TytuÅ‚ Dashboardu (Nazwa pliku)", label_entity: "Wybierz EncjÄ™ (Home Assistant)",
                    label_dashboard: "Nazwa pliku dashboardu (np. joan3)", label_type: "Typ Widgetu",
                    label_name: "TytuÅ‚ na ekranie", label_icon: "Ikona (Puste = Brak)", label_preview: "Ikona",
                    label_size: "Rozmiar", btn_add: "+ DODAJ DO WIERSZA", btn_update: "ZAPISZ ZMIANY", btn_new_row: "+ Dodaj Nowy Wiersz", btn_generate: "GENERUJ KOD .DASH", btn_cancel: "Anuluj",
                    state_on: "WÅÄ„CZONE", state_off: "WYÅÄ„CZONE", state_open: "OTWARTE", state_closed: "ZAMKNIÄ˜TE",
                    info_step1: "1. Zapisz kod w pliku:", info_step2: "2. Uruchom ponownie AppDaemon i sprawdÅº dashboard:",
                    btn_import_toggle: "ðŸ“‚ Importuj / Edytuj Kod", header_paste_code: "Wklej kod pliku .dash tutaj:", btn_load_dash: "Wczytaj Dashboard"
                },
                en: {
                    sec_settings: "1. Settings", sec_add: "2. Add Widget", sec_edit: "2. Edit Widget",
                    sec_preview: "3. Dashboard Preview (Click to Edit)", sec_code: "Your YAML Code:",
                    dash_title: "Dashboard Title (Filename)", label_entity: "Select Entity (Home Assistant)",
                    label_dashboard: "Dashboard Filename (e.g. joan3)", label_type: "Widget Type", label_name: "Title on Screen",
                    label_icon: "Icon (Empty = None)", label_preview: "Icon", label_size: "Size",
                    btn_add: "+ ADD TO ROW", btn_update: "UPDATE WIDGET", btn_new_row: "+ Add New Row", btn_generate: "GENERATE .DASH CODE", btn_cancel: "Cancel",
                    state_on: "ON", state_off: "OFF", state_open: "OPEN", state_closed: "CLOSED",
                    info_step1: "1. Save code to file:", info_step2: "2. Restart AppDaemon and check dashboard:",
                    btn_import_toggle: "ðŸ“‚ Import / Edit Code", header_paste_code: "Paste .dash file code here:", btn_load_dash: "Load Dashboard"
                }
            }[currentLang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (dict[key]) el.innerText = dict[key];
            });
            const btn = document.getElementById('btn-action');
            const rowNum = activeRowIndex + 1;
            if (btn) btn.querySelector('span').innerText = (editingIndices ? dict.btn_update : `${dict.btn_add} (${currentLang==='pl'?'Wiersz':'Row'} ${rowNum})`);
            const header = document.getElementById('form-header');
            if (header) header.innerText = editingIndices ? dict.sec_edit : dict.sec_add;
        }

        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('joan_theme', isDark ? 'dark' : 'light');
            updateThemeBtn();
        }
        function updateThemeBtn() {
            const btn = document.getElementById('btn-theme');
            btn.innerText = document.body.classList.contains('dark-mode') ? 'â˜€ï¸' : 'ðŸŒ™';
        }

        function getEntityState(id) {
            const ent = entitiesData.find(e => e.id === id);
            if (ent) {
                if (ent.state === 'on') return translations[currentLang].state_on;
                if (ent.state === 'off') return translations[currentLang].state_off;
                if (ent.state === 'open') return translations[currentLang].state_open;
                if (ent.state === 'closed') return translations[currentLang].state_closed;
                let val = ent.state;
                if (!isNaN(parseFloat(val)) && val.includes('.')) val = parseFloat(val).toFixed(1);
                if (ent.unit) val += ' ' + ent.unit;
                return val;
            }
            return null;
        }

        function getLiveIcon(widget) {
            const ent = entitiesData.find(e => e.id === widget.id);
            let baseIcon = widget.icon;
            if (!baseIcon || !ent) return baseIcon; 
            const i = baseIcon.toLowerCase();
            const state = ent.state;
            const is_on = (state === 'on' || state === 'open' || state === 'unlocked');
            if (is_on) {
                if (i.includes('garage')) return 'mdi-garage-open';
                if (i.includes('gate')) return 'mdi-gate-open';
                if (i.includes('light') || i.includes('bulb')) return 'mdi-lightbulb-on';
                if (i.includes('lock')) return 'mdi-lock-open';
                if (i.includes('door')) return 'mdi-door-open';
                if (i.includes('window') || i.includes('blind')) return 'mdi-window-shutter-open';
                if (i.includes('-off')) return i.replace('-off', '');
                if (i.includes('-outline')) return i.replace('-outline', '');
                return i;
            } else {
                if (i.includes('garage')) return 'mdi-garage';
                if (i.includes('gate')) return 'mdi-gate';
                if (i.includes('light') || i.includes('bulb')) return 'mdi-lightbulb-outline';
                if (i.includes('lock')) return 'mdi-lock';
                if (i.includes('door')) return 'mdi-door-closed';
                if (i.includes('window') || i.includes('blind')) return 'mdi-window-shutter';
                return i;
            }
        }

        function renderRows() {
            const container = document.getElementById('rows-container');
            container.innerHTML = '';
            const T = translations[currentLang];
            const defaultStates = { 'switch': T.state_on, 'sensor': '21.5 Â°C', 'cover': T.state_open, 'media_player': 'PLAYING', 'navigate': 'GO', 'binary_sensor': T.state_open, 'script': 'RUN', 'climate': '21Â°' };

            rows.forEach((rowWidgets, index) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'eink-row';
                rowDiv.id = 'row-' + index;
                rowDiv.onclick = () => { if(editingIndices) cancelEdit(); activeRowIndex = index; highlightActiveRow(); };
                
                const rowLabel = document.createElement('div');
                rowLabel.style.position = 'absolute'; rowLabel.style.top = '-10px'; rowLabel.style.left='5px'; 
                rowLabel.style.fontWeight = 'bold'; rowLabel.style.fontSize = '10px'; rowLabel.style.color='#666';
                rowLabel.innerText = (currentLang === 'pl' ? 'WIERSZ ' : 'ROW ') + (index + 1);
                rowDiv.appendChild(rowLabel);

                rowWidgets.forEach((widget, wIndex) => {
                    const wDiv = document.createElement('div');
                    wDiv.className = 'eink-widget';
                    if (editingIndices && editingIndices.r === index && editingIndices.w === wIndex) wDiv.classList.add('being-edited');

                    let w = 160, h = 120;
                    if (widget.size) {
                        const dims = widget.size.replace(/[()]/g,'').split('x');
                        const cols = parseInt(dims[0]) || 2;
                        const rowsVal = parseInt(dims[1]) || 1;
                        w = (cols * 80) + ((cols - 1) * 8);
                        h = (rowsVal * 80) + ((rowsVal - 1) * 8);
                    }
                    wDiv.style.width = w + 'px'; wDiv.style.height = h + 'px';
                    
                    wDiv.onclick = (e) => { e.stopPropagation(); editWidget(index, wIndex); };

                    const liveIcon = getLiveIcon(widget);
                    const iconClass = liveIcon ? liveIcon : ''; 
                    let iconHtml = iconClass ? `<i class="mdi ${iconClass} ew-icon"></i>` : `<div style="height:38px"></div>`;
                    let displayState = getEntityState(widget.id) || defaultStates[widget.type] || '---';

                    // --- FIX: TITLE DISPLAY ---
                    const importedTitle = resolveImportedTitle(widget.id);
                    let safeName = (widget.name && widget.name.trim()) ? widget.name : (importedTitle || formatNameFromId(widget.id));
                    if(!safeName || safeName.trim() === "") safeName = widget.id.split('.').pop();

                    wDiv.innerHTML = `<div class="ew-title">${safeName}</div>${iconHtml}<div class="ew-state">${displayState}</div><div class="ew-delete" onclick="removeWidget(${index}, ${wIndex}); event.stopPropagation();">X</div><div class="ew-edit-overlay"></div>`;
                    rowDiv.appendChild(wDiv);
                });

                if(rows.length > 1) {
                    const del = document.createElement('button');
                    del.innerText = 'USUÅƒ'; del.className='btn-remove-row btn';
                    del.style.position='absolute'; del.style.right='5px'; del.style.top='5px';
                    del.onclick = (e) => { e.stopPropagation(); deleteRow(index); };
                    rowDiv.appendChild(del);
                }
                container.appendChild(rowDiv);
            });
            highlightActiveRow();
        }

        function toggleImport() { document.getElementById('import-area').classList.toggle('visible'); }
        
        function importYaml() {
            const code = document.getElementById('import-code').value;
            if (!code) return;
            try {
                const lines = code.split('\n');
                const rawDefs = {};
                let currentKey = null;
                const layoutLines = [];
                let parsingLayout = false;

                for (let i = 0; i < lines.length; i++) {
                    let lineRaw = lines[i];
                    let line = lineRaw.split('#')[0].trim();
                    if (!line) continue;

                    if (line.startsWith('layout:')) { parsingLayout = true; continue; }
                    if (!parsingLayout && lineRaw.match(/^title:/)) {
                        const parts = lineRaw.split(':');
                        document.getElementById('dash-title').value = parts.slice(1).join(':').trim().replace(/['"]/g, '');
                        continue;
                    }
                    if (parsingLayout) {
                        if (line.startsWith('-')) layoutLines.push(line);
                        else if (lineRaw.match(/^\S+:/)) parsingLayout = false;
                    }
                    if (!parsingLayout) {
                        const matchRoot = lineRaw.match(/^([a-zA-Z0-9_\.\-]+)\s*:/);
                        if (matchRoot) {
                            const key = matchRoot[1];
                            const ignore = ['global_parameters','widget_dimensions','widget_size','widget_margins','columns','rows','skin','title'];
                            if (!ignore.includes(key)) { currentKey = key; rawDefs[currentKey] = {}; } else { currentKey = null; }
                        } else if (currentKey && line.includes(':')) {
                            let val = line.substring(line.indexOf(':') + 1).trim();
                            if ((val.startsWith('"') && val.endsWith('"')) || (val.startsWith("'") && val.endsWith("'"))) val = val.slice(1, -1);
                            const k = line.split(':')[0].trim();
                            rawDefs[currentKey][k] = val;
                        }
                    }
                }

                importedDefsMap = {};
                Object.entries(rawDefs).forEach(([k, def]) => {
                    importedDefsMap[k] = def;
                    if (def.entity) importedDefsMap[def.entity] = def;
                });

                rows = [];
                layoutLines.forEach(l => {
                    const items = l.substring(1).trim().split(',');
                    const newRow = [];
                    items.forEach(itemRaw => {
                        let id = itemRaw.trim();
                        let size = "";
                        const sm = id.match(/\(\d+x\d+\)/);
                        if (sm) { size = sm[0]; id = id.replace(sm[0],'').trim(); }

                        const def = importedDefsMap[id] || importedDefsMap[id.split('.').pop()] || null;
                        let type = def && def.widget_type;
                        if (!type) {
                            if (id.startsWith('navigate.')) type='navigate';
                            else if (id.startsWith('sensor.')) type='sensor';
                            else if (id.startsWith('binary_sensor.')) type='binary_sensor';
                            else if (id.startsWith('cover.')) type='cover';
                            else if (id.startsWith('media_player.')) type='media_player';
                            else if (id.startsWith('climate.')) type='climate';
                            else if (id.startsWith('light.') || id.startsWith('switch.') || id.startsWith('input_boolean.')) type='switch';
                            else type='switch';
                        }

                        let name = resolveImportedTitle(id);
                        if (!name && def && def.title) name = def.title;
                        if (!name) name = formatNameFromId(id);

                        let icon = (def && def.icon) || '';
                        let icon_on = def && (def.icon_on || def.icon_active) || '';
                        if(!icon && icon_on) icon = icon_on;
                        [icon] = [icon].map(x => (x && !x.startsWith('mdi-')) ? ('mdi-'+x) : x);

                        newRow.push({ id, type, name, icon, size });
                    });
                    if (newRow.length) rows.push(newRow);
                });

                if (!rows.length) { alert("Layout not found."); return; }
                renderRows();
                activeRowIndex = rows.length - 1;
                refreshUIText();
                highlightActiveRow();
                toggleImport();
                alert("Import successful!");
            } catch (e) { alert("Import failed: " + e.message); }
        }

        function editWidget(r, w) {
            editingIndices = { r, w }; const widget = rows[r][w]; activeRowIndex = r; highlightActiveRow();
            document.getElementById('new-widget-type').value = widget.type; toggleInputs();
            if (widget.type === 'navigate') document.getElementById('new-dashboard-name').value = widget.id.replace('navigate.', '');
            else document.getElementById('new-entity-id').value = widget.id;
            document.getElementById('new-widget-name').value = widget.name || '';
            document.getElementById('new-widget-icon').value = widget.icon || '';
            document.getElementById('new-widget-size').value = widget.size || '';
            updateIconPreview();
            document.getElementById('widget-form-box').classList.add('editing');
            document.getElementById('btn-cancel').classList.remove('hidden');
            refreshUIText(); renderRows();
        }
        function cancelEdit() { editingIndices = null; clearForm(); document.getElementById('widget-form-box').classList.remove('editing'); document.getElementById('btn-cancel').classList.add('hidden'); refreshUIText(); renderRows(); }
        function saveWidget() {
            const type = document.getElementById('new-widget-type').value;
            let name = document.getElementById('new-widget-name').value.trim();
            let icon = document.getElementById('new-widget-icon').value.trim();
            const size = document.getElementById('new-widget-size').value;
            let id = '';
            if (type === 'navigate') { const dashName = document.getElementById('new-dashboard-name').value.trim(); if (!dashName) { alert(currentLang === 'pl' ? "Wymagana nazwa dashboardu" : "Dashboard name required"); return; } id = 'navigate.' + dashName; } else { id = document.getElementById('new-entity-id').value.trim(); if(!id) { alert(currentLang === 'pl' ? "Wymagana encja" : "Entity required"); return; } }
            if (!name) name = formatNameFromId(id);
            if(icon && !icon.startsWith('mdi-') && icon !== '') icon = 'mdi-' + icon;
            const newWidget = { id, type, name, icon, size };
            if (editingIndices) { rows[editingIndices.r][editingIndices.w] = newWidget; cancelEdit(); } else { if (!rows.length) addNewRow(); rows[activeRowIndex].push(newWidget); clearForm(); }
            renderRows();
        }
        function clearForm() { document.getElementById('new-entity-id').value = ''; document.getElementById('new-dashboard-name').value = ''; document.getElementById('new-widget-name').value = ''; document.getElementById('new-widget-icon').value = ''; document.getElementById('new-widget-size').value = ''; updateIconPreview(); }
        function removeWidget(r, w) { if (editingIndices && editingIndices.r === r && editingIndices.w === w) cancelEdit(); rows[r].splice(w, 1); renderRows(); }
        function toggleInputs() { const type = document.getElementById('new-widget-type').value; const groupEntity = document.getElementById('group-entity'); const groupNav = document.getElementById('group-nav'); const iconInput = document.getElementById('new-widget-icon'); const sizeInput = document.getElementById('new-widget-size'); if (type === 'navigate') { groupEntity.classList.add('hidden'); groupNav.classList.remove('hidden'); if(!iconInput.value) { iconInput.value = 'mdi-arrow-right-circle'; updateIconPreview(); } } else { groupEntity.classList.remove('hidden'); groupNav.classList.add('hidden'); } if((type === 'media_player' || type === 'climate') && !sizeInput.value) { sizeInput.value = '(2x2)'; } }
        async function fetchIcons() { const dataList = document.getElementById('icons-list'); try { const response = await fetch('https://raw.githubusercontent.com/Templarian/MaterialDesign/master/meta.json'); const icons = await response.json(); dataList.innerHTML = ''; icons.forEach(i => { const opt = document.createElement('option'); opt.value = 'mdi-' + i.name; dataList.appendChild(opt); }); } catch (e) {} } fetchIcons();
        function updateIconPreview() { const val = document.getElementById('new-widget-icon').value.trim(); const preview = document.getElementById('icon-preview-i'); preview.className = (val && val.startsWith('mdi-')) ? 'mdi ' + val : 'mdi mdi-help-circle-outline'; }
        function highlightActiveRow() { document.querySelectorAll('.eink-row').forEach(el => el.classList.remove('active')); const active = document.getElementById('row-' + activeRowIndex); if(active) active.classList.add('active'); refreshButtonText(); }
        function refreshButtonText() { if (editingIndices) return; const btn = document.getElementById('btn-action'); const rowNum = activeRowIndex + 1; const T = (currentLang==='pl'?{btn_add:'+ DODAJ DO WIERSZA'}:{btn_add:'+ ADD TO ROW'}); btn.querySelector('span').innerText = `${T.btn_add} (${currentLang==='pl'?'Wiersz':'Row'} ${rowNum})`; }
        function addNewRow() { rows.push([]); renderRows(); activeRowIndex = rows.length - 1; highlightActiveRow(); }
        function deleteRow(i) { rows.splice(i, 1); if (activeRowIndex >= rows.length) activeRowIndex = rows.length - 1; renderRows(); }
        function submitForm() { document.getElementById('layout_data_json').value = JSON.stringify(rows); document.getElementById('main-form').submit(); }
        function addWidgetToStaging() { saveWidget(); }
        function megaAutoConfig() { const id = document.getElementById('new-entity-id').value.toLowerCase(); const typeSelect = document.getElementById('new-widget-type'); const iconInput = document.getElementById('new-widget-icon'); const sizeInput = document.getElementById('new-widget-size'); const nameInput = document.getElementById('new-widget-name'); if(typeSelect.value === 'navigate') return; let detectedType = ''; if(id.startsWith('sensor.')) detectedType = 'sensor'; else if(id.startsWith('binary_sensor.')) detectedType = 'binary_sensor'; else if(id.startsWith('cover.')) detectedType = 'cover'; else if(id.startsWith('media_player.')) detectedType = 'media_player'; else if(id.startsWith('climate.')) detectedType = 'climate'; else if(id.startsWith('light.') || id.startsWith('switch.')) detectedType = 'switch'; if(detectedType) { typeSelect.value = detectedType; if((detectedType === 'media_player' || detectedType === 'climate') && !sizeInput.value) sizeInput.value = '(2x2)'; } if(!nameInput.value) nameInput.value = formatNameFromId(id); if(iconInput.value) return; const keywords = { 'battery': 'mdi-battery', 'temp': 'mdi-thermometer', 'light': 'mdi-lightbulb', 'garage': 'mdi-garage', 'lock': 'mdi-lock', 'fan': 'mdi-fan' }; for (const [key, icon] of Object.entries(keywords)) { if (id.includes(key)) { iconInput.value = icon; updateIconPreview(); break; } } }

        window.addEventListener('DOMContentLoaded', (event) => {
            const haHost = window.location.hostname;
            const codePath = document.getElementById('path-code');
            const linkDash = document.getElementById('dashboard-link');

            if(codePath) codePath.innerHTML = codePath.innerHTML.replace('IP_HA', haHost);
            if(linkDash) {
                let currentHref = linkDash.getAttribute('href');
                currentHref = currentHref.replace('IP_HA', haHost);
                linkDash.setAttribute('href', currentHref);
                linkDash.innerText = currentHref;
            }

            const savedLang = localStorage.getItem('joan_lang') || 'pl';
            const savedTheme = localStorage.getItem('joan_theme') || 'light';
            setLang(savedLang);
            if(savedTheme === 'dark') { document.body.classList.add('dark-mode'); updateThemeBtn(); }
            if(rows.length === 0) addNewRow();
        });
    </script>
</body>
</html>
