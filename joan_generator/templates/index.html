<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Joan 6 E-Ink Generator</title>
<link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
<style>
/* (Style identyczne jak wcze≈õniejsze ‚Äì skr√≥cone dla czytelno≈õci) */
:root {
  --bg-color:#e0e0e0;--container-bg:#fff;--text-color:#333;--border-color:#ddd;
  --accent-color:#d32f2f;--input-bg:#fff;--section-bg:#fafafa;--preview-bg:#f0f0f0;
  --link-bg:#fff;--link-color:#0056b3;--link-border:#bee5eb;
}
body.dark-mode {
  --bg-color:#121212;--container-bg:#1e1e1e;--text-color:#e0e0e0;--border-color:#333;
  --accent-color:#ff5252;--input-bg:#2c2c2c;--section-bg:#252525;--preview-bg:#121212;
  --link-bg:rgba(0,0,0,0.3);--link-color:#80d8ff;--link-border:#37474f;
}
body{font-family:'Roboto',sans-serif;background:var(--bg-color);color:var(--text-color);padding:20px;}
.container{max-width:1200px;margin:0 auto;background:var(--container-bg);padding:25px;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,0.1);}
.header-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;border-bottom:2px solid var(--border-color);padding-bottom:15px;}
h1{color:var(--accent-color);margin:0;font-size:24px;}
.controls{display:flex;gap:10px;align-items:center;}
.lang-switch button,.theme-switch button{padding:8px 12px;border:1px solid var(--border-color);background:var(--section-bg);color:var(--text-color);cursor:pointer;border-radius:4px;font-weight:bold;}
.lang-switch button.active{background:var(--accent-color);color:#fff;border-color:var(--accent-color);}
.status-bar{padding:10px;margin-bottom:20px;border-radius:4px;text-align:center;font-weight:bold;}
.section{margin-bottom:30px;border:1px solid var(--border-color);padding:20px;border-radius:8px;background:var(--section-bg);}
.section-title{font-size:1.2em;font-weight:bold;margin-bottom:15px;border-bottom:2px solid var(--accent-color);display:inline-block;}
.import-box{background:#fff3e0;border:1px solid #ffe0b2;color:#000;display:none;}
.import-box.visible{display:block;}
.add-widget-box{background:#e3f2fd;padding:15px;border-radius:8px;margin-bottom:20px;border:1px solid #2196f3;color:#000;transition:.3s;}
.add-widget-box.editing{background:#fff8e1;border-color:#ffc107;border:2px solid #ffc107;}
.flex-row{display:flex;gap:15px;align-items:flex-end;margin-bottom:10px;flex-wrap:wrap;}
.flex-col{flex:1;min-width:150px;}
label{display:block;margin-top:10px;font-weight:bold;font-size:.9em;margin-bottom:5px;}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--border-color);border-radius:4px;background:var(--input-bg);color:var(--text-color);}
.icon-preview-box{width:42px;height:42px;background:#fff;border:1px solid #ccc;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:24px;color:#333;}
.btn{padding:10px 20px;border:none;cursor:pointer;border-radius:4px;font-weight:bold;text-transform:uppercase;}
.btn-add{background:#4caf50;color:#fff;width:100%;}
.btn-cancel{background:#9e9e9e;color:#fff;}
.btn-row{background:#2196f3;color:#fff;margin-top:10px;}
.btn-import{background:#ff9800;color:#fff;margin-bottom:10px;}
.btn-secondary{background:#607d8b;color:#fff;width:100%;margin-top:10px;}
.btn-primary{background:var(--accent-color);color:#fff;width:100%;font-size:18px;margin-top:20px;}
.preview-area{background:var(--preview-bg);padding:24px;border-radius:8px;border:2px solid var(--border-color);overflow-x:auto;min-height:220px;}
.eink-row{display:flex;gap:12px;margin-bottom:12px;padding:18px 12px;border:2px dashed #999;background:transparent;border-radius:6px;align-items:center;position:relative;min-height:120px;cursor:pointer;}
.eink-row.active{border-color:#2196f3;background:rgba(33,150,243,0.08);}
.eink-widget{background:#fff;border:2px solid #000;color:#000;display:flex;flex-direction:column;align-items:center;justify-content:space-between;padding:8px 4px;position:relative;cursor:pointer;box-shadow:2px 2px 5px rgba(0,0,0,0.1);border-radius:6px;}
.eink-widget.being-edited{border:3px solid #ff9800;transform:scale(1.03);z-index:10;}
.ew-title{font-size:12px;font-weight:700;text-align:center;width:100%;line-height:1.2;min-height:30px;padding:0 4px;display:flex;align-items:center;justify-content:center;}
.ew-icon{font-size:32px;}
.ew-state{font-size:11px;font-weight:700;text-transform:uppercase;min-height:18px;display:flex;align-items:center;}
.ew-delete{position:absolute;top:4px;right:4px;background:red;color:#fff;width:20px;height:20px;text-align:center;line-height:20px;font-size:12px;border-radius:4px;display:none;}
.eink-widget:hover .ew-delete{display:block;}
textarea.output{width:100%;height:500px;font-family:monospace;background:#263238;color:#eceff1;border:none;padding:15px;border-radius:4px;}
.file-path-info{background:#d1ecf1;color:#0c5460;border:1px solid #bee5eb;padding:20px;margin-bottom:20px;border-radius:6px;font-family:monospace;font-size:16px;line-height:1.6;}
.file-path-info a{background:var(--link-bg);padding:5px 10px;border-radius:4px;font-weight:bold;color:var(--link-color);text-decoration:none;display:block;margin-top:5px;border:1px solid var(--link-border);font-size:18px;}
</style>
</head>
<body>
<div class="container">
  <div class="header-row">
    <h1>Joan 6 E-Ink Generator</h1>
    <div class="controls">
      <div class="theme-switch"><button type="button" onclick="toggleTheme()" id="btn-theme">üåô</button></div>
      <div class="lang-switch">
        <button type="button" onclick="setLang('pl')" id="btn-pl" class="active">PL</button>
        <button type="button" onclick="setLang('en')" id="btn-en">EN</button>
      </div>
    </div>
  </div>

  {% if entities %}
    <div class="status-bar" style="background:#d4edda;color:#155724;">
      <span data-i18n="status_ok">‚úì Po≈ÇƒÖczono z Home Assistant</span> ({{ entities|length }})
    </div>
  {% else %}
    <div class="status-bar" style="background:#f8d7da;color:#721c24;">
      <span data-i18n="status_error">‚ö† Brak po≈ÇƒÖczenia z API. Sprawd≈∫ token.</span>
    </div>
  {% endif %}

  <button type="button" class="btn btn-import" onclick="toggleImport()">
    <span data-i18n="btn_import_toggle">üìÇ Importuj / Edytuj Kod</span>
  </button>
  <div id="import-area" class="section import-box">
    <h4 style="margin-top:0" data-i18n="header_paste_code">Wklej kod pliku .dash tutaj:</h4>
    <textarea id="import-code" style="height:150px;background:#fff;color:#000;" placeholder="title: Joan3
widget_dimensions: [117, 117]
..."></textarea>
    <button type="button" class="btn btn-add" style="margin-top:10px;" onclick="importYaml()">
      <span data-i18n="btn_load_dash">Wczytaj Dashboard</span>
    </button>
  </div>

  <form method="POST" id="main-form">
    <input type="hidden" name="ui_language" id="ui_language" value="pl">
    <input type="hidden" name="ui_theme" id="ui_theme" value="light">
    <input type="hidden" name="layout_data_json" id="layout_data_json">
    <input type="hidden" name="generated_yaml_client" id="generated_yaml_client">

    <div class="section">
      <div class="section-title" data-i18n="sec_settings">1. Ustawienia</div>
      <div class="flex-row">
        <div class="flex-col">
          <label data-i18n="dash_title">Tytu≈Ç Dashboardu (Nazwa pliku)</label>
          <input type="text" name="title" id="dash-title" value="Joan3">
        </div>
      </div>
    </div>

    <div class="add-widget-box" id="widget-form-box">
      <h4 style="margin-top:0" id="form-header" data-i18n="sec_add">2. Dodaj Widget</h4>
      <div class="flex-row">
        <div class="flex-col">
          <label data-i18n="label_type">Typ Widgetu</label>
          <select id="new-widget-type" onchange="toggleInputs()">
            <option value="switch">Switch / Light</option>
            <option value="navigate">Navigate / Dashboard Button</option>
            <option value="sensor">Sensor</option>
            <option value="binary_sensor">Binary Sensor</option>
            <option value="cover">Cover / Gate</option>
            <option value="media_player">Media Player</option>
            <option value="climate">Climate</option>
            <option value="script">Script</option>
            <option value="label">Label (Text)</option>
          </select>
        </div>
        <div class="flex-col" id="group-entity">
          <label data-i18n="label_entity">Wybierz Encjƒô (Home Assistant)</label>
          <input list="entities-list" id="new-entity-id" placeholder="np. light.swiatlo_kuchnia" oninput="smartAutoFill()" onchange="smartAutoFill()" autocomplete="off">
          <datalist id="entities-list">
            {% for entity in entities %}
            <option value="{{ entity.id }}">{{ entity.id }}</option>
            {% endfor %}
          </datalist>
        </div>
        <div class="flex-col hidden" id="group-nav">
          <label data-i18n="label_dashboard">Nazwa pliku dashboardu</label>
          <input type="text" id="new-dashboard-name" placeholder="np. joan2 (bez .dash)" oninput="autoNameForNavigate()">
        </div>
        <div class="flex-col">
          <label data-i18n="label_name">Tytu≈Ç na ekranie</label>
          <input type="text" id="new-widget-name" placeholder="np. Kuchnia">
        </div>
      </div>
      <div class="flex-row" style="margin-top:10px;align-items:flex-end;">
        <div class="flex-col" style="max-width:150px;">
          <label data-i18n="label_size">Rozmiar</label>
          <select id="new-widget-size">
            <option value="">Domy≈õlny (1x1)</option>
            <option value="(1x1)">1x1</option>
            <option value="(2x1)">2x1</option>
            <option value="(2x2)">2x2</option>
            <option value="(3x1)">3x1</option>
            <option value="(1x2)">1x2</option>
            <option value="(3x2)">3x2</option>
          </select>
        </div>
        <div style="width:50px;">
          <label data-i18n="label_preview">PodglƒÖd</label>
          <div class="icon-preview-box"><i id="icon-preview-i" class="mdi mdi-help-circle-outline"></i></div>
        </div>
        <div class="flex-col">
          <label data-i18n="label_icon">Ikona</label>
          <input list="icons-list" id="new-widget-icon" placeholder="np. mdi-home" oninput="userEditedIcon();updateIconPreview()" autocomplete="off">
          <datalist id="icons-list"></datalist>
        </div>
        <div class="flex-col">
          <label>Ikona ON</label>
          <input list="icons-list" id="new-widget-icon-on" placeholder="np. mdi-lightbulb-on" oninput="userEditedIconPair();updateIconPreview()" autocomplete="off">
        </div>
        <div class="flex-col">
          <label>Ikona OFF</label>
          <input list="icons-list" id="new-widget-icon-off" placeholder="np. mdi-lightbulb-outline" oninput="userEditedIconPair();updateIconPreview()" autocomplete="off">
        </div>
      </div>
      <div class="flex-row" style="display:flex;align-items:flex-end;gap:10px;">
        <button type="button" id="btn-action" class="btn btn-add" onclick="saveWidget()">
          <span data-i18n="btn_add">+ DODAJ DO WIERSZA</span>
        </button>
        <button type="button" id="btn-cancel" class="btn btn-cancel hidden" onclick="cancelEdit()">
          <span data-i18n="btn_cancel">Anuluj</span>
        </button>
      </div>
    </div>

    <div class="section">
      <div class="section-title" data-i18n="sec_preview">3. PodglƒÖd Dashboardu (Kliknij, aby edytowaƒá)</div>
      <div id="rows-container" class="preview-area"></div>
      <button type="button" class="btn btn-row" onclick="addNewRow()">
        <span data-i18n="btn_new_row">+ Dodaj Nowy Wiersz</span>
      </button>
    </div>

    <button type="button" class="btn btn-secondary" onclick="generateLocalYaml()">LOKALNY PODGLƒÑD YAML (Joan3)</button>
    <button type="button" class="btn btn-primary" onclick="submitForm()">
      <span data-i18n="btn_generate">GENERUJ KOD .DASH (SERWER)</span>
    </button>
  </form>

  <div id="local-yaml-section" class="section hidden">
    <h3>PodglƒÖd YAML (Tablet E‚ÄëInk ‚Äì Joan3)</h3>
    <div class="file-path-info">
      <strong>1. Zapisz plik:</strong>
      <code id="local-path-code">\\IP_HA\addon_configs\appdaemon\dashboards\<span id="local-filename">Joan3.dash</span></code>
      <strong>2. Restart AppDaemon i otw√≥rz dashboard:</strong>
      <a href="#" id="local-dashboard-link" target="_blank">http://IP_HA:5050/<span id="local-dashname">Joan3</span></a>
    </div>
    <textarea id="local-yaml-output" class="output" readonly></textarea>
  </div>

  {% if generated_yaml %}
  <div class="section">
    <h3 data-i18n="sec_code">Tw√≥j kod YAML (Serwer):</h3>
    <div class="file-path-info">
      <strong data-i18n="info_step1">1. Zapisz kod w pliku:</strong>
      <code id="path-code">\\IP_HA\addon_configs\appdaemon\dashboards\{{ filename }}</code>
      <strong data-i18n="info_step2">2. Uruchom ponownie AppDaemon i sprawd≈∫ dashboard:</strong>
      <a href="#" id="dashboard-link" target="_blank">http://IP_HA:5050/{{ dash_name }}</a>
    </div>
    <textarea class="output" readonly>{{ generated_yaml }}</textarea>
  </div>
  {% endif %}
</div>

<script>
/* --- T≈Çumaczenia --- */
const translations={pl:{status_ok:"‚úì Po≈ÇƒÖczono z Home Assistant",status_error:"‚ö† Brak po≈ÇƒÖczenia z API. Sprawd≈∫ token.",sec_settings:"1. Ustawienia",sec_add:"2. Dodaj Widget",sec_edit:"2. Edytuj Widget",sec_preview:"3. PodglƒÖd Dashboardu (Kliknij, aby edytowaƒá)",sec_code:"Tw√≥j kod YAML:",dash_title:"Tytu≈Ç Dashboardu (Nazwa pliku)",label_entity:"Wybierz Encjƒô (Home Assistant)",label_dashboard:"Nazwa pliku dashboardu (np. joan2)",label_type:"Typ Widgetu",label_name:"Tytu≈Ç na ekranie",label_icon:"Ikona (Automatyczna)",label_preview:"Ikona",label_size:"Rozmiar",btn_add:"+ DODAJ DO WIERSZA",btn_update:"ZAPISZ ZMIANY",btn_new_row:"+ Dodaj Nowy Wiersz",btn_generate:"GENERUJ KOD .DASH",btn_cancel:"Anuluj",state_on:"W≈ÅƒÑCZONE",state_off:"WY≈ÅƒÑCZONE",state_open:"OTWARTE",state_closed:"ZAMKNIƒòTE",info_step1:"1. Zapisz kod w pliku:",info_step2:"2. Uruchom ponownie AppDaemon i sprawd≈∫ dashboard:",btn_import_toggle:"üìÇ Importuj / Edytuj Kod",header_paste_code:"Wklej kod pliku .dash tutaj:",btn_load_dash:"Wczytaj Dashboard"},en:{status_ok:"‚úì Connected to Home Assistant",status_error:"‚ö† No API Connection. Check Token.",sec_settings:"1. Settings",sec_add:"2. Add Widget",sec_edit:"2. Edit Widget",sec_preview:"3. Dashboard Preview (Click to Edit)",sec_code:"Your YAML Code:",dash_title:"Dashboard Title (Filename)",label_entity:"Select Entity (Home Assistant)",label_dashboard:"Dashboard Filename (e.g. joan2)",label_type:"Widget Type",label_name:"Title on Screen",label_icon:"Icon (Automatic)",label_preview:"Icon",label_size:"Size",btn_add:"+ ADD TO ROW",btn_update:"UPDATE WIDGET",btn_new_row:"+ Add New Row",btn_generate:"GENERATE .DASH CODE",btn_cancel:"Cancel",state_on:"ON",state_off:"OFF",state_open:"OPEN",state_closed:"CLOSED",info_step1:"1. Save code to file:",info_step2:"2. Restart AppDaemon and check dashboard:",btn_import_toggle:"üìÇ Import / Edit Code",header_paste_code:"Paste .dash file code here:",btn_load_dash:"Load Dashboard"}};
const entitiesData={{ entities | tojson }};
let currentLang='pl',rows=[],activeRowIndex=0,editingIndices=null,importedDefsMap={};
let lastAutoName='',userEditedName=false,lastAutoIcon='',userEditedIconFlag=false,userEditedIconPairFlag=false;

/* --- Funkcje pomocnicze --- */
function formatNameFromId(id){
  if(!id)return "";
  if(id.startsWith('navigate.'))return id.replace('navigate.','').replace(/_/g,' ').replace(/\b\w/g,l=>l.toUpperCase());
  const last=id.includes('.')?id.split('.').pop():id;
  return last.replace(/_/g,' ').replace(/\b\w/g,l=>l.toUpperCase());
}
function setLang(l){currentLang=l;localStorage.setItem('joan_lang',l);document.getElementById('ui_language').value=l;document.getElementById('btn-pl').className=l==='pl'?'active':'';document.getElementById('btn-en').className=l==='en'?'active':'';refreshUIText();renderRows();}
function refreshUIText(){const d=translations[currentLang];document.querySelectorAll('[data-i18n]').forEach(el=>{const k=el.getAttribute('data-i18n');if(d[k])el.innerText=d[k];});const btn=document.getElementById('btn-action');const rowNum=activeRowIndex+1;if(btn)btn.querySelector('span').innerText=(editingIndices?d.btn_update:`${d.btn_add} (${currentLang==='pl'?'Wiersz':'Row'} ${rowNum})`);const h=document.getElementById('form-header');if(h)h.innerText=editingIndices?d.sec_edit:d.sec_add;}
function toggleTheme(){const dark=document.body.classList.toggle('dark-mode');localStorage.setItem('joan_theme',dark?'dark':'light');document.getElementById('ui_theme').value=dark?'dark':'light';document.getElementById('btn-theme').innerText=dark?'‚òÄÔ∏è':'üåô';}
function getEntityData(id){return entitiesData.find(e=>e.id===id)||null;}
function normalizeState(s){if(s==null) return null;const T=translations[currentLang];const v=String(s).toLowerCase().trim();if(['1','true','on'].includes(v))return T.state_on;if(['0','false','off'].includes(v))return T.state_off;if(v==='open')return T.state_open;if(v==='closed')return T.state_closed;return null;}
function getDisplayState(id,type){const ent=getEntityData(id);if(!ent)return '';if(type==='label'||type==='navigate')return '';const norm=normalizeState(ent.state);if(type==='sensor'){const val=String(ent.state).trim();if((val==='1'||val==='0')&&!ent.unit)return '';if(!isNaN(parseFloat(val))&&val.includes('.')){const f=parseFloat(val).toFixed(1);return ent.unit?`${f} ${ent.unit}`:f;}return ent.unit?`${val} ${ent.unit}`:val;}return norm||String(ent.state).toUpperCase();}
function iconPairFor(id){
  const v=(id||'').toLowerCase();
  if(v.startsWith('light.')||v.includes('swiatlo')||v.includes('light'))return['mdi-lightbulb-on','mdi-lightbulb-outline'];
  if(v.startsWith('cover.')||v.includes('brama')||v.includes('gate')||v.includes('roleta')||v.includes('window'))return['mdi-window-shutter-open','mdi-window-shutter'];
  if(v.includes('garage')||v.includes('garaz')||v.includes('gara≈º'))return['mdi-garage-open','mdi-garage'];
  if(v.includes('radiator')||v.includes('ogrzew')||v.includes('grzejnik'))return['mdi-radiator','mdi-radiator-off'];
  if(v.includes('cwu')||v.includes('woda')||v.includes('water'))return['mdi-water-outline','mdi-water-off'];
  if(v.startsWith('fan.')||v.includes('wentyl'))return['mdi-fan','mdi-fan-off'];
  if(v.startsWith('input_boolean.')||v.startsWith('script.')||v.startsWith('switch.'))return['mdi-toggle-switch','mdi-toggle-switch-off'];
  if(v.startsWith('media_player.'))return['mdi-speaker','mdi-speaker-off'];
  if(v.startsWith('climate.'))return['mdi-thermometer','mdi-thermometer-off'];
  return['mdi-toggle-switch','mdi-toggle-switch-off'];
}
function pickAutoIcon(type,id){
  const v=(id||'').toLowerCase();const map=[
    {k:['hydrofor','storage','zbiornik','tank'],i:'mdi-storage-tank'},
    {k:['cwu','woda','water'],i:'mdi-water-outline'},
    {k:['ogrzew','grzejnik','radiator','heat'],i:'mdi-radiator'},
    {k:['brama','gate'],i:'mdi-gate'},
    {k:['garaz','gara≈º','garage'],i:'mdi-garage'},
    {k:['wilgotn','humidity'],i:'mdi-water-percent'},
    {k:['temp','temperatur','temperature'],i:'mdi-thermometer'},
    {k:['bateria','battery','akumulator'],i:'mdi-battery'},
    {k:['swiatlo','light','bulb','lamp'],i:'mdi-lightbulb'},
    {k:['media_player','spotify','radio','speaker'],i:'mdi-speaker'},
    {k:['klima','climate','hvac'],i:'mdi-home-thermometer'},
    {k:['sensor','czujnik'],i:'mdi-gauge'},
    {k:['lock','zamek','door','drzwi'],i:'mdi-door'},
    {k:['window','roleta','blind'],i:'mdi-window-shutter'},
    {k:['fan','wentyl'],i:'mdi-fan'}
  ];
  for(const m of map) if(m.k.some(kw=>v.includes(kw))) return m.i;
  const fallback={switch:'mdi-toggle-switch',sensor:'mdi-gauge',cover:'mdi-window-shutter',media_player:'mdi-speaker',climate:'mdi-home-thermometer',binary_sensor:'mdi-alert-circle-outline',script:'mdi-script-text-outline',navigate:'mdi-arrow-left-circle',label:'mdi-label',fan:'mdi-fan'};
  return fallback[type]||'mdi-help-circle-outline';
}
function pickPreviewIcon(w){
  const ent=getEntityData(w.id);
  const actionable=['switch','cover','binary_sensor','media_player','climate','script','fan'].some(t=>t===w.type)||w.id.startsWith('input_boolean.');
  if(actionable){
    let on=w.icon_on,off=w.icon_off;
    if(!on||!off){const p=iconPairFor(w.id);on=on||p[0];off=off||p[1];}
    const st=ent?String(ent.state).toLowerCase().trim():'off';
    const isOn=['on','true','1','open','unlocked','playing','heat','cool','auto'].includes(st);
    return isOn?on:off;
  }
  return (w.icon&&w.icon.trim())?w.icon:pickAutoIcon(w.type,w.id);
}

/* --- Smart Auto --- */
function userEditedIcon(){userEditedIconFlag=true;}
function userEditedIconPair(){userEditedIconPairFlag=true;}
function userEditedNameCheck(){userEditedName=true;}
document.getElementById('new-widget-name').addEventListener('input',userEditedNameCheck);

function updateIconPreview(){
  const iconOn=(document.getElementById('new-widget-icon-on')?.value||'').trim();
  const iconOff=(document.getElementById('new-widget-icon-off')?.value||'').trim();
  const base=document.getElementById('new-widget-icon').value.trim();
  const val=iconOn||iconOff||base;
  document.getElementById('icon-preview-i').className=(val && val.startsWith('mdi-'))?'mdi '+val:'mdi mdi-help-circle-outline';
}

function smartAutoFill(){
  const idField=document.getElementById('new-entity-id');
  const nameInput=document.getElementById('new-widget-name');
  const typeSel=document.getElementById('new-widget-type');
  const iconInput=document.getElementById('new-widget-icon');
  const iconOnInput=document.getElementById('new-widget-icon-on');
  const iconOffInput=document.getElementById('new-widget-icon-off');
  const sizeInput=document.getElementById('new-widget-size');
  const raw=(idField.value||'').trim(); if(!raw) return;
  const id=raw.toLowerCase();
  if(id.startsWith('sensor.')) typeSel.value='sensor';
  else if(id.startsWith('binary_sensor.')) typeSel.value='binary_sensor';
  else if(id.startsWith('cover.')) typeSel.value='cover';
  else if(id.startsWith('media_player.')) typeSel.value='media_player';
  else if(id.startsWith('climate.')) typeSel.value='climate';
  else if(id.startsWith('fan.')) typeSel.value='fan';
  else if(id.startsWith('switch.')||id.startsWith('light.')||id.startsWith('input_boolean.')||id.startsWith('script.')) typeSel.value='switch';
  else typeSel.value='switch';

  if((typeSel.value==='media_player'||typeSel.value==='climate')&&!sizeInput.value) sizeInput.value='(2x2)';
  const autoName=formatNameFromId(id);
  if(!userEditedName || nameInput.value===lastAutoName || nameInput.value.trim()===''){nameInput.value=autoName;lastAutoName=autoName;}

  const actionable=['switch','cover','binary_sensor','media_player','climate','script','fan'].includes(typeSel.value)||id.startsWith('input_boolean.');
  if(actionable){
    if(!userEditedIconPairFlag){const p=iconPairFor(id);iconOnInput.value=p[0];iconOffInput.value=p[1];}
    if(!userEditedIconFlag){iconInput.value='';}
  }else{
    if(!userEditedIconFlag||iconInput.value===lastAutoIcon||iconInput.value.trim()===''){const autoIcon=pickAutoIcon(typeSel.value,id);iconInput.value=autoIcon;lastAutoIcon=autoIcon;}
    if(!userEditedIconPairFlag){iconOnInput.value='';iconOffInput.value='';}
  }
  updateIconPreview();
}

/* --- Render podglƒÖdu --- */
function renderRows(){
  const c=document.getElementById('rows-container');c.innerHTML='';
  rows.forEach((rowWidgets,i)=>{
    const rowDiv=document.createElement('div');rowDiv.className='eink-row';rowDiv.id='row-'+i;
    rowDiv.onclick=()=>{if(editingIndices)cancelEdit();activeRowIndex=i;refreshUIText();highlightActiveRow();};
    const label=document.createElement('div');label.style.position='absolute';label.style.top='-10px';label.style.left='5px';label.style.fontSize='10px';label.style.fontWeight='bold';label.style.color='#666';label.innerText=(currentLang==='pl'?'WIERSZ ':'ROW ')+(i+1);rowDiv.appendChild(label);
    rowWidgets.forEach((w,wIdx)=>{
      const wDiv=document.createElement('div');wDiv.className='eink-widget';if(editingIndices&&editingIndices.r===i&&editingIndices.w===wIdx)wDiv.classList.add('being-edited');
      let width=117,height=117;
      if(w.size){
        const dims=w.size.replace(/[()]/g,'').split('x');const cols=parseInt(dims[0])||1;const rowsVal=parseInt(dims[1])||1;
        width=cols===1?117:(cols*117+(cols-1)*8);height=rowsVal===1?117:(rowsVal*117+(rowsVal-1)*8);
      }
      wDiv.style.width=width+'px';wDiv.style.height=height+'px';
      wDiv.onclick=(e)=>{e.stopPropagation();editWidget(i,wIdx);};
      const nameDisplay=w.name&&w.name.trim()?w.name:formatNameFromId(w.id);
      const iconCls=pickPreviewIcon(w);
      const displayState=getDisplayState(w.id,w.type);
      wDiv.innerHTML=`<div class="ew-title">${nameDisplay}</div>${iconCls?`<i class="mdi ${iconCls} ew-icon"></i>`:`<div style="height:38px"></div>`}${displayState?`<div class="ew-state">${displayState}</div>`:`<div style="height:14px"></div>`}<div class="ew-delete" onclick="removeWidget(${i},${wIdx});event.stopPropagation();">X</div><div class="ew-edit-overlay"></div>`;
      rowDiv.appendChild(wDiv);
    });
    if(rows.length>1){
      const del=document.createElement('button');del.innerText='USU≈É';del.className='btn-remove-row btn';del.style.position='absolute';del.style.right='5px';del.style.top='5px';del.onclick=(e)=>{e.stopPropagation();deleteRow(i);};rowDiv.appendChild(del);
    }
    c.appendChild(rowDiv);
  });
  highlightActiveRow();
}
function highlightActiveRow(){document.querySelectorAll('.eink-row').forEach(el=>el.classList.remove('active'));const act=document.getElementById('row-'+activeRowIndex);if(act)act.classList.add('active');}

/* --- Import --- */
function toggleImport(){document.getElementById('import-area').classList.toggle('visible');}
function importYaml(){
  const code=document.getElementById('import-code').value;if(!code)return;
  try{
    const lines=code.split('\n');const rawDefs={};let currentKey=null;const layoutLines=[];let parsingLayout=false;
    const ignoreKeys=['global_parameters','widget_dimensions','widget_size','widget_margins','columns','rows','skin','title'];
    for(let lineRaw of lines){
      let line=lineRaw.split('#')[0].trim();if(!line)continue;
      if(line.startsWith('layout:')){parsingLayout=true;continue;}
      if(!parsingLayout && /^title:/.test(lineRaw)){document.getElementById('dash-title').value=lineRaw.split(':').slice(1).join(':').trim().replace(/['"]/g,'');continue;}
      if(parsingLayout){
        if(line.startsWith('-'))layoutLines.push(line);
        else if(/^\S+:/.test(lineRaw))parsingLayout=false;
      }
      if(!parsingLayout){
        const m=lineRaw.match(/^([a-zA-Z0-9_\.\-]+)\s*:/);
        if(m){const key=m[1];if(!ignoreKeys.includes(key)){currentKey=key;rawDefs[currentKey]={};}else currentKey=null;}
        else if(currentKey && line.includes(':')){
          let val=line.substring(line.indexOf(':')+1).trim();
          if((val.startsWith('"')&&val.endsWith('"'))||(val.startsWith("'")&&val.endsWith("'")))val=val.slice(1,-1);
          const k=line.split(':')[0].trim();rawDefs[currentKey][k]=val;
        }
      }
    }
    importedDefsMap={};
    Object.entries(rawDefs).forEach(([k,def])=>{importedDefsMap[k]=def;if(def.entity)importedDefsMap[def.entity]=def;});
    rows=[];
    layoutLines.forEach(l=>{
      const items=l.substring(1).trim().split(',');
      const newRow=[];
      items.forEach(rawItem=>{
        let item=rawItem.trim();
        const sizeMatch=item.match(/\(\d+x\d+\)/);
        const size=sizeMatch?sizeMatch[0]:'';
        const id=item.replace(size,'').trim();
        const def=importedDefsMap[id]||importedDefsMap[id.split('.').pop()]||null;
        let type=def && def.widget_type;
        if(!type){
          if(id.startsWith('navigate.'))type='navigate';
          else if(id.startsWith('sensor.'))type='sensor';
          else if(id.startsWith('binary_sensor.'))type='binary_sensor';
          else if(id.startsWith('cover.'))type='cover';
          else if(id.startsWith('media_player.'))type='media_player';
          else if(id.startsWith('climate.'))type='climate';
          else if(id.startsWith('fan.'))type='fan';
          else if(id.startsWith('switch.')||id.startsWith('light.')||id.startsWith('input_boolean.')||id.startsWith('script.'))type='switch';
          else type='switch';
        }
        let name=(def && def.title)||formatNameFromId(id);
        let icon=(def && (def.icon||def.icon_on||def.icon_off||def.icon_inactive))||'';
        let icon_on=def && (def.icon_on||def.icon_active)||'';
        let icon_off=def && (def.icon_off||def.icon_inactive)||'';
        const actionable=['switch','cover','binary_sensor','media_player','climate','script','fan'].includes(type)||id.startsWith('input_boolean.');
        if(actionable && (!icon_on||!icon_off)){const p=iconPairFor(id);icon_on=icon_on||p[0];icon_off=icon_off||p[1];}
        [icon,icon_on,icon_off]=[icon,icon_on,icon_off].map(x=>(x&&!x.startsWith('mdi-'))?('mdi-'+x):x);
        newRow.push({id,type,name,icon,icon_on,icon_off,size});
      });
      if(newRow.length)rows.push(newRow);
    });
    if(!rows.length){alert("Layout not found.");return;}
    renderRows();activeRowIndex=rows.length-1;refreshUIText();highlightActiveRow();toggleImport();alert("Import successful!");
  }catch(e){alert("Import failed: "+e.message);}
}

/* --- Edycja / Zapis --- */
function editWidget(r,w){
  editingIndices={r,w};const widget=rows[r][w];activeRowIndex=r;highlightActiveRow();
  document.getElementById('new-widget-type').value=widget.type;toggleInputs();
  if(widget.type==='navigate'){document.getElementById('new-dashboard-name').value=widget.id.replace('navigate.','');document.getElementById('group-nav').classList.remove('hidden');document.getElementById('group-entity').classList.add('hidden');}
  else {document.getElementById('new-entity-id').value=widget.id;document.getElementById('group-entity').classList.remove('hidden');document.getElementById('group-nav').classList.add('hidden');}
  document.getElementById('new-widget-name').value=widget.name||'';
  document.getElementById('new-widget-icon').value=widget.icon||'';
  document.getElementById('new-widget-icon-on').value=widget.icon_on||'';
  document.getElementById('new-widget-icon-off').value=widget.icon_off||'';
  document.getElementById('new-widget-size').value=widget.size||'';
  updateIconPreview();
  document.getElementById('widget-form-box').classList.add('editing');
  document.getElementById('btn-cancel').classList.remove('hidden');
  refreshUIText();renderRows();
}
function cancelEdit(){editingIndices=null;clearForm();document.getElementById('widget-form-box').classList.remove('editing');document.getElementById('btn-cancel').classList.add('hidden');refreshUIText();renderRows();}

function saveWidget(){
  const type=document.getElementById('new-widget-type').value;
  let name=document.getElementById('new-widget-name').value.trim();
  let icon=document.getElementById('new-widget-icon').value.trim();
  let icon_on=(document.getElementById('new-widget-icon-on')?.value||'').trim();
  let icon_off=(document.getElementById('new-widget-icon-off')?.value||'').trim();
  const size=document.getElementById('new-widget-size').value;
  let id='';
  if(type==='navigate'){
    const dashName=document.getElementById('new-dashboard-name').value.trim();
    if(!dashName){alert(currentLang==='pl'?"Wymagana nazwa dashboardu":"Dashboard name required");return;}
    id='navigate.'+dashName;
  }else{
    id=document.getElementById('new-entity-id').value.trim();
    if(!id){alert(currentLang==='pl'?"Wymagana encja":"Entity required");return;}
  }
  if(!name)name=formatNameFromId(id);
  const actionable=['switch','cover','binary_sensor','media_player','climate','script','fan'].includes(type)||id.startsWith('input_boolean.');
  if(actionable && (!icon_on||!icon_off)){const p=iconPairFor(id);icon_on=icon_on||p[0];icon_off=icon_off||p[1];}
  if(!actionable && !icon){icon=pickAutoIcon(type,id);}
  [icon,icon_on,icon_off]=[icon,icon_on,icon_off].map(x=>(x&&!x.startsWith('mdi-')&&x!=='')?('mdi-'+x):x);
  const widget={id,type,name,icon,icon_on,icon_off,size};
  if(editingIndices){rows[editingIndices.r][editingIndices.w]=widget;cancelEdit();}
  else {if(!rows.length) addNewRow(); rows[activeRowIndex].push(widget); clearForm();}
  renderRows();
  lastAutoName='';userEditedName=false;lastAutoIcon='';userEditedIconFlag=false;userEditedIconPairFlag=false;
}

function clearForm(){
  document.getElementById('new-entity-id').value='';
  document.getElementById('new-dashboard-name').value='';
  document.getElementById('new-widget-name').value='';
  document.getElementById('new-widget-icon').value='';
  document.getElementById('new-widget-icon-on').value='';
  document.getElementById('new-widget-icon-off').value='';
  document.getElementById('new-widget-size').value='';
  updateIconPreview();
  userEditedName=false;userEditedIconFlag=false;userEditedIconPairFlag=false;lastAutoName='';lastAutoIcon='';
}
function removeWidget(r,w){if(editingIndices&&editingIndices.r===r&&editingIndices.w===w)cancelEdit();rows[r].splice(w,1);renderRows();}

function toggleInputs(){
  const type=document.getElementById('new-widget-type').value;
  const groupEntity=document.getElementById('group-entity');
  const groupNav=document.getElementById('group-nav');
  const iconInput=document.getElementById('new-widget-icon');
  const sizeInput=document.getElementById('new-widget-size');
  if(type==='navigate'){groupEntity.classList.add('hidden');groupNav.classList.remove('hidden');if(!iconInput.value){iconInput.value='mdi-arrow-left-circle';updateIconPreview();}}
  else {groupEntity.classList.remove('hidden');groupNav.classList.add('hidden');}
  if((type==='media_player'||type==='climate')&&!sizeInput.value)sizeInput.value='(2x2)';
}

/* --- Ikony lista --- */
async function fetchIcons(){
  const dl=document.getElementById('icons-list');
  try{
    const res=await fetch('https://raw.githubusercontent.com/Templarian/MaterialDesign/master/meta.json');
    const icons=await res.json();dl.innerHTML='';icons.forEach(i=>{const opt=document.createElement('option');opt.value='mdi-'+i.name;dl.appendChild(opt);});
  }catch(e){}
}
fetchIcons();

/* --- YAML generation --- */
function ensureMdi(i){return i && !i.startsWith('mdi-') ? 'mdi-'+i : i;}
const TITLE_STYLE="color: #000000; font-size: 20px; font-weight: 700; text-align: center; padding-top: 3px; width: 100%; font-family: 'Roboto', 'Arial Black', sans-serif;";
const TITLE_STYLE_SENSOR_TOP5="color: #000000; font-size: 20px; font-weight: 700; text-align: center; padding-top: 5px; width: 100%; font-family: 'Roboto', 'Arial Black', sans-serif;";
const WIDGET_STYLE="color: #000000 !important; background-color: #FFFFFF !important;";
const TEXT_STYLE="color: #000000 !important; font-weight: 700 !important;";
const VALUE_STYLE="color: #000000 !important; font-size: 44px !important; font-weight: 700 !important;";
const UNIT_STYLE="color: #000000 !important;";
const ICON_STYLE_ACTIVE="color: #000000 !important;";
const ICON_STYLE_INACTIVE="color: #000000 !important;";
const NAV_TITLE_STYLE="color: #000000; font-size: 24px; font-weight: 700; text-align: center; padding-top: 5px; width: 100%; font-family: 'Roboto', 'Arial Black', sans-serif;";
const NAV_WIDGET_STYLE="background-color: #FFFFFF !important; border-radius: 8px !important; padding: 10px !important; color: #000000 !important;";

function buildLayoutLine(rowWidgets){
  return "  - " + rowWidgets.map(w=>w.id + (w.size? w.size : '')).join(", ");
}

function buildHeader(title){
  return [
    `title: ${title}`,
    `widget_dimensions: [117, 117]`,
    `widget_size: [1, 1]`,
    `widget_margins: [8, 8]`,
    `columns: 6`,
    `rows: 8`,
    `global_parameters:`,
    `  use_comma: 0`,
    `  precision: 1`,
    `  use_hass_icon: 1`,
    `  namespace: default`,
    `  devices:`,
    `    media_player:`,
    `      step: 5`,
    `  white_text_style: "color: #000000 !important; font-weight: 700 !important;"`,
    `  state_text_style: "color: #000000 !important; font-weight: 700 !important; font-size: 16px !important;"`,
    `skin: simplyred`,
    ``,
    `layout:`
  ].join("\n");
}

function buildActionYaml(w,T){
  // wsp√≥lny dla switch / binary_sensor / fan / script / climate / media_player / input_boolean
  const pair=iconPairFor(w.id);
  const iconOn=ensureMdi(w.icon_on||w.icon||pair[0]);
  const iconOff=ensureMdi(w.icon_off||pair[1]);
  const lines=[];
  lines.push(`${w.id}:`);
  lines.push(`  widget_type: ${w.type==='fan' ? 'switch' : w.type}`); // fan jako switch
  lines.push(`  entity: ${w.id}`);
  lines.push(`  title: ${JSON.stringify(w.name)}`);
  lines.push(`  icon_on: ${iconOn}`);
  lines.push(`  icon_off: ${iconOff}`);
  lines.push(`  title_style: "${TITLE_STYLE}"`);
  lines.push(`  widget_style: "${WIDGET_STYLE}"`);
  lines.push(`  icon_style_active: "${ICON_STYLE_ACTIVE}"`);
  lines.push(`  icon_style_inactive: "${ICON_STYLE_INACTIVE}"`);
  // dodatkowa mapa stan√≥w dla climate / media_player je≈õli potrzebujesz mo≈ºesz rozszerzyƒá
  if(w.type==='climate'){
    lines.push(`  state_text: 1`);
    lines.push(`  state_map:`);
    lines.push(`    "off": "WY≈ÅƒÑCZONA"`);
    lines.push(`    "auto": "AUTO"`);
    lines.push(`    "heat": "GRZANIE"`);
    lines.push(`    "cool": "CH≈ÅODZENIE"`);
    lines.push(`    "dry": "OSUSZANIE"`);
    lines.push(`    "fan_only": "WENTYLATOR"`);
  } else if(w.type==='media_player'){
    lines.push(`  state_text: 1`);
    lines.push(`  state_map:`);
    lines.push(`    "playing": "PLAYING"`);
    lines.push(`    "paused": "PAUSED"`);
    lines.push(`    "off": "${T.state_off}"`);
  } else if(w.type==='cover'){
    // cover generowane innƒÖ funkcjƒÖ, tu pomijamy
  } else {
    lines.push(`  state_text: 1`);
    lines.push(`  state_map:`);
    lines.push(`    "on": "${T.state_on}"`);
    lines.push(`    "off": "${T.state_off}"`);
  }
  return lines.join("\n");
}

function buildCoverYaml(w){
  const pair=iconPairFor(w.id);
  const iconOn=ensureMdi(w.icon_on||pair[0]);
  const iconOff=ensureMdi(w.icon_off||pair[1]);
  return [
    `${w.id}:`,
    `  widget_type: cover`,
    `  entity: ${w.id}`,
    `  title: ${JSON.stringify(w.name)}`,
    `  icon_on: ${iconOn}`,
    `  icon_off: ${iconOff}`,
    `  state_text: 1`,
    `  title_style: "${TITLE_STYLE}"`,
    `  text_style: "${TEXT_STYLE}"`,
    `  widget_style: "${WIDGET_STYLE}"`,
    `  state_map:`,
    `    "open": "OTWARTA"`,
    `    "closed": "ZAMKNIƒòTA"`,
    `  icon_style_active: "${ICON_STYLE_ACTIVE}"`,
    `  icon_style_inactive: "${ICON_STYLE_INACTIVE}"`,
    ``
  ].join("\n");
}

function buildSensorYaml(w){
  const base=ensureMdi(w.icon||pickAutoIcon(w.type,w.id));
  return [
    `${w.id}:`,
    `  widget_type: sensor`,
    `  entity: ${w.id}`,
    `  title: ${JSON.stringify(w.name)}`,
    `  title_style: "${TITLE_STYLE_SENSOR_TOP5}"`,
    `  value_style: "${VALUE_STYLE}"`,
    `  unit_style: "${UNIT_STYLE}"`,
    `  widget_style: "${WIDGET_STYLE}"`,
    `  icon_style: "${ICON_STYLE_ACTIVE}"`,
    `  icon: ${base}`,
    `  precision: 1`,
    ``
  ].join("\n");
}

function buildNavigateYaml(w){
  const iconInactive=ensureMdi(w.icon||'mdi-arrow-left-circle');
  const dash=w.id.replace('navigate.','');
  return [
    `${w.id}:`,
    `  widget_type: navigate`,
    `  title: ${JSON.stringify(w.name)}`,
    `  dashboard: ${dash}`,
    `  icon_inactive: ${iconInactive}`,
    `  title_style: "${NAV_TITLE_STYLE}"`,
    `  widget_style: "${NAV_WIDGET_STYLE}"`,
    ``
  ].join("\n");
}

function generateLocalYaml(){
  if(!rows.length){alert("Brak widget√≥w");return;}
  const titleRaw=document.getElementById('dash-title').value.trim()||'Joan3';
  const title=titleRaw.replace(/"/g,'');
  const T=translations[currentLang];
  let yaml=buildHeader(title)+"\n";
  rows.forEach(r=>{yaml+=buildLayoutLine(r)+"\n";});
  yaml+="\n# -------------------\n# DEFINICJE WID≈ªET√ìW\n# -------------------\n\n";

  rows.forEach(r=>{
    r.forEach(w=>{
      const name=(w.name&&w.name.trim())?w.name:formatNameFromId(w.id);
      const ww={...w,name};
      if(ww.type==='cover') yaml+=buildCoverYaml(ww);
      else if(ww.type==='sensor') yaml+=buildSensorYaml(ww);
      else if(ww.type==='navigate') yaml+=buildNavigateYaml(ww);
      else yaml+=buildActionYaml(ww,T)+"\n";
    });
  });

  document.getElementById('local-yaml-output').value=yaml;
  document.getElementById('generated_yaml_client').value=yaml;
  document.getElementById('local-filename').innerText=title+'.dash';
  document.getElementById('local-dashname').innerText=title;
  const host=window.location.hostname;
  document.getElementById('local-dashboard-link').href=`http://${host}:5050/${title}`;
  document.getElementById('local-dashboard-link').innerText=`http://${host}:5050/${title}`;
  const pathEl=document.getElementById('local-path-code');
  pathEl.innerHTML=pathEl.innerHTML.replace('IP_HA',host);
  document.getElementById('local-yaml-section').classList.remove('hidden');
  window.scrollTo({top:document.getElementById('local-yaml-section').offsetTop,behavior:'smooth'});
}

function submitForm(){
  document.getElementById('layout_data_json').value=JSON.stringify(rows);
  generateLocalYaml(); // zapewnia ikony w kliencie
  document.getElementById('main-form').submit();
}

/* --- Inicjalizacja --- */
window.addEventListener('DOMContentLoaded',()=>{
  const host=window.location.hostname;
  const codePath=document.getElementById('path-code');
  const linkDash=document.getElementById('dashboard-link');
  if(codePath)codePath.innerHTML=codePath.innerHTML.replace('IP_HA',host);
  if(linkDash){
    const href=`http://${host}:5050/{{ dash_name }}`;
    linkDash.href=href;linkDash.innerText=href;
    linkDash.style.background='var(--link-bg)';linkDash.style.color='var(--link-color)';
    linkDash.style.border='1px solid var(--link-border)';
  }
  const savedLang=localStorage.getItem('joan_lang')||'pl';
  setLang(savedLang);
  const themeInput=document.getElementById('ui_theme');
  const persisted=themeInput && themeInput.value ? themeInput.value : (localStorage.getItem('joan_theme')||'light');
  if(persisted==='dark')document.body.classList.add('dark-mode');
  document.getElementById('btn-theme').innerText=document.body.classList.contains('dark-mode')?'‚òÄÔ∏è':'üåô';
  if(themeInput)themeInput.value=document.body.classList.contains('dark-mode')?'dark':'light';
  if(!rows.length) addNewRow();
});
</script>
</body>
</html>
