<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Joan 6 E-Ink Generator</title>
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet" />
  
  <style>
    /* STYLE CSS - BEZ ZMIAN (Dla porzÄ…dku zostawiam je tutaj, ale moÅ¼na je teÅ¼ wynieÅ›Ä‡ do static/style.css) */
    :root { --bg-color:#e0e0e0; --container-bg:#ffffff; --text-color:#333; --border-color:#ddd; --accent-color:#d32f2f; --input-bg:#fff; --section-bg:#fafafa; --preview-bg:#f0f0f0; --link-bg:#ffffff; --link-color:#0056b3; --link-border:#bee5eb; }
    body.dark-mode { --bg-color:#121212; --container-bg:#1e1e1e; --text-color:#e0e0e0; --border-color:#333; --accent-color:#ff5252; --input-bg:#2c2c2c; --section-bg:#252525; --preview-bg:#121212; --link-bg:#1e1e1e; --link-color:#80d8ff; --link-border:#37474f; }
    body { font-family:'Roboto',sans-serif; background:var(--bg-color); color:var(--text-color); padding:20px; transition:background-color 0.3s; }
    .container { max-width:1250px; margin:0 auto; background:var(--container-bg); padding:25px; border-radius:10px; box-shadow:0 4px 15px rgba(0,0,0,.1); transition:background-color 0.3s; }
    .header-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:2px solid var(--border-color); padding-bottom:15px; }
    h1 { color:var(--accent-color); margin:0; font-size:24px; font-weight:900; }
    .controls { display:flex; gap:10px; }
    .controls button { padding:8px 14px; border:1px solid var(--border-color); background:var(--section-bg); color:var(--text-color); cursor:pointer; border-radius:6px; font-weight:700; }
    .controls button.active { background:var(--accent-color); color:#fff; border-color:var(--accent-color); }
    .status-bar { padding:10px; border-radius:6px; font-weight:700; margin-bottom:20px; }
    .section { margin-bottom:28px; padding:20px; border:1px solid var(--border-color); border-radius:10px; background:var(--section-bg); }
    .section-title { font-weight:900; font-size:1.15em; margin:0 0 15px; padding:0 0 6px; border-bottom:2px solid var(--accent-color); color:var(--text-color); }
    .import-box { display:none; } .import-box.visible { display:block; }
    label { display:block; font-size:.9em; font-weight:700; margin:10px 0 6px; color:var(--text-color); }
    input,select,textarea { width:100%; padding:10px; border:1px solid var(--border-color); border-radius:6px; box-sizing:border-box; background:var(--input-bg); color:var(--text-color); }
    .add-widget-box { background:#e3f2fd; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #2196f3; color:#000; transition:background 0.3s; }
    body.dark-mode .add-widget-box { background:#0d47a1; border-color:#1565c0; color:#fff; }
    .add-widget-box.editing { background:#fff8e1; border-color:#ffc107; border:2px solid #ffc107; }
    body.dark-mode .add-widget-box.editing { background:#3e2723; border-color:#ffb300; }
    .flex-row { display:flex; gap:15px; align-items:flex-end; margin-bottom:10px; flex-wrap:wrap; }
    .flex-col { flex:1; min-width:170px; }
    .icon-preview-box { width:46px; height:46px; background:#fff; border:1px solid #ccc; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:26px; color:#333; }
    .btn { padding:10px 18px; border:none; cursor:pointer; border-radius:6px; font-weight:700; text-transform:uppercase; }
    .btn-primary { background:var(--accent-color); color:#fff; width:100%; font-size:18px; margin-top:10px; }
    .btn-add { background:#4caf50; color:#fff; }
    .btn-update { background:#ff9800; color:#fff; }
    .btn-cancel { background:#9e9e9e; color:#fff; margin-left:10px; }
    .btn-row { background:#2196f3; color:#fff; margin-top:10px; }
    .btn-import { background:#ff9800; color:#fff; margin-bottom:10px; }
    .btn-remove-row { font-size:11px; padding:4px 8px; margin-left:auto; background:#757575; color:#fff; border-radius:4px; position:absolute; right:6px; top:6px; z-index:20; }
    .preview-area { background:var(--preview-bg); padding:20px; border-radius:8px; border:2px solid var(--border-color); overflow-x:auto; min-height:240px; }
    .eink-row { display:flex; gap:10px; margin-bottom:10px; padding:14px 10px; border:2px dashed #999; background:transparent; border-radius:6px; align-items:center; position:relative; min-height:80px; cursor:pointer; }
    .eink-row:hover { border-color:#2196f3; }
    .eink-row.active { border-color:#2196f3; background:rgba(33, 150, 243, 0.1); }
    .eink-widget { background:#FFFFFF; border:2px solid #000; color:#000; display:flex; flex-direction:column; align-items:center; justify-content:space-between; padding:6px 4px; box-sizing:border-box; position:relative; cursor:pointer; box-shadow:2px 2px 5px rgba(0,0,0,0.12); border-radius:6px; min-width:120px; min-height:108px; transition:.1s; }
    .eink-widget:hover { transform:translateY(-2px); box-shadow:4px 4px 8px rgba(0,0,0,0.2); z-index:5; }
    .eink-widget.being-edited { border:3px solid #ff9800; transform:scale(1.03); z-index:10; }
    .ew-title { font-size:12px; font-weight:700; text-align:center; width:100%; white-space:normal; line-height:1.2; min-height:30px; padding:0 4px; display:flex; align-items:center; justify-content:center; }
    .ew-icon { font-size:30px; margin:6px 0; }
    .ew-state { font-size:11px; font-weight:700; text-transform:uppercase; min-height:18px; display:flex; align-items:center; }
    .ew-edit-overlay { position:absolute; top:0; left:0; right:0; bottom:0; background:rgba(33, 150, 243, 0.15); display:none; pointer-events:none;}
    .eink-widget:hover .ew-edit-overlay { display:block; }
    .ew-delete { position:absolute; top:4px; right:4px; background:red; color:#fff; width:20px; height:20px; text-align:center; line-height:18px; font-size:10px; display:none; border-radius:4px; z-index:20; }
    .eink-widget:hover .ew-delete { display:block; }
    textarea.output { width:100%; min-height:520px; font-family:monospace; background:#263238; color:#eceff1; border:none; padding:15px; border-radius:4px; white-space:pre; }
    .file-path-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; padding: 20px; margin-bottom: 20px; border-radius: 6px; font-family: monospace; font-size: 16px; line-height: 1.6; }
    body.dark-mode .file-path-info { background: #263238; color: #eceff1; border-color: #37474f; }
    .file-path-info strong { font-size: 1.1em; display:block; margin-top:10px; color: #004085; }
    body.dark-mode .file-path-info strong { color:#90caf9; }
    .file-path-info code { background: rgba(255,255,255,0.6); padding: 5px 10px; border-radius: 4px; font-weight: bold; color: #d63384; display: block; margin-top: 5px; word-break: break-all; }
    body.dark-mode .file-path-info code { background: rgba(0,0,0,0.3); color: #f48fb1; }
    .dashboard-link-btn { background: var(--link-bg); padding: 10px 15px; border-radius: 6px; font-weight: bold; color: var(--link-color); text-decoration: none; display: block; margin-top: 10px; word-break: break-all; border: 2px solid var(--link-border); font-size: 1.0em; }
    .dashboard-link-btn:hover { background-color: #f0f0f0; text-decoration: underline; }
    body.dark-mode .dashboard-link-btn:hover { background-color: #444; }
    .hidden { display:none !important; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-row">
      <h1>Joan 6 E-Ink Generator</h1>
      <div class="controls">
        <button id="btn-theme" title="Theme">ðŸŒ™</button>
        <button id="btn-pl" class="active">PL</button>
        <button id="btn-en">EN</button>
      </div>
    </div>

    <!-- PASS ENTITIES TO JS -->
    <script>
        const entitiesData = {{ entities | tojson }};
    </script>

    {% if entities %}
      <div class="status-bar" style="background:#d4edda;color:#155724;">
        <span data-i18n="status_ok">âœ“ PoÅ‚Ä…czono z Home Assistant</span> ({{ entities|length }})
      </div>
    {% else %}
      <div class="status-bar" style="background:#f8d7da;color:#721c24;">
        <span data-i18n="status_error">âš  Brak poÅ‚Ä…czenia z API. SprawdÅº token.</span>
      </div>
    {% endif %}

    <button type="button" class="btn btn-import" id="btn-toggle-import">
      <span data-i18n="btn_import_toggle">ðŸ“‚ Importuj / Edytuj Kod</span>
    </button>

    <div id="import-area" class="section import-box">
      <h4 style="margin-top:0" data-i18n="header_paste_code">Wklej kod pliku .dash tutaj:</h4>
      <textarea id="import-code" style="height:150px;background:#fff;color:#000;" placeholder="Wklej caÅ‚y plik .dash..."></textarea>
      <button type="button" class="btn btn-add" id="btn-import">
        <span data-i18n="btn_load_dash">Wczytaj Dashboard</span>
      </button>
    </div>

    <form id="main-form">
      <input type="hidden" name="ui_language" id="ui_language" value="pl" />
      <input type="hidden" name="ui_theme" id="ui_theme" value="light" />
      <input type="hidden" name="layout_data_json" id="layout_data_json" />
      <input type="hidden" name="widgets_full_json" id="widgets_full_json" />
      <input type="hidden" name="generated_yaml_client" id="generated_yaml_client" />

      <div class="section">
        <div class="section-title" data-i18n="sec_settings">1. Ustawienia</div>
        <div class="flex-row">
          <div class="flex-col">
            <label data-i18n="dash_title">TytuÅ‚ Dashboardu (Nazwa pliku)</label>
            <input type="text" id="dash-title" value="Dashboard" />
          </div>
        </div>
      </div>

      <div class="add-widget-box" id="widget-form-box">
        <h4 style="margin-top:0" id="form-header" data-i18n="sec_add">2. Dodaj / Edytuj Widget</h4>

        <div class="flex-row">
          <div class="flex-col">
            <label data-i18n="label_type">Typ Widgetu</label>
            <select id="new-widget-type">
              <!-- Options generated by JS -->
            </select>
          </div>

          <div class="flex-col" id="group-entity">
            <label data-i18n="label_entity">Wybierz EncjÄ™ (Home Assistant)</label>
            <input list="entities-list" id="new-entity-id" placeholder="np. light.salon" autocomplete="off" />
            <datalist id="entities-list">
              {% for entity in entities %}
              <option value="{{ entity.id }}">{{ entity.id }}</option>
              {% endfor %}
            </datalist>
          </div>

          <div class="flex-col hidden" id="group-nav">
            <label data-i18n="label_dashboard">Nazwa pliku dashboardu</label>
            <input id="new-dashboard-name" placeholder="np. joan3" />
          </div>

          <div class="flex-col">
            <label data-i18n="label_name">TytuÅ‚ na ekranie</label>
            <input id="new-widget-name" placeholder="Automatycznie" />
          </div>
        </div>

        <div class="flex-row" style="margin-top:10px; align-items:flex-end;">
          <div class="flex-col" style="max-width:160px;">
            <label data-i18n="label_size">Rozmiar</label>
            <select id="new-widget-size">
              <option value="">DomyÅ›lny (2x1)</option>
              <option value="(1x1)">1x1</option>
              <option value="(2x1)">2x1</option>
              <option value="(2x2)">2x2</option>
              <option value="(3x1)">3x1</option>
              <option value="(1x2)">1x2</option>
              <option value="(3x2)">3x2</option>
            </select>
          </div>

          <div style="width:56px;">
            <label data-i18n="label_preview">PodglÄ…d</label>
            <div class="icon-preview-box">
              <i id="icon-preview-i" class="mdi mdi-help-circle-outline"></i>
            </div>
          </div>

          <div class="flex-col">
            <label data-i18n="label_icon">Ikona</label>
            <input id="new-widget-icon" list="icons-list" placeholder="np. mdi-lightbulb" />
            <datalist id="icons-list"></datalist>
          </div>

          <div class="flex-col" style="display:flex; gap:10px; align-items:flex-end;">
            <button type="button" id="btn-action" class="btn btn-add"><span data-i18n="btn_add">+ DODAJ DO WIERSZA</span></button>
            <button type="button" id="btn-cancel" class="btn btn-cancel hidden"><span data-i18n="btn_cancel">Anuluj</span></button>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title" data-i18n="sec_preview">3. PodglÄ…d Dashboardu (Kliknij, aby edytowaÄ‡)</div>
        <div id="rows-container" class="preview-area"></div>
        <button type="button" class="btn btn-row" id="btn-new-row"><span data-i18n="btn_new_row">+ Dodaj Nowy Wiersz</span></button>
      </div>

      <button type="submit" class="btn btn-primary"><span data-i18n="btn_generate">GENERUJ KOD .DASH</span></button>
    </form>

    <div class="section hidden" id="client-yaml-section">
      <h3 data-i18n="sec_code">TwÃ³j kod YAML (Klient):</h3>
      <div class="file-path-info">
        <strong data-i18n="info_step1">1. Zapisz kod w pliku:</strong>
        <code id="client-path-code">\\IP_HA\addon_configs\appdaemon\dashboards\dashboard.dash</code>
        <strong data-i18n="info_step2">2. PodglÄ…d dashboardu:</strong>
        <a id="client-dashboard-link" class="dashboard-link-btn" target="_blank" href="#">Link...</a>
      </div>
      <textarea id="client-yaml-output" class="output" readonly></textarea>
    </div>
  </div>

  <!-- Load external Logic -->
  <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>
