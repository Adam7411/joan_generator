<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joan 6 E-Ink Generator (THE BEHEMOTH)</title>
    
    <!-- 1. BIBLIOTEKI ZEWNƒòTRZNE -->
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- 2. SKRYPT INICJUJƒÑCY MOTYW -->
    <script>
        (function() {
            try {
                const savedTheme = localStorage.getItem('joan_theme') || 'light';
                if (savedTheme === 'dark') {
                    document.documentElement.classList.add('dark-mode');
                }
            } catch(e) {
                console.error("B≈ÇƒÖd ≈Çadowania motywu:", e);
            }
        })();
    </script>

    <style>
        /* ---------------------------------------------------------- */
        /* 3. ZMIENNE KOLORYSTYCZNE */
        /* ---------------------------------------------------------- */
        :root {
            --bg-body: #e0e0e0;
            --bg-container: #ffffff;
            --bg-section: #fafafa;
            --bg-input: #ffffff;
            --text-main: #333333;
            --border: #cccccc;
            --accent: #d32f2f; /* Czerwony Joan */
            --highlight: #e3f2fd;
            --preview-bg: #f0f0f0;
            --link-bg: #e1f5fe;
            --link-color: #0277bd;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
            --btn-text: #ffffff;
        }
        
        html.dark-mode {
            --bg-body: #121212;
            --bg-container: #1e1e1e;
            --bg-section: #252525;
            --bg-input: #2c2c2c;
            --text-main: #e0e0e0;
            --border: #444444;
            --accent: #ff5252;
            --highlight: #0d47a1;
            --preview-bg: #000000;
            --link-bg: #013655;
            --link-color: #81d4fa;
            --shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        /* ---------------------------------------------------------- */
        /* 4. STYLE G≈Å√ìWNE */
        /* ---------------------------------------------------------- */
        body { 
            font-family: 'Roboto', sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            padding: 20px; 
            transition: background-color 0.3s, color 0.3s; 
        }

        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: var(--bg-container); 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: var(--shadow); 
        }
        
        /* NAG≈Å√ìWEK */
        .header-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 2px solid var(--border); 
            padding-bottom: 20px; 
            margin-bottom: 25px; 
        }

        h1 { 
            margin: 0; 
            color: var(--accent); 
            font-size: 28px; 
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* KONTROLKI */
        .controls button { 
            padding: 8px 16px; 
            border: 1px solid var(--border); 
            background: var(--bg-section); 
            color: var(--text-main); 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: bold; 
            margin-left: 5px;
            transition: all 0.2s;
        }
        
        .controls button:hover {
            filter: brightness(0.9);
        }

        .controls button.active { 
            background: var(--accent); 
            color: var(--btn-text); 
            border-color: var(--accent); 
        }

        /* SEKCJE */
        .section { 
            background: var(--bg-section); 
            padding: 25px; 
            border-radius: 8px; 
            border: 1px solid var(--border); 
            margin-bottom: 30px; 
        }

        .section-title { 
            font-size: 1.4em; 
            font-weight: 900; 
            border-bottom: 3px solid var(--accent); 
            display: inline-block; 
            margin-bottom: 20px; 
            color: var(--text-main); 
        }

        /* INFO O PLIKU (NA DOLE) */
        .file-path-info { 
            background-color: var(--link-bg); 
            color: var(--link-color); 
            border: 1px solid var(--border); 
            padding: 20px; 
            margin-bottom: 20px; 
            border-radius: 6px; 
            font-family: monospace; 
            font-size: 15px; 
            line-height: 1.6; 
            word-break: break-all; 
        }
        
        .file-info-block {
            display: block;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        .file-info-block:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .file-path-info strong { 
            display: block; 
            margin-bottom: 5px; 
            color: var(--text-main); 
            font-size: 1.1em; 
        }

        .file-path-info a { 
            color: var(--accent); 
            font-weight: bold; 
            font-size: 16px; 
            text-decoration: underline; 
        }
        
        .file-path-info code {
            display: block;
            background: rgba(255,255,255,0.4);
            padding: 8px;
            border-radius: 4px;
            font-weight: bold;
        }

        /* ------------------------------------------------------------------ */
        /* FORMULARZE */
        /* ------------------------------------------------------------------ */
        .add-widget-box { 
            background: var(--highlight); 
            padding: 25px; 
            border-radius: 8px; 
            border: 1px solid var(--accent); 
            transition: all 0.3s; 
            margin-bottom: 30px; 
        }

        .add-widget-box.editing { 
            border: 3px solid #ff9800; 
            background: rgba(255, 152, 0, 0.15); 
        }

        .flex-row { 
            display: flex; 
            gap: 20px; 
            flex-wrap: wrap; 
            align-items: flex-end; 
            margin-bottom: 15px; 
        }

        .flex-col { 
            flex: 1; 
            min-width: 160px; 
        }
        
        label { 
            display: block; 
            font-weight: bold; 
            font-size: 0.9em; 
            margin-bottom: 8px; 
            color: var(--text-main); 
        }

        input, select, textarea { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid var(--border); 
            background: var(--bg-input); 
            color: var(--text-main); 
            border-radius: 4px; 
            box-sizing: border-box; 
            font-size: 14px; 
        }
        
        /* WYSZUKIWARKA ENCJI - WYR√ì≈ªNIENIE */
        #w-id { 
            border: 2px solid var(--accent); 
            background-color: var(--bg-input); 
            font-weight: bold; 
        }
        
        /* LICZNIK ZNAK√ìW */
        .char-counter {
            font-size: 11px;
            text-align: right;
            margin-top: 4px;
            color: #666;
            font-weight: bold;
        }
        .char-counter.limit {
            color: red;
        }

        /* PRZYCISKI AKCJI */
        .btn { 
            padding: 12px 24px; 
            border: none; 
            cursor: pointer; 
            border-radius: 4px; 
            font-weight: bold; 
            text-transform: uppercase; 
            color: var(--btn-text); 
            font-size: 14px; 
            transition: opacity 0.2s, transform 0.1s; 
        }
        .btn:hover { 
            opacity: 0.9; 
            transform: translateY(-1px); 
        }
        .btn:active {
            transform: translateY(0);
        }

        .btn-add { background: #4caf50; width: 100%; }
        .btn-gen { background: var(--accent); width: 100%; font-size: 20px; padding: 15px; margin-top: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-cancel { background: #757575; }
        .btn-row { background: #2196f3; margin-top: 15px; }
        .btn-import { background: #ff9800; color: white; width: auto; margin-top: 10px; }
        .btn-dash-save { background: #009688; color: white; width: auto; padding: 8px 15px; font-size: 13px; margin-left: 10px;}

        /* ------------------------------------------------------------------ */
        /* PODGLƒÑD E-INK (PIXEL PERFECT JOAN 6 STYLE) */
        /* ------------------------------------------------------------------ */
        .preview-area { 
            background: var(--preview-bg); 
            padding: 30px; 
            border: 2px solid var(--border); 
            border-radius: 8px; 
            overflow-x: auto; 
            min-height: 400px; 
        }
        
        /* Wiersz - Bardzo wysoki, ≈ºeby przyciski mia≈Çy oddech */
        .eink-row { 
            display: flex; 
            gap: 8px; /* Margines z Joan.txt */
            margin-bottom: 15px; 
            padding: 15px; 
            border: 2px dashed #999; 
            border-radius: 6px; 
            min-height: 180px; /* Zwiƒôkszona wysoko≈õƒá */
            align-items: flex-end; /* Wyr√≥wnaj do do≈Çu */
            position: relative; 
        }
        
        .row-label { 
            position: absolute; 
            top: -10px; 
            left: 10px; 
            font-size: 11px; 
            background: var(--bg-body); 
            padding: 2px 8px; 
            color: var(--text-main); 
            border: 1px solid var(--border); 
            border-radius: 4px; 
            font-weight: bold; 
        }
        
        /* Wrapper dla etykiety nad przyciskiem */
        .widget-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 0;
            position: relative;
            flex-shrink: 0;
        }
        
        /* Etykieta Typu (SWITCH, SENSOR) - NAD Przyciskiem */
        .ew-type-label {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--text-main);
            margin-bottom: 4px;
            font-weight: bold;
            letter-spacing: 1px;
            opacity: 0.7;
            text-align: center;
            width: 100%;
        }

        /* G≈Å√ìWNY KAFELEK (WYGLƒÑD E-INK) */
        .eink-widget {
            background: #FFFFFF; 
            border: 3px solid #000000; 
            color: #000000;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: space-between; /* RozciƒÖgnij tre≈õƒá g√≥ra-d√≥≈Ç */
            padding: 8px; 
            box-sizing: border-box; 
            cursor: pointer; 
            position: relative;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.25); 
            transition: transform 0.1s; 
            flex-shrink: 0; 
            overflow: hidden;
        }

        .eink-widget:hover { 
            transform: translateY(-3px); 
            z-index: 10; 
            border-color: var(--accent); 
        }

        .eink-widget.editing { 
            border: 3px dashed #ff9800; 
            transform: scale(1.03); 
            z-index: 20; 
        }

        /* Tytu≈Ç - Mniejszy aby nie zas≈Çania≈Ç */
        .ew-title { 
            font-weight: 900; 
            font-size: 12px; /* Ma≈Ça czcionka */
            text-align: center; 
            width: 100%; 
            line-height: 1.2; 
            margin-top: 8px; 
            margin-bottom: 2px; 
            white-space: normal; 
            font-family: 'Roboto', 'Arial Black', sans-serif; 
            text-transform: uppercase;
            pointer-events: none;
        }
        
        /* Ikona - Zmniejszona, aby zrobiƒá miejsce */
        .ew-icon { 
            font-size: 38px; /* Zmniejszona z 50px */
            display: block; 
            margin: 2px 0; 
            pointer-events: none;
        }
        
        /* STAN (WARTO≈öƒÜ) - Na dole, wyra≈∫ny */
        .ew-value { 
            font-weight: 900; 
            font-size: 15px; 
            text-transform: uppercase; 
            margin-bottom: 5px; 
            text-align: center; 
            border-top: 2px solid #000; 
            width: 90%; 
            padding-top: 3px;
            margin-top: auto; /* Dopycha do do≈Çu */
            pointer-events: none;
        }
        
        /* Przycisk usuwania */
        .ew-del { 
            position: absolute; 
            top: -8px; 
            right: -8px; 
            background: red; 
            color: white; 
            width: 20px; 
            height: 20px; 
            border-radius: 50%; 
            text-align: center; 
            line-height: 20px; 
            font-weight: bold; 
            display: none; 
            box-shadow: 1px 1px 3px rgba(0,0,0,0.5); 
            z-index: 30; 
        }
        .eink-widget:hover .ew-del { display: block; }

        /* PodglƒÖd ikony w formularzu */
        .icon-preview { 
            font-size: 32px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            width: 48px; 
            height: 48px; 
            border: 1px solid var(--border); 
            border-radius: 4px; 
            background: var(--bg-input); 
        }
        
        .hidden { display: none !important; }
        
        textarea.output { 
            width: 100%; 
            height: 500px; 
            font-family: 'Consolas', 'Monaco', monospace; 
            background: #263238; 
            color: #eceff1; 
            border: none; 
            padding: 20px; 
            border-radius: 8px; 
            font-size: 14px; 
            line-height: 1.5; 
        }
        
        /* CUSTOM GRID INPUTS */
        #custom-grid-inputs { display: none; gap: 10px; margin-top: 10px; align-items: center; border-top: 1px dashed var(--border); padding-top: 10px; }
        .custom-num-input { width: 80px !important; }
        
        /* DASHBOARD MANAGER LIST */
        .dash-list { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 10px; }
        .dash-item { 
            background: var(--bg-input); border: 1px solid var(--border); 
            padding: 10px 15px; 
            border-radius: 6px; cursor: pointer; 
            font-size: 14px; 
            display: flex; align-items: center; gap: 10px; 
            transition: all 0.2s; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .dash-item:hover { background: var(--highlight); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .dash-item.active { background: #4caf50; color: white; border-color: #388e3c; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .dash-item span { font-weight: bold; }
        .dash-item button { 
            font-size: 11px; padding: 4px 8px; margin-left: 10px; 
            background: #d32f2f; color: white; border: none; 
            border-radius: 4px; cursor: pointer; opacity: 0.8; 
        }
        .dash-item.active button { background: white; color: #d32f2f; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-row">
            <h1>Joan 6 E-Ink Generator (THE BEHEMOTH)</h1>
            <div class="controls">
                <button type="button" onclick="toggleTheme()" id="btn-theme">üåô</button>
                <button type="button" onclick="setLang('pl')" id="btn-pl" class="active">PL</button>
                <button type="button" onclick="setLang('en')" id="btn-en">EN</button>
            </div>
        </div>

        <!-- 1. USTAWIENIA SIATKI (SMART GRID + CUSTOM) -->
        <div class="section">
            <div class="section-title">1. Ustawienia Dashboardu</div>
            <div class="flex-row">
                <div class="flex-col">
                    <label>Tytu≈Ç Dashboardu</label>
                    <input type="text" id="dash-title" oninput="syncTitle()" value="JoanDashboard">
                </div>
                <div class="flex-col">
                    <label>Uk≈Çad Siatki (Smart Grid)</label>
                    <select id="grid-preset" onchange="handleGridChange(this)">
                        <option value="6x8" selected>Standard+ (3 kolumny / 8 wierszy) - DOMY≈öLNY</option>
                        <option value="6x6">Standard (3 kolumny / 6 wierszy)</option>
                        <option value="4x4">Du≈ºy (2 kolumny / 4 wiersze)</option>
                        <option value="4x6">≈öredni (2 kolumny / 6 wierszy)</option>
                        <option value="6x9">Ma≈Çy (3 kolumny / 9 wierszy)</option>
                        <option value="custom">-- Uk≈Çad W≈Çasny (Custom) --</option>
                    </select>
                    
                    <!-- POLA DLA UK≈ÅADU W≈ÅASNEGO -->
                    <div id="custom-grid-inputs" class="flex-row">
                        <div>
                            <label style="font-size:10px">Kolumny:</label>
                            <input type="number" id="custom-cols" class="custom-num-input" value="6" min="1" max="20" onchange="updateCustomGrid()">
                        </div>
                        <div>
                            <label style="font-size:10px">Wiersze:</label>
                            <input type="number" id="custom-rows" class="custom-num-input" value="8" min="1" max="20" onchange="updateCustomGrid()">
                        </div>
                    </div>
                </div>
                <input type="hidden" id="h-cols" value="6">
                <input type="hidden" id="h-rows" value="8">
            </div>
        </div>

        <!-- 2. IMPORT -->
        <div class="section" id="import-section">
            <details>
                <summary style="cursor: pointer; font-weight: bold; font-size: 1.1em;">üìÇ Import / Eksport Kodu .DASH</summary>
                <div style="margin-top: 15px;">
                    <textarea id="import-code" style="height: 150px;" placeholder="Wklej tutaj zawarto≈õƒá pliku .dash..."></textarea>
                    <button type="button" class="btn btn-import" onclick="importYaml()">Wczytaj Kod</button>
                </div>
            </details>
        </div>

        <form method="POST" id="main-form">
            <input type="hidden" name="title" id="form-title" value="JoanDashboard">
            <input type="hidden" name="ui_language" id="input-lang" value="pl">
            <input type="hidden" name="grid_columns" id="form-cols" value="6">
            <input type="hidden" name="grid_rows" id="form-rows" value="8">
            
            <input type="hidden" name="layout_data_json" id="layout_json">
            <input type="hidden" name="custom_definitions_json" id="custom_defs_input">
            
            <!-- 3. EDYTOR WIDGETU -->
            <div class="add-widget-box" id="editor-box">
                <div class="section-title" id="editor-title" data-i18n="sec_add">2. Dodaj Widget</div>
                
                <div class="flex-row">
                    <div class="flex-col">
                        <label data-i18n="lbl_type">Typ Widgetu</label>
                        <select id="w-type" onchange="toggleInputs()">
                            <option value="switch" data-i18n="opt_switch">Switch / Light</option>
                            <option value="cover" data-i18n="opt_cover">Cover / Gate</option>
                            <option value="sensor" data-i18n="opt_sensor">Sensor</option>
                            <option value="binary_sensor" data-i18n="opt_binary">Binary Sensor</option>
                            <option value="lock" data-i18n="opt_lock">Lock</option>
                            <option value="person" data-i18n="opt_person">Person / Tracker</option>
                            <option value="media_player" data-i18n="opt_media">Media Player</option>
                            <option value="climate" data-i18n="opt_climate">Climate</option>
                            <option value="input_select" data-i18n="opt_input_select">Input Select</option>
                            <option value="input_number" data-i18n="opt_input_number">Input Number</option>
                            <option value="script" data-i18n="opt_script">Script</option>
                            <option value="navigate" data-i18n="opt_navigate">Navigate / Button</option>
                            <option value="label" data-i18n="opt_label">Label (Text)</option>
                            <option value="clock" data-i18n="opt_clock">Clock</option>
                            <option value="spacer" data-i18n="opt_spacer">Spacer (Empty)</option>
                        </select>
                    </div>
                    <div class="flex-col" id="grp-entity">
                        <label data-i18n="lbl_entity">Encja (Wyszukaj po nazwie lub ID)</label>
                        <input list="entity-list" id="w-id" placeholder="np. g≈Ço≈õnik kuchnia..." oninput="searchEntities(this.value)" autocomplete="off">
                        <datalist id="entity-list"></datalist>
                    </div>
                    <div class="flex-col hidden" id="grp-nav">
                        <label data-i18n="lbl_dash">Nazwa Dashboardu</label>
                        <input type="text" id="w-dash" placeholder="np. main" oninput="autoNameNav()">
                    </div>
                    <div class="flex-col">
                        <label data-i18n="lbl_name">Tytu≈Ç na ekranie</label>
                        <input type="text" id="w-name" placeholder="np. Salon" oninput="checkTitleLimit()">
                        <div id="char-count" class="char-counter">0/20</div>
                    </div>
                </div>

                <div class="flex-row">
                    <div class="flex-col">
                        <label data-i18n="lbl_size">Rozmiar</label>
                        <select id="w-size" onchange="updateTitleLimit()">
                            <option value="(2x1)" data-i18n="size_2x1">2x1 (Szeroki Przycisk)</option>
                            <option value="(1x1)" data-i18n="size_1x1">1x1 (Ma≈Çy)</option>
                            <option value="(2x2)" data-i18n="size_2x2">2x2 (Du≈ºy)</option>
                            <option value="(3x1)" data-i18n="size_3x1">3x1 (Szeroki)</option>
                            <option value="(1x2)" data-i18n="size_1x2">1x2 (Wysoki)</option>
                            <option value="(3x2)" data-i18n="size_3x2">3x2 (Ogromny)</option>
                        </select>
                    </div>
                    <div class="flex-col" style="flex: 0 0 60px;">
                        <label data-i18n="lbl_preview">Ikona</label>
                        <div style="display:flex; justify-content:center;">
                            <i id="preview-icon" class="mdi mdi-help-circle-outline icon-preview"></i>
                        </div>
                    </div>
                    <div class="flex-col">
                        <label data-i18n="lbl_icon">Ikona</label>
                        <input type="text" id="w-icon" oninput="updateIconPreview()" placeholder="mdi-home">
                    </div>
                    <div class="flex-col">
                        <label>Ikona ON</label>
                        <input type="text" id="w-icon-on" oninput="updateIconPreview()" placeholder="mdi-lightbulb-on">
                    </div>
                    <div class="flex-col">
                        <label>Ikona OFF</label>
                        <input type="text" id="w-icon-off" oninput="updateIconPreview()" placeholder="mdi-lightbulb-outline">
                    </div>
                </div>

                <div class="flex-row" style="margin-top: 20px;">
                    <button type="button" class="btn btn-add" id="btn-submit" onclick="saveWidget()" data-i18n="btn_add">+ DODAJ WIDGET</button>
                    <button type="button" class="btn btn-cancel hidden" id="btn-cancel" onclick="cancelEdit()" data-i18n="btn_cancel">ANULUJ</button>
                </div>
            </div>

            <!-- 4. PODGLƒÑD E-INK -->
            <div class="section">
                <div class="section-title" data-i18n="sec_preview">3. PodglƒÖd Dashboardu (Kliknij by edytowaƒá)</div>
                <div class="preview-area" id="preview-container"></div>
                <button type="button" class="btn btn-row" onclick="addRow()" data-i18n="btn_row">+ Dodaj Wiersz</button>
            </div>
            
            <!-- MENAD≈ªER DASHBOARD√ìW -->
            <div class="section" style="background:#f0f4c3;">
                <div class="section-title" style="border-bottom-color:#afb42b;">Zapisane Dashboardy (PrzeglƒÖdarka)</div>
                <p style="font-size:12px;">Zapisz swoje uk≈Çady lokalnie, aby ≈Çatwo siƒô prze≈ÇƒÖczaƒá. Kliknij na nazwƒô, aby wczytaƒá.</p>
                <div class="flex-row" style="align-items: center;">
                    <input type="text" id="save-name" placeholder="Nazwa zapisu (np. Kuchnia)" style="width:200px;">
                    <button type="button" class="btn btn-dash-save" onclick="saveToBrowser()">ZAPISZ</button>
                </div>
                <div id="saved-dash-list" class="dash-list"></div>
            </div>

            <button type="button" class="btn btn-gen" onclick="submitData()" data-i18n="btn_gen">GENERUJ KOD .DASH</button>
        </form>

        <!-- 5. WYNIK YAML -->
        {% if generated_yaml %}
        <div class="section" style="margin-top:30px;">
            <div class="section-title">Wynikowy Kod YAML</div>
            <div class="file-path-info">
                <div class="file-info-block">
                    <strong>1. Zapisz kod w pliku:</strong>
                    <code id="path-code">\\IP_HA\addon_configs\appdaemon\dashboards\{{ filename }}</code>
                </div>
                <div class="file-info-block">
                    <strong>2. Uruchom ponownie AppDaemon i sprawd≈∫ dashboard:</strong>
                    <a href="http://[HOST]:5050/{{ dash_name }}" id="dashboard-link" target="_blank">http://[HOST]:5050/{{ dash_name }}</a>
                </div>
            </div>
            <textarea class="output" readonly>{{ generated_yaml }}</textarea>
        </div>
        {% endif %}
    </div>

    <!-- ------------------------------------------------------------------ -->
    <!-- LOGIKA JAVASCRIPT -->
    <!-- ------------------------------------------------------------------ -->
    <script>
        // --- DANE I ZMIENNE ---
        const entitiesData = {{ entities | tojson | safe }};
        let rows = [[]]; 
        let editIdx = null; 
        let blockSmart = false; 
        let currentLang = 'pl';
        let importedDefsMap = {}; 
        let previousGridState = "6x8";
        let currentLoadedDashName = null;

        const TRANSLATIONS = {
            pl: {
                sec_add: "2. Dodaj Widget", sec_edit: "2. Edytuj Widget", sec_preview: "3. PodglƒÖd Dashboardu",
                lbl_type: "Typ Widgetu", lbl_entity: "Encja (Wpisz nazwƒô lub ID)", lbl_name: "Tytu≈Ç na ekranie", lbl_size: "Rozmiar", 
                lbl_icon: "Ikona", lbl_dash: "Nazwa Dashboardu", lbl_preview: "PodglƒÖd",
                btn_add: "+ DODAJ WIDGET", btn_update: "ZAPISZ ZMIANY", btn_cancel: "ANULUJ", 
                btn_row: "+ Dodaj Wiersz", btn_gen: "GENERUJ KOD .DASH",
                opt_switch: "Prze≈ÇƒÖcznik / ≈öwiat≈Ço", opt_cover: "Roleta / Brama", opt_sensor: "Sensor (Info)",
                opt_binary: "Sensor Binarny (On/Off)", opt_lock: "Zamek", opt_person: "Osoba / Tracker",
                opt_media: "Media Player", opt_climate: "Termostat", opt_input_select: "Lista Wyboru",
                opt_input_number: "Suwak", opt_script: "Skrypt", opt_navigate: "Przycisk Nawigacji",
                opt_label: "Etykieta (Tekst)", opt_clock: "Zegar", opt_spacer: "Odstƒôp (Pusty)",
                size_1x1: "1x1 (Ma≈Çy)", size_2x1: "2x1 (Szeroki)", size_2x2: "2x2 (Du≈ºy)",
                size_3x1: "3x1 (Bardzo Szeroki)", size_1x2: "1x2 (Wysoki)", size_3x2: "3x2 (Ogromny)",
                limit_15: "Maks 15 znak√≥w", limit_20: "Maks 20 znak√≥w",
                warning_grid_rows: "UWAGA: Nowy uk≈Çad ma mniej wierszy ({0}) ni≈º aktualnie u≈ºywasz ({1}). Nadmiarowe wiersze zostanƒÖ USUNIƒòTE. Kontynuowaƒá?"
            },
            en: {
                sec_add: "2. Add Widget", sec_edit: "2. Edit Widget", sec_preview: "3. Dashboard Preview",
                lbl_type: "Widget Type", lbl_entity: "Entity", lbl_name: "Title", lbl_size: "Size", 
                lbl_icon: "Icon", lbl_dash: "Dashboard Name", lbl_preview: "Icon",
                btn_add: "+ ADD WIDGET", btn_update: "SAVE CHANGES", btn_cancel: "CANCEL", 
                btn_row: "+ Add Row", btn_gen: "GENERATE .DASH CODE",
                opt_switch: "Switch / Light", opt_cover: "Cover / Gate", opt_sensor: "Sensor", 
                opt_binary: "Binary Sensor", opt_lock: "Lock", opt_person: "Person",
                opt_media: "Media Player", opt_climate: "Climate", opt_input_select: "Input Select",
                opt_input_number: "Input Number", opt_script: "Script", opt_navigate: "Navigation",
                opt_label: "Label", opt_clock: "Clock", opt_spacer: "Spacer",
                size_1x1: "1x1 (Small)", size_2x1: "2x1 (Wide)", size_2x2: "2x2 (Large)",
                size_3x1: "3x1 (X-Wide)", size_1x2: "1x2 (Tall)", size_3x2: "3x2 (Huge)",
                limit_15: "Max 15 chars", limit_20: "Max 20 chars",
                warning_grid_rows: "WARNING: The new layout has fewer rows ({0}) than currently used ({1}). Excess rows will be REMOVED. Continue?"
            }
        };

        const SMART_MAP = {
            'light': { type: 'switch', size: '(2x1)', iconOn: 'mdi-lightbulb-on', iconOff: 'mdi-lightbulb-outline' },
            'switch': { type: 'switch', size: '(2x1)', iconOn: 'mdi-toggle-switch', iconOff: 'mdi-toggle-switch-off' },
            'cover': { type: 'cover', size: '(2x1)', iconOn: 'mdi-window-shutter-open', iconOff: 'mdi-window-shutter' },
            'garage': { type: 'cover', size: '(2x1)', iconOn: 'mdi-garage-open', iconOff: 'mdi-garage' },
            'binary_sensor': { type: 'binary_sensor', size: '(1x1)', iconOn: 'mdi-checkbox-marked-circle', iconOff: 'mdi-checkbox-blank-circle-outline' },
            'sensor': { type: 'sensor', size: '(1x1)', icon: 'mdi-eye' },
            'media_player': { type: 'media_player', size: '(2x2)', icon: '' },
            'climate': { type: 'climate', size: '(2x2)', icon: '' },
            'lock': { type: 'lock', size: '(2x1)', iconOn: 'mdi-lock-open', iconOff: 'mdi-lock' },
            'script': { type: 'script', size: '(2x1)', icon: 'mdi-script-text-outline' }
        };

        // --- HELPERY ---
        function normalizeString(str) {
            return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
        }

        function searchEntities(val) {
            runSmartLogic(val);
            const dl = document.getElementById('entity-list');
            dl.innerHTML = '';
            if(!val || val.length < 2) return;
            const terms = normalizeString(val).split(" ").filter(t => t);
            let count = 0;
            for(const e of entitiesData) {
                if(count > 50) break;
                const searchStr = normalizeString(e.id + " " + (e.attributes.friendly_name || ""));
                const match = terms.every(term => searchStr.includes(term));
                if(match) {
                    const opt = document.createElement('option');
                    opt.value = e.id;
                    opt.label = e.attributes.friendly_name ? `${e.attributes.friendly_name} (${e.id})` : e.id;
                    opt.setAttribute('data-dclass', e.attributes.device_class || '');
                    opt.setAttribute('data-friendly', e.attributes.friendly_name || '');
                    dl.appendChild(opt);
                    count++;
                }
            }
        }

        function resolveImportedTitle(id) {
            if (!importedDefsMap) return '';
            if (importedDefsMap[id] && importedDefsMap[id].title) return importedDefsMap[id].title;
            const shortId = id.includes('.') ? id.split('.')[1] : id;
            if (importedDefsMap[shortId] && importedDefsMap[shortId].title) return importedDefsMap[shortId].title;
            return '';
        }

        function getEntityMeta(id) {
            return entitiesData.find(e => e.id === id) || { attributes: {} };
        }

        function formatSmartName(id, friendlyName) {
            if (friendlyName && friendlyName.length > 2) return friendlyName;
            if(!id) return "";
            if(id.startsWith('navigate.')) return id.replace('navigate.','').toUpperCase();
            let name = id.split('.').pop();
            name = name.replace(/_[lvr]\d+$/i, '').replace(/_state$/i, '').replace(/_/g, ' ');
            return name.replace(/\b\w/g, l => l.toUpperCase());
        }

        function updateIconPreview() {
            const i1 = document.getElementById('w-icon').value;
            const i2 = document.getElementById('w-icon-on').value;
            const i3 = document.getElementById('w-icon-off').value;
            const final = i1 || i2 || i3 || 'mdi-help-circle-outline';
            document.getElementById('preview-icon').className = `mdi ${final} icon-preview`;
        }

        function toggleInputs() {
            const type = document.getElementById('w-type').value;
            const isNav = type === 'navigate';
            const isSpacer = type === 'spacer';
            document.getElementById('grp-entity').style.display = (isNav || isSpacer) ? 'none' : 'block';
            document.getElementById('grp-nav').style.display = isNav ? 'block' : 'none';
            document.getElementById('grp-nav').classList.toggle('hidden', !isNav);
        }

        function updateTitleLimit() {
            const size = document.getElementById('w-size').value;
            const input = document.getElementById('w-name');
            const counter = document.getElementById('char-count');
            let max = 20;
            if(size === '(1x1)' || size === '(1x2)') max = 15;
            input.maxLength = max;
            const current = input.value.length;
            const txt = max === 15 ? (currentLang==='pl'?"Maks 15":"Max 15") : (currentLang==='pl'?"Maks 20":"Max 20");
            counter.innerText = `${current}/${max} (${txt})`;
            if(current >= max) counter.classList.add('limit'); else counter.classList.remove('limit');
        }
        
        function checkTitleLimit() { updateTitleLimit(); }

        function runSmartLogic(val) {
            if (blockSmart) return;
            const id = val.toLowerCase();
            const idNorm = normalizeString(id);
            if (id.length < 3) return;

            const ent = getEntityMeta(id);
            const dClass = (ent.attributes.device_class || '').toLowerCase();
            const fName = ent.attributes.friendly_name || '';
            const fNameNorm = normalizeString(fName);
            const domain = id.split('.')[0];

            let conf = SMART_MAP[domain] || { type: 'sensor', size: '(1x1)', icon: 'mdi-eye' };

            const check = (keywords) => keywords.some(k => idNorm.includes(k) || fNameNorm.includes(k));

            if (check(['glosnik', 'speaker', 'audio', 'tv', 'odtwarzacz'])) conf = SMART_MAP['media_player'];
            else if (check(['swiatlo', 'lamp', 'kinkiet', 'led', 'zarowka'])) conf = SMART_MAP['light'];
            else if (check(['gniazdko', 'wtyczka', 'outlet', 'plug'])) conf = SMART_MAP['switch'];
            else if (check(['brama', 'garaz', 'gate'])) conf = { type: 'cover', size: '(2x1)', iconOn: 'mdi-garage-open', iconOff: 'mdi-garage' };
            else if (check(['rolet', 'blind', 'shutter', 'zaslon'])) conf = SMART_MAP['cover'];
            else if (check(['zamek', 'lock', 'rygiel'])) conf = SMART_MAP['lock'];
            else if (check(['drzwi', 'door', 'furtka', 'okno', 'window'])) {
                conf = { type: 'binary_sensor', size: '(1x1)', iconOn: 'mdi-door-open', iconOff: 'mdi-door-closed' };
                if (check(['okno', 'window'])) { conf.iconOn = 'mdi-window-open-variant'; conf.iconOff = 'mdi-window-closed-variant'; }
            } else if (check(['temp', 'therm'])) conf = { type: 'sensor', size: '(1x1)', icon: 'mdi-thermometer' };
            else if (check(['wilg', 'humid'])) conf = { type: 'sensor', size: '(1x1)', icon: 'mdi-water-percent' };
            else if (check(['script', 'skrypt', 'radio'])) conf = SMART_MAP['script'];

            if (dClass === 'garage') conf = { type: 'cover', size: '(2x1)', iconOn: 'mdi-garage-open', iconOff: 'mdi-garage' };
            if (dClass === 'door') conf = { type: 'binary_sensor', size: '(1x1)', iconOn: 'mdi-door-open', iconOff: 'mdi-door-closed' };
            if (dClass === 'battery') conf = { type: 'sensor', size: '(1x1)', icon: 'mdi-battery' };
            if (dClass === 'temperature') conf = { type: 'sensor', size: '(1x1)', icon: 'mdi-thermometer' };
            if (domain === 'input_boolean') conf = SMART_MAP['switch'];
            if (domain === 'script') conf = SMART_MAP['script'];

            // SMART GRID: Wymu≈õ 2x1 dla uk≈Çad√≥w Standard/Standard+
            const currentGrid = document.getElementById('grid-preset').value;
            if ((currentGrid === '6x8' || currentGrid === '6x6' || currentGrid === 'custom') && conf.size === '(1x1)' && conf.type !== 'binary_sensor') {
                conf.size = '(2x1)';
            }

            document.getElementById('w-type').value = conf.type;
            document.getElementById('w-size').value = conf.size;
            const nameField = document.getElementById('w-name');
            nameField.value = formatSmartName(id, fName);
            document.getElementById('w-icon').value = conf.icon || '';
            document.getElementById('w-icon-on').value = conf.iconOn || '';
            document.getElementById('w-icon-off').value = conf.iconOff || '';

            toggleInputs();
            updateIconPreview();
            updateTitleLimit();
        }

        // --- MANAGER DASHBOARD√ìW (Browser Storage) ---
        function saveToBrowser() {
            const name = document.getElementById('save-name').value.trim();
            if(!name) { alert("Podaj nazwƒô!"); return; }
            
            const data = {
                rows: rows,
                title: document.getElementById('dash-title').value,
                grid: document.getElementById('grid-preset').value,
                defs: importedDefsMap
            };
            
            localStorage.setItem('joan_dash_' + name, JSON.stringify(data));
            currentLoadedDashName = name;
            refreshSavedList();
            alert("Zapisano dashboard: " + name);
        }

        function loadFromBrowser(name) {
            if(!confirm("Niezapisane zmiany zostanƒÖ utracone. Wczytaƒá " + name + "?")) return;
            const raw = localStorage.getItem('joan_dash_' + name);
            if(!raw) return;
            
            try {
                const data = JSON.parse(raw);
                rows = data.rows;
                importedDefsMap = data.defs || {};
                document.getElementById('dash-title').value = data.title;
                document.getElementById('grid-preset').value = data.grid;
                
                currentLoadedDashName = name;
                refreshSavedList();
                
                syncTitle();
                
                // Sprawd≈∫ czy to Custom
                if (data.grid === 'custom') {
                    // Spr√≥buj zgadnƒÖƒá z rows
                    // Tutaj uproszczenie - zostawiamy 6x8 w polach custom
                    document.getElementById('custom-grid-inputs').style.display = 'flex';
                } else {
                    document.getElementById('custom-grid-inputs').style.display = 'none';
                }
                
                applyGrid();
                renderPreview();
            } catch(e) { console.error(e); alert("B≈ÇƒÖd odczytu danych."); }
        }

        function deleteFromBrowser(name, e) {
            e.stopPropagation();
            if(confirm("UsunƒÖƒá dashboard " + name + "?")) {
                localStorage.removeItem('joan_dash_' + name);
                if(currentLoadedDashName === name) currentLoadedDashName = null;
                refreshSavedList();
            }
        }

        function refreshSavedList() {
            const list = document.getElementById('saved-dash-list');
            list.innerHTML = '';
            
            Object.keys(localStorage).forEach(key => {
                if(key.startsWith('joan_dash_')) {
                    const name = key.replace('joan_dash_', '');
                    const div = document.createElement('div');
                    div.className = 'dash-item';
                    if(name === currentLoadedDashName) div.classList.add('active');
                    div.innerHTML = `<span>${name}</span> <button onclick="deleteFromBrowser('${name}', event)">X</button>`;
                    div.onclick = () => loadFromBrowser(name);
                    list.appendChild(div);
                }
            });
        }

        // --- SMART GRID PROTECTION ---
        function handleGridChange(selectObj) {
            const newVal = selectObj.value;
            
            if (newVal === 'custom') {
                document.getElementById('custom-grid-inputs').style.display = 'flex';
                updateCustomGrid();
                return;
            } else {
                document.getElementById('custom-grid-inputs').style.display = 'none';
            }

            let targetRows = 8;
            if(newVal === '6x6' || newVal === '4x6') targetRows = 6;
            if(newVal === '4x4') targetRows = 4;
            if(newVal === '6x9') targetRows = 9;

            const currentUsed = rows.length;
            if (currentUsed > targetRows) {
                const msg = TRANSLATIONS[currentLang].warning_grid_rows.replace('{0}', targetRows).replace('{1}', currentUsed);
                if (confirm(msg)) {
                    // FIZYCZNE USUWANIE NADMIARU
                    rows = rows.slice(0, targetRows);
                    renderPreview();
                } else {
                    selectObj.value = previousGridState;
                    if(previousGridState === 'custom') document.getElementById('custom-grid-inputs').style.display = 'flex';
                    return;
                }
            }
            
            previousGridState = newVal;
            applyGrid();
        }

        function updateCustomGrid() {
            const c = document.getElementById('custom-cols').value;
            const r = document.getElementById('custom-rows').value;
            document.getElementById('h-cols').value = c;
            document.getElementById('h-rows').value = r;
            document.getElementById('form-cols').value = c;
            document.getElementById('form-rows').value = r;
        }

        function applyGrid() {
            const val = document.getElementById('grid-preset').value;
            if(val === 'custom') { updateCustomGrid(); return; }
            const parts = val.split('x');
            document.getElementById('h-cols').value = parts[0];
            document.getElementById('h-rows').value = parts[1];
            document.getElementById('form-cols').value = parts[0];
            document.getElementById('form-rows').value = parts[1];
        }

        function syncTitle() { document.getElementById('form-title').value = document.getElementById('dash-title').value; }
        function autoNameNav() { if(blockSmart) return; document.getElementById('w-name').value = document.getElementById('w-dash').value.toUpperCase(); }

        function saveWidget() {
            const w = {
                type: document.getElementById('w-type').value,
                id: document.getElementById('w-id').value,
                dash: document.getElementById('w-dash').value,
                name: document.getElementById('w-name').value,
                size: document.getElementById('w-size').value,
                icon: document.getElementById('w-icon').value,
                icon_on: document.getElementById('w-icon-on').value,
                icon_off: document.getElementById('w-icon-off').value,
                was_edited: true
            };
            if(w.type === 'navigate') w.id = 'navigate.' + w.dash;
            if(w.type === 'spacer') w.id = 'spacer';

            if(editIdx) {
                rows[editIdx.r][editIdx.w] = w;
                cancelEdit();
            } else {
                rows[rows.length-1].push(w);
                clearForm();
                blockSmart = false;
            }
            renderPreview();
        }

        function editWidget(r, w) {
            blockSmart = true;
            editIdx = {r, w};
            const data = rows[r][w];
            document.getElementById('editor-box').classList.add('editing');
            document.getElementById('btn-cancel').classList.remove('hidden');
            const t = TRANSLATIONS[currentLang];
            document.getElementById('editor-title').innerText = t.sec_edit;
            document.getElementById('btn-submit').innerText = t.btn_update;

            document.getElementById('w-type').value = data.type;
            toggleInputs();

            if(data.type === 'navigate') document.getElementById('w-dash').value = data.id.replace('navigate.', '');
            else document.getElementById('w-id').value = data.id;

            document.getElementById('w-name').value = data.name;
            document.getElementById('w-size').value = data.size || '(2x1)';
            document.getElementById('w-icon').value = data.icon || '';
            document.getElementById('w-icon-on').value = data.icon_on || '';
            document.getElementById('w-icon-off').value = data.icon_off || '';
            updateIconPreview();
            updateTitleLimit();
            setTimeout(() => blockSmart = false, 500);
        }

        function cancelEdit() {
            editIdx = null;
            blockSmart = false;
            document.getElementById('editor-box').classList.remove('editing');
            document.getElementById('btn-cancel').classList.add('hidden');
            const t = TRANSLATIONS[currentLang];
            document.getElementById('editor-title').innerText = t.sec_add;
            document.getElementById('btn-submit').innerText = t.btn_add;
            clearForm();
        }

        function clearForm() {
            document.getElementById('w-id').value = '';
            document.getElementById('w-name').value = '';
            document.getElementById('w-icon').value = '';
            document.getElementById('w-icon-on').value = '';
            document.getElementById('w-icon-off').value = '';
            updateIconPreview();
            updateTitleLimit();
        }

        function deleteWidget(r, w, e) {
            e.stopPropagation();
            rows[r].splice(w, 1);
            if(editIdx && editIdx.r === r && editIdx.w === w) cancelEdit();
            renderPreview();
        }

        function addRow() {
            // Ochrona przed dodawaniem za du≈ºo wierszy
            let maxRows = 8;
            const gridVal = document.getElementById('grid-preset').value;
            
            if (gridVal === 'custom') {
                maxRows = parseInt(document.getElementById('custom-rows').value) || 20;
            } else {
                maxRows = parseInt(gridVal.split('x')[1]);
            }
            
            if (rows.length >= maxRows) {
                alert("Limit wierszy dla tego uk≈Çadu to: " + maxRows);
                return;
            }
            
            rows.push([]);
            renderPreview();
        }

        function getRealState(w) {
            const isPL = currentLang === 'pl';
            const id = (w.id || '');
            const ent = entitiesData.find(e => e.id === id);
            if (!ent) return "---";
            const val = String(ent.state);
            const unit = ent.unit || "";

            if (val === 'on') return isPL ? "W≈ÅƒÑCZONE" : "ON";
            if (val === 'off') return isPL ? "WY≈ÅƒÑCZONE" : "OFF";
            if (val === 'open') return isPL ? "OTWARTE" : "OPEN";
            if (val === 'closed') return isPL ? "ZAMKNIƒòTE" : "CLOSED";
            if (val === 'locked') return isPL ? "ZAMKNIƒòTE" : "LOCKED";
            if (val === 'unlocked') return isPL ? "OTWARTE" : "UNLOCKED";
            
            if (!isNaN(parseFloat(val)) && val.includes('.')) {
                return parseFloat(val).toFixed(1) + " " + unit;
            }
            return val + " " + unit;
        }

        function renderPreview() {
            const container = document.getElementById('preview-container');
            container.innerHTML = '';
            rows.forEach((row, rI) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'eink-row';
                const label = document.createElement('div');
                label.className = 'row-label';
                label.innerText = (currentLang === 'pl' ? 'WIERSZ ' : 'ROW ') + (rI + 1);
                rowDiv.appendChild(label);

                row.forEach((w, wI) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'widget-wrapper';

                    const typeLabel = document.createElement('div');
                    typeLabel.className = 'ew-type-label';
                    typeLabel.innerText = w.type;
                    wrapper.appendChild(typeLabel);

                    const div = document.createElement('div');
                    div.className = 'eink-widget';
                    if(editIdx && editIdx.r === rI && editIdx.w === wI) div.classList.add('editing');

                    let cols = 2, rw = 1;
                    if(w.size) {
                        const parts = w.size.replace(/[()]/g, '').split('x');
                        cols = parseInt(parts[0]) || 1;
                        rw = parseInt(parts[1]) || 1;
                    }
                    const width = (cols * 117) + ((cols - 1) * 8);
                    const height = (rw * 117) + ((rw - 1) * 8);
                    div.style.width = width + 'px';
                    div.style.height = height + 'px';

                    if(w.type === 'spacer') {
                        div.style.border = '1px dashed #aaa';
                        div.style.boxShadow = 'none';
                        div.style.opacity = '0.5';
                        div.innerHTML = '<span style="font-size:10px; color:#999;">SPACER</span>';
                    } else {
                        const icon = w.icon || w.icon_on || 'mdi-cube-outline';
                        const realState = getRealState(w);
                        div.innerHTML = `
                            <div class="ew-title">${w.name || w.id}</div>
                            <i class="mdi ${icon} ew-icon"></i>
                            <div class="ew-value">${realState}</div>
                            <div class="ew-del" onclick="deleteWidget(${rI}, ${wI}, event)">X</div>
                        `;
                    }
                    div.onclick = () => editWidget(rI, wI);
                    wrapper.appendChild(div);
                    rowDiv.appendChild(wrapper);
                });
                container.appendChild(rowDiv);
            });
        }

        function submitData() {
            document.getElementById('layout_json').value = JSON.stringify(rows);
            document.getElementById('custom_defs_input').value = JSON.stringify(importedDefsMap);
            document.getElementById('main-form').submit();
        }

        function importYaml() {
            const text = document.getElementById('import-code').value;
            if(!text) return;
            blockSmart = true;
            const lines = text.split('\n');
            const newRows = [];
            let inLayout = false;
            let rawDefs = {};
            let currentDefKey = null;

            let foundCols = 6;
            let foundRows = 8;

            lines.forEach(line => {
                const tr = line.trim();
                if(tr.startsWith('columns:')) foundCols = parseInt(tr.split(':')[1]);
                if(tr.startsWith('rows:')) foundRows = parseInt(tr.split(':')[1]);

                if(!tr || tr.startsWith('#')) return;
                if (line.match(/^\S+:/) && !line.startsWith('layout:') && !line.startsWith('global_parameters:')) {
                    currentDefKey = line.split(':')[0].trim();
                    rawDefs[currentDefKey] = {};
                } else if (currentDefKey && (line.startsWith('  ') || line.startsWith('\t'))) {
                    const parts = tr.split(':');
                    if(parts.length >= 2) {
                        const key = parts[0].trim();
                        let val = parts.slice(1).join(':').trim().replace(/['"]/g, '');
                        rawDefs[currentDefKey][key] = val;
                    }
                } else if (!line.startsWith('  ') && !line.startsWith('\t')) {
                    currentDefKey = null;
                }
            });
            
            // Automatyczne ustawienie siatki
            const presetVal = `${foundCols}x${foundRows}`;
            const sel = document.getElementById('grid-preset');
            let matched = false;
            for(let i=0; i<sel.options.length; i++) {
                if(sel.options[i].value === presetVal) { sel.value = presetVal; matched = true; break; }
            }
            if(!matched) {
                sel.value = 'custom';
                document.getElementById('custom-grid-inputs').style.display = 'flex';
                document.getElementById('custom-cols').value = foundCols;
                document.getElementById('custom-rows').value = foundRows;
            }
            previousGridState = sel.value;
            applyGrid();

            importedDefsMap = rawDefs;

            lines.forEach(line => {
                const tr = line.trim();
                if(tr.startsWith('layout:')) { inLayout = true; return; }
                if(inLayout && tr.startsWith('-')) {
                    const content = tr.substring(1).trim();
                    const widgets = content.split(',').map(s => s.trim());
                    const rowData = [];
                    widgets.forEach(wStr => {
                        let id = wStr;
                        let size = '(2x1)'; 
                        const sizeMatch = wStr.match(/\(\d+x\d+\)/);
                        if(sizeMatch) {
                            size = sizeMatch[0];
                            id = wStr.replace(size, '').trim();
                        }
                        let type = 'switch';
                        let name = id;
                        let icon = '';
                        let icon_on = '';
                        let icon_off = '';
                        const def = rawDefs[id];
                        if(def) {
                            if(def.widget_type) type = def.widget_type;
                            if(def.title) name = def.title;
                            if(def.icon) icon = def.icon;
                            if(def.icon_on) icon_on = def.icon_on;
                            if(def.icon_off) icon_off = def.icon_off;
                        } else {
                            if(id === 'spacer') type = 'spacer';
                            else if(id.startsWith('navigate.')) type = 'navigate';
                            else if(id.startsWith('sensor.')) type = 'sensor';
                        }
                        if(name === id && type !== 'spacer') name = formatSmartName(id, '');
                        rowData.push({ id, type, size, name, icon, icon_on, icon_off, was_edited: false });
                    });
                    newRows.push(rowData);
                }
                if(inLayout && tr.length > 0 && !tr.startsWith('-') && !tr.startsWith(' ') && !tr.startsWith('layout:')) {
                    inLayout = false;
                }
            });

            if(newRows.length > 0) {
                rows = newRows;
                renderPreview();
                alert("Pomy≈õlnie zaimportowano uk≈Çad.");
            } else {
                alert("B≈ÇƒÖd: Nie znaleziono sekcji 'layout:' w kodzie.");
            }
            setTimeout(() => blockSmart = false, 1000);
        }

        function setLang(lang) {
            currentLang = lang;
            document.getElementById('input-lang').value = lang;
            document.getElementById('btn-pl').className = lang === 'pl' ? 'active' : '';
            document.getElementById('btn-en').className = lang === 'en' ? 'active' : '';
            const t = TRANSLATIONS[lang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) {
                    if (el.tagName === 'INPUT' && el.type === 'submit') el.value = t[key];
                    else el.innerText = t[key];
                }
            });
            document.querySelectorAll('option[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.text = t[key];
            });
            const btn = document.getElementById('btn-submit');
            btn.innerText = editIdx ? t.btn_update : t.btn_add;
            updateTitleLimit();
            renderPreview();
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark-mode');
            localStorage.setItem('joan_theme', isDark ? 'dark' : 'light');
            document.getElementById('btn-theme').innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        window.addEventListener('DOMContentLoaded', () => {
            const host = window.location.hostname;
            const pathEl = document.getElementById('path-code');
            const linkEl = document.getElementById('dashboard-link');
            if(pathEl) pathEl.innerText = pathEl.innerText.replace('IP_HA', host);
            if(linkEl) {
                const rawHref = linkEl.getAttribute('href');
                if (rawHref.includes('[HOST]')) {
                    const newHref = rawHref.replace(/\[HOST\]/g, host);
                    linkEl.setAttribute('href', newHref);
                    linkEl.innerText = newHref;
                }
            }
            setLang('pl');
            const savedTheme = localStorage.getItem('joan_theme') || 'light';
            document.getElementById('btn-theme').innerText = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            updateTitleLimit();
            refreshSavedList(); 
            if(!rows.length || (rows.length===1 && !rows[0].length)) { } else { renderPreview(); }
        });
    </script>
</body>
</html>
