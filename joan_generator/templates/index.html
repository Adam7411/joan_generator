<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Joan 6 E-Ink Generator</title>
<link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
<style>
/* ... (pozostaw styl jak w Twojej ostatniej wersji z powiÄ™kszonym podglÄ…dem) ... */
</style>
</head>
<body>
<div class="container">
  <!-- ... nagÅ‚Ã³wek i status jak wczeÅ›niej ... -->

  <button type="button" class="btn btn-import" onclick="toggleImport()">ðŸ“‚ Importuj / Edytuj Kod</button>
  <div id="import-area" class="section import-box">
    <h4 style="margin-top:0">Wklej kod pliku .dash tutaj:</h4>
    <textarea id="import-code" style="height:170px;" placeholder="title: Moj Dashboard..."></textarea>
    <button type="button" class="btn btn-add" style="margin-top:12px;" onclick="importYaml()">Wczytaj Dashboard</button>
  </div>

  <form method="POST" id="main-form">
    <input type="hidden" name="ui_language" id="ui_language" value="pl">

    <!-- Ustawienia -->
    <div class="section">
      <div class="section-title">1. Ustawienia</div>
      <div class="flex-row">
        <div class="flex-col">
          <label>TytuÅ‚ Dashboardu (Nazwa pliku)</label>
          <input type="text" name="title" id="dash-title" value="JoanDashboard">
        </div>
      </div>
    </div>

    <!-- Formularz widgetu: dodane icon, icon_on, icon_off -->
    <div class="add-widget-box" id="widget-form-box">
      <h4 style="margin-top:0" id="form-header">2. Dodaj Widget</h4>
      <div class="flex-row">
        <div class="flex-col">
          <label>Typ Widgetu</label>
          <select id="new-widget-type" onchange="toggleInputs()">
            <option value="switch">Switch / Light / Input Boolean</option>
            <option value="cover">Cover / Gate / Garage</option>
            <option value="sensor">Sensor</option>
            <option value="binary_sensor">Binary Sensor</option>
            <option value="media_player">Media Player</option>
            <option value="climate">Climate</option>
            <option value="script">Script</option>
            <option value="navigate">Navigate / Dashboard Button</option>
            <option value="label">Label (Text)</option>
          </select>
        </div>

        <div class="flex-col" id="group-entity">
          <label>Wybierz EncjÄ™ (Home Assistant)</label>
          <input list="entities-list" id="new-entity-id" placeholder="np. light.kuchnia..." oninput="megaAutoConfig()">
          <datalist id="entities-list">
            {% for entity in entities %}
            <option value="{{ entity.id }}">{{ entity.id }}</option>
            {% endfor %}
          </datalist>
        </div>

        <div class="flex-col hidden" id="group-nav">
          <label>Nazwa pliku dashboardu</label>
          <input type="text" id="new-dashboard-name" placeholder="np. joan3 (bez .dash)">
        </div>

        <div class="flex-col">
          <label>TytuÅ‚ na ekranie</label>
          <input type="text" id="new-widget-name" placeholder="np. Hydrofor">
        </div>
      </div>

      <!-- Ikony: bazowa + pary on/off -->
      <div class="flex-row" style="margin-top:12px;">
        <div class="flex-col">
          <label>Ikona (sensor/navigate/label)</label>
          <input list="icons-list" id="new-widget-icon" placeholder="np. mdi-thermometer" oninput="updateIconPreview()">
        </div>
        <div class="flex-col">
          <label>Ikona ON (switch/cover)</label>
          <input list="icons-list" id="new-widget-icon-on" placeholder="np. mdi-lightbulb-on" oninput="updateIconPreview()">
        </div>
        <div class="flex-col">
          <label>Ikona OFF (switch/cover)</label>
          <input list="icons-list" id="new-widget-icon-off" placeholder="np. mdi-lightbulb-outline" oninput="updateIconPreview()">
        </div>
        <div style="width:70px;">
          <label>PodglÄ…d</label>
          <div class="icon-preview-box">
            <i id="icon-preview-i" class="mdi mdi-help-circle-outline" style="font-size:36px;"></i>
          </div>
        </div>
      </div>

      <div class="flex-row" style="margin-top:12px; align-items:flex-end;">
        <div class="flex-col" style="max-width:170px;">
          <label>Rozmiar</label>
          <select id="new-widget-size">
            <option value="">DomyÅ›lny (2x1)</option>
            <option value="(1x1)">1x1</option>
            <option value="(2x1)">2x1</option>
            <option value="(2x2)">2x2</option>
            <option value="(3x1)">3x1</option>
            <option value="(1x2)">1x2</option>
            <option value="(3x2)">3x2</option>
          </select>
        </div>
        <div class="flex-col" style="display:flex; gap:12px; align-items:flex-end;">
          <button type="button" id="btn-action" class="btn btn-add" onclick="saveWidget()">+ DODAJ DO WIERSZA</button>
          <button type="button" id="btn-cancel" class="btn btn-cancel hidden" onclick="cancelEdit()">Anuluj</button>
        </div>
      </div>
    </div>

    <!-- PodglÄ…d -->
    <div class="section">
      <div class="section-title">3. PodglÄ…d Dashboardu (Kliknij, aby edytowaÄ‡)</div>
      <div id="rows-container" class="preview-area"></div>
      <button type="button" class="btn btn-row" onclick="addNewRow()">+ Dodaj Nowy Wiersz</button>
    </div>

    <input type="hidden" name="layout_data_json" id="layout_data_json">
    <button type="button" class="btn btn-primary" onclick="submitForm()">GENERUJ KOD .DASH</button>
  </form>

  {% if generated_yaml %}
  <div class="section">
    <h3>TwÃ³j kod YAML:</h3>
    <div class="file-path-info">
      <strong>1. Zapisz kod w pliku:</strong>
      <code id="path-code">\\IP_HA\addon_configs\appdaemon\dashboards\{{ filename }}</code>
      <strong>2. Uruchom ponownie AppDaemon i sprawdÅº dashboard:</strong>
      <a href="#" id="dashboard-link" target="_blank">http://IP_HA:5050/{{ dash_name }}</a>
    </div>
    <textarea class="output" readonly>{{ generated_yaml }}</textarea>
  </div>
  {% endif %}
</div>

<script>
const entitiesData = {{ entities | tojson }};
let currentLang='pl', rows=[], activeRowIndex=0, editingIndices=null, importedDefsMap={};

function formatNameFromId(id){
  if(!id) return "";
  const last=id.includes('.')?id.split('.').pop():id;
  return last.replace(/_/g,' ').replace(/\b\w/g,l=>l.toUpperCase());
}
function resolveImportedTitle(id){
  const tries=[id];
  if(id.includes('.')) tries.push(id.split('.').pop());
  for(const t of tries){
    const def=importedDefsMap[t];
    if(def){
      if(def.title) return def.title;
      if(def.entity && importedDefsMap[def.entity] && importedDefsMap[def.entity].title)
        return importedDefsMap[def.entity].title;
    }
  }
  return '';
}

// Pobieranie encji
function getEntity(id){ return entitiesData.find(e=>e.id===id)||null; }
function normalizeStateText(s){
  if(s==null) return null;
  s=String(s).toLowerCase().trim();
  const T=currentLang==='pl'
    ? {on:"WÅÄ„CZONE", off:"WYÅÄ„CZONE", open:"OTWARTE", closed:"ZAMKNIÄ˜TE"}
    : {on:"ON", off:"OFF", open:"OPEN", closed:"CLOSED"};
  if(['1','true','on'].includes(s)) return T.on;
  if(['0','false','off'].includes(s)) return T.off;
  if(s==='open') return T.open;
  if(s==='closed') return T.closed;
  return null;
}

// Auto-ikony par on/off
function autoIconPair(type, id){
  const v=(id||'').toLowerCase();
  // light
  if(v.startsWith('light.') || v.includes('swiatlo') || v.includes('light')) return ['mdi-lightbulb-on','mdi-lightbulb-outline'];
  // switch generic
  if(v.startsWith('switch.') || v.startsWith('input_boolean.')) return ['mdi-toggle-switch','mdi-toggle-switch-off'];
  // gate/garage/cover
  if(v.startsWith('cover.') || v.includes('brama') || v.includes('gate')) return ['mdi-gate-open','mdi-gate'];
  if(v.includes('garage') || v.includes('garaz') || v.includes('garaÅ¼')) return ['mdi-garage-open','mdi-garage'];
  // radiator/heating
  if(v.includes('radiator') || v.includes('ogrzew') || v.includes('grzejnik')) return ['mdi-radiator','mdi-radiator-off'];
  // water
  if(v.includes('woda') || v.includes('water') || v.includes('cwu')) return ['mdi-water-outline','mdi-water-off'];
  // window shutter
  if(v.includes('roleta') || v.includes('blind') || v.includes('window')) return ['mdi-window-shutter-open','mdi-window-shutter'];
  // default
  return ['mdi-toggle-switch','mdi-toggle-switch-off'];
}

// Ikona do podglÄ…du: uÅ¼yj icon_on/icon_off jeÅ›li typ akcyjny
function previewIcon(widget){
  const ent=getEntity(widget.id);
  const actionable = ['switch','cover','binary_sensor','media_player','climate','script'].includes(widget.type) || widget.id.startsWith('input_boolean.');
  if(actionable){
    let onIcon = widget.icon_on, offIcon = widget.icon_off;
    if(!onIcon || !offIcon){
      const pair=autoIconPair(widget.type, widget.id);
      onIcon = onIcon || pair[0];
      offIcon = offIcon || pair[1];
    }
    const state = ent ? String(ent.state).toLowerCase().trim() : 'off';
    const isOn = (state==='on' || state==='true' || state==='1' || state==='open' || state==='unlocked');
    return isOn ? onIcon : offIcon;
  } else {
    // sensor/navigate/label â€“ staÅ‚a ikona
    return widget.icon || 'mdi-gauge';
  }
}

function getDisplayState(id,type){
  const ent=getEntity(id);
  if(!ent) return '';
  if(['label','navigate','sensor'].includes(type)) {
    if(type==='sensor'){
      const raw=String(ent.state).trim();
      if((raw==='1'||raw==='0') && !ent.unit) return '';
      if(!isNaN(parseFloat(raw)) && raw.includes('.')){
        const v=parseFloat(raw).toFixed(1);
        return ent.unit?`${v} ${ent.unit}`:v;
      }
      return ent.unit?`${raw} ${ent.unit}`:raw;
    }
    return '';
  }
  const norm = normalizeStateText(ent.state);
  return norm || '';
}

function renderRows(){
  const c=document.getElementById('rows-container');
  c.innerHTML='';
  rows.forEach((rowWidgets,rowIdx)=>{
    const row=document.createElement('div');
    row.className='eink-row';
    row.id='row-'+rowIdx;
    row.addEventListener('click',()=>{ if(editingIndices) cancelEdit(); activeRowIndex=rowIdx; refreshUIText(); highlightActiveRow(); });

    const chip=document.createElement('div');
    chip.className='row-label-chip';
    chip.innerText=(currentLang==='pl'?'WIERSZ ':'ROW ')+(rowIdx+1);
    row.appendChild(chip);

    rowWidgets.forEach((w,i)=>{
      const wDiv=document.createElement('div');
      wDiv.className='eink-widget';
      wDiv.dataset.title=w.name || resolveImportedTitle(w.id) || formatNameFromId(w.id);
      if(editingIndices && editingIndices.r===rowIdx && editingIndices.w===i) wDiv.classList.add('being-edited');

      // sizing
      let width= w.size ? parseInt(w.size.replace(/[()]/,'').split('x')[0]) : 2;
      let height= w.size ? parseInt(w.size.replace(/[()]/,'').split('x')[1]) : 1;
      const baseW=160, baseH=130;
      wDiv.style.width=(baseW + (width-2)*70)+'px';
      wDiv.style.minHeight=(baseH + (height-1)*70)+'px';

      wDiv.addEventListener('click',(e)=>{ e.stopPropagation(); editWidget(rowIdx,i); });

      const importedTitle=resolveImportedTitle(w.id);
      const safeName=w.name && w.name.trim()?w.name:(importedTitle||formatNameFromId(w.id));

      const iconClass = previewIcon(w);
      const stateText = getDisplayState(w.id, w.type);

      wDiv.innerHTML=`
        <div class="ew-title">${safeName}</div>
        ${iconClass?`<i class="mdi ${iconClass} ew-icon"></i>`:`<div style="height:42px"></div>`}
        ${stateText?`<div class="ew-state">${stateText}</div>`:`<div style="height:14px"></div>`}
        <div class="ew-delete" onclick="removeWidget(${rowIdx},${i}); event.stopPropagation();">X</div>
        <div class="ew-edit-overlay"></div>
      `;
      row.appendChild(wDiv);
    });

    c.appendChild(row);
  });
  highlightActiveRow();
}
function highlightActiveRow(){
  document.querySelectorAll('.eink-row').forEach(r=>r.classList.remove('active'));
  const active=document.getElementById('row-'+activeRowIndex);
  if(active) active.classList.add('active');
}

// Import: zachowaj icon/icon_on/icon_off
function importYaml(){
  const code=document.getElementById('import-code').value;
  if(!code) return;
  try{
    const lines=code.split('\n');
    const defs={};
    let current=null;
    const layoutLines=[];
    let parsingLayout=false;
    for(const raw of lines){
      const line=raw.split('#')[0].trim();
      if(!line) continue;
      if(line.startsWith('layout:')){ parsingLayout=true; continue; }
      if(parsingLayout){
        if(line.startsWith('-')) layoutLines.push(line);
        else if(/^\S+:/m.test(raw)) parsingLayout=false;
      }
      if(!parsingLayout){
        const m=raw.match(/^([a-zA-Z0-9_\.]+):/);
        if(m){
          const key=m[1];
          const ignore=['global_parameters','widget_dimensions','widget_size','widget_margins','columns','rows','skin','title'];
          if(!ignore.includes(key)){ current=key; defs[current]={}; } else { current=null; }
        } else if(current && line.includes(':')){
          let val=line.substring(line.indexOf(':')+1).trim();
          if((val.startsWith('"')&&val.endsWith('"'))||(val.startsWith("'")&&val.endsWith("'"))) val=val.slice(1,-1);
          const k=line.split(':')[0].trim();
          defs[current][k]=val;
        }
      }
    }
    importedDefsMap={};
    Object.entries(defs).forEach(([k,v])=>{
      importedDefsMap[k]=v;
      if(v.entity) importedDefsMap[v.entity]=v;
    });
    rows=[];
    layoutLines.forEach(l=>{
      const items=l.substring(1).trim().split(',');
      const row=[];
      items.forEach(itemRaw=>{
        let id=itemRaw.trim();
        let size="";
        const sm=id.match(/\(\d+x\d+\)/);
        if(sm){ size=sm[0]; id=id.replace(sm[0],'').trim(); }
        const def=importedDefsMap[id] || importedDefsMap[id.split('.').pop()] || null;

        // type
        let type=def && def.widget_type;
        if(!type){
          if(id.startsWith('navigate.')) type='navigate';
          else if(id.startsWith('sensor.')) type='sensor';
          else if(id.startsWith('binary_sensor.')) type='binary_sensor';
          else if(id.startsWith('cover.')) type='cover';
          else if(id.startsWith('media_player.')) type='media_player';
          else if(id.startsWith('climate.')) type='climate';
          else if(id.startsWith('light.') || id.startsWith('switch.') || id.startsWith('input_boolean.')) type='switch';
          else type='switch';
        }

        let name=resolveImportedTitle(id);
        if(!name && def && def.entity) name=formatNameFromId(def.entity);
        if(!name) name=formatNameFromId(id);

        // icons: read icon/icon_on/icon_off
        let icon = def && def.icon || '';
        let icon_on = def && (def.icon_on || def.icon_active) || '';
        let icon_off = def && (def.icon_off || def.icon_inactive) || '';

        // If missing pair for actionable types, auto-fill
        const actionable = ['switch','cover','binary_sensor','media_player','climate','script'].includes(type) || id.startsWith('input_boolean.');
        if(actionable && (!icon_on || !icon_off)){
          const pair=autoIconPair(type, def && def.entity ? def.entity : id);
          icon_on = icon_on || pair[0];
          icon_off = icon_off || pair[1];
        }
        // normalize mdi prefix
        [icon, icon_on, icon_off] = [icon, icon_on, icon_off].map(x => (x && !x.startsWith('mdi-')) ? ('mdi-'+x) : x);

        row.push({ id, type, name, icon, icon_on, icon_off, size });
      });
      if(row.length) rows.push(row);
    });
    if(!rows.length){ alert("Brak sekcji layout w kodzie."); return; }
    activeRowIndex=rows.length-1;
    renderRows();
    refreshUIText();
    toggleImport();
    alert("Import OK");
  }catch(e){ alert("Import bÅ‚Ä…d: "+e.message); }
}

// Edit/Save: obsÅ‚uga icon/icon_on/icon_off
function editWidget(r,w){
  editingIndices={r,w};
  const wid=rows[r][w];
  activeRowIndex=r;
  document.getElementById('new-widget-type').value=wid.type;
  toggleInputs();
  if(wid.type==='navigate'){
    document.getElementById('new-dashboard-name').value=wid.id.replace('navigate.','');
    document.getElementById('group-nav').classList.remove('hidden');
    document.getElementById('group-entity').classList.add('hidden');
  }else{
    document.getElementById('new-entity-id').value=wid.id;
    document.getElementById('group-entity').classList.remove('hidden');
    document.getElementById('group-nav').classList.add('hidden');
  }
  document.getElementById('new-widget-name').value=wid.name||'';
  document.getElementById('new-widget-icon').value=wid.icon||'';
  document.getElementById('new-widget-icon-on').value=wid.icon_on||'';
  document.getElementById('new-widget-icon-off').value=wid.icon_off||'';
  document.getElementById('new-widget-size').value=wid.size||'';
  updateIconPreview();
  document.getElementById('widget-form-box').classList.add('editing');
  document.getElementById('btn-cancel').classList.remove('hidden');
  refreshUIText();
  renderRows();
}
function cancelEdit(){
  editingIndices=null;
  clearForm();
  document.getElementById('widget-form-box').classList.remove('editing');
  document.getElementById('btn-cancel').classList.add('hidden');
  refreshUIText();
  renderRows();
}
function saveWidget(){
  const type=document.getElementById('new-widget-type').value;
  let name=document.getElementById('new-widget-name').value.trim();
  let icon=document.getElementById('new-widget-icon').value.trim();
  let icon_on=document.getElementById('new-widget-icon-on').value.trim();
  let icon_off=document.getElementById('new-widget-icon-off').value.trim();
  const size=document.getElementById('new-widget-size').value;
  let id='';
  if(type==='navigate'){
    const dash=document.getElementById('new-dashboard-name').value.trim();
    if(!dash){ alert("Wymagana nazwa dashboardu"); return; }
    id='navigate.'+dash;
  }else{
    id=document.getElementById('new-entity-id').value.trim();
    if(!id){ alert("Wymagana encja"); return; }
  }
  if(!name) name=formatNameFromId(id);

  // Autocomplete icon pair for actionable types
  const actionable = ['switch','cover','binary_sensor','media_player','climate','script'].includes(type) || id.startsWith('input_boolean.');
  if(actionable && (!icon_on || !icon_off)){
    const pair=autoIconPair(type,id);
    icon_on = icon_on || pair[0];
    icon_off = icon_off || pair[1];
  }
  // normalize mdi-
  [icon, icon_on, icon_off] = [icon, icon_on, icon_off].map(x => (x && !x.startsWith('mdi-')) ? ('mdi-'+x) : x);

  const obj={id,type,name,icon,icon_on,icon_off,size};
  if(editingIndices){
    rows[editingIndices.r][editingIndices.w]=obj;
    cancelEdit();
  }else{
    if(!rows.length) addNewRow();
    rows[activeRowIndex].push(obj);
    clearForm();
  }
  renderRows();
  refreshUIText();
}
function clearForm(){
  document.getElementById('new-entity-id').value='';
  document.getElementById('new-dashboard-name').value='';
  document.getElementById('new-widget-name').value='';
  document.getElementById('new-widget-icon').value='';
  document.getElementById('new-widget-icon-on').value='';
  document.getElementById('new-widget-icon-off').value='';
  document.getElementById('new-widget-size').value='';
  updateIconPreview();
}
function toggleInputs(){
  const t=document.getElementById('new-widget-type').value;
  const entityGrp=document.getElementById('group-entity');
  const navGrp=document.getElementById('group-nav');
  if(t==='navigate'){ entityGrp.classList.add('hidden'); navGrp.classList.remove('hidden'); }
  else { navGrp.classList.add('hidden'); entityGrp.classList.remove('hidden'); }
}
function updateIconPreview(){
  const val=document.getElementById('new-widget-icon').value.trim()
           || document.getElementById('new-widget-icon-on').value.trim()
           || document.getElementById('new-widget-icon-off').value.trim();
  const el=document.getElementById('icon-preview-i');
  el.className= val && val.startsWith('mdi-') ? 'mdi '+val : 'mdi mdi-help-circle-outline';
}
function megaAutoConfig(){
  const id=document.getElementById('new-entity-id').value.toLowerCase();
  if(!id) return;
  const tSel=document.getElementById('new-widget-type');
  if(id.startsWith('sensor.')) tSel.value='sensor';
  else if(id.startsWith('binary_sensor.')) tSel.value='binary_sensor';
  else if(id.startsWith('cover.')) tSel.value='cover';
  else if(id.startsWith('media_player.')) tSel.value='media_player';
  else if(id.startsWith('climate.')) tSel.value='climate';
  else if(id.startsWith('switch.') || id.startsWith('light.') || id.startsWith('input_boolean.')) tSel.value='switch';
  // Auto pair for actionable
  const actionable = ['switch','cover','binary_sensor','media_player','climate','script'].includes(tSel.value) || id.startsWith('input_boolean.');
  if(actionable){
    const pair=autoIconPair(tSel.value,id);
    if(!document.getElementById('new-widget-icon-on').value) document.getElementById('new-widget-icon-on').value=pair[0];
    if(!document.getElementById('new-widget-icon-off').value) document.getElementById('new-widget-icon-off').value=pair[1];
  } else {
    if(!document.getElementById('new-widget-icon').value){
      document.getElementById('new-widget-icon').value='mdi-gauge';
    }
  }
  updateIconPreview();
}

function addNewRow(){ rows.push([]); activeRowIndex=rows.length-1; renderRows(); refreshUIText(); }
function deleteRow(i){ rows.splice(i,1); if(activeRowIndex>=rows.length) activeRowIndex=rows.length-1; renderRows(); refreshUIText(); }
function submitForm(){ document.getElementById('layout_data_json').value=JSON.stringify(rows); document.getElementById('main-form').submit(); }

// Ikony datalist
async function fetchIcons(){
  const dataList=document.getElementById('icons-list');
  try{
    const response=await fetch('https://raw.githubusercontent.com/Templarian/MaterialDesign/master/meta.json');
    const icons=await response.json();
    dataList.innerHTML='';
    icons.forEach(i=>{ const opt=document.createElement('option'); opt.value='mdi-'+i.name; dataList.appendChild(opt); });
  }catch(e){}
}
fetchIcons();

window.addEventListener('DOMContentLoaded',()=>{
  const host=window.location.hostname;
  const pathCode=document.getElementById('path-code');
  const dashLink=document.getElementById('dashboard-link');
  if(pathCode) pathCode.innerHTML=pathCode.innerHTML.replace('IP_HA',host);
  if(dashLink){
    const href=`http://${host}:5050/{{ dash_name }}`;
    dashLink.href=href;
    dashLink.innerText=href;
  }
  const lang=localStorage.getItem('joan_lang')||'pl';
  const theme=localStorage.getItem('joan_theme')||'light';
  setLang(lang);
  if(theme==='dark') document.body.classList.add('dark-mode');
  if(!rows.length) addNewRow();
});
</script>
</body>
</html>
