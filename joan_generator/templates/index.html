<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joan 6 E-Ink Generator (Ultimate)</title>
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    
    <script>
        (function() {
            try {
                const savedTheme = localStorage.getItem('joan_theme') || 'light';
                if (savedTheme === 'dark') document.documentElement.classList.add('dark-mode');
            } catch(e) {}
        })();
    </script>

    <style>
        :root {
            --bg-body: #e0e0e0; --bg-container: #ffffff; --bg-section: #fafafa; --bg-input: #ffffff;
            --text-main: #333333; --border: #cccccc; --accent: #d32f2f; --highlight: #e3f2fd;
            --preview-bg: #f0f0f0; --link-bg: #e1f5fe; --link-color: #0277bd;
        }
        html.dark-mode {
            --bg-body: #121212; --bg-container: #1e1e1e; --bg-section: #252525; --bg-input: #2c2c2c;
            --text-main: #e0e0e0; --border: #444444; --accent: #ff5252; --highlight: #0d47a1;
            --preview-bg: #000000; --link-bg: #013655; --link-color: #81d4fa;
        }

        body { font-family: 'Roboto', sans-serif; background-color: var(--bg-body); color: var(--text-main); padding: 20px; transition: background 0.3s; }
        .container { max-width: 1400px; margin: 0 auto; background: var(--bg-container); padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        
        .header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border); padding-bottom: 20px; margin-bottom: 25px; }
        h1 { margin: 0; color: var(--accent); font-size: 28px; }
        
        .controls button { padding: 8px 16px; border: 1px solid var(--border); background: var(--bg-section); color: var(--text-main); border-radius: 4px; cursor: pointer; font-weight: bold; }
        .controls button.active { background: var(--accent); color: white; border-color: var(--accent); }

        .section { background: var(--bg-section); padding: 25px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 30px; }
        .file-path-info { background-color: var(--link-bg); color: var(--link-color); border: 1px solid var(--border); padding: 20px; margin-bottom: 20px; border-radius: 6px; font-family: monospace; font-size: 15px; }
        .file-path-info a { color: var(--accent); font-weight: bold; }

        .add-widget-box { background: var(--highlight); padding: 25px; border-radius: 8px; border: 1px solid var(--accent); transition: all 0.3s; margin-bottom: 30px; }
        .add-widget-box.editing { border: 3px solid #ff9800; background: rgba(255, 152, 0, 0.1); }

        .flex-row { display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 15px; }
        .flex-col { flex: 1; min-width: 160px; }
        label { display: block; font-weight: bold; font-size: 0.9em; margin-bottom: 8px; color: var(--text-main); }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); background: var(--bg-input); color: var(--text-main); border-radius: 4px; box-sizing: border-box; font-size: 14px; }
        
        #w-id { border: 2px solid var(--accent); background-color: var(--bg-input); font-weight: bold; }
        .btn { padding: 12px 24px; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; text-transform: uppercase; color: white; font-size: 14px; }
        .btn-add { background: #4caf50; width: 100%; }
        .btn-gen { background: var(--accent); width: 100%; font-size: 20px; padding: 15px; margin-top: 20px; }
        .btn-cancel { background: #757575; }
        .btn-row { background: #2196f3; margin-top: 15px; }
        .btn-import { background: #ff9800; color: white; width: auto; margin-top: 10px; }

        /* --- PODGLƒÑD E-INK --- */
        .preview-area { background: var(--preview-bg); padding: 30px; border: 2px solid var(--border); border-radius: 8px; overflow-x: auto; min-height: 350px; }
        
        /* WIERSZ (DU≈ªY, ≈ªEBY WSZYSTKO WESZ≈ÅO) */
        .eink-row { 
            display: flex; gap: 10px; margin-bottom: 15px; padding: 15px; 
            border: 2px dashed #999; border-radius: 6px; 
            min-height: 200px; /* Du≈ºo miejsca na przyciski */
            align-items: center; position: relative; 
        }
        .row-label { position: absolute; top: -10px; left: 10px; font-size: 11px; background: var(--bg-body); padding: 2px 8px; color: var(--text-main); border: 1px solid var(--border); border-radius: 4px; font-weight: bold; }

        /* WIDGET (STYL Z PLIKU JOAN.TXT - BIA≈ÅE T≈ÅO, CZARNE RAMKI) */
        .eink-widget {
            background: #FFFFFF; border: 3px solid #000000; color: #000000;
            display: flex; flex-direction: column; align-items: center; justify-content: space-between;
            padding: 8px; box-sizing: border-box; cursor: pointer; position: relative;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.25); transition: transform 0.1s; flex-shrink: 0; overflow: hidden;
        }
        .eink-widget:hover { transform: translateY(-3px); z-index: 10; border-color: var(--accent); }
        .eink-widget.editing { border: 3px dashed #ff9800; transform: scale(1.03); z-index: 20; }

        .ew-header {
            font-size: 10px; text-transform: uppercase; color: #666; width: 100%;
            text-align: right; position: absolute; top: 2px; right: 4px;
        }
        /* TYTU≈Å PRZYCISKU */
        .ew-title { 
            font-weight: 900; font-size: 16px; text-align: center; width: 100%; 
            line-height: 1.1; margin-top: 10px; white-space: normal; 
            font-family: 'Roboto', 'Arial Black', sans-serif; text-transform: uppercase;
        }
        /* IKONA */
        .ew-icon { font-size: 52px; display: block; margin: 5px 0; }
        
        /* STAN (WARTO≈öƒÜ) */
        .ew-value { 
            font-weight: 900; font-size: 22px; text-transform: uppercase; 
            margin-bottom: 5px; text-align: center; border-top: 3px solid #000; 
            width: 90%; padding-top: 5px;
        }
        
        .ew-del { position: absolute; top: -10px; right: -10px; background: red; color: white; width: 24px; height: 24px; border-radius: 50%; text-align: center; line-height: 24px; font-weight: bold; display: none; box-shadow: 1px 1px 3px rgba(0,0,0,0.5); z-index: 30; }
        .eink-widget:hover .ew-del { display: block; }

        .icon-preview { font-size: 32px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-input); }
        .hidden { display: none !important; }
        textarea.output { width: 100%; height: 500px; font-family: 'Consolas', 'Monaco', monospace; background: #263238; color: #eceff1; border: none; padding: 20px; border-radius: 8px; font-size: 14px; line-height: 1.5; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-row">
            <h1>Joan 6 E-Ink Generator</h1>
            <div class="controls">
                <button type="button" onclick="toggleTheme()" id="btn-theme">üåô</button>
            </div>
        </div>

        <div class="section" id="import-section">
            <details>
                <summary style="cursor: pointer; font-weight: bold; font-size: 1.1em;">üìÇ Import / Eksport Kodu .DASH</summary>
                <div style="margin-top: 15px;">
                    <textarea id="import-code" style="height: 150px;" placeholder="Wklej tutaj zawarto≈õƒá pliku .dash..."></textarea>
                    <button type="button" class="btn btn-import" onclick="importYaml()">Wczytaj Kod</button>
                </div>
            </details>
        </div>

        <form method="POST" id="main-form">
            <input type="hidden" name="title" value="JoanDashboard">
            <input type="hidden" name="ui_language" id="input-lang" value="pl">
            
            <div class="add-widget-box" id="editor-box">
                <div class="section-title" id="editor-title">Dodaj Widget</div>
                
                <div class="flex-row">
                    <div class="flex-col">
                        <label>Typ Widgetu</label>
                        <select id="w-type" onchange="toggleInputs()">
                            <option value="switch">Prze≈ÇƒÖcznik / ≈öwiat≈Ço</option>
                            <option value="cover">Roleta / Brama</option>
                            <option value="sensor">Sensor (Info)</option>
                            <option value="binary_sensor">Sensor Binarny (Drzwi)</option>
                            <option value="media_player">Media Player</option>
                            <option value="climate">Klimatyzacja / Termostat</option>
                            <option value="lock">Zamek</option>
                            <option value="person">Osoba</option>
                            <option value="input_boolean">Input Boolean</option>
                            <option value="script">Skrypt</option>
                            <option value="navigate">Przycisk Nawigacji</option>
                            <option value="label">Etykieta</option>
                            <option value="clock">Zegar</option>
                            <option value="spacer">Spacer (Pusty)</option>
                        </select>
                    </div>
                    <div class="flex-col" id="grp-entity">
                        <label>Encja (Wpisz nazwƒô lub ID)</label>
                        <input list="entity-list" id="w-id" placeholder="np. g≈Ço≈õnik, swiatlo..." oninput="searchEntities(this.value)" autocomplete="off">
                        <datalist id="entity-list"></datalist>
                    </div>
                    <div class="flex-col hidden" id="grp-nav">
                        <label>Nazwa Dashboardu</label>
                        <input type="text" id="w-dash" placeholder="np. main" oninput="autoNameNav()">
                    </div>
                    <div class="flex-col">
                        <label>Tytu≈Ç na ekranie</label>
                        <input type="text" id="w-name" placeholder="np. Salon">
                    </div>
                </div>

                <div class="flex-row">
                    <div class="flex-col">
                        <label>Rozmiar</label>
                        <select id="w-size">
                            <option value="(2x1)">2x1 (Standard)</option>
                            <option value="(1x1)">1x1 (Ma≈Çy)</option>
                            <option value="(2x2)">2x2 (Du≈ºy)</option>
                            <option value="(3x1)">3x1 (Szeroki)</option>
                            <option value="(1x2)">1x2 (Wysoki)</option>
                            <option value="(3x2)">3x2 (Ogromny)</option>
                        </select>
                    </div>
                    <div class="flex-col" style="flex: 0 0 60px;">
                        <label>Ikona</label>
                        <div style="display:flex; justify-content:center;">
                            <i id="preview-icon" class="mdi mdi-help-circle-outline icon-preview"></i>
                        </div>
                    </div>
                    <div class="flex-col">
                        <label>Ikona (Baza)</label>
                        <input type="text" id="w-icon" oninput="updateIconPreview()" placeholder="mdi-home">
                    </div>
                    <div class="flex-col">
                        <label>Ikona ON</label>
                        <input type="text" id="w-icon-on" oninput="updateIconPreview()" placeholder="mdi-lightbulb-on">
                    </div>
                    <div class="flex-col">
                        <label>Ikona OFF</label>
                        <input type="text" id="w-icon-off" oninput="updateIconPreview()" placeholder="mdi-lightbulb-outline">
                    </div>
                </div>

                <div class="flex-row" style="margin-top: 20px;">
                    <button type="button" class="btn btn-add" id="btn-submit" onclick="saveWidget()">+ DODAJ WIDGET</button>
                    <button type="button" class="btn btn-cancel hidden" id="btn-cancel" onclick="cancelEdit()">ANULUJ</button>
                </div>
            </div>

            <div class="section">
                <div class="section-title">PodglƒÖd Dashboardu</div>
                <div class="preview-area" id="preview-container"></div>
                <button type="button" class="btn btn-row" onclick="addRow()">+ Dodaj Wiersz</button>
            </div>

            <input type="hidden" name="layout_data_json" id="layout_json">
            <button type="button" class="btn btn-gen" onclick="submitData()">GENERUJ KOD .DASH</button>
        </form>

        {% if generated_yaml %}
        <div class="section" style="margin-top:30px;">
            <div class="section-title">Wynikowy Kod YAML</div>
            <div class="file-path-info">
                <strong>1. Zapisz kod w pliku:</strong>
                <code id="path-code">\\IP_HA\addon_configs\appdaemon\dashboards\{{ filename }}</code>
                <strong>2. Uruchom ponownie AppDaemon i sprawd≈∫ dashboard:</strong>
                <a href="http://[HOST]:5050/{{ dash_name }}" id="dashboard-link" target="_blank">http://[HOST]:5050/{{ dash_name }}</a>
            </div>
            <textarea class="output" readonly>{{ generated_yaml }}</textarea>
        </div>
        {% endif %}
    </div>

    <script>
        // --- 1. DANE I ZMIENNE ---
        const entitiesData = {{ entities | tojson | safe }};
        let rows = [[]];
        let editIdx = null;
        let blockSmart = false; 
        let importedDefsMap = {}; 

        // --- MAPY SMART LOGIC (ZGODNIE Z PLIKIEM JOAN.TXT) ---
        // Domy≈õlnie: Switch/Cover -> 2x1, Sensor -> 1x1
        const SMART_MAP = {
            'light': { type: 'switch', size: '(2x1)', iconOn: 'mdi-lightbulb-on', iconOff: 'mdi-lightbulb-outline' },
            'switch': { type: 'switch', size: '(2x1)', iconOn: 'mdi-toggle-switch', iconOff: 'mdi-toggle-switch-off' },
            'cover': { type: 'cover', size: '(2x1)', iconOn: 'mdi-window-shutter-open', iconOff: 'mdi-window-shutter' },
            'garage': { type: 'cover', size: '(2x1)', iconOn: 'mdi-garage-open', iconOff: 'mdi-garage' },
            'binary_sensor': { type: 'binary_sensor', size: '(1x1)', iconOn: 'mdi-checkbox-marked-circle', iconOff: 'mdi-checkbox-blank-circle-outline' },
            'sensor': { type: 'sensor', size: '(1x1)', icon: 'mdi-eye' },
            'media_player': { type: 'media_player', size: '(2x2)', icon: '' },
            'climate': { type: 'climate', size: '(2x2)', icon: '' },
            'lock': { type: 'lock', size: '(2x1)', iconOn: 'mdi-lock-open', iconOff: 'mdi-lock' }
        };

        // --- 2. FUNKCJE POMOCNICZE ---

        function normalizeString(str) {
            return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
        }

        function searchEntities(val) {
            runSmartLogic(val); // Uruchom logikƒô smart na ≈ºywo
            
            const dl = document.getElementById('entity-list');
            dl.innerHTML = ''; 
            
            if(!val || val.length < 2) return; 
            const terms = normalizeString(val).split(" ").filter(t => t);
            
            let count = 0;
            for(const e of entitiesData) {
                if(count > 50) break;
                // Szukamy w ID i Friendly Name
                const searchStr = normalizeString(e.id + " " + (e.attributes.friendly_name || ""));
                if(terms.every(term => searchStr.includes(term))) {
                    const opt = document.createElement('option');
                    opt.value = e.id;
                    // Pokazujemy przyjaznƒÖ nazwƒô
                    opt.label = e.attributes.friendly_name ? `${e.attributes.friendly_name} (${e.id})` : e.id;
                    opt.setAttribute('data-dclass', e.attributes.device_class || '');
                    opt.setAttribute('data-friendly', e.attributes.friendly_name || '');
                    dl.appendChild(opt);
                    count++;
                }
            }
        }

        function getEntityMeta(id) {
            return entitiesData.find(e => e.id === id) || { attributes: {} };
        }

        function formatSmartName(id, friendlyName) {
            if (friendlyName && friendlyName.length > 2) return friendlyName;
            if(!id) return "";
            if(id.startsWith('navigate.')) return id.replace('navigate.','').toUpperCase();
            let name = id.split('.').pop(); 
            name = name.replace(/_[lvr]\d+$/i, '').replace(/_state$/i, '');
            name = name.replace(/_/g, ' ');
            return name.replace(/\b\w/g, l => l.toUpperCase());
        }

        function updateIconPreview() {
            const i1 = document.getElementById('w-icon').value;
            const i2 = document.getElementById('w-icon-on').value;
            const i3 = document.getElementById('w-icon-off').value;
            const final = i1 || i2 || i3 || 'mdi-help-circle-outline';
            document.getElementById('preview-icon').className = `mdi ${final} icon-preview`;
        }

        function toggleInputs() {
            const type = document.getElementById('w-type').value;
            const isNav = type === 'navigate';
            const isSpacer = type === 'spacer';
            document.getElementById('grp-entity').style.display = (isNav || isSpacer) ? 'none' : 'block';
            document.getElementById('grp-nav').style.display = isNav ? 'block' : 'none';
            document.getElementById('grp-nav').classList.toggle('hidden', !isNav);
        }

        // --- 3. SMART LOGIC ---
        function runSmartLogic(val) {
            if (blockSmart) return;
            
            const id = val.toLowerCase();
            const idNorm = normalizeString(id);
            if (id.length < 3) return;

            const ent = getEntityMeta(id);
            const dClass = (ent.attributes.device_class || '').toLowerCase();
            const fName = ent.attributes.friendly_name || '';
            const fNameNorm = normalizeString(fName);
            const domain = id.split('.')[0];

            // Baza
            let conf = SMART_MAP[domain] || { type: 'sensor', size: '(1x1)', icon: 'mdi-eye' };

            // Detekcja s≈Ç√≥w kluczowych (PL)
            const check = (keywords) => keywords.some(k => idNorm.includes(k) || fNameNorm.includes(k));
            
            if (check(['glosnik', 'audio', 'tv'])) conf = SMART_MAP['media_player'];
            else if (check(['swiatlo', 'lamp', 'kinkiet'])) conf = SMART_MAP['light'];
            else if (check(['brama', 'garaz'])) conf = { type: 'cover', size: '(2x1)', iconOn: 'mdi-garage-open', iconOff: 'mdi-garage' };
            else if (check(['rolet', 'blind'])) conf = SMART_MAP['cover'];
            else if (check(['zamek'])) conf = SMART_MAP['lock'];
            else if (check(['drzwi', 'okno'])) {
                conf = { type: 'binary_sensor', size: '(1x1)', iconOn: 'mdi-door-open', iconOff: 'mdi-door-closed' };
            }

            // Detekcja Device Class
            if (dClass === 'garage') conf = { type: 'cover', size: '(2x1)', iconOn: 'mdi-garage-open', iconOff: 'mdi-garage' };
            if (dClass === 'door') conf = { type: 'binary_sensor', size: '(1x1)', iconOn: 'mdi-door-open', iconOff: 'mdi-door-closed' };
            if (dClass === 'battery') conf = { type: 'sensor', size: '(1x1)', icon: 'mdi-battery' };
            if (dClass === 'temperature') conf = { type: 'sensor', size: '(1x1)', icon: 'mdi-thermometer' };
            if (domain === 'input_boolean') conf = SMART_MAP['switch'];

            // Aplikuj
            document.getElementById('w-type').value = conf.type;
            document.getElementById('w-size').value = conf.size;
            document.getElementById('w-name').value = formatSmartName(id, fName);
            document.getElementById('w-icon').value = conf.icon || '';
            document.getElementById('w-icon-on').value = conf.iconOn || '';
            document.getElementById('w-icon-off').value = conf.iconOff || '';

            toggleInputs();
            updateIconPreview();
        }

        function autoNameNav() {
            if(blockSmart) return;
            const val = document.getElementById('w-dash').value;
            document.getElementById('w-name').value = val.toUpperCase();
        }

        // --- 4. PODGLƒÑD ZE STANAMI (REAL-TIME) ---
        
        function getRealState(w) {
            const type = w.type;
            const id = (w.id || '');
            // Szukamy w danych pobranych z Pythona
            const ent = entitiesData.find(e => e.id === id);

            if (!ent) return "---"; // Brak encji

            const val = ent.state;
            const unit = ent.unit || "";

            // Mapowanie stan√≥w (PL)
            if (val === 'on') return "W≈ÅƒÑCZONE";
            if (val === 'off') return "WY≈ÅƒÑCZONE";
            if (val === 'open') return "OTWARTE";
            if (val === 'closed') return "ZAMKNIƒòTE";
            if (val === 'locked') return "ZAMKNIƒòTE";
            if (val === 'unlocked') return "OTWARTE";
            if (val === 'playing') return "ODTWARZA";
            if (val === 'paused') return "PAUZA";
            if (val === 'idle') return "BEZCZYNNY";
            
            // Liczby (np. 21.567 -> 21.6)
            if (!isNaN(parseFloat(val)) && val.includes('.')) {
                return parseFloat(val).toFixed(1) + " " + unit;
            }
            
            return val + " " + unit;
        }

        function saveWidget() {
            const w = {
                type: document.getElementById('w-type').value,
                id: document.getElementById('w-id').value,
                dash: document.getElementById('w-dash').value,
                name: document.getElementById('w-name').value,
                size: document.getElementById('w-size').value,
                icon: document.getElementById('w-icon').value,
                icon_on: document.getElementById('w-icon-on').value,
                icon_off: document.getElementById('w-icon-off').value
            };
            if(w.type === 'navigate') w.id = 'navigate.' + w.dash;
            if(w.type === 'spacer') w.id = 'spacer';

            if(editIdx) {
                rows[editIdx.r][editIdx.w] = w;
                cancelEdit();
            } else {
                rows[rows.length-1].push(w);
                clearForm();
                blockSmart = false;
            }
            renderPreview();
        }

        function renderPreview() {
            const container = document.getElementById('preview-container');
            container.innerHTML = '';

            rows.forEach((row, rI) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'eink-row';
                
                const label = document.createElement('div');
                label.className = 'row-label';
                label.innerText = 'WIERSZ ' + (rI + 1);
                rowDiv.appendChild(label);

                row.forEach((w, wI) => {
                    const div = document.createElement('div');
                    div.className = 'eink-widget';
                    if(editIdx && editIdx.r === rI && editIdx.w === wI) div.classList.add('editing');

                    let cols = 2, rw = 1; // Domy≈õlnie 2x1
                    if(w.size) {
                        const parts = w.size.replace(/[()]/g, '').split('x');
                        cols = parseInt(parts[0]);
                        rw = parseInt(parts[1]);
                    }
                    
                    // Skalowanie (115px + 8px margines)
                    const width = (cols * 115) + ((cols - 1) * 8);
                    const height = (rw * 115) + ((rw - 1) * 8);
                    
                    div.style.width = width + 'px';
                    div.style.height = height + 'px';

                    if(w.type === 'spacer') {
                        div.style.border = '1px dashed #aaa';
                        div.style.boxShadow = 'none';
                        div.style.opacity = '0.5';
                        div.innerHTML = '<span style="font-size:10px; color:#999;">SPACER</span>';
                    } else {
                        const icon = w.icon || w.icon_on || 'mdi-cube-outline';
                        const realState = getRealState(w); // TU POBIERAMY STAN
                        
                        div.innerHTML = `
                            <div class="ew-header">${w.type}</div>
                            <div class="ew-title">${w.name || w.id}</div>
                            <i class="mdi ${icon} ew-icon"></i>
                            <div class="ew-value">${realState}</div>
                            <div class="ew-del" onclick="deleteWidget(${rI}, ${wI}, event)">X</div>
                        `;
                    }
                    div.onclick = () => editWidget(rI, wI);
                    rowDiv.appendChild(div);
                });
                container.appendChild(rowDiv);
            });
        }

        function editWidget(r, w) {
            blockSmart = true; 
            editIdx = {r, w};
            const data = rows[r][w];
            document.getElementById('editor-box').classList.add('editing');
            document.getElementById('btn-cancel').classList.remove('hidden');
            document.getElementById('editor-title').innerText = "Edytuj Widget";
            document.getElementById('btn-submit').innerText = "ZAPISZ ZMIANY";

            document.getElementById('w-type').value = data.type;
            toggleInputs();

            if(data.type === 'navigate') document.getElementById('w-dash').value = data.id.replace('navigate.', '');
            else document.getElementById('w-id').value = data.id;

            document.getElementById('w-name').value = data.name;
            document.getElementById('w-size').value = data.size || '(2x1)';
            document.getElementById('w-icon').value = data.icon || '';
            document.getElementById('w-icon-on').value = data.icon_on || '';
            document.getElementById('w-icon-off').value = data.icon_off || '';
            updateIconPreview();
            setTimeout(() => blockSmart = false, 500);
        }

        function cancelEdit() {
            editIdx = null;
            blockSmart = false;
            document.getElementById('editor-box').classList.remove('editing');
            document.getElementById('btn-cancel').classList.add('hidden');
            document.getElementById('editor-title').innerText = "Dodaj Widget";
            document.getElementById('btn-submit').innerText = "+ DODAJ WIDGET";
            clearForm();
        }

        function clearForm() {
            document.getElementById('w-id').value = '';
            document.getElementById('w-name').value = '';
            document.getElementById('w-icon').value = '';
            document.getElementById('w-icon-on').value = '';
            document.getElementById('w-icon-off').value = '';
            updateIconPreview();
        }

        function deleteWidget(r, w, e) {
            e.stopPropagation();
            rows[r].splice(w, 1);
            if(editIdx && editIdx.r === r && editIdx.w === w) cancelEdit();
            renderPreview();
        }

        function addRow() {
            rows.push([]);
            renderPreview();
        }

        function submitData() {
            document.getElementById('layout_json').value = JSON.stringify(rows);
            document.getElementById('main-form').submit();
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark-mode');
            localStorage.setItem('joan_theme', isDark ? 'dark' : 'light');
            document.getElementById('btn-theme').innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        function importYaml() {
            const text = document.getElementById('import-code').value;
            if(!text) return;
            blockSmart = true;
            
            const lines = text.split('\n');
            const newRows = [];
            let inLayout = false;
            let rawDefs = {};
            let currentDefKey = null;

            // Parsowanie definicji
            lines.forEach(line => {
                const tr = line.trim();
                if(!tr || tr.startsWith('#')) return;

                if (line.match(/^\S+:/) && !line.startsWith('layout:') && !line.startsWith('global_parameters:')) {
                    currentDefKey = line.split(':')[0].trim();
                    rawDefs[currentDefKey] = {};
                } else if (currentDefKey && (line.startsWith('  ') || line.startsWith('\t'))) {
                    const parts = tr.split(':');
                    if(parts.length >= 2) {
                        const key = parts[0].trim();
                        let val = parts.slice(1).join(':').trim().replace(/['"]/g, '');
                        rawDefs[currentDefKey][key] = val;
                    }
                } else if (!line.startsWith('  ') && !line.startsWith('\t')) {
                    currentDefKey = null;
                }
            });
            
            importedDefsMap = rawDefs;

            // Parsowanie layoutu
            lines.forEach(line => {
                const tr = line.trim();
                if(tr.startsWith('layout:')) { inLayout = true; return; }
                
                if(inLayout && tr.startsWith('-')) {
                    const content = tr.substring(1).trim();
                    const widgets = content.split(',').map(s => s.trim());
                    const rowData = [];
                    widgets.forEach(wStr => {
                        let id = wStr;
                        let size = '(2x1)';
                        const sizeMatch = wStr.match(/\(\d+x\d+\)/);
                        if(sizeMatch) {
                            size = sizeMatch[0];
                            id = wStr.replace(size, '').trim();
                        }
                        
                        let type = 'switch';
                        let name = id;
                        let icon = '';
                        let icon_on = '';
                        let icon_off = '';

                        const def = rawDefs[id];
                        if(def) {
                            if(def.widget_type) type = def.widget_type;
                            if(def.title) name = def.title;
                            if(def.icon) icon = def.icon;
                            if(def.icon_on) icon_on = def.icon_on;
                            if(def.icon_off) icon_off = def.icon_off;
                        } else {
                            if(id === 'spacer') type = 'spacer';
                            else if(id.startsWith('navigate.')) type = 'navigate';
                            else if(id.startsWith('sensor.')) type = 'sensor';
                        }

                        rowData.push({
                            id: id, type: type, size: size, name: name, 
                            icon: icon, icon_on: icon_on, icon_off: icon_off
                        });
                    });
                    newRows.push(rowData);
                }
                
                if(inLayout && tr.length > 0 && !tr.startsWith('-') && !tr.startsWith(' ') && !tr.startsWith('layout:')) {
                    inLayout = false;
                }
            });
            
            if(newRows.length > 0) {
                rows = newRows;
                renderPreview();
                alert("Pomy≈õlnie zaimportowano uk≈Çad.");
            } else {
                alert("B≈ÇƒÖd: Nie znaleziono sekcji 'layout:' w kodzie.");
            }
            setTimeout(() => blockSmart = false, 1000);
        }

        // --- START ---
        window.addEventListener('DOMContentLoaded', () => {
            const host = window.location.hostname;
            const pathEl = document.getElementById('path-code');
            const linkEl = document.getElementById('dashboard-link');
            
            if(pathEl) pathEl.innerText = pathEl.innerText.replace('IP_HA', host);
            if(linkEl) {
                const rawHref = linkEl.getAttribute('href');
                if (rawHref.includes('[HOST]')) {
                    const newHref = rawHref.replace(/\[HOST\]/g, host);
                    linkEl.setAttribute('href', newHref);
                    linkEl.innerText = newHref;
                }
            }

            const savedTheme = localStorage.getItem('joan_theme') || 'light';
            document.getElementById('btn-theme').innerText = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            
            if(rows.length === 1 && rows[0].length === 0) {
                // Pusty start
            } else {
                renderPreview();
            }
        });
    </script>
</body>
</html>
