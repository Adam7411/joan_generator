<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Joan 6 E-Ink Generator</title>

  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet" />

  <style>
    :root { --bg-color:#e0e0e0; --container-bg:#ffffff; --text-color:#333; --border-color:#ddd; --accent-color:#d32f2f; --input-bg:#fff; --section-bg:#fafafa; --preview-bg:#f0f0f0; --link-bg:#ffffff; --link-color:#0056b3; --link-border:#bee5eb; }
    body.dark-mode { --bg-color:#121212; --container-bg:#1e1e1e; --text-color:#e0e0e0; --border-color:#333; --accent-color:#ff5252; --input-bg:#2c2c2c; --section-bg:#252525; --preview-bg:#121212; --link-bg:#1e1e1e; --link-color:#80d8ff; --link-border:#37474f; }
    body { font-family:'Roboto',sans-serif; background:var(--bg-color); color:var(--text-color); padding:20px; transition:background-color 0.3s; }
    .container { max-width:1250px; margin:0 auto; background:var(--container-bg); padding:25px; border-radius:10px; box-shadow:0 4px 15px rgba(0,0,0,.1); transition:background-color 0.3s; }
    .header-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:2px solid var(--border-color); padding-bottom:15px; }
    h1 { color:var(--accent-color); margin:0; font-size:24px; font-weight:900; }
    .controls { display:flex; gap:10px; }
    .controls button { padding:8px 14px; border:1px solid var(--border-color); background:var(--section-bg); color:var(--text-color); cursor:pointer; border-radius:6px; font-weight:700; }
    .controls button.active { background:var(--accent-color); color:#fff; border-color:var(--accent-color); }
    .status-bar { padding:10px; border-radius:6px; font-weight:700; margin-bottom:20px; }
    .section { margin-bottom:28px; padding:20px; border:1px solid var(--border-color); border-radius:10px; background:var(--section-bg); }
    .section-title { font-weight:900; font-size:1.15em; margin:0 0 15px; padding:0 0 6px; border-bottom:2px solid var(--accent-color); color:var(--text-color); }
    .import-box { display:none; } .import-box.visible { display:block; }
    label { display:block; font-size:.9em; font-weight:700; margin:10px 0 6px; color:var(--text-color); }
    input,select,textarea { width:100%; padding:10px; border:1px solid var(--border-color); border-radius:6px; box-sizing:border-box; background:var(--input-bg); color:var(--text-color); }
    .add-widget-box { background:#e3f2fd; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #2196f3; color:#000; transition:background 0.3s; }
    body.dark-mode .add-widget-box { background:#0d47a1; border-color:#1565c0; color:#fff; }
    .add-widget-box.editing { background:#fff8e1; border-color:#ffc107; border:2px solid #ffc107; }
    body.dark-mode .add-widget-box.editing { background:#3e2723; border-color:#ffb300; }
    .flex-row { display:flex; gap:15px; align-items:flex-end; margin-bottom:10px; flex-wrap:wrap; }
    .flex-col { flex:1; min-width:170px; }
    .icon-preview-box { width:46px; height:46px; background:#fff; border:1px solid #ccc; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:26px; color:#333; }
    .btn { padding:10px 18px; border:none; cursor:pointer; border-radius:6px; font-weight:700; text-transform:uppercase; }
    .btn-primary { background:var(--accent-color); color:#fff; width:100%; font-size:18px; margin-top:10px; }
    .btn-add { background:#4caf50; color:#fff; }
    .btn-update { background:#ff9800; color:#fff; }
    .btn-cancel { background:#9e9e9e; color:#fff; margin-left:10px; }
    .btn-row { background:#2196f3; color:#fff; margin-top:10px; }
    .btn-import { background:#ff9800; color:#fff; margin-bottom:10px; }
    .btn-remove-row { font-size:11px; padding:4px 8px; margin-left:auto; background:#757575; color:#fff; border-radius:4px; position:absolute; right:6px; top:6px; z-index:20; }
    .preview-area { background:var(--preview-bg); padding:20px; border-radius:8px; border:2px solid var(--border-color); overflow-x:auto; min-height:240px; }
    .eink-row { display:flex; gap:10px; margin-bottom:10px; padding:14px 10px; border:2px dashed #999; background:transparent; border-radius:6px; align-items:center; position:relative; min-height:80px; cursor:pointer; }
    .eink-row:hover { border-color:#2196f3; }
    .eink-row.active { border-color:#2196f3; background:rgba(33, 150, 243, 0.1); }
    .eink-widget { background:#FFFFFF; border:2px solid #000; color:#000; display:flex; flex-direction:column; align-items:center; justify-content:space-between; padding:6px 4px; box-sizing:border-box; position:relative; cursor:pointer; box-shadow:2px 2px 5px rgba(0,0,0,0.12); border-radius:6px; min-width:120px; min-height:108px; transition:.1s; }
    .eink-widget:hover { transform:translateY(-2px); box-shadow:4px 4px 8px rgba(0,0,0,0.2); z-index:5; }
    .eink-widget.being-edited { border:3px solid #ff9800; transform:scale(1.03); z-index:10; }
    .ew-title { font-size:12px; font-weight:700; text-align:center; width:100%; white-space:normal; line-height:1.2; min-height:30px; padding:0 4px; display:flex; align-items:center; justify-content:center; }
    .ew-icon { font-size:30px; margin:6px 0; }
    .ew-state { font-size:11px; font-weight:700; text-transform:uppercase; min-height:18px; display:flex; align-items:center; }
    .ew-delete { position:absolute; top:4px; right:4px; background:red; color:#fff; width:20px; height:20px; text-align:center; line-height:18px; font-size:10px; display:none; border-radius:4px; z-index:20; }
    .eink-widget:hover .ew-delete { display:block; }
    textarea.output { width:100%; min-height:520px; font-family:monospace; background:#263238; color:#eceff1; border:none; padding:15px; border-radius:4px; white-space:pre; }
    .file-path-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; padding: 20px; margin-bottom: 20px; border-radius: 6px; font-family: monospace; font-size: 16px; line-height: 1.6; }
    body.dark-mode .file-path-info { background: #263238; color: #eceff1; border-color: #37474f; }
    .file-path-info strong { font-size: 1.1em; display:block; margin-top:10px; color: #004085; }
    body.dark-mode .file-path-info strong { color:#90caf9; }
    .file-path-info code { background: rgba(255,255,255,0.6); padding: 5px 10px; border-radius: 4px; font-weight: bold; color: #d63384; display: block; margin-top: 5px; word-break: break-all; }
    body.dark-mode .file-path-info code { background: rgba(0,0,0,0.3); color: #f48fb1; }
    .dashboard-link-btn { background: var(--link-bg); padding: 10px 15px; border-radius: 6px; font-weight: bold; color: var(--link-color); text-decoration: none; display: block; margin-top: 10px; word-break: break-all; border: 2px solid var(--link-border); font-size: 1.0em; }
    .dashboard-link-btn:hover { background-color: #f0f0f0; text-decoration: underline; }
    body.dark-mode .dashboard-link-btn:hover { background-color: #444; }
    .hidden { display:none !important; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-row">
      <h1>Joan 6 E-Ink Generator</h1>
      <div class="controls">
        <button id="btn-theme" onclick="toggleTheme()" title="Theme">üåô</button>
        <button id="btn-pl" onclick="setLang('pl')" class="active">PL</button>
        <button id="btn-en" onclick="setLang('en')">EN</button>
      </div>
    </div>

    {% if entities %}
      <div class="status-bar" style="background:#d4edda;color:#155724;">
        <span data-i18n="status_ok">‚úì Po≈ÇƒÖczono z Home Assistant</span> ({{ entities|length }})
      </div>
    {% else %}
      <div class="status-bar" style="background:#f8d7da;color:#721c24;">
        <span data-i18n="status_error">‚ö† Brak po≈ÇƒÖczenia z API. Sprawd≈∫ token.</span>
      </div>
    {% endif %}

    <button type="button" class="btn btn-import" onclick="toggleImport()">
      <span data-i18n="btn_import_toggle">üìÇ Importuj / Edytuj Kod</span>
    </button>

    <div id="import-area" class="section import-box">
      <h4 style="margin-top:0" data-i18n="header_paste_code">Wklej kod pliku .dash tutaj:</h4>
      <textarea id="import-code" style="height:150px;background:#fff;color:#000;" placeholder="Wklej ca≈Çy plik .dash..."></textarea>
      <button type="button" class="btn btn-add" onclick="importYaml()">
        <span data-i18n="btn_load_dash">Wczytaj Dashboard</span>
      </button>
    </div>

    <form id="main-form" onsubmit="prepareAndSubmit(event)">
      <input type="hidden" name="ui_language" id="ui_language" value="pl" />
      <input type="hidden" name="ui_theme" id="ui_theme" value="light" />
      <input type="hidden" name="layout_data_json" id="layout_data_json" />
      <input type="hidden" name="widgets_full_json" id="widgets_full_json" />
      <input type="hidden" name="generated_yaml_client" id="generated_yaml_client" />

      <div class="section">
        <div class="section-title" data-i18n="sec_settings">1. Ustawienia</div>
        <div class="flex-row">
          <div class="flex-col">
            <label data-i18n="dash_title">Tytu≈Ç Dashboardu (Nazwa pliku)</label>
            <input type="text" id="dash-title" value="Dashboard" />
          </div>
        </div>
      </div>

      <div class="add-widget-box" id="widget-form-box">
        <h4 style="margin-top:0" id="form-header" data-i18n="sec_add">2. Dodaj / Edytuj Widget</h4>

        <div class="flex-row">
          <div class="flex-col">
            <label data-i18n="label_type">Typ Widgetu</label>
            <select id="new-widget-type" onchange="applySmartForForm(true)">
              <!-- Generowane przez JS -->
            </select>
          </div>

          <div class="flex-col" id="group-entity">
            <label data-i18n="label_entity">Wybierz Encjƒô (Home Assistant)</label>
            <input
              list="entities-list"
              id="new-entity-id"
              placeholder="np. light.salon"
              autocomplete="off"
              oninput="applySmartForForm(true)"
            />
            <datalist id="entities-list">
              {% for entity in entities %}
              <option value="{{ entity.id }}">{{ entity.id }}</option>
              {% endfor %}
            </datalist>
          </div>

          <div class="flex-col hidden" id="group-nav">
            <label data-i18n="label_dashboard">Nazwa pliku dashboardu</label>
            <input id="new-dashboard-name" placeholder="np. joan3" oninput="applySmartForForm(true)" />
          </div>

          <div class="flex-col">
            <label data-i18n="label_name">Tytu≈Ç na ekranie</label>
            <input id="new-widget-name" placeholder="Automatycznie" />
          </div>
        </div>

        <div class="flex-row" style="margin-top:10px; align-items:flex-end;">
          <div class="flex-col" style="max-width:160px;">
            <label data-i18n="label_size">Rozmiar</label>
            <select id="new-widget-size">
              <option value="">Domy≈õlny (2x1)</option>
              <option value="(1x1)">1x1</option>
              <option value="(2x1)">2x1</option>
              <option value="(2x2)">2x2</option>
              <option value="(3x1)">3x1</option>
              <option value="(1x2)">1x2</option>
              <option value="(3x2)">3x2</option>
            </select>
          </div>

          <div style="width:56px;">
            <label data-i18n="label_preview">PodglƒÖd</label>
            <div class="icon-preview-box">
              <i id="icon-preview-i" class="mdi mdi-help-circle-outline"></i>
            </div>
          </div>

          <div class="flex-col">
            <label data-i18n="label_icon">Ikona</label>
            <input id="new-widget-icon" list="icons-list" placeholder="np. mdi-lightbulb" oninput="updateIconPreview()" />
            <datalist id="icons-list"></datalist>
          </div>

          <div class="flex-col" style="display:flex; gap:10px; align-items:flex-end;">
            <button type="button" id="btn-action" class="btn btn-add" onclick="saveWidget()">
                <span data-i18n="btn_add">+ DODAJ DO WIERSZA</span>
            </button>
            <button type="button" id="btn-cancel" class="btn btn-cancel hidden" onclick="cancelEdit()">
                <span data-i18n="btn_cancel">Anuluj</span>
            </button>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title" data-i18n="sec_preview">3. PodglƒÖd Dashboardu (Kliknij, aby edytowaƒá)</div>
        <div id="rows-container" class="preview-area"></div>
        <button type="button" class="btn btn-row" onclick="addNewRow()">
            <span data-i18n="btn_new_row">+ Dodaj Nowy Wiersz</span>
        </button>
      </div>

      <button type="submit" class="btn btn-primary"><span data-i18n="btn_generate">GENERUJ KOD .DASH</span></button>
    </form>

    <div class="section hidden" id="client-yaml-section">
      <h3 data-i18n="sec_code">Tw√≥j kod YAML (Klient):</h3>
      <div class="file-path-info">
        <strong data-i18n="info_step1">1. Zapisz kod w pliku:</strong>
        <code id="client-path-code">\\IP_HA\addon_configs\appdaemon\dashboards\dashboard.dash</code>
        <strong data-i18n="info_step2">2. PodglƒÖd dashboardu:</strong>
        <a id="client-dashboard-link" class="dashboard-link-btn" target="_blank" href="#">Link...</a>
      </div>
      <textarea id="client-yaml-output" class="output" readonly></textarea>
    </div>
  </div>

  <script>
    /* ================= DEFINICJE ZMIENNYCH GLOBALNYCH (NA G√ìRZE) ================= */
    const entitiesData = {{ entities | tojson }};

    // Typy Widget√≥w
    const widgetTypesConfig = [
      { value: 'switch', pl: 'Prze≈ÇƒÖcznik / ≈öwiat≈Ço', en: 'Switch / Light' },
      { value: 'sensor', pl: 'Sensor (Liczba/Tekst)', en: 'Sensor' },
      { value: 'binary_sensor', pl: 'Sensor Binarny', en: 'Binary Sensor' },
      { value: 'cover', pl: 'Roleta / Brama', en: 'Cover / Gate' },
      { value: 'lock', pl: 'Zamek', en: 'Lock' },
      { value: 'person', pl: 'Osoba / Tracker', en: 'Person / Tracker' },
      { value: 'media_player', pl: 'Odtwarzacz', en: 'Media Player' },
      { value: 'climate', pl: 'Klimatyzacja', en: 'Climate' },
      { value: 'script', pl: 'Skrypt', en: 'Script' },
      { value: 'navigate', pl: 'Nawigacja', en: 'Navigate' },
      { value: 'weather', pl: 'Pogoda', en: 'Weather' },
      { value: 'alarm_control_panel', pl: 'Alarm', en: 'Alarm' },
      { value: 'input_number', pl: 'Suwak', en: 'Input Number' },
      { value: 'input_select', pl: 'Lista', en: 'Input Select' },
      { value: 'scene', pl: 'Scena', en: 'Scene' },
      { value: 'fan', pl: 'Wentylator', en: 'Fan' },
      { value: 'clock', pl: 'Zegar', en: 'Clock' },
      { value: 'label', pl: 'Etykieta', en: 'Label' },
      { value: 'reload', pl: 'Od≈õwie≈º', en: 'Reload' }
    ];

    // Stan aplikacji
    let currentLang = 'pl';
    let rows = []; 
    let activeRowIndex = 0;
    let editingIndices = null;
    let importedDefsMap = {};

    // T≈Çumaczenia
    const i18n = {
      pl: {
        status_ok:"‚úì Po≈ÇƒÖczono z Home Assistant", status_error:"‚ö† Brak po≈ÇƒÖczenia z API. Sprawd≈∫ token.",
        sec_settings:"1. Ustawienia", sec_add:"2. Dodaj / Edytuj Widget", sec_preview:"3. PodglƒÖd Dashboardu (Kliknij, aby edytowaƒá)", sec_code:"Tw√≥j kod YAML:",
        dash_title:"Tytu≈Ç Dashboardu (Nazwa pliku)", label_entity:"Wybierz Encjƒô (Home Assistant)", label_dashboard:"Nazwa pliku dashboardu (np. joan3)",
        label_type:"Typ Widgetu", label_name:"Tytu≈Ç na ekranie", label_icon:"Ikona", label_preview:"PodglƒÖd", label_size:"Rozmiar",
        btn_add:"+ DODAJ DO WIERSZA", btn_update:"ZAPISZ ZMIANY", btn_cancel:"Anuluj", btn_new_row:"+ Dodaj Nowy Wiersz", btn_generate:"GENERUJ KOD .DASH",
        btn_import_toggle:"üìÇ Importuj / Edytuj Kod", header_paste_code:"Wklej kod pliku .dash tutaj:", btn_load_dash:"Wczytaj Dashboard",
        info_step1:"1. Zapisz kod w pliku:", info_step2:"2. PodglƒÖd dashboardu:",
        state_on:"W≈ÅƒÑCZONE", state_off:"WY≈ÅƒÑCZONE", state_open:"OTWARTA", state_closed:"ZAMKNIƒòTA",
        state_locked:"ZAMKNIƒòTE", state_unlocked:"OTWARTE", state_home:"W DOMU", state_not_home:"POZA DOMEM"
      },
      en: {
        status_ok:"‚úì Connected to Home Assistant", status_error:"‚ö† No API Connection. Check Token.",
        sec_settings:"1. Settings", sec_add:"2. Add / Edit Widget", sec_preview:"3. Dashboard Preview (Click to Edit)", sec_code:"Your YAML Code:",
        dash_title:"Dashboard Title (Filename)", label_entity:"Select Entity (Home Assistant)", label_dashboard:"Dashboard filename (e.g. joan3)",
        label_type:"Widget Type", label_name:"Title on Screen", label_icon:"Icon", label_preview:"Preview", label_size:"Size",
        btn_add:"+ ADD TO ROW", btn_update:"SAVE CHANGES", btn_cancel:"Cancel", btn_new_row:"+ Add New Row", btn_generate:"GENERATE .DASH CODE",
        btn_import_toggle:"üìÇ Import / Edit Code", header_paste_code:"Paste .dash file here:", btn_load_dash:"Load Dashboard",
        info_step1:"1. Save code to file:", info_step2:"2. Dashboard preview:",
        state_on:"ON", state_off:"OFF", state_open:"OPEN", state_closed:"CLOSED"
      }
    };

    // S≈Çownik ikon
    const smartIconMap = [
      {k:['hydrofor','pump','water pump','zbiornik','tank'],on:'mdi-water-pump',off:'mdi-water-pump-off'},
      {k:['cwu','boiler','woda','water'],on:'mdi-water-outline',off:'mdi-water-off'},
      {k:['grzejnik','radiator','ogrzew','heat'],on:'mdi-radiator',off:'mdi-radiator-off'},
      {k:['gate','brama'],on:'mdi-gate-open',off:'mdi-gate'},
      {k:['garage','garaz','gara≈º'],on:'mdi-garage-open',off:'mdi-garage'},
      {k:['blind','roleta','shutter','okno','window'],on:'mdi-window-shutter-open',off:'mdi-window-shutter'},
      {k:['door','drzwi'],on:'mdi-door-open',off:'mdi-door-closed'},
      {k:['lock','zamek'],on:'mdi-lock-open',off:'mdi-lock'},
      {k:['light','lamp','swiatlo','≈õwiat≈Ço','zarowka','≈ºar√≥wka'],on:'mdi-lightbulb-on',off:'mdi-lightbulb-outline'},
      {k:['fan','wentyl'],on:'mdi-fan',off:'mdi-fan-off'},
      {k:['speaker','radio','media_player','spotify','audio'],on:'mdi-speaker',off:'mdi-speaker-off'},
      {k:['climate','klima','hvac','thermostat','temp','temperatura','temperature'],on:'mdi-thermometer',off:'mdi-thermometer-off'},
      {k:['battery','bateria'],base:'mdi-battery'},
      {k:['wilgotn','humid','humidity'],base:'mdi-water-percent'},
      {k:['pressure','cisnienie','ci≈õnienie'],base:'mdi-gauge'},
      {k:['sensor','czujnik'],base:'mdi-gauge'},
      {k:['power','moc','energia','energy'],base:'mdi-flash'}
    ];

    /* ================== FUNKCJE ================== */

    // 1. Pomocnicze
    function formatNameFromId(id){
      if(!id) return "";
      const last = id.includes('.') ? id.split('.').pop() : id;
      let n = last.replace(/[_\-]+/g,' ').trim();
      n = n.replace(/\b(esp|node|sensor|switch|light|binary sensor|input boolean|media player|climate|script|lock|cover|person|device tracker)\b/gi,'');
      n = n.replace(/\s{2,}/g,' ').trim();
      n = n.toLowerCase().replace(/\b\w/g, l => l.toUpperCase());
      return n || last;
    }

    function ensureMdi(icon){ if(!icon) return ""; return icon.startsWith('mdi-') ? icon : 'mdi-'+icon; }

    function inferTypeFromIdOrEntity(val){
      const v = (val||'').toLowerCase();
      if(v.startsWith('lock.')) return 'lock';
      if(v.startsWith('person.') || v.startsWith('device_tracker.')) return 'person';
      if(v.startsWith('input_number.')) return 'input_number';
      if(v.startsWith('input_select.')) return 'input_select';
      if(v.startsWith('weather.')) return 'weather';
      if(v.startsWith('alarm')) return 'alarm_control_panel';
      if(v.startsWith('sensor.')) return 'sensor';
      if(v.startsWith('binary_sensor.')) return 'binary_sensor';
      if(v.startsWith('cover.')) return 'cover';
      if(v.startsWith('media_player.')) return 'media_player';
      if(v.startsWith('climate.')) return 'climate';
      if(v.startsWith('fan.')) return 'fan';
      if(v.startsWith('script.')) return 'script';
      if(v.startsWith('scene.')) return 'scene';
      if(v.startsWith('light.') || v.startsWith('switch.') || v.startsWith('input_boolean.')) return 'switch';
      if(v.startsWith('navigate.')) return 'navigate';
      return 'switch';
    }

    function findIconPairById(id){
      const lower = (id||'').toLowerCase();
      for(const e of smartIconMap){
        if(e.k && e.k.some(k => lower.includes(k))){
          if(e.on && e.off) return [e.on,e.off];
          if(e.base) return [e.base,e.base];
        }
      }
      return ['mdi-toggle-switch','mdi-toggle-switch-off'];
    }
    function findBaseIconByIdAndType(id,type){
      const lower = (id||'').toLowerCase();
      for(const e of smartIconMap){
        if(e.k && e.k.some(k => lower.includes(k))){
          return ensureMdi(e.base || e.on || 'mdi-help-circle-outline');
        }
      }
      const fallback = {
        switch:'mdi-toggle-switch', binary_sensor:'mdi-alert-circle-outline', sensor:'mdi-gauge',
        cover:'mdi-window-shutter', media_player:'mdi-speaker', climate:'mdi-thermometer',
        script:'mdi-script-text-outline', navigate:'mdi-arrow-right-circle', fan:'mdi-fan',
        label:'mdi-label-outline', light:'mdi-lightbulb', lock:'mdi-lock', person:'mdi-account',
        clock:'mdi-clock-outline', reload:'mdi-refresh', iframe:'mdi-image-area', scene:'mdi-palette'
      };
      return ensureMdi(fallback[type] || 'mdi-help-circle-outline');
    }

    // 2. UI Helpers
    function toggleTheme(){
      const toDark = !document.body.classList.contains('dark-mode');
      document.body.classList.toggle('dark-mode', toDark);
      document.getElementById('btn-theme').innerText = toDark ? '‚òÄÔ∏è' : 'üåô';
      localStorage.setItem('joan_theme', toDark ? 'dark' : 'light');
    }

    function setLang(lang){
      currentLang = lang;
      localStorage.setItem('joan_lang', lang);
      document.getElementById('ui_language').value = lang;
      document.getElementById('btn-pl').classList.toggle('active', lang==='pl');
      document.getElementById('btn-en').classList.toggle('active', lang==='en');
      
      updateWidgetTypeOptions(lang);
      applyTranslations();
      renderRows();
    }

    function updateWidgetTypeOptions(lang) {
      const select = document.getElementById('new-widget-type');
      const currentVal = select.value;
      select.innerHTML = '';
      widgetTypesConfig.forEach(type => {
        const opt = document.createElement('option');
        opt.value = type.value;
        opt.innerText = (lang === 'pl') ? type.pl : type.en;
        select.appendChild(opt);
      });
      if(currentVal) select.value = currentVal; else select.value = 'switch';
    }

    function applyTranslations(){
      const t = i18n[currentLang];
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const k = el.getAttribute('data-i18n');
        if(t[k]) el.innerText = t[k];
      });
      const btn = document.getElementById('btn-action');
      if(btn){
          const span = btn.querySelector('span');
          if(editingIndices) span.innerText = t.btn_update;
          else span.innerText = `${t.btn_add} (${currentLang==='pl'?'Wiersz':'Row'} ${activeRowIndex+1})`;
      }
      const header = document.getElementById('form-header');
      if(header) header.innerText = editingIndices ? t.sec_edit : t.sec_add;
    }

    function updateIconPreview(){
      const icon = document.getElementById('new-widget-icon').value.trim();
      const preview = document.getElementById('icon-preview-i');
      if(preview) preview.className = (icon && icon.startsWith('mdi-')) ? ('mdi '+icon) : 'mdi mdi-help-circle-outline';
    }

    function applySmartForForm(userAction=false){
      const typeSel = document.getElementById('new-widget-type');
      const entityInput = document.getElementById('new-entity-id');
      const nameInput = document.getElementById('new-widget-name');
      const iconInput = document.getElementById('new-widget-icon');
      const groupEntity = document.getElementById('group-entity');
      const groupNav = document.getElementById('group-nav');
      const sizeInput = document.getElementById('new-widget-size');

      if(typeSel.value==='navigate'){
        groupEntity.classList.add('hidden'); groupNav.classList.remove('hidden');
        if(!iconInput.value) iconInput.value='mdi-arrow-right-circle';
        updateIconPreview(); return;
      } else {
        groupEntity.classList.remove('hidden'); groupNav.classList.add('hidden');
      }

      const idRaw = (entityInput.value||'').trim();
      const id = idRaw.toLowerCase();

      // Smart Type
      if(userAction && document.activeElement === entityInput) {
          const newType = inferTypeFromIdOrEntity(id);
          if(typeSel.value === 'switch' && newType !== 'switch') typeSel.value = newType;
      }

      // Smart Size
      if((typeSel.value==='media_player' || typeSel.value==='climate' || typeSel.value==='weather' || typeSel.value==='clock') && !sizeInput.value) sizeInput.value='(2x2)';

      // Smart Name & Icon
      if(userAction || !nameInput.value.trim()){
         const ent = (entitiesData||[]).find(e => e.id === idRaw);
         // Use friendly name or fallback
         nameInput.value = formatNameFromId(idRaw);

         const actionable = ['switch','binary_sensor','cover','media_player','climate','script','fan','light','lock'].includes(typeSel.value) || id.startsWith('input_boolean.');
         if(actionable){
            const pair = findIconPairById(idRaw);
            iconInput.value = pair[0]; 
         } else {
            iconInput.value = findBaseIconByIdAndType(idRaw, typeSel.value);
         }
      }
      updateIconPreview();
    }

    // 3. RENDER & LOGIC
    function getLiveStateText(ent, type){
      if(!ent) return '';
      const raw = String(ent.state).toLowerCase();
      const t = i18n[currentLang];
      if(type==='sensor' || type==='input_number'){
        let val=ent.state;
        if(!isNaN(parseFloat(val)) && String(val).includes('.')) val=parseFloat(val).toFixed(1);
        return ent.unit ? `${val} ${ent.unit}` : val;
      }
      if(['switch','binary_sensor','script','media_player','climate','fan','light','input_boolean','lock'].includes(type) || ent.id?.startsWith?.('input_boolean.')){
        if(['on','playing','open','unlocked','heat','cool','true','1','opening'].includes(raw)) return t.state_on;
        if(['off','closed','locked','idle','stopped','standby','false','0','closing'].includes(raw)) return t.state_off;
        return raw.toUpperCase();
      }
      return ent.state;
    }
    function pickPreviewIcon(widget){
      const ent = (entitiesData||[]).find(e=>e.id===widget.id);
      const actionable = ['switch','binary_sensor','cover','media_player','climate','script','fan','light','lock','input_boolean'].includes(widget.type) || widget.id.startsWith('input_boolean.');
      if(actionable){
        const pair = findIconPairById(widget.id);
        const state = ent ? String(ent.state).toLowerCase() : 'off';
        const isOn = ['on','open','playing','unlocked','heat','cool','true','1','opening','home'].includes(state);
        return ensureMdi(isOn ? (widget.icon_on || pair[0]) : (widget.icon_off || pair[1]));
      }
      return ensureMdi(widget.icon || findBaseIconByIdAndType(widget.id, widget.type));
    }
    function resolveImportedTitle(id) {
        if (importedDefsMap[id] && importedDefsMap[id].title) return importedDefsMap[id].title;
        const shortId = id.split('.').pop();
        if (importedDefsMap[shortId] && importedDefsMap[shortId].title) return importedDefsMap[shortId].title;
        for(let key in importedDefsMap) {
            if(importedDefsMap[key].entity === id && importedDefsMap[key].title) return importedDefsMap[key].title;
        }
        return '';
    }

    function renderRows() {
      const container = document.getElementById('rows-container');
      container.innerHTML='';
      rows.forEach((rowWidgets,index)=>{
        const rowDiv=document.createElement('div');
        rowDiv.className='eink-row';
        rowDiv.id='row-'+index;
        rowDiv.onclick=()=>{ if(editingIndices) cancelEdit(); activeRowIndex=index; highlightActiveRow(); applyTranslations(); };
        const label=document.createElement('div');
        label.style.position='absolute'; label.style.top='-10px'; label.style.left='5px';
        label.style.fontSize='10px'; label.style.fontWeight='900'; label.style.color='#666';
        label.textContent=(currentLang==='pl'?'WIERSZ ':'ROW ')+(index+1);
        rowDiv.appendChild(label);
        if(rows.length>1){
          const del=document.createElement('button');
          del.className='btn-remove-row';
          del.textContent = currentLang==='pl'?'USU≈É':'DELETE';
          del.onclick=(e)=>{ e.stopPropagation(); deleteRow(index); };
          rowDiv.appendChild(del);
        }
        rowWidgets.forEach((widget,wIndex)=>{
          const wDiv=document.createElement('div');
          wDiv.className='eink-widget';
          if(editingIndices && editingIndices.r===index && editingIndices.w===wIndex) wDiv.classList.add('being-edited');
          let w=140,h=110;
          if(widget.size){
            const dims=widget.size.replace(/[()]/g,'').split('x');
            const cols=parseInt(dims[0])||2; const rs=parseInt(dims[1])||1;
            width=(cols*70)+((cols-1)*6);
            height=(rs*90)+((rs-1)*6);
          }
          wDiv.style.width=width+'px'; wDiv.style.height=height+'px';
          wDiv.onclick=(e)=>{ e.stopPropagation(); editWidget(index,wIndex); };
          
          const ent = (entitiesData||[]).find(e=>e.id===widget.id);
          const stateText = getLiveStateText(ent, widget.type);
          const iconClass = pickPreviewIcon(widget);
          let displayTitle = widget.name;
          if (!displayTitle) displayTitle = resolveImportedTitle(widget.id) || formatNameFromId(widget.id);

          wDiv.innerHTML = `<div class="ew-title">${displayTitle}</div><i class="mdi ${iconClass} ew-icon"></i><div class="ew-state">${stateText || ' '}</div><div class="ew-delete" onclick="removeWidget(${index},${wIndex}); event.stopPropagation();">X</div><div class="ew-edit-overlay"></div>`;
          rowDiv.appendChild(wDiv);
        });
        container.appendChild(rowDiv);
      });
      highlightActiveRow();
    }
    function highlightActiveRow(){
      document.querySelectorAll('.eink-row').forEach(el=>el.classList.remove('active'));
      const act = document.getElementById('row-'+activeRowIndex);
      if(act) act.classList.add('active');
    }

    // --- CRUD & IMPORT ---
    function saveWidget(){
        applySmartForForm(false);
        const type = document.getElementById('new-widget-type').value || 'switch';
        let id='';
        if(type==='navigate'){
            const dashName = document.getElementById('new-dashboard-name').value.trim();
            if(!dashName){ alert(currentLang==='pl'?'Wymagana nazwa dashboardu':'Dashboard name required'); return; }
            id = 'navigate.' + dashName;
        }else{
            id = document.getElementById('new-entity-id').value.trim();
            if(!id && type !== 'clock' && type !== 'label' && type !== 'reload'){ alert(currentLang==='pl'?'Wymagana encja':'Entity required'); return; }
            if(!id) id = type + '.' + Date.now(); 
        }
        let name = document.getElementById('new-widget-name').value.trim();
        if(!name && type!=='clock' && type!=='reload') name = formatNameFromId(id);
        let icon = document.getElementById('new-widget-icon').value.trim();
        const size = document.getElementById('new-widget-size').value;
        const actionable = ['switch','binary_sensor','cover','media_player','climate','script','fan','light','lock'].includes(type) || id.toLowerCase().startsWith('input_boolean.');
        let icon_on='', icon_off='';
        if(actionable){
            const pair = findIconPairById(id);
            icon_on = ensureMdi(pair[0]);
            icon_off = ensureMdi(pair[1]);
            icon = '';
        }else{
            if(!icon) icon = ensureMdi(findBaseIconByIdAndType(id, type));
        }
        const widget = { id, type, name, icon: ensureMdi(icon), icon_on, icon_off, size };
        if(editingIndices){ rows[editingIndices.r][editingIndices.w] = widget; editingIndices=null; document.getElementById('btn-cancel').classList.add('hidden'); document.getElementById('widget-form-box').classList.remove('editing'); }
        else{ if(!rows.length) addNewRow(); rows[activeRowIndex].push(widget); }
        clearFormInputs(); renderRows(); applyTranslations();
    }

    function editWidget(r,w){
        editingIndices={r,w};
        const widget = rows[r][w];
        activeRowIndex=r; highlightActiveRow();
        document.getElementById('new-widget-type').value = widget.type;
        const groupEntity = document.getElementById('group-entity');
        const groupNav = document.getElementById('group-nav');
        if(widget.type==='navigate'){
            groupEntity.classList.add('hidden'); groupNav.classList.remove('hidden');
            document.getElementById('new-dashboard-name').value = widget.id.replace('navigate.','');
            document.getElementById('new-entity-id').value = '';
        }else{
            groupEntity.classList.remove('hidden'); groupNav.classList.add('hidden');
            document.getElementById('new-dashboard-name').value = '';
            document.getElementById('new-entity-id').value = widget.id.includes(widget.type+'.') && !widget.id.includes('_') ? '' : widget.id;
        }
        document.getElementById('new-widget-name').value = widget.name;
        document.getElementById('new-widget-icon').value = widget.icon || widget.icon_on || '';
        document.getElementById('new-widget-size').value = widget.size || '';
        document.getElementById('btn-cancel').classList.remove('hidden');
        document.getElementById('widget-form-box').classList.add('editing');
        updateIconPreview(); applyTranslations(); renderRows();
    }

    function cancelEdit(){ editingIndices=null; document.getElementById('btn-cancel').classList.add('hidden'); document.getElementById('widget-form-box').classList.remove('editing'); clearFormInputs(); applyTranslations(); renderRows(); }
    function clearFormInputs(){ ['new-dashboard-name','new-entity-id','new-widget-name','new-widget-icon','new-widget-size'].forEach(id=>document.getElementById(id).value=''); updateIconPreview(); }
    function removeWidget(r,w){ if(editingIndices && editingIndices.r===r && editingIndices.w===w) cancelEdit(); rows[r].splice(w,1); renderRows(); }
    function addNewRow(){ rows.push([]); activeRowIndex=rows.length-1; renderRows(); applyTranslations(); }
    function deleteRow(rowIndex){ if(editingIndices && editingIndices.r===rowIndex) cancelEdit(); rows.splice(rowIndex,1); if(activeRowIndex>=rows.length) activeRowIndex=rows.length-1; renderRows(); applyTranslations(); }

    function toggleImport(){ document.getElementById('import-area').classList.toggle('visible'); }
    function importYaml(){
        const code = document.getElementById('import-code').value;
        if(!code) return;
        try{
            const lines = code.split('\n');
            let parsingLayout=false, currentKey=null, globalTitleSet=false;
            const layoutLines=[]; const defs={};
            const ignore=['global_parameters','widget_dimensions','widget_size','widget_margins','columns','rows','skin'];
            for(const raw of lines){
                const cut = raw.split('#')[0]; const line = (cut||'').trim(); if(!line) continue;
                if(!parsingLayout && /^title\s*:/i.test(line) && !globalTitleSet){
                    const val = line.split(':').slice(1).join(':').trim().replace(/^["']|["']$/g,'');
                    if(val) document.getElementById('dash-title').value = val;
                    globalTitleSet=true; continue;
                }
                if(/^layout\s*:/i.test(line)){ parsingLayout=true; continue; }
                if(parsingLayout){
                    if(line.startsWith('-')){ layoutLines.push(line); continue; }
                    if(/^[A-Za-z0-9_.-]+\s*:/i.test(line)){ parsingLayout=false; }
                }
                const root = line.match(/^([A-Za-z0-9_.-]+)\s*:/);
                if(root){
                    const key = root[1];
                    if(!ignore.includes(key)){ currentKey=key; defs[key]=defs[key]||{}; } else currentKey=null;
                    continue;
                }
                if(currentKey && line.includes(':')){
                    const k = line.split(':')[0].trim();
                    let v = line.substring(line.indexOf(':')+1).trim().replace(/^["']|["']$/g,'');
                    defs[currentKey][k]=v;
                }
            }
            importedDefsMap={};
            Object.entries(defs).forEach(([k,v])=>{ importedDefsMap[k]=v; if(v.entity) importedDefsMap[v.entity]=v; });
            rows=[];
            layoutLines.forEach(l=>{
                const content = l.replace(/^-+\s*/,'').trim();
                const items = content.split(',').map(x=>x.trim()).filter(Boolean);
                const rowWidgets=[];
                items.forEach(item=>{
                    const sizeMatch = item.match(/\(\d+x\d+\)/);
                    const size = sizeMatch ? sizeMatch[0] : '';
                    const rawId = item.replace(size,'').trim();
                    const def = importedDefsMap[rawId] || importedDefsMap[rawId.split('.').pop()] || {};
                    const sourceEntity = def.entity || rawId;
                    let type = def.widget_type || inferTypeFromIdOrEntity(sourceEntity);
                    let name = resolveImportedTitle(rawId);
                    if(!name && def.title) name = def.title;
                    if(!name) name = formatNameFromId(rawId);
                    let icon = ensureMdi(def.icon || def.icon_inactive || '');
                    let icon_on = ensureMdi(def.icon_on || def.icon_active || '');
                    let icon_off = ensureMdi(def.icon_off || def.icon_inactive || '');
                    const actionable = ['switch','binary_sensor','cover','media_player','climate','script','fan','light','lock'].includes(type) || sourceEntity.startsWith('input_boolean.');
                    if(actionable){
                        const pair = findIconPairById(sourceEntity);
                        if(!icon_on) icon_on = ensureMdi(pair[0]);
                        if(!icon_off) icon_off = ensureMdi(pair[1]);
                    }else{
                        if(!icon) icon = ensureMdi(findBaseIconByIdAndType(sourceEntity, type));
                    }
                    rowWidgets.push({ id: sourceEntity, type, name, icon, icon_on, icon_off, size });
                });
                if(rowWidgets.length) rows.push(rowWidgets);
            });
            if(!rows.length){ alert(currentLang==='pl'?'Brak layout':'No layout found'); return; }
            activeRowIndex=rows.length-1; renderRows(); applyTranslations(); toggleImport(); alert(currentLang==='pl'?'Import zako≈Ñczony':'Import completed');
        }catch(e){ alert((currentLang==='pl'?'B≈ÇƒÖd importu: ':'Import error: ')+e.message); }
    }

    // --- GENERATE ---
    function prepareAndSubmit(e){
      e.preventDefault();
      try{
        const title = (document.getElementById('dash-title').value || 'Dashboard').replace(/"/g,'');
        const yaml = [buildHeader(title), buildLayout(), buildWidgetsSection()].join("\n");
        document.getElementById('generated_yaml_client').value = yaml;
        document.getElementById('widgets_full_json').value = JSON.stringify(rows);
        document.getElementById('layout_data_json').value = JSON.stringify(rows.map(r=>r.map(w=>w.id+(w.size? " "+w.size:""))));
        const host = window.location.hostname;
        const sec = document.getElementById('client-yaml-section');
        sec.classList.remove('hidden');
        document.getElementById('client-yaml-output').value = yaml;
        document.getElementById('client-path-code').innerText = `\\\\${host}\\addon_configs\\appdaemon\\dashboards\\${title.toLowerCase().replace(/\s+/g,'_')}.dash`;
        const link = `http://${host}:5050/${title.toLowerCase().replace(/\s+/g,'_')}`;
        const linkEl = document.getElementById('client-dashboard-link');
        linkEl.href = link; linkEl.innerText = link;
        sec.scrollIntoView({ behavior: "smooth" });
      }catch(err){ console.error(err); alert("B≈ÇƒÖd generowania: " + err.message); }
    }
    function buildHeader(title){
      return [
        "# --- JOAN 6 E-INK DASHBOARD ---", `# File: ${title.toLowerCase().replace(/\s+/g,'_')}.dash`, "# Location: \\\\IP_HA\\addon_configs\\appdaemon\\dashboards\\", "# --------------------------------", "", `title: ${title}`, "widget_dimensions: [117, 117]", "widget_size: [2, 1]", "widget_margins: [8, 8]", "columns: 6", `rows: ${(rows.length||8)} # auto`, "global_parameters:", "  refresh: 0", "  use_comma: 0", "  precision: 1", "  use_hass_icon: 1", "  namespace: default", "  state_text: 1", "  white_text_style: \"color: #000000 !important; font-weight: 700 !important;\"", "  state_text_style: \"color: #000000 !important; font-weight: 700 !important; font-size: 16px !important;\"", "  widget_style: \"color: #000000 !important; background-color: #FFFFFF !important; border: 2px solid #000000 !important;\"", "skin: simplyred", "", "layout:"
      ].join("\n");
    }
    function buildLayout(){ return rows.map(r=>"  - "+r.map(w=>w.id+(w.size? " "+w.size:"")).join(", ")).join("\n"); }
    function buildWidgetsSection(){
      const seen = new Set(); const defs = []; defs.push("# --- DEFINICJE WID≈ªET√ìW ---");
      rows.flat().forEach(w => { if(seen.has(w.id)) return; seen.add(w.id); defs.push(widgetYaml(w)); });
      return defs.join("\n\n");
    }
    function widgetYaml(w){
      const t=i18n[currentLang];
      const lines=[]; lines.push(`${w.id}:`); lines.push(`  widget_type: ${w.type==='fan'?'switch':w.type}`);
      if(w.type==='navigate'){
        lines.push(`  title: "${w.name.replace(/"/g,'\\"')}"`); lines.push(`  dashboard: ${w.id.replace('navigate.','')}`);
        lines.push(`  icon_inactive: ${ensureMdi(w.icon||'mdi-arrow-right-circle')}`);
        lines.push(`  title_style: "color:#000; font-size:24px; font-weight:700; text-align:center; padding-top:5px; width:100%;"`);
        lines.push(`  widget_style: "background-color:#FFFFFF !important; border-radius:8px !important; padding:10px !important; color:#000 !important;"`);
        return lines.join("\n");
      }
      if(w.type==='label'){
        lines.push(`  text: "${w.name.replace(/"/g,'\\"')}"`);
        lines.push(`  widget_style: "background-color:#FFFFFF !important; color:#000 !important;"`);
        lines.push(`  text_style: "color:#000 !important; font-size:24px; font-weight:bold;"`);
        return lines.join("\n");
      }
      if(w.type==='clock'){
        lines.push(`  time_format: 24hr`); lines.push(`  show_seconds: 0`);
        lines.push(`  date_style: "color:#000 !important;"`); lines.push(`  time_style: "color:#000 !important; font-size:40px !important;"`);
        lines.push(`  widget_style: "background-color:#FFFFFF !important; color:#000 !important;"`);
        return lines.join("\n");
      }
      lines.push(`  entity: ${w.id}`); lines.push(`  title: "${w.name.replace(/"/g,'\\"')}"`);
      const actionable = ['switch','binary_sensor','cover','media_player','climate','script','fan','light','lock'].includes(w.type) || w.id.startsWith('input_boolean.');
      if(actionable){
        const pair = findIconPairById(w.id);
        lines.push(`  icon_on: ${ensureMdi(w.icon_on||pair[0])}`); lines.push(`  icon_off: ${ensureMdi(w.icon_off||pair[1])}`);
        lines.push(`  state_text: 1`);
        lines.push(`  title_style: "color:#000; font-size:20px; font-weight:700; text-align:center; padding-top:3px; width:100%;"`);
        lines.push(`  text_style: "color:#000 !important; font-weight:700 !important;"`);
        lines.push(`  widget_style: "color:#000 !important; background-color:#FFFFFF !important; border:2px solid #000 !important;"`);
        lines.push(`  state_map:`);
        if(w.type==='cover'){ lines.push(`    "open": "${t.state_open}"`); lines.push(`    "closed": "${t.state_closed}"`); }
        else if(w.type==='lock'){ lines.push(`    "locked": "${t.state_locked}"`); lines.push(`    "unlocked": "${t.state_unlocked}"`); }
        else { lines.push(`    "on": "${t.state_on}"`); lines.push(`    "off": "${t.state_off}"`); }
        lines.push(`  icon_style_active: "color:#000 !important;"`); lines.push(`  icon_style_inactive: "color:#000 !important;"`);
      } else if(w.type==='sensor'){
        lines.push(`  icon: ${ensureMdi(w.icon||findBaseIconByIdAndType(w.id,'sensor'))}`);
        lines.push(`  title_style: "color:#000; font-size:20px; font-weight:700; text-align:center; padding-top:5px; width:100%;"`);
        lines.push(`  text_style: "color:#000 !important;"`);
        lines.push(`  value_style: "color:#000 !important; font-size:44px !important; font-weight:700 !important;"`);
        lines.push(`  unit_style: "color:#000 !important;"`);
        lines.push(`  widget_style: "color:#000 !important; background-color:#FFFFFF !important;"`);
      } else {
        lines.push(`  icon: ${ensureMdi(w.icon||findBaseIconByIdAndType(w.id,w.type))}`);
        lines.push(`  title_style: "color:#000; font-size:20px; font-weight:700; text-align:center; padding-top:3px; width:100%;"`);
        lines.push(`  widget_style: "color:#000 !important; background-color:#FFFFFF !important;"`);
      }
      return lines.join("\n");
    }

    // INIT
    window.addEventListener('DOMContentLoaded', ()=>{
      const savedLang = localStorage.getItem('joan_lang') || 'pl';
      const savedTheme = localStorage.getItem('joan_theme') || 'light';
      setLang(savedLang);
      if(savedTheme==='dark'){ document.body.classList.add('dark-mode'); document.getElementById('btn-theme').innerText='‚òÄÔ∏è'; }
      fetchIcons();
      if(!rows.length) addNewRow();
    });
  </script>
</body>
</html>
