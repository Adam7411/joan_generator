<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Joan E‑Ink Dashboard – Konfigurator</title>
  <!-- Icons + fonts -->
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.3.67/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f172a;           /* slate-900 */
      --panel:#111827;        /* slate-800 */
      --panel-2:#0b1222;      /* deeper */
      --text:#e5e7eb;         /* slate-200 */
      --muted:#9ca3af;        /* slate-400 */
      --accent:#22d3ee;       /* cyan-400 */
      --accent-2:#06b6d4;     /* cyan-500 */
      --border:#1f2937;       /* slate-700 */
      --success:#10b981;      /* emerald-500 */
      --warn:#f59e0b;         /* amber-500 */
      --error:#ef4444;        /* red-500 */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:radial-gradient(1200px 600px at 10% 0%, #0b1222 0%, #0f172a 50%, #0a0f1f 100%);
      color:var(--text); font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;
    }
    a{color:var(--accent)}
    /* Layout */
    .shell{max-width:1200px; margin:0 auto; padding:32px 22px;}
    .header{
      display:flex; align-items:center; justify-content:space-between; margin-bottom:24px;
    }
    .brand{
      display:flex; align-items:center; gap:14px;
    }
    .brand .logo{
      width:42px; height:42px; border-radius:10px;
      display:grid; place-items:center;
      background:linear-gradient(135deg, rgba(34,211,238,.25), rgba(6,182,212,.1));
      border:1px solid var(--border);
      color:var(--accent);
      box-shadow:0 0 24px rgba(34,211,238,.2) inset;
    }
    .brand h1{
      margin:0; font-weight:800; letter-spacing:.3px; font-size:20px;
    }
    .controls{ display:flex; align-items:center; gap:10px; }
    .btn{
      appearance:none; border:1px solid var(--border); background:var(--panel);
      color:var(--text); padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer;
      transition:transform .08s ease, box-shadow .18s ease, border-color .18s ease;
    }
    .btn:hover{ transform:translateY(-2px); border-color:var(--accent); box-shadow:0 8px 24px rgba(34,211,238,.1) }
    .btn-accent{ background:linear-gradient(135deg, rgba(34,211,238,.18), rgba(6,182,212,.1)); border-color:var(--accent-2); color:#eafeff }
    .btn-danger{ border-color:#7f1d1d; background:#111; color:#ffbfbf }
    .chip{
      padding:8px 12px; border-radius:999px; font-weight:700; display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--border); background:var(--panel);
    }
    .chip.ok{ color:#d1fae5; border-color:#064e3b; background:#06221d }
    .chip.err{ color:#fee2e2; border-color:#7f1d1d; background:#220b0b }
    /* Cards */
    .grid{ display:grid; grid-template-columns:1.15fr .85fr; gap:20px; }
    .card{
      border:1px solid var(--border); border-radius:16px; background:linear-gradient(180deg,var(--panel),var(--panel-2));
      box-shadow:0 20px 40px rgba(0,0,0,.35); overflow:hidden;
    }
    .card .card-h{
      display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.03));
    }
    .card .card-h h2{ margin:0; font-size:16px; letter-spacing:.25px; }
    .card .card-b{ padding:16px 18px; }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-bottom:12px; }
    .row-3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:14px; margin-bottom:12px; }
    .row-auto{ display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; margin-top:10px; }
    label{ font-size:12px; color:var(--muted); font-weight:700; letter-spacing:.25px; margin-bottom:6px; display:block; }
    input,select,textarea{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--border); outline:none;
      background:#0a0f1f; color:var(--text); font-weight:600;
      transition:border-color .18s ease, box-shadow .18s ease;
    }
    input:focus,select:focus,textarea:focus{ border-color:var(--accent); box-shadow:0 0 0 4px rgba(34,211,238,.15) }
    textarea.small{ min-height:120px; resize:vertical }
    .hint{ font-size:12px; color:var(--muted); }
    .icon-preview{
      width:60px; height:60px; border:1px dashed var(--border); border-radius:12px; display:grid; place-items:center;
      color:var(--accent); background:#0a0f1f;
    }
    /* Preview Dashboard */
    .preview{
      display:flex; flex-direction:column; gap:12px; min-height:220px; background:#0b1222; border-radius:12px; border:1px solid var(--border);
      padding:12px;
    }
    .preview-row{
      display:flex; gap:12px; flex-wrap:wrap; align-items:stretch; border:1px dashed var(--border); padding:10px; border-radius:12px;
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.04));
      position:relative;
    }
    .row-tag{
      position:absolute; top:-10px; left:10px; background:#0b1222; border:1px solid var(--border); border-radius:8px;
      padding:4px 10px; font-size:11px; letter-spacing:.25px; color:var(--muted)
    }
    .widget{
      background:#0a0f1f; border:1px solid var(--border); border-radius:14px; padding:10px; min-width:170px; min-height:130px;
      display:flex; flex-direction:column; align-items:center; justify-content:space-between;
      box-shadow:0 14px 24px rgba(0,0,0,.25); position:relative; cursor:pointer; transition:transform .08s ease, box-shadow .18s ease;
    }
    .widget:hover{ transform:translateY(-2px); box-shadow:0 24px 36px rgba(0,0,0,.35); border-color:var(--accent) }
    .widget.editing{ border-color:#f59e0b; box-shadow:0 0 0 3px rgba(245,158,11,.25) inset; }
    .w-title{ font-weight:800; text-align:center; font-size:14px; line-height:1.35; color:#eafaff; padding:0 6px; }
    .w-icon{ font-size:40px; color:var(--accent-2) }
    .w-state{ font-weight:800; font-size:12px; letter-spacing:.35px; color:#b7f5ff; text-transform:uppercase }
    .w-del{
      position:absolute; top:6px; right:6px; width:24px; height:24px; border-radius:8px; display:none; align-items:center; justify-content:center;
      background:#1b0e0e; border:1px solid #7f1d1d; color:#ffbfbf; font-weight:800; font-size:12px;
    }
    .widget:hover .w-del{ display:flex }
    /* Footer path */
    .path-box{
      border:1px solid var(--border); border-radius:12px; background:#0a0f1f; padding:14px; margin-top:12px;
    }
    .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; }
    .path{ background:#0b1222; border:1px dashed var(--border); padding:10px 12px; border-radius:8px; color:#a5f3fc; margin-top:6px; }
  </style>
</head>
<body>
  <div class="shell">
    <div class="header">
      <div class="brand">
        <div class="logo"><i class="mdi mdi-tablet"></i></div>
        <h1>Joan E‑Ink Dashboard – Konfigurator</h1>
      </div>
      <div class="controls">
        <button class="btn" id="btn-theme" onclick="toggleTheme()">Tryb: Ciemny</button>
        <button class="btn btn-accent" onclick="toggleImport()">Importuj / Edytuj kod</button>
      </div>
    </div>

    <!-- status -->
    {% if entities %}
    <div class="chip ok"><i class="mdi mdi-check-circle"></i> Połączono z Home Assistant ({{ entities|length }})</div>
    {% else %}
    <div class="chip err"><i class="mdi mdi-alert-circle"></i> Brak połączenia z API. Sprawdź token.</div>
    {% endif %}

    <!-- grid -->
    <div class="grid" style="margin-top:16px">
      <!-- LEWA: konfiguracja -->
      <div class="card">
        <div class="card-h"><h2>Ustawienia i dodawanie wieltów</h2></div>
        <div class="card-b">
          <!-- Import -->
          <div id="import-area" class="path-box" style="display:none">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px;">
              <strong>Wklej kod .dash</strong>
              <button class="btn btn-danger" onclick="toggleImport()">Zamknij</button>
            </div>
            <textarea id="import-code" class="small mono" placeholder="Wklej tutaj zawartość pliku .dash..."></textarea>
            <div class="row-auto" style="margin-top:8px">
              <button class="btn btn-accent" onclick="importYaml()"><i class="mdi mdi-upload"></i> Wczytaj Dashboard</button>
            </div>
          </div>

          <!-- Ustawienia pliku -->
          <div class="row">
            <div>
              <label>Nazwa pliku (dashboard)</label>
              <input id="dash-title" value="JoanDashboard">
              <div class="hint">Przykład: Joan6</div>
            </div>
            <div>
              <label>Język UI</label>
              <select id="ui_language"><option value="pl" selected>Polski</option><option value="en">English</option></select>
              <div class="hint">Dotyczy podpisów w podglądzie</div>
            </div>
          </div>

          <!-- Formularz widgetu -->
          <div class="card" style="margin-top:12px">
            <div class="card-h"><h2>Dodaj / Edytuj widget</h2></div>
            <div class="card-b">
              <div class="row">
                <div>
                  <label>Typ widgetu</label>
                  <select id="new-widget-type" onchange="toggleInputs()">
                    <option value="switch">Switch / Light / Input Boolean</option>
                    <option value="cover">Cover / Gate / Garage</option>
                    <option value="sensor">Sensor</option>
                    <option value="binary_sensor">Binary Sensor</option>
                    <option value="media_player">Media Player</option>
                    <option value="climate">Climate</option>
                    <option value="script">Script</option>
                    <option value="navigate">Navigate / Przycisk Dashboardu</option>
                    <option value="label">Label (Tekst)</option>
                  </select>
                </div>
                <div id="group-entity">
                  <label>Encja (Home Assistant)</label>
                  <input list="entities-list" id="new-entity-id" placeholder="np. light.kurnik" oninput="autoTypeAndIcons()">
                  <datalist id="entities-list">
                    {% for entity in entities %}
                    <option value="{{ entity.id }}">{{ entity.id }}</option>
                    {% endfor %}
                  </datalist>
                </div>
              </div>

              <div class="row" id="group-nav" style="display:none">
                <div>
                  <label>Nazwa dashboardu (navigate)</label>
                  <input id="new-dashboard-name" placeholder="np. joan3">
                </div>
                <div>
                  <label>Tytuł na ekranie</label>
                  <input id="new-widget-name" placeholder="np. Kuchnia">
                </div>
              </div>

              <div class="row" id="group-title">
                <div>
                  <label>Tytuł na ekranie</label>
                  <input id="new-widget-name" placeholder="np. Hydrofor">
                </div>
                <div>
                  <label>Rozmiar</label>
                  <select id="new-widget-size">
                    <option value="">Domyślny (2x1)</option>
                    <option value="(1x1)">1x1</option>
                    <option value="(2x1)">2x1</option>
                    <option value="(2x2)">2x2</option>
                    <option value="(3x1)">3x1</option>
                    <option value="(1x2)">1x2</option>
                    <option value="(3x2)">3x2</option>
                  </select>
                </div>
              </div>

              <div class="row-3">
                <div>
                  <label>Ikona (sensor/navigate/label)</label>
                  <input list="icons-list" id="new-widget-icon" placeholder="np. mdi-thermometer" oninput="updateIconPreview()">
                </div>
                <div>
                  <label>Ikona ON (switch/cover)</label>
                  <input list="icons-list" id="new-widget-icon-on" placeholder="np. mdi-lightbulb-on" oninput="updateIconPreview()">
                </div>
                <div>
                  <label>Ikona OFF (switch/cover)</label>
                  <input list="icons-list" id="new-widget-icon-off" placeholder="np. mdi-lightbulb-outline" oninput="updateIconPreview()">
                </div>
              </div>

              <div class="row-auto" style="align-items:center">
                <div class="icon-preview"><i id="icon-preview-i" class="mdi mdi-help-circle-outline" style="font-size:28px"></i></div>
                <button class="btn btn-accent" id="btn-save" onclick="saveWidget()"><i class="mdi mdi-plus"></i> Dodaj do wiersza</button>
                <button class="btn" id="btn-cancel" style="display:none" onclick="cancelEdit()"><i class="mdi mdi-close"></i> Anuluj edycję</button>
              </div>
            </div>
          </div>

          <!-- Podgląd -->
          <div class="card" style="margin-top:12px">
            <div class="card-h">
              <h2>Podgląd Dashboardu (kliknij, aby edytować)</h2>
              <button class="btn" onclick="addRow()"><i class="mdi mdi-table-row-plus-after"></i> Dodaj wiersz</button>
            </div>
            <div class="card-b">
              <div id="preview" class="preview"></div>
            </div>
          </div>

          <!-- Generuj -->
          <div class="row-auto" style="margin-top:10px">
            <button class="btn btn-accent" onclick="generate()"><i class="mdi mdi-file-code"></i> Generuj kod .dash</button>
          </div>
        </div>
      </div>

      <!-- PRAWA: kod wyjściowy -->
      <div class="card">
        <div class="card-h"><h2>Wygenerowany YAML (.dash)</h2></div>
        <div class="card-b">
          {% if generated_yaml %}
          <div class="path-box">
            <div>Ścieżka zapisu pliku:</div>
            <div id="path-code" class="path mono">\\IP_HA\addon_configs\appdaemon\dashboards\{{ filename }}</div>
            <div style="margin-top:10px">Dashboard:</div>
            <a href="#" id="dashboard-link" target="_blank" class="mono">http://IP_HA:5050/{{ dash_name }}</a>
          </div>
          <textarea class="small mono" style="min-height:420px" readonly>{{ generated_yaml }}</textarea>
          {% else %}
          <div class="hint">Tu pojawi się kod YAML po kliknięciu “Generuj kod .dash”.</div>
          <textarea class="small mono" style="min-height:420px" readonly id="out"></textarea>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Icons datalist -->
  <datalist id="icons-list"></datalist>

  <script>
    // Data
    const entitiesData = {{ entities | tojson }};
    let rows = [];            // [[{id,type,name,size,icon,icon_on,icon_off}, ...], ...]
    let activeRow = 0;
    let editing = null;       // {r,w} or null
    let defsMap = {};         // imported defs: id or entity -> def

    // Theme
    function toggleTheme(){
      document.body.classList.toggle('light');
      const btn = document.getElementById('btn-theme');
      if(document.body.classList.contains('light')){
        btn.textContent = 'Tryb: Jasny';
      }else{
        btn.textContent = 'Tryb: Ciemny';
      }
    }

    // Import UI
    function toggleImport(){
      const box = document.getElementById('import-area');
      box.style.display = (box.style.display==='none'||!box.style.display)?'block':'none';
    }

    // Helpers
    function fmtName(id){
      if(!id) return '';
      const last = id.includes('.') ? id.split('.').pop() : id;
      return last.replace(/_/g,' ').replace(/\b\w/g, c=>c.toUpperCase());
    }
    function resolveTitle(id){
      const candidates = [id];
      if(id.includes('.')) candidates.push(id.split('.').pop());
      for(const k of candidates){
        const d = defsMap[k];
        if(d){
          if(d.title) return d.title;
          if(d.entity && defsMap[d.entity] && defsMap[d.entity].title) return defsMap[d.entity].title;
        }
      }
      return '';
    }
    function getEntity(id){ return entitiesData.find(e=>e.id===id) || null; }
    function normStateText(s){
      if(s==null) return null;
      s = String(s).toLowerCase().trim();
      const PL={on:'Włączone', off:'Wyłączone', open:'Otwarte', closed:'Zamknięte'};
      const EN={on:'ON', off:'OFF', open:'OPEN', closed:'CLOSED'};
      const T = document.getElementById('ui_language').value==='pl' ? PL : EN;
      if(['1','true','on'].includes(s)) return T.on;
      if(['0','false','off'].includes(s)) return T.off;
      if(s==='open') return T.open;
      if(s==='closed') return T.closed;
      return null;
    }
    function iconPairFor(id){
      const v=(id||'').toLowerCase();
      if(v.startsWith('light.')||v.includes('swiatlo')||v.includes('light')) return ['mdi-lightbulb-on','mdi-lightbulb-outline'];
      if(v.startsWith('cover.')||v.includes('brama')||v.includes('gate')) return ['mdi-gate-open','mdi-gate'];
      if(v.includes('garage')||v.includes('garaz')||v.includes('garaż')) return ['mdi-garage-open','mdi-garage'];
      if(v.includes('radiator')||v.includes('ogrzew')||v.includes('grzejnik')) return ['mdi-radiator','mdi-radiator-off'];
      if(v.includes('cwu')||v.includes('woda')||v.includes('water')) return ['mdi-water-outline','mdi-water-off'];
      if(v.includes('window')||v.includes('roleta')||v.includes('blind')) return ['mdi-window-shutter-open','mdi-window-shutter'];
      if(v.startsWith('input_boolean.')) return ['mdi-toggle-switch','mdi-toggle-switch-off'];
      return ['mdi-toggle-switch','mdi-toggle-switch-off'];
    }
    function pickPreviewIcon(w){
      const ent = getEntity(w.id);
      const actionable = ['switch','cover','binary_sensor','media_player','climate','script'].includes(w.type) || w.id.startsWith('input_boolean.');
      if(actionable){
        let on = w.icon_on, off = w.icon_off;
        if(!on || !off){
          const p = iconPairFor(w.id);
          on = on || p[0];
          off= off|| p[1];
        }
        const st = ent ? String(ent.state).toLowerCase().trim() : 'off';
        const isOn = (st==='on'||st==='true'||st==='1'||st==='open'||st==='unlocked');
        return isOn ? on : off;
      }else{
        return w.icon || 'mdi-gauge';
      }
    }
    function displayState(id,type){
      const ent = getEntity(id);
      if(!ent) return '';
      if(['sensor','label','navigate'].includes(type)){
        if(type==='sensor'){
          const raw = String(ent.state).trim();
          if((raw==='1'||raw==='0') && !ent.unit) return '';
          if(!isNaN(parseFloat(raw)) && raw.includes('.')){
            const v = parseFloat(raw).toFixed(1);
            return ent.unit ? `${v} ${ent.unit}` : v;
          }
          return ent.unit ? `${raw} ${ent.unit}` : raw;
        }
        return '';
      }
      return normStateText(ent.state) || '';
    }

    // Render preview
    function render(){
      const wrap = document.getElementById('preview');
      wrap.innerHTML = '';
      if(rows.length===0) rows.push([]);
      rows.forEach((rset,ri)=>{
        const row = document.createElement('div');
        row.className='preview-row';
        row.onclick = ()=>{ activeRow = ri; render(); };
        const tag = document.createElement('div');
        tag.className='row-tag';
        tag.textContent = (document.getElementById('ui_language').value==='pl'?'Wiersz ':'Row ') + (ri+1);
        row.appendChild(tag);

        rset.forEach((w,wi)=>{
          const card = document.createElement('div');
          card.className='widget';
          if(editing && editing.r===ri && editing.w===wi) card.classList.add('editing');

          // sizing
          let width = w.size ? parseInt(String(w.size).replace(/[()]/,'').split('x')[0]) : 2;
          let height= w.size ? parseInt(String(w.size).replace(/[()]/,'').split('x')[1]) : 1;
          const baseW=170, baseH=130;
          card.style.minWidth = (baseW + (width-2)*70)+'px';
          card.style.minHeight= (baseH + (height-1)*70)+'px';

          const title = w.name && w.name.trim() ? w.name : (resolveTitle(w.id) || fmtName(w.id));
          const icon  = pickPreviewIcon(w);
          const state = displayState(w.id,w.type);

          card.innerHTML = `
            <div class="w-title">${title}</div>
            ${icon ? `<i class="mdi ${icon} w-icon"></i>` : `<div style="height:40px"></div>`}
            ${state ? `<div class="w-state">${state}</div>` : `<div style="height:14px"></div>`}
            <div class="w-del" title="Usuń" onclick="removeWidget(${ri},${wi}); event.stopPropagation();">×</div>
          `;
          card.onclick = (e)=>{ e.stopPropagation(); editWidget(ri,wi); };
          row.appendChild(card);
        });

        wrap.appendChild(row);
      });
    }

    // Rows ops
    function addRow(){ rows.push([]); activeRow = rows.length-1; render(); }
    function removeWidget(ri,wi){
      if(editing && editing.r===ri && editing.w===wi) cancelEdit();
      rows[ri].splice(wi,1); render();
    }

    // Form ops
    function toggleInputs(){
      const type = document.getElementById('new-widget-type').value;
      const ge = document.getElementById('group-entity');
      const gn = document.getElementById('group-nav');
      const gt = document.getElementById('group-title');
      if(type==='navigate'){ ge.style.display='none'; gn.style.display='grid'; gt.style.display='none'; }
      else { ge.style.display='grid'; gn.style.display='none'; gt.style.display='grid'; }
    }
    function updateIconPreview(){
      const val = document.getElementById('new-widget-icon-on').value.trim()
              || document.getElementById('new-widget-icon-off').value.trim()
              || document.getElementById('new-widget-icon').value.trim();
      const el  = document.getElementById('icon-preview-i');
      el.className = val && val.startsWith('mdi-') ? 'mdi '+val : 'mdi mdi-help-circle-outline';
    }
    function autoTypeAndIcons(){
      const id = document.getElementById('new-entity-id').value.toLowerCase();
      if(!id) return;
      const typeSel = document.getElementById('new-widget-type');
      if(id.startsWith('sensor.')) typeSel.value='sensor';
      else if(id.startsWith('binary_sensor.')) typeSel.value='binary_sensor';
      else if(id.startsWith('cover.')) typeSel.value='cover';
      else if(id.startsWith('media_player.')) typeSel.value='media_player';
      else if(id.startsWith('climate.')) typeSel.value='climate';
      else if(id.startsWith('switch.') || id.startsWith('light.') || id.startsWith('input_boolean.')) typeSel.value='switch';
      // Auto icon pair
      const pair = iconPairFor(id);
      const onEl = document.getElementById('new-widget-icon-on');
      const offEl= document.getElementById('new-widget-icon-off');
      if(!onEl.value) onEl.value = pair[0];
      if(!offEl.value) offEl.value= pair[1];
      updateIconPreview();
    }

    function editWidget(r,w){
      editing = {r,w};
      const wid = rows[r][w];
      activeRow = r;
      document.getElementById('new-widget-type').value = wid.type;
      toggleInputs();
      if(wid.type==='navigate'){
        document.getElementById('group-nav').style.display='grid';
        document.getElementById('group-entity').style.display='none';
        document.getElementById('new-dashboard-name').value = wid.id.replace('navigate.','');
      }else{
        document.getElementById('group-nav').style.display='none';
        document.getElementById('group-entity').style.display='grid';
        document.getElementById('new-entity-id').value = wid.id;
      }
      document.getElementById('new-widget-name').value    = wid.name || '';
      document.getElementById('new-widget-icon').value    = wid.icon || '';
      document.getElementById('new-widget-icon-on').value = wid.icon_on || '';
      document.getElementById('new-widget-icon-off').value= wid.icon_off || '';
      document.getElementById('new-widget-size').value    = wid.size || '';
      document.getElementById('btn-save').innerHTML       = '<i class="mdi mdi-content-save"></i> Zapisz zmiany';
      document.getElementById('btn-cancel').style.display = 'inline-block';
      updateIconPreview();
      render();
    }
    function cancelEdit(){
      editing = null;
      document.getElementById('new-dashboard-name').value='';
      document.getElementById('new-entity-id').value='';
      document.getElementById('new-widget-name').value='';
      document.getElementById('new-widget-icon').value='';
      document.getElementById('new-widget-icon-on').value='';
      document.getElementById('new-widget-icon-off').value='';
      document.getElementById('new-widget-size').value='';
      document.getElementById('btn-save').innerHTML = '<i class="mdi mdi-plus"></i> Dodaj do wiersza';
      document.getElementById('btn-cancel').style.display = 'none';
      updateIconPreview();
      render();
    }
    function saveWidget(){
      const type = document.getElementById('new-widget-type').value;
      let name   = document.getElementById('new-widget-name').value.trim();
      let icon   = document.getElementById('new-widget-icon').value.trim();
      let icon_on= document.getElementById('new-widget-icon-on').value.trim();
      let icon_off= document.getElementById('new-widget-icon-off').value.trim();
      const size = document.getElementById('new-widget-size').value;
      let id='';
      if(type==='navigate'){
        const dn = document.getElementById('new-dashboard-name').value.trim();
        if(!dn){ alert('Wymagana nazwa dashboardu'); return; }
        id = 'navigate.'+dn;
      }else{
        id = document.getElementById('new-entity-id').value.trim();
        if(!id){ alert('Wymagana encja'); return; }
      }
      if(!name) name = fmtName(id);
      const actionable = ['switch','cover','binary_sensor','media_player','climate','script'].includes(type) || id.startsWith('input_boolean.');
      if(actionable && (!icon_on || !icon_off)){
        const pair = iconPairFor(id);
        icon_on = icon_on || pair[0];
        icon_off= icon_off|| pair[1];
      }
      // normalize mdi-
      [icon,icon_on,icon_off] = [icon,icon_on,icon_off].map(x => (x && !x.startsWith('mdi-')) ? ('mdi-'+x) : x);

      const item = {id,type,name,size,icon,icon_on,icon_off};
      if(editing){ rows[editing.r][editing.w] = item; cancelEdit(); }
      else{ if(rows.length===0) rows.push([]); rows[activeRow].push(item); }
      render();
    }

    // Import YAML
    function importYaml(){
      const code = document.getElementById('import-code').value;
      if(!code) return;
      try{
        const lines = code.split('\n');
        const defs = {}; let cur=null; const layoutLines=[]; let parsing=false;
        for(const raw of lines){
          const line = raw.split('#')[0].trim();
          if(!line) continue;
          if(line.startsWith('layout:')){ parsing=true; continue; }
          if(parsing){
            if(line.startsWith('-')) layoutLines.push(line);
            else if(/^\S+:/m.test(raw)) parsing=false;
          }
          if(!parsing){
            const m = raw.match(/^([a-zA-Z0-9_.]+):/);
            const ignore=['global_parameters','widget_dimensions','widget_size','widget_margins','columns','rows','skin','title'];
            if(m){
              const key = m[1];
              if(!ignore.includes(key)){ cur=key; defs[cur]={}; } else cur=null;
            }else if(cur && line.includes(':')){
              let val=line.substring(line.indexOf(':')+1).trim();
              if((val.startsWith('"')&&val.endsWith('"'))||(val.startsWith("'")&&val.endsWith("'"))) val=val.slice(1,-1);
              const k=line.split(':')[0].trim();
              defs[cur][k]=val;
            }
          }
        }
        defsMap = {};
        Object.entries(defs).forEach(([k,v])=>{
          defsMap[k]=v;
          if(v.entity) defsMap[v.entity]=v;
        });
        rows = [];
        layoutLines.forEach(l=>{
          const items = l.substring(1).trim().split(',');
          const row = [];
          items.forEach(rawItem=>{
            let id = rawItem.trim(), size='';
            const sm = id.match(/\(\d+x\d+\)/);
            if(sm){ size=sm[0]; id = id.replace(sm[0],'').trim(); }
            const def = defsMap[id] || defsMap[id.split('.').pop()] || null;
            // type
            let type = def && def.widget_type;
            if(!type){
              if(id.startsWith('navigate.')) type='navigate';
              else if(id.startsWith('sensor.')) type='sensor';
              else if(id.startsWith('binary_sensor.')) type='binary_sensor';
              else if(id.startsWith('cover.')) type='cover';
              else if(id.startsWith('media_player.')) type='media_player';
              else if(id.startsWith('climate.')) type='climate';
              else if(id.startsWith('light.') || id.startsWith('switch.') || id.startsWith('input_boolean.')) type='switch';
              else type='switch';
            }
            // title
            let name = resolveTitle(id);
            if(!name && def && def.entity) name = fmtName(def.entity);
            if(!name) name = fmtName(id);
            // icons
            let icon    = def && def.icon || '';
            let icon_on = def && (def.icon_on || def.icon_active) || '';
            let icon_off= def && (def.icon_off || def.icon_inactive) || '';
            const actionable = ['switch','cover','binary_sensor','media_player','climate','script'].includes(type) || id.startsWith('input_boolean.');
            if(actionable && (!icon_on || !icon_off)){
              const pair = iconPairFor(def && def.entity ? def.entity : id);
              icon_on = icon_on || pair[0];
              icon_off= icon_off|| pair[1];
            }
            [icon,icon_on,icon_off] = [icon,icon_on,icon_off].map(x => (x && !x.startsWith('mdi-')) ? ('mdi-'+x) : x);
            row.push({id,type,name,size,icon,icon_on,icon_off});
          });
          if(row.length) rows.push(row);
        });
        if(!rows.length){ alert('Brak sekcji layout w kodzie.'); return; }
        activeRow = rows.length-1;
        render();
        alert('Import OK');
        toggleImport();
      }catch(e){
        alert('Import błąd: '+e.message);
      }
    }

    // Generate (client-side preview textarea)
    function generate(){
      // Minimal generator – pokazuje strukturę JSON (backend użyje rows z hidden input)
      const out = document.getElementById('out');
      if(out){
        out.value = JSON.stringify(rows, null, 2);
      }
      // Submit hidden field to backend if used
      const hidden = document.getElementById('layout_data_json');
      if(hidden){ hidden.value = JSON.stringify(rows); }
      // Optional: show path with current host
      const host = window.location.hostname;
      const pathCode = document.getElementById('path-code');
      const dashLink = document.getElementById('dashboard-link');
      if(pathCode) pathCode.innerHTML = pathCode.innerHTML.replace('IP_HA', host);
      if(dashLink){
        const href = dashLink.innerText.replace('IP_HA', host);
        dashLink.href = href; dashLink.innerText = href;
      }
    }

    // Icons datalist fetch
    async function fetchIcons(){
      try{
        const res = await fetch('https://raw.githubusercontent.com/Templarian/MaterialDesign/master/meta.json');
        const icons = await res.json();
        const dl = document.getElementById('icons-list');
        dl.innerHTML='';
        icons.forEach(i=>{
          const opt = document.createElement('option');
          opt.value = 'mdi-'+i.name; dl.appendChild(opt);
        });
      }catch(e){}
    }
    fetchIcons();

    // Init
    window.addEventListener('DOMContentLoaded', ()=>{
      if(rows.length===0) rows.push([]);
      render();
    });
  </script>
</body>
</html>
