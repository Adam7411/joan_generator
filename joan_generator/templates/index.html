<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joan 6 E-Ink Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #e0e0e0;
            --container-bg: #ffffff;
            --text-color: #222;
            --border-color: #bbb;
            --accent-color: #1976d2;
            --input-bg: #fff;
            --section-bg: #f9f9f9;
            --preview-bg: #f4f4f4;
            --link-bg: #ffffff;
            --link-color: #0056b3;
            --link-border: #bee5eb;
        }
        body.dark-mode {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --border-color: #444;
            --accent-color: #64b5f6;
            --input-bg: #2c2c2c;
            --section-bg: #252525;
            --preview-bg: #1d1d1d;
            --link-bg: #2c2c2c;
            --link-color: #80d8ff;
            --link-border: #37474f;
        }
        body { font-family: 'Roboto', sans-serif; background-color: var(--bg-color); color: var(--text-color); padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: var(--container-bg); padding: 25px; border-radius: 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.15); }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; border-bottom: 2px solid var(--border-color); padding-bottom: 16px; }
        h1 { color: var(--accent-color); margin: 0; font-size: 28px; letter-spacing: .5px; }
        .controls { display: flex; gap: 12px; align-items: center; }
        .controls button { padding: 10px 14px; border: 1px solid var(--border-color); background: var(--section-bg); color: var(--text-color); cursor: pointer; border-radius: 6px; font-weight: 700; }
        .lang-switch button.active { background: var(--accent-color); color:#fff; border-color: var(--accent-color); }
        .status-bar { padding: 12px; margin-bottom: 20px; border-radius: 6px; font-weight: 700; text-align:center; }

        .section { margin-bottom: 32px; border: 1px solid var(--border-color); padding: 22px; border-radius: 10px; background: var(--section-bg); }
        .section-title { font-size: 1.25em; font-weight: 900; margin-bottom: 18px; padding-bottom: 6px; border-bottom: 3px solid var(--accent-color); display:block; }
        label { display:block; margin:10px 0 4px; font-size:.85em; font-weight:700; text-transform:uppercase; letter-spacing:.5px; }
        input, select, textarea { width:100%; padding:11px; border:1px solid var(--border-color); border-radius:6px; background:var(--input-bg); color:var(--text-color); font-size:14px; }
        .add-widget-box { background:#e3f2fd; border:1px solid #2196f3; border-radius:12px; padding:18px; }
        body.dark-mode .add-widget-box { background:#0d47a1; }
        .add-widget-box.editing { background:#fff8e1; border-color:#ffc107; }
        body.dark-mode .add-widget-box.editing { background:#3e2723; border-color:#ffb300; }
        .flex-row { display:flex; gap:18px; flex-wrap:wrap; align-items:flex-end; }
        .flex-col { flex:1; min-width:190px; }
        .btn { padding:12px 20px; border:none; cursor:pointer; border-radius:8px; font-weight:900; letter-spacing:.5px; }
        .btn-add { background:#4caf50; color:#fff; }
        .btn-update { background:#ff9800; color:#fff; }
        .btn-cancel { background:#9e9e9e; color:#fff; }
        .btn-row { background:#1976d2; color:#fff; margin-top:10px; }
        .btn-import { background:#ff9800; color:#fff; margin-bottom:14px; }
        .btn-primary { background:var(--accent-color); color:#fff; font-size:18px; margin-top:10px; }

        /* PREVIEW AREA */
        .preview-area {
            background: var(--preview-bg);
            padding: 30px;
            border-radius: 14px;
            border: 2px solid var(--border-color);
            min-height: 240px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        .eink-row {
            display: flex;
            gap: 16px;
            padding: 18px 14px 26px;
            border: 3px dashed #888;
            background: rgba(0,0,0,0.02);
            border-radius: 10px;
            align-items: stretch;
            position: relative;
            min-height: 140px;
            cursor: pointer;
            flex-wrap: wrap;
        }
        .eink-row.active { border-color: var(--accent-color); background: rgba(25,118,210,.12); }
        .eink-row:hover { border-color: var(--accent-color); }

        .row-label-chip {
            position: absolute;
            top: -10px;
            left: 10px;
            background: var(--accent-color);
            color:#fff;
            font-size:11px;
            font-weight:900;
            padding:4px 8px;
            border-radius: 10px;
            letter-spacing:.5px;
        }

        .eink-widget {
            background: #ffffff;
            border: 2px solid #000;
            color:#000;
            display:flex;
            flex-direction:column;
            justify-content:space-between;
            align-items:center;
            padding:10px 8px 12px;
            box-sizing:border-box;
            position:relative;
            cursor:pointer;
            box-shadow: 2px 3px 6px rgba(0,0,0,0.16);
            flex: 0 0 auto;
            min-width: 160px;
            min-height: 130px;
            border-radius:12px;
            transition: transform .12s, box-shadow .15s;
        }
        .eink-widget:hover { transform: translateY(-4px); box-shadow: 4px 6px 14px rgba(0,0,0,0.28); }
        .eink-widget.being-edited { border:3px solid #ff9800; transform:scale(1.05); z-index:5; }

        .ew-title {
            font-size: 15px;
            font-weight: 900;
            text-align: center;
            width: 100%;
            line-height: 1.3;
            white-space: normal;
            word-break: break-word;
            hyphens: auto;
            min-height: 38px;
            display:flex;
            align-items:center;
            justify-content:center;
            padding:0 4px;
        }
        .ew-icon { font-size: 42px; margin: 2px 0 4px; transition: color .15s ease; }
        .ew-state {
            font-size: 12px;
            font-weight: 800;
            letter-spacing:.5px;
            text-transform: uppercase;
            min-height:18px;
            display:flex;
            align-items:center;
        }
        .ew-delete {
            position:absolute;
            top:4px;
            right:4px;
            background:#d50000;
            color:#fff;
            width:22px;
            height:22px;
            font-size:11px;
            border-radius:6px;
            display:none;
            align-items:center;
            justify-content:center;
            font-weight:700;
        }
        .eink-widget:hover .ew-delete { display:flex; }

        .ew-edit-overlay {
            position:absolute;
            inset:0;
            background:rgba(25,118,210,.18);
            display:none;
            pointer-events:none;
            border-radius:10px;
        }
        .eink-widget:hover .ew-edit-overlay { display:block; }

        textarea.output { width:100%; height:520px; font-family:monospace; background:#263238; color:#eceff1; border:none; padding:18px; border-radius:8px; font-size:13px; }

        .file-path-info {
            background: #eef7ff;
            border:1px solid #b5d9ff;
            color:#0c3c60;
            padding:18px 22px;
            border-radius:10px;
            font-family:monospace;
            font-size:15px;
        }
        body.dark-mode .file-path-info { background:#1f2c37; border-color:#39566b; color:#d5e9f9; }
        .file-path-info code { background:#fff; padding:6px 10px; border-radius:6px; display:block; margin-top:6px; font-weight:700; word-break:break-word; }
        body.dark-mode .file-path-info code { background:#2b3a45; }
        .file-path-info a { background: var(--link-bg); padding:6px 10px; border-radius:6px; font-weight:700; color:var(--link-color); text-decoration:none; display:inline-block; margin-top:8px; border:1px solid var(--link-border); }
        .file-path-info a:hover { text-decoration:underline; background:#fff; }
        .hidden { display:none !important; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-row">
            <h1>Joan 6 E-Ink Generator</h1>
            <div class="controls">
                <div>
                    <button type="button" onclick="toggleTheme()" id="btn-theme">ðŸŒ™</button>
                </div>
                <div class="lang-switch">
                    <button type="button" onclick="setLang('pl')" id="btn-pl" class="active">PL</button>
                    <button type="button" onclick="setLang('en')" id="btn-en">EN</button>
                </div>
            </div>
        </div>

        {% if entities %}
        <div class="status-bar" style="background:#d7f7dd; color:#145c22;">
            âœ“ PoÅ‚Ä…czono z Home Assistant ({{ entities|length }})
        </div>
        {% else %}
        <div class="status-bar" style="background:#fde2e2; color:#7a1e1e;">
            âš  Brak poÅ‚Ä…czenia z API. SprawdÅº token.
        </div>
        {% endif %}

        <button type="button" class="btn btn-import" onclick="toggleImport()">ðŸ“‚ Importuj / Edytuj Kod</button>
        <div id="import-area" class="section import-box">
            <h4 style="margin-top:0">Wklej kod pliku .dash tutaj:</h4>
            <textarea id="import-code" style="height:170px;" placeholder="title: Moj Dashboard..."></textarea>
            <button type="button" class="btn btn-add" style="margin-top:12px;" onclick="importYaml()">Wczytaj Dashboard</button>
        </div>

        <form method="POST" id="main-form">
            <input type="hidden" name="ui_language" id="ui_language" value="pl">

            <div class="section">
                <div class="section-title">1. Ustawienia</div>
                <div class="flex-row">
                    <div class="flex-col">
                        <label>TytuÅ‚ Dashboardu (Nazwa pliku)</label>
                        <input type="text" name="title" id="dash-title" value="JoanDashboard">
                    </div>
                </div>
            </div>

            <div class="add-widget-box" id="widget-form-box">
                <h4 style="margin-top:0" id="form-header">2. Dodaj Widget</h4>
                <div class="flex-row">
                    <div class="flex-col">
                        <label>Typ Widgetu</label>
                        <select id="new-widget-type" onchange="toggleInputs()">
                            <option value="switch">Switch / Light</option>
                            <option value="navigate">Navigate / Dashboard Button</option>
                            <option value="sensor">Sensor</option>
                            <option value="binary_sensor">Binary Sensor</option>
                            <option value="cover">Cover / Gate</option>
                            <option value="media_player">Media Player</option>
                            <option value="climate">Climate</option>
                            <option value="script">Script</option>
                            <option value="label">Label (Text)</option>
                        </select>
                    </div>

                    <div class="flex-col" id="group-entity">
                        <label>Wybierz EncjÄ™ (Home Assistant)</label>
                        <input list="entities-list" id="new-entity-id" placeholder="np. light.kuchnia..." oninput="megaAutoConfig()">
                        <datalist id="entities-list">
                            {% for entity in entities %}
                            <option value="{{ entity.id }}">{{ entity.id }}</option>
                            {% endfor %}
                        </datalist>
                    </div>

                    <div class="flex-col hidden" id="group-nav">
                        <label>Nazwa pliku dashboardu</label>
                        <input type="text" id="new-dashboard-name" placeholder="np. joan3 (bez .dash)">
                    </div>

                    <div class="flex-col">
                        <label>TytuÅ‚ na ekranie</label>
                        <input type="text" id="new-widget-name" placeholder="np. Hydrofor">
                    </div>
                </div>

                <div class="flex-row" style="margin-top:12px; align-items:flex-end;">
                    <div class="flex-col" style="max-width:170px;">
                        <label>Rozmiar</label>
                        <select id="new-widget-size">
                            <option value="">DomyÅ›lny (2x1)</option>
                            <option value="(1x1)">1x1</option>
                            <option value="(2x1)">2x1</option>
                            <option value="(2x2)">2x2</option>
                            <option value="(3x1)">3x1</option>
                            <option value="(1x2)">1x2</option>
                            <option value="(3x2)">3x2</option>
                        </select>
                    </div>
                    <div style="width:70px;">
                        <label>PodglÄ…d Ikony</label>
                        <div class="icon-preview-box">
                            <i id="icon-preview-i" class="mdi mdi-help-circle-outline" style="font-size:36px;"></i>
                        </div>
                    </div>
                    <div class="flex-col">
                        <label>Ikona</label>
                        <input list="icons-list" id="new-widget-icon" placeholder="np. mdi-radiator" oninput="updateIconPreview()">
                        <datalist id="icons-list"></datalist>
                    </div>
                    <div class="flex-col" style="display:flex; gap:12px; align-items:flex-end;">
                        <button type="button" id="btn-action" class="btn btn-add" onclick="saveWidget()">+ DODAJ DO WIERSZA</button>
                        <button type="button" id="btn-cancel" class="btn btn-cancel hidden" onclick="cancelEdit()">Anuluj</button>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">3. PodglÄ…d Dashboardu (Kliknij, aby edytowaÄ‡)</div>
                <div id="rows-container" class="preview-area"></div>
                <button type="button" class="btn btn-row" onclick="addNewRow()">+ Dodaj Nowy Wiersz</button>
            </div>

            <input type="hidden" name="layout_data_json" id="layout_data_json">
            <button type="button" class="btn btn-primary" onclick="submitForm()">GENERUJ KOD .DASH</button>
        </form>

        {% if generated_yaml %}
        <div class="section">
            <h3>TwÃ³j kod YAML:</h3>
            <div class="file-path-info">
                <strong>1. Zapisz kod w pliku:</strong>
                <code id="path-code">\\IP_HA\addon_configs\appdaemon\dashboards\{{ filename }}</code>
                <strong>2. Uruchom ponownie AppDaemon i sprawdÅº dashboard:</strong>
                <a href="#" id="dashboard-link" target="_blank">http://IP_HA:5050/{{ dash_name }}</a>
            </div>
            <textarea class="output" readonly>{{ generated_yaml }}</textarea>
        </div>
        {% endif %}
    </div>

    <script>
        const entitiesData = {{ entities | tojson }};

        let currentLang='pl', rows=[], activeRowIndex=0, editingIndices=null, importedDefsMap={};

        function formatNameFromId(id){
            if(!id) return "";
            const last=id.includes('.')?id.split('.').pop():id;
            return last.replace(/_/g,' ').replace(/\b\w/g,l=>l.toUpperCase());
        }

        function resolveImportedTitle(id){
            const tries=[id];
            if(id.includes('.')) tries.push(id.split('.').pop());
            for(const t of tries){
                const def=importedDefsMap[t];
                if(def){
                    if(def.title) return def.title;
                    if(def.entity && importedDefsMap[def.entity] && importedDefsMap[def.entity].title)
                        return importedDefsMap[def.entity].title;
                }
            }
            return '';
        }

        function toggleTheme(){
            document.body.classList.toggle('dark-mode');
            document.getElementById('btn-theme').innerText=document.body.classList.contains('dark-mode')?'â˜€ï¸':'ðŸŒ™';
        }
        function setLang(lang){
            currentLang=lang;
            document.getElementById('btn-pl').classList.toggle('active',lang==='pl');
            document.getElementById('btn-en').classList.toggle('active',lang==='en');
            refreshUIText(); renderRows();
        }
        function refreshUIText(){
            const dict=currentLang==='pl'
             ? {btn_add:"+ DODAJ DO WIERSZA",btn_update:"ZAPISZ ZMIANY",sec_add:"2. Dodaj Widget",sec_edit:"2. Edytuj Widget", on:"WÅÄ„CZONE", off:"WYÅÄ„CZONE", open:"OTWARTE", closed:"ZAMKNIÄ˜TE"}
             : {btn_add:"+ ADD TO ROW",btn_update:"UPDATE WIDGET",sec_add:"2. Add Widget",sec_edit:"2. Edit Widget", on:"ON", off:"OFF", open:"OPEN", closed:"CLOSED"};
            const btn=document.getElementById('btn-action');
            const header=document.getElementById('form-header');
            if(btn){
                btn.innerText=(editingIndices?dict.btn_update:dict.btn_add)+" ("+(currentLang==='pl'?'Wiersz':'Row')+" "+(activeRowIndex+1)+")";
            }
            if(header) header.innerText=editingIndices?dict.sec_edit:dict.sec_add;
        }

        // Entity helpers
        function getEntityData(id){ return entitiesData.find(e=>e.id===id)||null; }
        function normalizeStateText(s){
            if(s==null) return null;
            s=String(s).toLowerCase().trim();
            const T=currentLang==='pl'
                ? {on:"WÅÄ„CZONE", off:"WYÅÄ„CZONE", open:"OTWARTE", closed:"ZAMKNIÄ˜TE"}
                : {on:"ON", off:"OFF", open:"OPEN", closed:"CLOSED"};
            if(['1','true','on'].includes(s)) return T.on;
            if(['0','false','off'].includes(s)) return T.off;
            if(s==='open') return T.open;
            if(s==='closed') return T.closed;
            return null;
        }

        // Icon state mapping: reflect ON/OFF/Open/Closed visually for switches/covers etc.
        function getStateAwareIcon(widget){
            const baseIcon = (widget.icon && widget.icon.trim()) ? widget.icon : pickAutoIcon(widget.type, widget.id);
            const ent = getEntityData(widget.id);
            if(!ent) return baseIcon;

            const s = String(ent.state).toLowerCase().trim();
            const i = (baseIcon || '').toLowerCase();

            const isOn = (s==='on' || s==='true' || s==='1' || s==='open' || s==='unlocked');

            // Rules only for actionable types
            if(['switch','binary_sensor','cover','media_player','climate','script'].includes(widget.type)){
                // Lights
                if(i.includes('lightbulb')){
                    return isOn ? 'mdi-lightbulb-on' : 'mdi-lightbulb-outline';
                }
                // Gate/Garage/Cover
                if(i.includes('gate')) return isOn ? 'mdi-gate-open' : 'mdi-gate';
                if(i.includes('garage')) return isOn ? 'mdi-garage-open' : 'mdi-garage';
                if(i.includes('window-shutter')) return isOn ? 'mdi-window-shutter-open' : 'mdi-window-shutter';
                // Lock
                if(i.includes('lock')) return isOn ? 'mdi-lock-open' : 'mdi-lock';
                // Media player
                if(i.includes('play-circle') || i.includes('pause') || i.includes('stop')){
                    if(s.includes('play')) return 'mdi-play-circle';
                    if(s.includes('pause')) return 'mdi-pause-circle';
                    if(s.includes('stop')) return 'mdi-stop-circle';
                    return isOn ? 'mdi-play-circle' : 'mdi-play-circle-outline';
                }
                // Radiator / heating
                if(i.includes('radiator')) return isOn ? 'mdi-radiator' : 'mdi-radiator-off';
                // Water
                if(i.includes('water-outline') || i.includes('water-off')){
                    return isOn ? 'mdi-water-outline' : 'mdi-water-off';
                }
                // Toggle generic
                if(i.includes('toggle-switch')) return isOn ? 'mdi-toggle-switch' : 'mdi-toggle-switch-off';
            }
            return baseIcon;
        }

        function getDisplayState(id,type){
            const ent=getEntityData(id);
            if(!ent) return '';
            if(['label','navigate','sensor'].includes(type)) {
                // sensors already show numeric/units elsewhere; for simplicity we hide ON/OFF here
                if(type==='sensor'){
                    const raw=String(ent.state).trim();
                    if((raw==='1'||raw==='0') && !ent.unit) return '';
                    if(!isNaN(parseFloat(raw)) && raw.includes('.')){
                        const v=parseFloat(raw).toFixed(1);
                        return ent.unit?`${v} ${ent.unit}`:v;
                    }
                    return ent.unit?`${raw} ${ent.unit}`:raw;
                }
                return '';
            }
            const norm = normalizeStateText(ent.state);
            return norm || '';
        }

        function pickAutoIcon(type,id){
            const v=(id||'').toLowerCase();
            const map=[
                {k:['hydrofor','tank','storage'],i:'mdi-storage-tank'},
                {k:['cwu','woda','water'],i:'mdi-water-outline'},
                {k:['ogrzew','radiator','grzejnik','heat'],i:'mdi-radiator'},
                {k:['brama','gate'],i:'mdi-gate'},
                {k:['garaz','garaÅ¼','garage'],i:'mdi-garage'},
                {k:['wilgotn','humidity'],i:'mdi-water-percent'},
                {k:['temp','temperatur'],i:'mdi-thermometer'},
                {k:['bateria','battery'],i:'mdi-battery'},
                {k:['swiatlo','light','bulb'],i:'mdi-lightbulb'},
                {k:['spotify','radio','media_player'],i:'mdi-play-circle'},
                {k:['klima','climate','hvac'],i:'mdi-home-thermometer'},
                {k:['sensor','czujnik'],i:'mdi-gauge'},
                {k:['lock','zamek'],i:'mdi-lock'},
                {k:['window','roleta','blind'],i:'mdi-window-shutter'}
            ];
            for(const m of map) if(m.k.some(x=>v.includes(x))) return m.i;
            const f={switch:'mdi-toggle-switch',sensor:'mdi-gauge',cover:'mdi-gate',media_player:'mdi-play-circle',climate:'mdi-home-thermometer',binary_sensor:'mdi-alert-circle-outline',script:'mdi-script-text-outline',navigate:'mdi-arrow-right-circle',label:'mdi-label'};
            return f[type]||'mdi-help-circle-outline';
        }

        function renderRows(){
            const c=document.getElementById('rows-container');
            c.innerHTML='';
            rows.forEach((rowWidgets,rowIdx)=>{
                const row=document.createElement('div');
                row.className='eink-row';
                row.id='row-'+rowIdx;
                row.addEventListener('click',()=>{ if(editingIndices) cancelEdit(); activeRowIndex=rowIdx; refreshUIText(); highlightActiveRow(); });
                const chip=document.createElement('div');
                chip.className='row-label-chip';
                chip.innerText=(currentLang==='pl'?'WIERSZ ':'ROW ')+(rowIdx+1);
                row.appendChild(chip);

                rowWidgets.forEach((w,i)=>{
                    const wDiv=document.createElement('div');
                    wDiv.className='eink-widget';
                    wDiv.dataset.title=w.name || resolveImportedTitle(w.id) || formatNameFromId(w.id);
                    if(editingIndices && editingIndices.r===rowIdx && editingIndices.w===i) wDiv.classList.add('being-edited');

                    // sizing
                    let width= w.size ? parseInt(w.size.replace(/[()]/,'').split('x')[0]) : 2;
                    let height= w.size ? parseInt(w.size.replace(/[()]/,'').split('x')[1]) : 1;
                    const baseW=160, baseH=130;
                    wDiv.style.width=(baseW + (width-2)*70)+'px';
                    wDiv.style.minHeight=(baseH + (height-1)*70)+'px';

                    wDiv.addEventListener('click',(e)=>{ e.stopPropagation(); editWidget(rowIdx,i); });

                    // Title
                    const importedTitle=resolveImportedTitle(w.id);
                    const safeName=w.name && w.name.trim()?w.name:(importedTitle||formatNameFromId(w.id));

                    // State-aware icon
                    const iconClass = getStateAwareIcon(w);
                    const stateText = getDisplayState(w.id, w.type);

                    wDiv.innerHTML=`
                        <div class="ew-title">${safeName}</div>
                        ${iconClass?`<i class="mdi ${iconClass} ew-icon"></i>`:`<div style="height:42px"></div>`}
                        ${stateText?`<div class="ew-state">${stateText}</div>`:`<div style="height:14px"></div>`}
                        <div class="ew-delete" onclick="removeWidget(${rowIdx},${i}); event.stopPropagation();">X</div>
                        <div class="ew-edit-overlay"></div>
                    `;
                    row.appendChild(wDiv);
                });

                if(rows.length>1){
                    const del=document.createElement('button');
                    del.className='btn-remove-row btn';
                    del.innerText='USUÅƒ';
                    del.style.position='absolute';
                    del.style.right='10px';
                    del.style.bottom='10px';
                    del.addEventListener('click',(e)=>{ e.stopPropagation(); deleteRow(rowIdx); });
                    row.appendChild(del);
                }
                c.appendChild(row);
            });
            highlightActiveRow();
        }

        function highlightActiveRow(){
            document.querySelectorAll('.eink-row').forEach(r=>r.classList.remove('active'));
            const active=document.getElementById('row-'+activeRowIndex);
            if(active) active.classList.add('active');
        }

        function toggleImport(){ document.getElementById('import-area').classList.toggle('visible'); }

        function importYaml(){
            const code=document.getElementById('import-code').value;
            if(!code) return;
            try{
                const lines=code.split('\n');
                const defs={};
                let current=null;
                const layoutLines=[];
                let parsingLayout=false;
                for(const raw of lines){
                    const line=raw.split('#')[0].trim();
                    if(!line) continue;
                    if(line.startsWith('layout:')){ parsingLayout=true; continue; }
                    if(parsingLayout){
                        if(line.startsWith('-')) layoutLines.push(line);
                        else if(/^\S+:/m.test(raw)) parsingLayout=false;
                    }
                    if(!parsingLayout){
                        const m=raw.match(/^([a-zA-Z0-9_\.]+):/);
                        if(m){
                            const key=m[1];
                            const ignore=['global_parameters','widget_dimensions','widget_size','widget_margins','columns','rows','skin','title'];
                            if(!ignore.includes(key)){ current=key; defs[current]={}; } else { current=null; }
                        } else if(current && line.includes(':')){
                            let val=line.substring(line.indexOf(':')+1).trim();
                            if((val.startsWith('"')&&val.endsWith('"'))||(val.startsWith("'")&&val.endsWith("'"))) val=val.slice(1,-1);
                            const k=line.split(':')[0].trim();
                            defs[current][k]=val;
                        }
                    }
                }
                importedDefsMap={};
                Object.entries(defs).forEach(([k,v])=>{
                    importedDefsMap[k]=v;
                    if(v.entity) importedDefsMap[v.entity]=v;
                });
                rows=[];
                layoutLines.forEach(l=>{
                    const items=l.substring(1).trim().split(',');
                    const row=[];
                    items.forEach(itemRaw=>{
                        let id=itemRaw.trim();
                        let size="";
                        const sm=id.match(/\(\d+x\d+\)/);
                        if(sm){ size=sm[0]; id=id.replace(sm[0],'').trim(); }
                        const def=importedDefsMap[id] || importedDefsMap[id.split('.').pop()] || null;
                        let type=def && def.widget_type;
                        if(!type){
                            if(id.startsWith('navigate.')) type='navigate';
                            else if(id.startsWith('sensor.')) type='sensor';
                            else if(id.startsWith('binary_sensor.')) type='binary_sensor';
                            else if(id.startsWith('cover.')) type='cover';
                            else if(id.startsWith('media_player.')) type='media_player';
                            else if(id.startsWith('climate.')) type='climate';
                            else if(id.startsWith('light.') || id.startsWith('switch.') || id.startsWith('input_boolean.')) type='switch';
                            else type='switch';
                        }
                        let name=resolveImportedTitle(id);
                        if(!name && def && def.entity) name=formatNameFromId(def.entity);
                        if(!name) name=formatNameFromId(id);
                        let icon=def && (def.icon||def.icon_on||def.icon_off||def.icon_inactive) || '';
                        if(!icon) icon=pickAutoIcon(type, def && def.entity?def.entity:id);
                        if(icon && !icon.startsWith('mdi-')) icon='mdi-'+icon;
                        row.push({id,type,name,icon,size});
                    });
                    if(row.length) rows.push(row);
                });
                if(!rows.length){ alert("Brak sekcji layout w kodzie."); return; }
                activeRowIndex=rows.length-1;
                renderRows();
                refreshUIText();
                toggleImport();
                alert("Import OK");
            }catch(e){ alert("Import bÅ‚Ä…d: "+e.message); }
        }

        function editWidget(r,w){
            editingIndices={r,w};
            const wid=rows[r][w];
            activeRowIndex=r;
            document.getElementById('new-widget-type').value=wid.type;
            toggleInputs();
            if(wid.type==='navigate'){
                document.getElementById('new-dashboard-name').value=wid.id.replace('navigate.','');
                document.getElementById('group-nav').classList.remove('hidden');
                document.getElementById('group-entity').classList.add('hidden');
            }else{
                document.getElementById('new-entity-id').value=wid.id;
                document.getElementById('group-entity').classList.remove('hidden');
                document.getElementById('group-nav').classList.add('hidden');
            }
            document.getElementById('new-widget-name').value=wid.name||'';
            document.getElementById('new-widget-icon').value=wid.icon||'';
            document.getElementById('new-widget-size').value=wid.size||'';
            updateIconPreview();
            document.getElementById('widget-form-box').classList.add('editing');
            document.getElementById('btn-cancel').classList.remove('hidden');
            refreshUIText();
            renderRows();
        }

        function cancelEdit(){
            editingIndices=null;
            clearForm();
            document.getElementById('widget-form-box').classList.remove('editing');
            document.getElementById('btn-cancel').classList.add('hidden');
            refreshUIText();
            renderRows();
        }

        function saveWidget(){
            const type=document.getElementById('new-widget-type').value;
            let name=document.getElementById('new-widget-name').value.trim();
            let icon=document.getElementById('new-widget-icon').value.trim();
            const size=document.getElementById('new-widget-size').value;
            let id='';
            if(type==='navigate'){
                const dash=document.getElementById('new-dashboard-name').value.trim();
                if(!dash){ alert("Wymagana nazwa dashboardu"); return; }
                id='navigate.'+dash;
            }else{
                id=document.getElementById('new-entity-id').value.trim();
                if(!id){ alert("Wymagana encja"); return; }
            }
            if(!name) name=formatNameFromId(id);
            if(!icon) icon=pickAutoIcon(type,id);
            if(icon && !icon.startsWith('mdi-')) icon='mdi-'+icon;
            const obj={id,type,name,icon,size};
            if(editingIndices){
                rows[editingIndices.r][editingIndices.w]=obj;
                cancelEdit();
            }else{
                if(!rows.length) addNewRow();
                rows[activeRowIndex].push(obj);
                clearForm();
            }
            renderRows();
            refreshUIText();
        }

        function clearForm(){
            document.getElementById('new-entity-id').value='';
            document.getElementById('new-dashboard-name').value='';
            document.getElementById('new-widget-name').value='';
            document.getElementById('new-widget-icon').value='';
            document.getElementById('new-widget-size').value='';
            updateIconPreview();
        }
        function removeWidget(r,w){
            if(editingIndices && editingIndices.r===r && editingIndices.w===w) cancelEdit();
            rows[r].splice(w,1);
            renderRows();
        }
        function toggleInputs(){
            const t=document.getElementById('new-widget-type').value;
            const entityGrp=document.getElementById('group-entity');
            const navGrp=document.getElementById('group-nav');
            if(t==='navigate'){ entityGrp.classList.add('hidden'); navGrp.classList.remove('hidden'); }
            else { navGrp.classList.add('hidden'); entityGrp.classList.remove('hidden'); }
        }
        function updateIconPreview(){
            const val=document.getElementById('new-widget-icon').value.trim();
            const el=document.getElementById('icon-preview-i');
            el.className= val && val.startsWith('mdi-') ? 'mdi '+val : 'mdi mdi-help-circle-outline';
        }
        function megaAutoConfig(){
            const id=document.getElementById('new-entity-id').value.toLowerCase();
            if(!id) return;
            const tSel=document.getElementById('new-widget-type');
            if(id.startsWith('sensor.')) tSel.value='sensor';
            else if(id.startsWith('binary_sensor.')) tSel.value='binary_sensor';
            else if(id.startsWith('cover.')) tSel.value='cover';
            else if(id.startsWith('media_player.')) tSel.value='media_player';
            else if(id.startsWith('climate.')) tSel.value='climate';
            else if(id.startsWith('switch.') || id.startsWith('light.') || id.startsWith('input_boolean.')) tSel.value='switch';
            const iconInput=document.getElementById('new-widget-icon');
            if(!iconInput.value){
                iconInput.value=pickAutoIcon(tSel.value,id);
                updateIconPreview();
            }
        }
        function addNewRow(){ rows.push([]); activeRowIndex=rows.length-1; renderRows(); refreshUIText(); }
        function deleteRow(i){ rows.splice(i,1); if(activeRowIndex>=rows.length) activeRowIndex=rows.length-1; renderRows(); refreshUIText(); }
        function submitForm(){ document.getElementById('layout_data_json').value=JSON.stringify(rows); document.getElementById('main-form').submit(); }

        window.addEventListener('DOMContentLoaded',()=>{
            const host=window.location.hostname;
            const pathCode=document.getElementById('path-code');
            const dashLink=document.getElementById('dashboard-link');
            if(pathCode) pathCode.innerHTML=pathCode.innerHTML.replace('IP_HA',host);
            if(dashLink){
                const href=`http://${host}:5050/{{ dash_name }}`;
                dashLink.href=href;
                dashLink.innerText=href;
            }
            const lang=localStorage.getItem('joan_lang')||'pl';
            const theme=localStorage.getItem('joan_theme')||'light';
            setLang(lang);
            if(theme==='dark') document.body.classList.add('dark-mode');
            if(!rows.length) addNewRow();
        });
    </script>
</body>
</html>
