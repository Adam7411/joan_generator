<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joan 6 E-Ink Generator</title>
    <!-- Ikony i Czcionki -->
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- Skrypt motywu (zapobiega mruganiu) -->
    <script>
        (function() {
            try {
                const savedTheme = localStorage.getItem('joan_theme') || 'light';
                if (savedTheme === 'dark') document.documentElement.classList.add('dark-mode');
            } catch(e) {}
        })();
    </script>

    <style>
        /* Zmienne kolorystyczne */
        :root {
            --bg-body: #e0e0e0; --bg-container: #ffffff; --bg-section: #fafafa; --bg-input: #ffffff;
            --text-main: #333333; --border: #cccccc; --accent: #d32f2f; --highlight: #e3f2fd;
            --preview-bg: #f0f0f0; --link-bg: #e1f5fe; --link-color: #0277bd;
        }
        html.dark-mode {
            --bg-body: #121212; --bg-container: #1e1e1e; --bg-section: #252525; --bg-input: #2c2c2c;
            --text-main: #e0e0e0; --border: #444444; --accent: #ff5252; --highlight: #0d47a1;
            --preview-bg: #000000; --link-bg: #013655; --link-color: #81d4fa;
        }

        body { font-family: 'Roboto', sans-serif; background-color: var(--bg-body); color: var(--text-main); padding: 20px; transition: background 0.3s; }
        .container { max-width: 1400px; margin: 0 auto; background: var(--bg-container); padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        
        .header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border); padding-bottom: 20px; margin-bottom: 25px; }
        h1 { margin: 0; color: var(--accent); font-size: 28px; }
        
        .controls button { padding: 8px 16px; border: 1px solid var(--border); background: var(--bg-section); color: var(--text-main); border-radius: 4px; cursor: pointer; font-weight: bold; }
        .controls button.active { background: var(--accent); color: white; border-color: var(--accent); }

        .section { background: var(--bg-section); padding: 25px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 30px; }
        .section-title { font-size: 1.4em; font-weight: 900; border-bottom: 3px solid var(--accent); display: inline-block; margin-bottom: 20px; color: var(--text-main); }

        .file-path-info { background-color: var(--link-bg); color: var(--link-color); border: 1px solid var(--border); padding: 20px; margin-bottom: 20px; border-radius: 6px; font-family: monospace; font-size: 15px; line-height: 1.6; word-break: break-all; }
        .file-path-info strong { display: block; margin-top: 10px; color: var(--text-main); font-size: 1.1em; }
        .file-path-info a { color: var(--accent); font-weight: bold; font-size: 16px; text-decoration: underline; }

        .add-widget-box { background: var(--highlight); padding: 25px; border-radius: 8px; border: 1px solid var(--accent); transition: all 0.3s; margin-bottom: 30px; }
        .add-widget-box.editing { border: 3px solid #ff9800; background: rgba(255, 152, 0, 0.1); }

        .flex-row { display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 15px; }
        .flex-col { flex: 1; min-width: 160px; }
        
        label { display: block; font-weight: bold; font-size: 0.9em; margin-bottom: 8px; color: var(--text-main); }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); background: var(--bg-input); color: var(--text-main); border-radius: 4px; box-sizing: border-box; font-size: 14px; }
        
        /* Styl pola wyszukiwania encji */
        #w-id { border: 2px solid var(--accent); background-color: var(--bg-input); font-weight: bold; }

        .btn { padding: 12px 24px; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; text-transform: uppercase; color: white; font-size: 14px; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-add { background: #4caf50; width: 100%; }
        .btn-gen { background: var(--accent); width: 100%; font-size: 20px; padding: 15px; margin-top: 20px;}
        .btn-cancel { background: #757575; }
        .btn-row { background: #2196f3; margin-top: 15px; }
        .btn-import { background: #ff9800; color: white; width: auto; margin-top: 10px; }

        /* PODGLƒÑD E-INK */
        .preview-area { background: var(--preview-bg); padding: 30px; border: 2px solid var(--border); border-radius: 8px; overflow-x: auto; min-height: 300px; }
        .eink-row { display: flex; gap: 8px; margin-bottom: 12px; padding: 15px; border: 2px dashed #999; border-radius: 6px; min-height: 140px; align-items: center; position: relative; }
        .row-label { position: absolute; top: -10px; left: 10px; font-size: 11px; background: var(--bg-body); padding: 2px 8px; color: var(--text-main); border: 1px solid var(--border); border-radius: 4px; font-weight: bold; }

        .eink-widget {
            background: #FFFFFF; border: 3px solid #000000; color: #000000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 6px; box-sizing: border-box; cursor: pointer; position: relative;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.25); transition: transform 0.1s; flex-shrink: 0; overflow: hidden;
        }
        .eink-widget:hover { transform: translateY(-3px); z-index: 10; border-color: var(--accent); }
        .eink-widget.editing { border: 3px dashed #ff9800; transform: scale(1.03); z-index: 20; }

        .ew-title { font-weight: 900; font-size: 14px; text-align: center; width: 100%; line-height: 1.1; margin-bottom: 5px; white-space: normal; font-family: sans-serif; text-transform: uppercase; }
        .ew-icon { font-size: 42px; display: block; margin-bottom: 2px; }
        .ew-state { font-weight: 900; font-size: 12px; text-transform: uppercase; border: 2px solid #000; padding: 2px 6px; margin-top: 4px; border-radius: 4px; }
        .ew-del { position: absolute; top: -10px; right: -10px; background: red; color: white; width: 24px; height: 24px; border-radius: 50%; text-align: center; line-height: 24px; font-weight: bold; display: none; box-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        .eink-widget:hover .ew-del { display: block; }

        .icon-preview { font-size: 32px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-input); }
        .hidden { display: none !important; }
        textarea.output { width: 100%; height: 500px; font-family: 'Consolas', 'Monaco', monospace; background: #263238; color: #eceff1; border: none; padding: 20px; border-radius: 8px; font-size: 14px; line-height: 1.5; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-row">
            <h1>Joan 6 E-Ink Generator</h1>
            <div class="controls">
                <button type="button" onclick="toggleTheme()" id="btn-theme">üåô</button>
                <button type="button" onclick="setLang('pl')" id="btn-pl" class="active">PL</button>
                <button type="button" onclick="setLang('en')" id="btn-en">EN</button>
            </div>
        </div>

        <div class="section" id="import-section">
            <details>
                <summary style="cursor: pointer; font-weight: bold; font-size: 1.1em;">üìÇ Import / Eksport Kodu .DASH</summary>
                <div style="margin-top: 15px;">
                    <textarea id="import-code" style="height: 150px;" placeholder="Wklej tutaj zawarto≈õƒá pliku .dash aby go edytowaƒá..."></textarea>
                    <button type="button" class="btn btn-import" onclick="importYaml()">Wczytaj Kod</button>
                </div>
            </details>
        </div>

        <form method="POST" id="main-form">
            <input type="hidden" name="title" value="JoanDashboard">
            <input type="hidden" name="ui_language" id="input-lang" value="pl">
            
            <div class="add-widget-box" id="editor-box">
                <div class="section-title" id="editor-title" data-i18n="sec_add">Dodaj Widget</div>
                
                <div class="flex-row">
                    <div class="flex-col">
                        <label data-i18n="lbl_type">Typ Widgetu</label>
                        <select id="w-type" onchange="toggleInputs()">
                            <option value="switch" data-i18n="opt_switch">Switch / Light</option>
                            <option value="cover" data-i18n="opt_cover">Cover / Gate</option>
                            <option value="sensor" data-i18n="opt_sensor">Sensor</option>
                            <option value="binary_sensor" data-i18n="opt_binary">Binary Sensor</option>
                            <option value="lock" data-i18n="opt_lock">Lock</option>
                            <option value="person" data-i18n="opt_person">Person / Tracker</option>
                            <option value="media_player" data-i18n="opt_media">Media Player</option>
                            <option value="climate" data-i18n="opt_climate">Climate</option>
                            <option value="input_select" data-i18n="opt_input_select">Input Select</option>
                            <option value="input_number" data-i18n="opt_input_number">Input Number</option>
                            <option value="script" data-i18n="opt_script">Script</option>
                            <option value="navigate" data-i18n="opt_navigate">Navigate / Button</option>
                            <option value="label" data-i18n="opt_label">Label (Text)</option>
                            <option value="clock" data-i18n="opt_clock">Clock</option>
                            <option value="spacer" data-i18n="opt_spacer">Spacer (Empty)</option>
                        </select>
                    </div>
                    <div class="flex-col" id="grp-entity">
                        <label data-i18n="lbl_entity">Encja (Home Assistant)</label>
                        <!-- ULEPSZONE WYSZUKIWANIE -->
                        <input list="entity-list" id="w-id" placeholder="np. glosnik, swiatlo..." oninput="searchEntities(this.value)" autocomplete="off">
                        <datalist id="entity-list"></datalist>
                    </div>
                    <div class="flex-col hidden" id="grp-nav">
                        <label data-i18n="lbl_dash">Nazwa Dashboardu</label>
                        <input type="text" id="w-dash" placeholder="np. main" oninput="autoNameNav()">
                    </div>
                    <div class="flex-col">
                        <label data-i18n="lbl_name">Tytu≈Ç na ekranie</label>
                        <input type="text" id="w-name" placeholder="np. Salon">
                    </div>
                </div>

                <div class="flex-row">
                    <div class="flex-col">
                        <label data-i18n="lbl_size">Rozmiar</label>
                        <select id="w-size">
                            <option value="(1x1)" data-i18n="size_1x1">1x1 (Ma≈Çy)</option>
                            <option value="(2x1)" data-i18n="size_2x1">2x1 (Standard)</option>
                            <option value="(2x2)" data-i18n="size_2x2">2x2 (Du≈ºy)</option>
                            <option value="(3x1)" data-i18n="size_3x1">3x1 (Szeroki)</option>
                            <option value="(1x2)" data-i18n="size_1x2">1x2 (Wysoki)</option>
                            <option value="(3x2)" data-i18n="size_3x2">3x2 (Ogromny)</option>
                        </select>
                    </div>
                    <div class="flex-col" style="flex: 0 0 60px;">
                        <label data-i18n="lbl_preview">PodglƒÖd</label>
                        <div style="display:flex; justify-content:center;">
                            <i id="preview-icon" class="mdi mdi-help-circle-outline icon-preview"></i>
                        </div>
                    </div>
                    <div class="flex-col">
                        <label data-i18n="lbl_icon">Ikona</label>
                        <input type="text" id="w-icon" oninput="updateIconPreview()" placeholder="mdi-home">
                    </div>
                    <div class="flex-col">
                        <label>Ikona ON</label>
                        <input type="text" id="w-icon-on" oninput="updateIconPreview()" placeholder="mdi-lightbulb-on">
                    </div>
                    <div class="flex-col">
                        <label>Ikona OFF</label>
                        <input type="text" id="w-icon-off" oninput="updateIconPreview()" placeholder="mdi-lightbulb-outline">
                    </div>
                </div>

                <div class="flex-row" style="margin-top: 20px;">
                    <button type="button" class="btn btn-add" id="btn-submit" onclick="saveWidget()" data-i18n="btn_add">+ DODAJ WIDGET</button>
                    <button type="button" class="btn btn-cancel hidden" id="btn-cancel" onclick="cancelEdit()" data-i18n="btn_cancel">ANULUJ</button>
                </div>
            </div>

            <!-- PODGLƒÑD E-INK -->
            <div class="section">
                <div class="section-title" data-i18n="sec_preview">PodglƒÖd Dashboardu (Kliknij by edytowaƒá)</div>
                <div class="preview-area" id="preview-container"></div>
                <button type="button" class="btn btn-row" onclick="addRow()" data-i18n="btn_row">+ Dodaj Wiersz</button>
            </div>

            <input type="hidden" name="layout_data_json" id="layout_json">
            <button type="button" class="btn btn-gen" onclick="submitData()" data-i18n="btn_gen">GENERUJ KOD .DASH</button>
        </form>

        {% if generated_yaml %}
        <div class="section" style="margin-top:30px;">
            <div class="section-title">Wynikowy Kod YAML</div>
            <div class="file-path-info">
                <strong>1. Zapisz kod w pliku:</strong>
                <code id="path-code">\\IP_HA\addon_configs\appdaemon\dashboards\{{ filename }}</code>
                <strong>2. Uruchom ponownie AppDaemon i sprawd≈∫ dashboard:</strong>
                <!-- HOST zostanie podmieniony przez JS -->
                <a href="http://[HOST]:5050/{{ dash_name }}" id="dashboard-link" target="_blank">http://[HOST]:5050/{{ dash_name }}</a>
            </div>
            <textarea class="output" readonly>{{ generated_yaml }}</textarea>
        </div>
        {% endif %}
    </div>

    <!-- LOGIKA JAVASCRIPT (KOMPLETNA) -->
    <script>
        // --- 1. DANE I ZMIENNE ---
        const entitiesData = {{ entities | tojson | safe }};
        let rows = [[]]; // Start with 1 empty row
        let editIdx = null; 
        let blockSmart = false; // Blokada automatyki przy imporcie/edycji
        let currentLang = 'pl';
        let importedDefsMap = {}; 

        // --- T≈ÅUMACZENIA ---
        const TRANSLATIONS = {
            pl: {
                sec_add: "Dodaj Widget", sec_edit: "Edytuj Widget", sec_preview: "PodglƒÖd Dashboardu (Kliknij, aby edytowaƒá)",
                lbl_type: "Typ Widgetu", lbl_entity: "Encja (Home Assistant)", lbl_name: "Tytu≈Ç na ekranie", lbl_size: "Rozmiar", 
                lbl_icon: "Ikona", lbl_dash: "Nazwa Dashboardu", lbl_preview: "PodglƒÖd",
                btn_add: "+ DODAJ WIDGET", btn_update: "ZAPISZ ZMIANY", btn_cancel: "ANULUJ", 
                btn_row: "+ Dodaj Wiersz", btn_gen: "GENERUJ KOD .DASH",
                
                opt_switch: "Prze≈ÇƒÖcznik / ≈öwiat≈Ço", opt_cover: "Roleta / Brama", opt_sensor: "Sensor (Info)",
                opt_binary: "Sensor Binarny (On/Off)", opt_lock: "Zamek", opt_person: "Osoba / Tracker",
                opt_media: "Odtwarzacz Media", opt_climate: "Termostat", opt_input_select: "Lista Wyboru",
                opt_input_number: "Suwak Liczbowy", opt_script: "Skrypt", opt_navigate: "Przycisk Nawigacji",
                opt_label: "Etykieta (Tekst)", opt_clock: "Zegar", opt_spacer: "Odstƒôp (Pusty)",
                
                size_1x1: "1x1 (Ma≈Çy/Ikona)", size_2x1: "2x1 (Szeroki Przycisk)", size_2x2: "2x2 (Du≈ºy/Media)",
                size_3x1: "3x1 (Bardzo Szeroki)", size_1x2: "1x2 (Wysoki)", size_3x2: "3x2 (Ogromny)"
            },
            en: {
                sec_add: "Add Widget", sec_edit: "Edit Widget", sec_preview: "Dashboard Preview (Click to Edit)",
                lbl_type: "Widget Type", lbl_entity: "Entity (Home Assistant)", lbl_name: "Title on Screen", lbl_size: "Size", 
                lbl_icon: "Icon", lbl_dash: "Dashboard Name", lbl_preview: "Icon",
                btn_add: "+ ADD WIDGET", btn_update: "SAVE CHANGES", btn_cancel: "CANCEL", 
                btn_row: "+ Add Row", btn_gen: "GENERATE .DASH CODE",
                
                opt_switch: "Switch / Light", opt_cover: "Cover / Gate", opt_sensor: "Sensor (Info)", 
                opt_binary: "Binary Sensor", opt_lock: "Lock", opt_person: "Person / Tracker",
                opt_media: "Media Player", opt_climate: "Climate", opt_input_select: "Input Select",
                opt_input_number: "Input Number", opt_script: "Script", opt_navigate: "Navigation Button",
                opt_label: "Label (Text)", opt_clock: "Clock", opt_spacer: "Spacer (Empty)",

                size_1x1: "1x1 (Small/Icon)", size_2x1: "2x1 (Wide Button)", size_2x2: "2x2 (Large/Media)",
                size_3x1: "3x1 (Extra Wide)", size_1x2: "1x2 (Tall)", size_3x2: "3x2 (Huge)"
            }
        };

        // --- 2. FUNKCJE POMOCNICZE (NA G√ìRZE) ---

        // Zaawansowane wyszukiwanie encji (Filtrowanie datalist w locie)
        function searchEntities(val) {
            // Najpierw uruchom logikƒô smart dla tego, co ju≈º wpisano
            runSmartLogic(val);

            // Filtrowanie listy
            const dl = document.getElementById('entity-list');
            dl.innerHTML = ''; // Wyczy≈õƒá
            
            if(!val || val.length < 2) return; // Nie filtruj dla 1 litery

            const term = val.toLowerCase();
            const filtered = entitiesData.filter(e => e.id.toLowerCase().includes(term));
            
            // Poka≈º max 50 wynik√≥w, ≈ºeby nie muliƒá przeglƒÖdarki
            filtered.slice(0, 50).forEach(e => {
                const opt = document.createElement('option');
                opt.value = e.id;
                opt.setAttribute('data-dclass', e.attributes.device_class || '');
                opt.setAttribute('data-friendly', e.attributes.friendly_name || '');
                dl.appendChild(opt);
            });
        }

        function resolveImportedTitle(id) {
            if (!importedDefsMap) return '';
            if (importedDefsMap[id] && importedDefsMap[id].title) return importedDefsMap[id].title;
            const shortId = id.includes('.') ? id.split('.')[1] : id;
            if (importedDefsMap[shortId] && importedDefsMap[shortId].title) return importedDefsMap[shortId].title;
            return '';
        }

        function getEntityMeta(id) {
            return entitiesData.find(e => e.id === id) || { attributes: {} };
        }

        // SMART NAZWY - Inteligentne formatowanie
        function formatSmartName(id, friendlyName) {
            if (friendlyName && friendlyName.length > 2) return friendlyName;
            
            if(!id) return "";
            if(id.startsWith('navigate.')) return id.replace('navigate.','').toUpperCase();
            
            // light.swiatlo_podworko_ganek_l2 -> Swiatlo Podworko Ganek
            let name = id.split('.').pop(); 
            name = name.replace(/_[lvr]\d+$/i, '').replace(/_state$/i, '');
            name = name.replace(/_/g, ' ');
            return name.replace(/\b\w/g, l => l.toUpperCase());
        }

        function updateIconPreview() {
            const i1 = document.getElementById('w-icon').value;
            const i2 = document.getElementById('w-icon-on').value;
            const i3 = document.getElementById('w-icon-off').value;
            const final = i1 || i2 || i3 || 'mdi-help-circle-outline';
            document.getElementById('preview-icon').className = `mdi ${final} icon-preview`;
        }

        function toggleInputs() {
            const type = document.getElementById('w-type').value;
            const isNav = type === 'navigate';
            const isSpacer = type === 'spacer';
            
            document.getElementById('grp-entity').style.display = (isNav || isSpacer) ? 'none' : 'block';
            document.getElementById('grp-nav').style.display = isNav ? 'block' : 'none';
            document.getElementById('grp-nav').classList.toggle('hidden', !isNav);
        }

        // --- 3. SMART LOGIC (SUPER ROZBUDOWANA) ---
        // Definicje domy≈õlne typ√≥w
        const SMART_MAP = {
            'light': { type: 'switch', size: '(2x1)', iconOn: 'mdi-lightbulb-on', iconOff: 'mdi-lightbulb-outline' },
            'switch': { type: 'switch', size: '(2x1)', iconOn: 'mdi-toggle-switch', iconOff: 'mdi-toggle-switch-off' },
            'cover': { type: 'cover', size: '(2x1)', iconOn: 'mdi-window-shutter-open', iconOff: 'mdi-window-shutter' },
            'garage': { type: 'cover', size: '(2x1)', iconOn: 'mdi-garage-open', iconOff: 'mdi-garage' },
            'binary_sensor': { type: 'binary_sensor', size: '(1x1)', iconOn: 'mdi-checkbox-marked-circle', iconOff: 'mdi-checkbox-blank-circle-outline' },
            'sensor': { type: 'sensor', size: '(1x1)', icon: 'mdi-eye' },
            'media_player': { type: 'media_player', size: '(2x2)', icon: '' },
            'climate': { type: 'climate', size: '(2x2)', icon: '' },
            'lock': { type: 'lock', size: '(2x1)', iconOn: 'mdi-lock-open', iconOff: 'mdi-lock' }
        };

        function runSmartLogic(val) {
            if (blockSmart) return; 
            
            const id = val.toLowerCase();
            if (id.length < 3) return;

            // Szukamy w danych
            const ent = getEntityMeta(id);
            const dClass = (ent.attributes.device_class || '').toLowerCase();
            const fName = ent.attributes.friendly_name || '';
            const domain = id.split('.')[0];

            // 1. USTALENIE TYPU I BAZY
            let conf = SMART_MAP[domain] || { type: 'sensor', size: '(1x1)', icon: 'mdi-eye' };

            // 2. DETEKCJA PO S≈ÅOWACH KLUCZOWYCH (Dla polskich nazw bez znak√≥w)
            if (id.includes('glosnik') || id.includes('speaker') || id.includes('audio')) {
                conf = SMART_MAP['media_player'];
            } else if (id.includes('swiatlo') || id.includes('lamp') || id.includes('kinkiet')) {
                conf = SMART_MAP['light'];
            } else if (id.includes('gniazdko') || id.includes('outlet')) {
                conf = SMART_MAP['switch'];
            } else if (id.includes('brama') || id.includes('gate')) {
                conf = SMART_MAP['garage'];
            } else if (id.includes('drzwi') || id.includes('door') || id.includes('furtka')) {
                conf = { type: 'binary_sensor', size: '(1x1)', iconOn: 'mdi-door-open', iconOff: 'mdi-door-closed' };
            } else if (id.includes('temp') || id.includes('therm')) {
                conf = { type: 'sensor', size: '(1x1)', icon: 'mdi-thermometer' };
            } else if (id.includes('wilg') || id.includes('humid')) {
                conf = { type: 'sensor', size: '(1x1)', icon: 'mdi-water-percent' };
            }

            // 3. DETEKCJA PO DEVICE_CLASS (Nadpisuje s≈Çowa kluczowe)
            if (dClass === 'garage') conf = SMART_MAP['garage'];
            if (dClass === 'door') conf = { type: 'binary_sensor', size: '(1x1)', iconOn: 'mdi-door-open', iconOff: 'mdi-door-closed' };
            if (dClass === 'battery') conf = { type: 'sensor', size: '(1x1)', icon: 'mdi-battery' };
            if (dClass === 'temperature') conf = { type: 'sensor', size: '(1x1)', icon: 'mdi-thermometer' };
            if (domain === 'input_boolean') conf = SMART_MAP['switch'];

            // APLIKOWANIE DANYCH
            document.getElementById('w-type').value = conf.type;
            
            // Smart Size - zawsze ustawiaj sugerowany rozmiar przy wpisywaniu nowej encji
            document.getElementById('w-size').value = conf.size;
            
            // Smart Name
            const nameField = document.getElementById('w-name');
            nameField.value = formatSmartName(id, fName);

            // Smart Icons
            document.getElementById('w-icon').value = conf.icon || '';
            document.getElementById('w-icon-on').value = conf.iconOn || '';
            document.getElementById('w-icon-off').value = conf.iconOff || '';

            toggleInputs();
            updateIconPreview();
        }

        function autoNameNav() {
            if(blockSmart) return;
            const val = document.getElementById('w-dash').value;
            document.getElementById('w-name').value = val.toUpperCase();
        }

        // --- 4. CRUD & RENDER ---

        function setLang(lang) {
            currentLang = lang;
            document.getElementById('input-lang').value = lang;
            document.getElementById('btn-pl').className = lang === 'pl' ? 'active' : '';
            document.getElementById('btn-en').className = lang === 'en' ? 'active' : '';
            const t = TRANSLATIONS[lang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) {
                    if (el.tagName === 'INPUT' && el.type === 'submit') el.value = t[key];
                    else el.innerText = t[key];
                }
            });
            document.querySelectorAll('option[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.text = t[key];
            });
            const btn = document.getElementById('btn-submit');
            btn.innerText = editIdx ? t.btn_update : t.btn_add;
            renderPreview();
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark-mode');
            localStorage.setItem('joan_theme', isDark ? 'dark' : 'light');
            document.getElementById('btn-theme').innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        function saveWidget() {
            const w = {
                type: document.getElementById('w-type').value,
                id: document.getElementById('w-id').value,
                dash: document.getElementById('w-dash').value,
                name: document.getElementById('w-name').value,
                size: document.getElementById('w-size').value,
                icon: document.getElementById('w-icon').value,
                icon_on: document.getElementById('w-icon-on').value,
                icon_off: document.getElementById('w-icon-off').value
            };

            if(w.type === 'navigate') w.id = 'navigate.' + w.dash;
            if(w.type === 'spacer') w.id = 'spacer';

            if(editIdx) {
                rows[editIdx.r][editIdx.w] = w;
                cancelEdit();
            } else {
                rows[rows.length-1].push(w);
                clearForm();
            }
            renderPreview();
        }

        function editWidget(r, w) {
            blockSmart = true; // ZABLOKUJ SMART
            editIdx = {r, w};
            const data = rows[r][w];

            document.getElementById('editor-box').classList.add('editing');
            document.getElementById('btn-cancel').classList.remove('hidden');
            const t = TRANSLATIONS[currentLang];
            document.getElementById('editor-title').innerText = t.sec_edit;
            document.getElementById('btn-submit').innerText = t.btn_update;

            document.getElementById('w-type').value = data.type;
            toggleInputs();

            if(data.type === 'navigate') document.getElementById('w-dash').value = data.id.replace('navigate.', '');
            else document.getElementById('w-id').value = data.id;

            document.getElementById('w-name').value = data.name;
            document.getElementById('w-size').value = data.size || '(1x1)';
            document.getElementById('w-icon').value = data.icon || '';
            document.getElementById('w-icon-on').value = data.icon_on || '';
            document.getElementById('w-icon-off').value = data.icon_off || '';
            
            updateIconPreview();
            setTimeout(() => blockSmart = false, 500);
        }

        function cancelEdit() {
            editIdx = null;
            blockSmart = false;
            document.getElementById('editor-box').classList.remove('editing');
            document.getElementById('btn-cancel').classList.add('hidden');
            const t = TRANSLATIONS[currentLang];
            document.getElementById('editor-title').innerText = t.sec_add;
            document.getElementById('btn-submit').innerText = t.btn_add;
            clearForm();
        }

        function clearForm() {
            document.getElementById('w-id').value = '';
            document.getElementById('w-name').value = '';
            document.getElementById('w-icon').value = '';
            document.getElementById('w-icon-on').value = '';
            document.getElementById('w-icon-off').value = '';
            updateIconPreview();
        }

        function deleteWidget(r, w, e) {
            e.stopPropagation();
            rows[r].splice(w, 1);
            if(editIdx && editIdx.r === r && editIdx.w === w) cancelEdit();
            renderPreview();
        }

        function addRow() {
            rows.push([]);
            renderPreview();
        }

        function renderPreview() {
            const container = document.getElementById('preview-container');
            container.innerHTML = '';

            rows.forEach((row, rI) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'eink-row';
                
                const label = document.createElement('div');
                label.className = 'row-label';
                label.innerText = (currentLang === 'pl' ? 'WIERSZ ' : 'ROW ') + (rI + 1);
                rowDiv.appendChild(label);

                row.forEach((w, wI) => {
                    const div = document.createElement('div');
                    div.className = 'eink-widget';
                    if(editIdx && editIdx.r === rI && editIdx.w === wI) div.classList.add('editing');

                    let cols = 1, rw = 1;
                    if(w.size) {
                        const parts = w.size.replace(/[()]/g, '').split('x');
                        cols = parseInt(parts[0]) || 1;
                        rw = parseInt(parts[1]) || 1;
                    }
                    
                    const width = (cols * 115) + ((cols - 1) * 8);
                    const height = (rw * 115) + ((rw - 1) * 8);
                    
                    div.style.width = width + 'px';
                    div.style.height = height + 'px';

                    if(w.type === 'spacer') {
                        div.style.border = '1px dashed #aaa';
                        div.style.boxShadow = 'none';
                        div.style.opacity = '0.5';
                        div.innerHTML = '<span style="font-size:10px; color:#999;">SPACER</span>';
                    } else {
                        const icon = w.icon || w.icon_on || 'mdi-cube-outline';
                        div.innerHTML = `
                            <div class="ew-title">${w.name || w.id}</div>
                            <i class="mdi ${icon} ew-icon"></i>
                            <div class="ew-state">${w.type}</div>
                            <div class="ew-del" onclick="deleteWidget(${rI}, ${wI}, event)">X</div>
                        `;
                    }
                    div.onclick = () => editWidget(rI, wI);
                    rowDiv.appendChild(div);
                });
                container.appendChild(rowDiv);
            });
        }

        function submitData() {
            document.getElementById('layout_json').value = JSON.stringify(rows);
            document.getElementById('main-form').submit();
        }

        // --- 5. IMPORT LOGIC ---
        function importYaml() {
            const text = document.getElementById('import-code').value;
            if(!text) return;
            blockSmart = true;
            
            const lines = text.split('\n');
            const newRows = [];
            let inLayout = false;
            let rawDefs = {};
            let currentDefKey = null;

            lines.forEach(line => {
                const tr = line.trim();
                if(!tr || tr.startsWith('#')) return;

                if (line.match(/^\S+:/) && !line.startsWith('layout:') && !line.startsWith('global_parameters:')) {
                    currentDefKey = line.split(':')[0].trim();
                    rawDefs[currentDefKey] = {};
                } else if (currentDefKey && (line.startsWith('  ') || line.startsWith('\t'))) {
                    const parts = tr.split(':');
                    if(parts.length >= 2) {
                        const key = parts[0].trim();
                        let val = parts.slice(1).join(':').trim().replace(/['"]/g, '');
                        rawDefs[currentDefKey][key] = val;
                    }
                } else if (!line.startsWith('  ') && !line.startsWith('\t')) {
                    currentDefKey = null;
                }
            });
            
            importedDefsMap = rawDefs;

            lines.forEach(line => {
                const tr = line.trim();
                if(tr.startsWith('layout:')) { inLayout = true; return; }
                
                if(inLayout && tr.startsWith('-')) {
                    const content = tr.substring(1).trim();
                    const widgets = content.split(',').map(s => s.trim());
                    const rowData = [];
                    widgets.forEach(wStr => {
                        let id = wStr;
                        let size = '(1x1)';
                        const sizeMatch = wStr.match(/\(\d+x\d+\)/);
                        if(sizeMatch) {
                            size = sizeMatch[0];
                            id = wStr.replace(size, '').trim();
                        }
                        
                        let type = 'switch';
                        let name = id;
                        let icon = '';
                        let icon_on = '';
                        let icon_off = '';

                        const def = rawDefs[id];
                        if(def) {
                            if(def.widget_type) type = def.widget_type;
                            if(def.title) name = def.title;
                            if(def.icon) icon = def.icon;
                            if(def.icon_on) icon_on = def.icon_on;
                            if(def.icon_off) icon_off = def.icon_off;
                            if(def.icon_locked) icon_off = def.icon_locked;
                            if(def.icon_unlocked) icon_on = def.icon_unlocked;
                        } else {
                            if(id === 'spacer') type = 'spacer';
                            else if(id.startsWith('navigate.')) type = 'navigate';
                            else if(id.startsWith('sensor.')) type = 'sensor';
                        }
                        
                        if(name === id && type !== 'spacer') name = formatSmartName(id, '');

                        rowData.push({
                            id: id, type: type, size: size, name: name, 
                            icon: icon, icon_on: icon_on, icon_off: icon_off
                        });
                    });
                    newRows.push(rowData);
                }
                
                if(inLayout && tr.length > 0 && !tr.startsWith('-') && !tr.startsWith(' ') && !tr.startsWith('layout:')) {
                    inLayout = false;
                }
            });
            
            if(newRows.length > 0) {
                rows = newRows;
                renderPreview();
                alert("Pomy≈õlnie zaimportowano uk≈Çad.");
            } else {
                alert("B≈ÇƒÖd: Nie znaleziono sekcji 'layout:' w kodzie.");
            }
            setTimeout(() => blockSmart = false, 1000);
        }

        // --- START ---
        window.addEventListener('DOMContentLoaded', () => {
            const host = window.location.hostname;
            const pathEl = document.getElementById('path-code');
            const linkEl = document.getElementById('dashboard-link');
            
            if(pathEl) {
                pathEl.innerText = pathEl.innerText.replace('IP_HA', host);
            }
            if(linkEl) {
                const rawHref = linkEl.getAttribute('href');
                if (rawHref.includes('[HOST]')) {
                    const newHref = rawHref.replace(/\[HOST\]/g, host);
                    linkEl.setAttribute('href', newHref);
                    linkEl.innerText = newHref;
                }
            }

            setLang('pl');
            const savedTheme = localStorage.getItem('joan_theme') || 'light';
            document.getElementById('btn-theme').innerText = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            
            if(!rows.length || (rows.length===1 && !rows[0].length)) {
                // Empty start
            } else {
                renderPreview();
            }
        });
    </script>
</body>
</html>
