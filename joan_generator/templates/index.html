<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joan 6 E-Ink Generator (Final Monster Edition)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    
    <script>
        (function() {
            try {
                const savedTheme = localStorage.getItem('joan_theme') || 'light';
                if (savedTheme === 'dark') { document.documentElement.classList.add('dark-mode'); }
            } catch(e) { console.error(e); }
        })();
    </script>

    <style>
        :root {
            --bg-body: #e0e0e0; --bg-container: #ffffff; --bg-section: #fafafa; --bg-input: #ffffff;
            --text-main: #333333; --border: #cccccc; --accent: #d32f2f; --highlight: #e3f2fd;
            --preview-bg: #f0f0f0; --link-bg: #e1f5fe; --link-color: #0277bd; --shadow: 0 4px 15px rgba(0,0,0,0.1);
            --btn-text: #ffffff;
        }
        html.dark-mode {
            --bg-body: #121212; --bg-container: #1e1e1e; --bg-section: #252525; --bg-input: #2c2c2c;
            --text-main: #e0e0e0; --border: #444444; --accent: #ff5252; --highlight: #0d47a1;
            --preview-bg: #000000; --link-bg: #013655; --link-color: #81d4fa; --shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        body { font-family: 'Roboto', sans-serif; background-color: var(--bg-body); color: var(--text-main); padding: 20px; transition: background-color 0.3s; }
        .container { max-width: 1400px; margin: 0 auto; background: var(--bg-container); padding: 30px; border-radius: 10px; box-shadow: var(--shadow); }
        .header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border); padding-bottom: 20px; margin-bottom: 25px; }
        h1 { margin: 0; color: var(--accent); font-size: 28px; font-weight: 900; text-transform: uppercase; }
        .controls button { padding: 8px 16px; border: 1px solid var(--border); background: var(--bg-section); color: var(--text-main); border-radius: 4px; cursor: pointer; font-weight: bold; margin-left: 5px; }
        .controls button.active { background: var(--accent); color: var(--btn-text); border-color: var(--accent); }
        .section { background: var(--bg-section); padding: 25px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 30px; }
        .section-title { font-size: 1.4em; font-weight: 900; border-bottom: 3px solid var(--accent); display: inline-block; margin-bottom: 20px; color: var(--text-main); }
        
        .file-path-info { background-color: var(--link-bg); color: var(--link-color); border: 1px solid var(--border); padding: 20px; margin-bottom: 20px; border-radius: 6px; font-family: monospace; }
        .file-info-block { margin-bottom: 15px; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 15px; }
        .file-path-info strong { display: block; margin-bottom: 5px; color: var(--text-main); }
        .file-path-info code { display: block; background: rgba(255,255,255,0.4); padding: 8px; border-radius: 4px; font-weight: bold; }
        .link-box { background-color: #ffffff; border: 2px solid var(--accent); padding: 10px; border-radius: 4px; display: inline-block; color: #000000; font-weight: bold; margin-top: 5px; }
        .link-box a { color: #0277bd; text-decoration: underline; font-size: 16px; }

        .add-widget-box { background: var(--highlight); padding: 25px; border-radius: 8px; border: 1px solid var(--accent); margin-bottom: 30px; }
        .add-widget-box.editing { border: 3px solid #ff9800; background: rgba(255, 152, 0, 0.15); }
        .flex-row { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 15px; align-items: center; }
        .flex-col { flex: 1; min-width: 160px; }
        label { display: block; font-weight: bold; font-size: 0.9em; margin-bottom: 8px; color: var(--text-main); }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); background: var(--bg-input); color: var(--text-main); border-radius: 4px; box-sizing: border-box; }
        
        .btn { padding: 12px 24px; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; text-transform: uppercase; color: var(--btn-text); font-size: 14px; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-add { background: #4caf50; width: 100%; }
        .btn-gen { background: var(--accent); width: 100%; font-size: 20px; padding: 15px; margin-top: 20px; }
        .btn-cancel { background: #757575; }
        .btn-row { background: #2196f3; margin-top: 15px; }
        .btn-import { background: #ff9800; color: white; margin-top: 10px; }
        
        .btn-tool { padding: 4px 8px; font-size: 12px; margin-left: 6px; border-radius: 4px; cursor: pointer; color: white; border: none; font-weight: bold; display: inline-block; width: 25px; text-align: center; }
        .btn-del-row { background: #d32f2f; }
        .btn-move-row { background: #757575; }

        .preview-area { background: var(--preview-bg); padding: 30px; border: 2px solid var(--border); border-radius: 8px; overflow-x: auto; min-height: 400px; transition: width 0.3s; }
        
        .eink-row { 
            display: flex; gap: 8px; margin-bottom: 15px; padding: 15px; 
            border: 2px dashed #999; border-radius: 6px; min-height: 140px; 
            align-items: flex-end; position: relative; 
            background-image: linear-gradient(to right, rgba(0,0,0,0.05) 1px, transparent 1px), linear-gradient(to bottom, rgba(0,0,0,0.05) 1px, transparent 1px); 
            background-size: 125px 125px; 
            transition: border-color 0.3s, box-shadow 0.3s, width 0.3s; 
            cursor: pointer; 
            flex-wrap: nowrap; /* ZMIANA: WYMUSZENIE POZIOMU */
            overflow-x: hidden; /* Ukryj nadmiar, szerokoÅ›Ä‡ kontrolowana przez JS */
        }
        
        .eink-row:hover { background-color: rgba(0,0,0,0.02); }
        .eink-row.row-selected { border: 2px solid #2196f3; background-color: rgba(33, 150, 243, 0.1); }
        .eink-row.row-active { border: 2px solid #ff9800; box-shadow: 0 0 10px rgba(255, 152, 0, 0.3); }
        .eink-row.drag-over { border: 2px dashed #4caf50; background: rgba(76, 175, 80, 0.1); }

        .row-controls { position: absolute; top: -12px; left: 10px; display: flex; align-items: center; z-index: 50; }
        .row-label { font-size: 11px; background: var(--bg-body); padding: 2px 8px; color: var(--text-main); border: 1px solid var(--border); border-radius: 4px; font-weight: bold; }
        
        .widget-wrapper { display: flex; flex-direction: column; align-items: center; margin-right: 0; position: relative; flex-shrink: 0; cursor: grab; }
        .widget-wrapper:active { cursor: grabbing; }
        .ew-type-label { font-size: 10px; text-transform: uppercase; color: var(--text-main); margin-bottom: 4px; font-weight: bold; opacity: 0.7; text-align: center; }

        .eink-widget { background: #FFFFFF; border: 3px solid #000000; color: #000000; display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 8px; box-sizing: border-box; position: relative; box-shadow: 4px 4px 0px rgba(0,0,0,0.25); transition: transform 0.1s; flex-shrink: 0; overflow: hidden; }
        .eink-widget:hover { transform: translateY(-3px); z-index: 10; border-color: var(--accent); }
        .eink-widget.editing { border: 4px solid #ff9800; transform: scale(1.05); z-index: 20; box-shadow: 0 0 15px rgba(255, 152, 0, 0.5); }
        .ew-title { font-weight: 900; font-size: 13px; text-align: center; width: 100%; line-height: 1.2; margin-top: 12px; margin-bottom: 2px; white-space: normal; text-transform: uppercase; pointer-events: none; }
        .ew-icon { font-size: 38px; display: block; margin: 2px 0; pointer-events: none; }
        .ew-value { font-weight: 900; font-size: 15px; text-transform: uppercase; margin-bottom: 5px; text-align: center; border-top: 2px solid #000; width: 90%; padding-top: 3px; margin-top: auto; pointer-events: none; }
        .ew-del { position: absolute; top: -8px; right: -8px; background: red; color: white; width: 20px; height: 20px; border-radius: 50%; text-align: center; line-height: 20px; font-weight: bold; display: none; box-shadow: 1px 1px 3px rgba(0,0,0,0.5); z-index: 30; }
        .eink-widget:hover .ew-del { display: block; }
        
        .icon-preview { font-size: 32px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-input); }
        .hidden { display: none !important; }
        textarea.output { width: 100%; height: 500px; font-family: 'Consolas', 'Monaco', monospace; background: #263238; color: #eceff1; border: none; padding: 20px; border-radius: 8px; font-size: 14px; line-height: 1.5; }
        .char-counter { font-size: 11px; text-align: right; margin-top: 4px; color: #666; font-weight: bold; }
        .char-counter.limit { color: red; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-row">
            <h1 data-i18n="title_main">Joan 6 E-Ink Generator (MONSTER EDITION)</h1>
            <div class="controls">
                <button type="button" onclick="toggleTheme()" id="btn-theme">ðŸŒ™</button>
                <button type="button" onclick="setLang('pl')" id="btn-pl" class="active">PL</button>
                <button type="button" onclick="setLang('en')" id="btn-en">EN</button>
            </div>
        </div>

        <div class="section">
            <div class="section-title" data-i18n="sec_settings">1. Ustawienia Dashboardu</div>
            <div class="flex-row">
                <div class="flex-col">
                    <label data-i18n="lbl_dash_title">TytuÅ‚ Dashboardu</label>
                    <input type="text" id="dash-title" oninput="syncTitle()" value="JoanDashboard">
                </div>
                <div class="flex-col">
                    <label data-i18n="lbl_grid">UkÅ‚ad Siatki (Smart Grid)</label>
                    <select id="grid-preset" onchange="applyGrid()">
                        <option value="4x8" data-i18n="grid_std_plus" selected>Standard+ (3 kolumny x 8 wierszy) - DOMYÅšLNY</option>
                        <option value="4x6" data-i18n="grid_std">Standard (3 kolumny x 6 wierszy)</option>
                        <option value="4x4" data-i18n="grid_large">DuÅ¼y (4 kolumny x 4 wiersze)</option>
                        <option value="4x6m" data-i18n="grid_med">Åšredni (4 kolumny x 6 wierszy)</option>
                        <option value="6x9" data-i18n="grid_small">MaÅ‚y (6 kolumn x 9 wierszy)</option>
                    </select>
                </div>
                <input type="hidden" id="h-cols" value="4">
                <input type="hidden" id="h-rows" value="8">
            </div>
        </div>

        <div class="section" id="import-section">
            <details>
                <summary style="cursor: pointer; font-weight: bold; font-size: 1.1em;" data-i18n="sec_import">ðŸ“‚ Import / Eksport Kodu .DASH</summary>
                <div style="margin-top: 15px;">
                    <textarea id="import-code" style="height: 150px;" placeholder="Wklej tutaj zawartoÅ›Ä‡ pliku .dash..."></textarea>
                    <button type="button" class="btn btn-import" onclick="importYaml()" data-i18n="btn_import">Wczytaj Kod</button>
                </div>
            </details>
        </div>

        <form method="POST" id="main-form">
            <input type="hidden" name="title" id="form-title" value="JoanDashboard">
            <input type="hidden" name="ui_language" id="input-lang" value="pl">
            <input type="hidden" name="grid_columns" id="form-cols" value="4">
            <input type="hidden" name="grid_rows" id="form-rows" value="8">
            
            <div class="add-widget-box" id="editor-box">
                <div class="section-title" id="editor-title" data-i18n="sec_add">2. Dodaj Widget</div>
                <div class="flex-row">
                    <div class="flex-col">
                        <label data-i18n="lbl_type">Typ Widgetu</label>
                        <select id="w-type" onchange="toggleInputs()">
                            <option value="switch" data-i18n="opt_switch">Switch / Light</option>
                            <option value="cover" data-i18n="opt_cover">Cover / Gate</option>
                            <option value="sensor" data-i18n="opt_sensor">Sensor</option>
                            <option value="binary_sensor" data-i18n="opt_binary">Binary Sensor</option>
                            <option value="weather" data-i18n="opt_weather">Pogoda (Weather)</option>
                            <option value="lock" data-i18n="opt_lock">Lock</option>
                            <option value="person" data-i18n="opt_person">Person / Tracker</option>
                            <option value="media_player" data-i18n="opt_media">Media Player</option>
                            <option value="climate" data-i18n="opt_climate">Climate</option>
                            <option value="input_select" data-i18n="opt_input_select">Input Select</option>
                            <option value="input_number" data-i18n="opt_input_number">Input Number</option>
                            <option value="script" data-i18n="opt_script">Script</option>
                            <option value="navigate" data-i18n="opt_navigate">Navigate / Button</option>
                            <option value="label" data-i18n="opt_label">Label (Text)</option>
                            <option value="clock" data-i18n="opt_clock">Clock</option>
                            <option value="spacer" data-i18n="opt_spacer">Spacer (Empty)</option>
                        </select>
                    </div>
                    <div class="flex-col" id="grp-entity">
                        <label data-i18n="lbl_entity">Encja (Wyszukaj po nazwie lub ID)</label>
                        <input list="entity-list" id="w-id" placeholder="np. gÅ‚oÅ›nik kuchnia..." oninput="searchEntities(this.value)" autocomplete="off">
                        <datalist id="entity-list"></datalist>
                    </div>
                    <div class="flex-col hidden" id="grp-nav">
                        <label data-i18n="lbl_dash_name">Nazwa Dashboardu (target)</label>
                        <input type="text" id="w-dash" placeholder="np. main" oninput="autoNameNav()">
                    </div>
                    <div class="flex-col">
                        <label data-i18n="lbl_name">TytuÅ‚ na ekranie</label>
                        <input type="text" id="w-name" placeholder="np. Salon" oninput="checkTitleLimit(); searchEntities(this.value, true)">
                        <div id="char-count" class="char-counter">0/20</div>
                    </div>
                </div>

                <div class="flex-row">
                    <div class="flex-col">
                        <label data-i18n="lbl_size">Rozmiar</label>
                        <select id="w-size" onchange="updateTitleLimit()">
                            <option value="(2x1)" data-i18n="size_2x1">2x1 (Szeroki Przycisk)</option>
                            <option value="(1x1)" data-i18n="size_1x1">1x1 (MaÅ‚y)</option>
                            <option value="(2x2)" data-i18n="size_2x2">2x2 (DuÅ¼y)</option>
                            <option value="(3x1)" data-i18n="size_3x1">3x1 (Bardzo Szeroki)</option>
                            <option value="(1x2)" data-i18n="size_1x2">1x2 (Wysoki)</option>
                            <option value="(3x2)" data-i18n="size_3x2">3x2 (Ogromny)</option>
                        </select>
                    </div>
                    <div class="flex-col" style="flex: 0 0 60px;">
                        <label data-i18n="lbl_preview">PodglÄ…d</label>
                        <div style="display:flex; justify-content:center;">
                            <i id="preview-icon" class="mdi mdi-help-circle-outline icon-preview"></i>
                        </div>
                    </div>
                    <div class="flex-col">
                        <label data-i18n="lbl_icon">Ikona (Standard)</label>
                        <input type="text" id="w-icon" list="icon-list" oninput="manualIconOverride = true; updateIconPreview()" placeholder="mdi-home">
                    </div>
                    <div class="flex-col">
                        <label data-i18n="lbl_icon_on">Ikona ON</label>
                        <input type="text" id="w-icon-on" list="icon-list" oninput="manualIconOverride = true; updateIconPreview()" placeholder="mdi-lightbulb-on">
                    </div>
                    <div class="flex-col">
                        <label data-i18n="lbl_icon_off">Ikona OFF</label>
                        <input type="text" id="w-icon-off" list="icon-list" oninput="manualIconOverride = true; updateIconPreview()" placeholder="mdi-lightbulb-outline">
                    </div>
                </div>

                <datalist id="icon-list"></datalist>

                <div class="flex-row" style="margin-top: 20px;">
                    <button type="button" class="btn btn-add" id="btn-submit" onclick="saveWidget()" data-i18n="btn_add">+ DODAJ WIDGET</button>
                    <button type="button" class="btn btn-cancel hidden" id="btn-cancel" onclick="cancelEdit()" data-i18n="btn_cancel">ANULUJ</button>
                </div>
            </div>

            <div class="section">
                <div class="section-title" data-i18n="sec_preview">3. PodglÄ…d Dashboardu</div>
                <p style="font-size:0.85em; margin-bottom: 10px; color: #666;">MoÅ¼esz przeciÄ…gaÄ‡ przyciski miÄ™dzy wierszami (Drag&Drop). Kliknij wiersz, aby dodaÄ‡ nowy element.</p>
                <div class="preview-area" id="preview-container"></div>
                <button type="button" class="btn btn-row" onclick="addRow()" data-i18n="btn_row">+ Dodaj Wiersz</button>
            </div>

            <input type="hidden" name="layout_data_json" id="layout_json">
            <input type="hidden" name="custom_definitions_json" id="custom_defs">
            <button type="button" class="btn btn-gen" onclick="submitData()" data-i18n="btn_gen">GENERUJ KOD .DASH</button>
        </form>

        {% if generated_yaml %}
        <div class="section" style="margin-top:30px;">
            <div class="section-title" data-i18n="sec_result">Wynikowy Kod YAML</div>
            <div class="file-path-info">
                <div class="file-info-block">
                    <strong data-i18n="lbl_save_path">1. Zapisz kod w pliku:</strong>
                    <code id="path-code">\\IP_HA\addon_configs\appdaemon\dashboards\{{ filename }}</code>
                </div>
                <div class="file-info-block">
                    <strong data-i18n="lbl_open_link">2. Uruchom ponownie AppDaemon i sprawdÅº:</strong>
                    <div class="link-box">
                        <a href="http://[HOST]:5050/{{ dash_name }}" id="dashboard-link" target="_blank">http://[HOST]:5050/{{ dash_name }}</a>
                    </div>
                </div>
            </div>
            <textarea class="output" readonly>{{ generated_yaml }}</textarea>
        </div>
        {% endif %}
    </div>

    <script>
        const entitiesData = {{ entities | tojson | safe }};
        let rows = [[]]; 
        let editIdx = null; 
        let selectedRowIdx = null; 
        let blockSmart = false; 
        let manualIconOverride = false; 
        let currentLang = 'pl';
        let rawImportedDefs = {}; 
        let dragSrc = null; 

        const POPULAR_ICONS = [ "mdi-home", "mdi-home-outline", "mdi-lightbulb", "mdi-lightbulb-on", "mdi-lightbulb-outline", "mdi-toggle-switch", "mdi-toggle-switch-off", "mdi-power", "mdi-window-shutter", "mdi-window-shutter-open", "mdi-garage", "mdi-garage-open", "mdi-door", "mdi-door-open", "mdi-lock", "mdi-lock-open", "mdi-thermometer", "mdi-water-percent", "mdi-battery", "mdi-weather-cloudy", "mdi-play", "mdi-pause", "mdi-wifi", "mdi-clock-outline", "mdi-calendar", "mdi-alert", "mdi-check", "mdi-close" ];

        const TRANSLATIONS = {
            pl: {
                title_main: "Joan 6 E-Ink Generator (Final Monster Edition)",
                sec_settings: "1. Ustawienia Dashboardu", lbl_dash_title: "TytuÅ‚ Dashboardu", lbl_grid: "UkÅ‚ad Siatki (Smart Grid)",
                grid_std_plus: "Standard+ (3 kolumny x 8 wierszy) - DOMYÅšLNY", grid_std: "Standard (3 kolumny x 6 wierszy)",
                grid_large: "DuÅ¼y (4 kolumny x 4 wiersze)", grid_med: "Åšredni (4 kolumny x 6 wierszy)", grid_small: "MaÅ‚y (6 kolumn x 9 wierszy)",
                sec_import: "ðŸ“‚ Import / Eksport Kodu .DASH", btn_import: "Wczytaj Kod",
                sec_add: "2. Dodaj Widget", sec_edit: "2. Edytuj Widget",
                lbl_type: "Typ Widgetu", lbl_entity: "Encja (Wyszukaj po nazwie lub ID)", lbl_dash_name: "Nazwa Dashboardu (target)",
                lbl_name: "TytuÅ‚ na ekranie", lbl_size: "Rozmiar", lbl_preview: "PodglÄ…d",
                lbl_icon: "Ikona (Standard)", lbl_icon_on: "Ikona ON", lbl_icon_off: "Ikona OFF",
                opt_switch: "PrzeÅ‚Ä…cznik / ÅšwiatÅ‚o", opt_cover: "Roleta / Brama", opt_sensor: "Sensor",
                opt_binary: "Sensor Binarny (On/Off)", opt_lock: "Zamek", opt_person: "Osoba / Tracker",
                opt_media: "Media Player", opt_climate: "Termostat", opt_input_select: "Lista Wyboru",
                opt_input_number: "Suwak", opt_script: "Skrypt", opt_navigate: "Przycisk Nawigacji",
                opt_label: "Etykieta (Tekst)", opt_clock: "Zegar", opt_spacer: "OdstÄ™p (Pusty)", opt_weather: "Pogoda",
                size_2x1: "2x1 (Szeroki Przycisk)", size_1x1: "1x1 (MaÅ‚y)", size_2x2: "2x2 (DuÅ¼y)",
                size_3x1: "3x1 (Bardzo Szeroki)", size_1x2: "1x2 (Wysoki)", size_3x2: "3x2 (Ogromny)",
                btn_add: "+ DODAJ WIDGET", btn_update: "ZAPISZ ZMIANY", btn_cancel: "ANULUJ",
                sec_preview: "3. PodglÄ…d Dashboardu", btn_row: "+ Dodaj Wiersz", btn_gen: "GENERUJ KOD .DASH",
                sec_result: "Wynikowy Kod YAML", lbl_save_path: "1. Zapisz kod w pliku:", lbl_open_link: "2. Uruchom ponownie AppDaemon i sprawdÅº:",
                limit_15: "Maks 15 znakÃ³w", limit_20: "Maks 20 znakÃ³w", alert_full: "Brak miejsca w tym wierszu! ZmieÅ„ siatkÄ™ lub dodaj nowy wiersz."
            },
            en: {
                title_main: "Joan 6 E-Ink Generator (Final Monster Edition)",
                sec_settings: "1. Dashboard Settings", lbl_dash_title: "Dashboard Title", lbl_grid: "Grid Layout (Smart Grid)",
                grid_std_plus: "Standard+ (3 columns x 8 rows) - DEFAULT", grid_std: "Standard (3 columns x 6 rows)",
                grid_large: "Large (4 columns x 4 rows)", grid_med: "Medium (4 columns x 6 rows)", grid_small: "Small (6 columns x 9 rows)",
                sec_import: "ðŸ“‚ Import / Export .DASH Code", btn_import: "Load Code",
                sec_add: "2. Add Widget", sec_edit: "2. Edit Widget",
                lbl_type: "Widget Type", lbl_entity: "Entity (Search by name/ID)", lbl_dash_name: "Dashboard Name (target)",
                lbl_name: "Title on Screen", lbl_size: "Size", lbl_preview: "Preview",
                lbl_icon: "Icon (Standard)", lbl_icon_on: "Icon ON", lbl_icon_off: "Icon OFF",
                opt_switch: "Switch / Light", opt_cover: "Cover / Gate", opt_sensor: "Sensor",
                opt_binary: "Binary Sensor", opt_lock: "Lock", opt_person: "Person / Tracker",
                opt_media: "Media Player", opt_climate: "Climate", opt_input_select: "Input Select",
                opt_input_number: "Input Number", opt_script: "Script", opt_navigate: "Navigation Button",
                opt_label: "Label (Text)", opt_clock: "Clock", opt_spacer: "Spacer (Empty)", opt_weather: "Weather",
                size_2x1: "2x1 (Wide Button)", size_1x1: "1x1 (Small)", size_2x2: "2x2 (Large)",
                size_3x1: "3x1 (Extra Wide)", size_1x2: "1x2 (Tall)", size_3x2: "3x2 (Huge)",
                btn_add: "+ ADD WIDGET", btn_update: "SAVE CHANGES", btn_cancel: "CANCEL",
                sec_preview: "3. Dashboard Preview", btn_row: "+ Add Row", btn_gen: "GENERATE .DASH CODE",
                sec_result: "Generated YAML Code", lbl_save_path: "1. Save code to file:", lbl_open_link: "2. Restart AppDaemon and check:",
                limit_15: "Max 15 chars", limit_20: "Max 20 chars", alert_full: "No space in this row! Change grid or add new row."
            }
        };

        const SMART_MAP = { 'light': { type: 'switch', size: '(2x1)', iconOn: 'mdi-lightbulb-on', iconOff: 'mdi-lightbulb-outline' }, 'switch': { type: 'switch', size: '(2x1)', iconOn: 'mdi-toggle-switch', iconOff: 'mdi-toggle-switch-off' }, 'cover': { type: 'cover', size: '(2x1)', iconOn: 'mdi-window-shutter-open', iconOff: 'mdi-window-shutter' }, 'garage': { type: 'cover', size: '(2x1)', iconOn: 'mdi-garage-open', iconOff: 'mdi-garage' }, 'binary_sensor': { type: 'binary_sensor', size: '(1x1)', iconOn: 'mdi-checkbox-marked-circle', iconOff: 'mdi-checkbox-blank-circle-outline' }, 'sensor': { type: 'sensor', size: '(2x1)', icon: 'mdi-eye' }, 'media_player': { type: 'media_player', size: '(2x2)', icon: '' }, 'climate': { type: 'climate', size: '(2x2)', icon: '' }, 'lock': { type: 'lock', size: '(2x1)', iconOn: 'mdi-lock-open', iconOff: 'mdi-lock' }, 'script': { type: 'script', size: '(2x1)', icon: 'mdi-script-text-outline' }, 'weather': { type: 'weather', size: '(2x2)', icon: 'mdi-weather-cloudy' } };

        function normalizeString(str) { return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase(); }

        function searchEntities(val, forceSmartTitle = false) {
            if (!val && !forceSmartTitle) return;
            if (forceSmartTitle) { runSmartLogic(val, true); return; }
            runSmartLogic(val, false); 
            const dl = document.getElementById('entity-list'); dl.innerHTML = '';
            if (val.length < 2) return;
            const terms = normalizeString(val).split(" ").filter(t => t);
            let count = 0;
            for (const e in entitiesData) {
                const obj = entitiesData[e]; if (count > 50) break;
                const searchStr = normalizeString(obj.id + " " + (obj.attributes.friendly_name || ""));
                if (terms.every(term => searchStr.includes(term))) {
                    const opt = document.createElement('option'); opt.value = obj.id;
                    opt.label = obj.attributes.friendly_name ? `${obj.attributes.friendly_name} (${obj.id})` : obj.id;
                    dl.appendChild(opt); count++;
                }
            }
        }

        function runSmartLogic(val, isTitleSearch) {
            if (blockSmart) return;
            const input = val.toLowerCase(); const inputNorm = normalizeString(input);
            if (input.length < 3) return;
            let conf = { type: 'sensor', size: '(2x1)', icon: 'mdi-eye' };
            if (!isTitleSearch) {
                const ent = entitiesData.find(e => e.id === input) || { attributes: {} };
                const dClass = (ent.attributes.device_class || '').toLowerCase();
                const domain = input.split('.')[0];
                if (SMART_MAP[domain]) conf = { ...SMART_MAP[domain] };
                if (dClass === 'garage') conf = { type: 'cover', size: '(2x1)', iconOn: 'mdi-garage-open', iconOff: 'mdi-garage' };
                if (dClass === 'door') conf = { type: 'binary_sensor', size: '(1x1)', iconOn: 'mdi-door-open', iconOff: 'mdi-door-closed' };
                if (dClass === 'battery') conf = { type: 'sensor', size: '(2x1)', icon: 'mdi-battery' };
                if (dClass === 'temperature') conf = { type: 'sensor', size: '(2x1)', icon: 'mdi-thermometer' };
            }
            const check = (keywords) => keywords.some(k => inputNorm.includes(k));
            if (check(['glosnik', 'speaker', 'audio', 'tv', 'odtwarzacz', 'radio'])) conf = SMART_MAP['media_player'];
            else if (check(['swiatlo', 'lamp', 'kinkiet', 'led', 'zarowka'])) conf = SMART_MAP['light'];
            else if (check(['gniazdko', 'wtyczka', 'outlet', 'plug'])) conf = SMART_MAP['switch'];
            else if (check(['brama', 'garaz', 'gate'])) conf = { type: 'cover', size: '(2x1)', iconOn: 'mdi-garage-open', iconOff: 'mdi-garage' };
            else if (check(['rolet', 'blind', 'shutter', 'zaslon'])) conf = SMART_MAP['cover'];
            else if (check(['zamek', 'lock', 'rygiel'])) conf = SMART_MAP['lock'];
            else if (check(['drzwi', 'door', 'furtka'])) conf = { type: 'binary_sensor', size: '(1x1)', iconOn: 'mdi-door-open', iconOff: 'mdi-door-closed' };
            else if (check(['okno', 'window'])) conf = { type: 'binary_sensor', size: '(1x1)', iconOn: 'mdi-window-open-variant', iconOff: 'mdi-window-closed-variant' };
            else if (check(['temp', 'therm'])) conf = { type: 'sensor', size: '(2x1)', icon: 'mdi-thermometer' };
            else if (check(['wilg', 'humid'])) conf = { type: 'sensor', size: '(2x1)', icon: 'mdi-water-percent' };
            else if (check(['pogoda', 'weather'])) conf = SMART_MAP['weather'];

            const currentGrid = document.getElementById('grid-preset').value;
            if ((currentGrid === '4x8' || currentGrid === '4x6') && conf.size === '(1x1)' && conf.type !== 'binary_sensor') {
                conf.size = '(2x1)';
            }

            if (isTitleSearch) {
                if (manualIconOverride) return;
                if (conf.iconOn) document.getElementById('w-icon-on').value = conf.iconOn;
                if (conf.iconOff) document.getElementById('w-icon-off').value = conf.iconOff;
                if (conf.icon && !conf.iconOn) document.getElementById('w-icon').value = conf.icon;
                updateIconPreview(); return;
            }
            document.getElementById('w-type').value = conf.type;
            document.getElementById('w-size').value = conf.size;
            if (!isTitleSearch) {
                let name = input.split('.').pop();
                name = name.replace(/_[lvr]\d+$/i, '').replace(/_state$/i, '').replace(/_/g, ' ');
                name = name.replace(/\b\w/g, l => l.toUpperCase());
                document.getElementById('w-name').value = name;
            }
            if (!manualIconOverride) {
                document.getElementById('w-icon').value = conf.icon || '';
                document.getElementById('w-icon-on').value = conf.iconOn || '';
                document.getElementById('w-icon-off').value = conf.iconOff || '';
                updateIconPreview();
            }
            toggleInputs(); updateTitleLimit();
        }

        function applyGrid() {
            const val = document.getElementById('grid-preset').value;
            const parts = val.replace('m','').split('x');
            document.getElementById('h-cols').value = parts[0];
            document.getElementById('h-rows').value = parts[1];
            document.getElementById('form-cols').value = parts[0];
            document.getElementById('form-rows').value = parts[1];
            
            // PRECYZYJNA SZEROKOÅšÄ† KONTENERA (Widget 117px + Gap 8px + Marginesy 30px)
            let slots = 3; 
            if (val === '4x4' || val === '4x6' || val === '4x6m') slots = 4;
            if (val === '6x9') slots = 6;
            if (val === '4x8') slots = 3;
            
            const px = (slots * 117) + ((slots - 1) * 8) + 40; // +40px zapasu na padding
            document.querySelectorAll('.eink-row').forEach(el => {
                el.style.minWidth = px + 'px';
            });
        }

        function syncTitle() { document.getElementById('form-title').value = document.getElementById('dash-title').value; }
        function autoNameNav() { if(blockSmart) return; document.getElementById('w-name').value = document.getElementById('w-dash').value.toUpperCase(); }
        function selectRow(rI) { if (editIdx) cancelEdit(); selectedRowIdx = rI; renderPreview(); }

        function getSlots(w) {
            let c = 2;
            if (w.size) c = parseInt(w.size.replace(/[()]/g, '').split('x')[0]) || 1;
            return c;
        }

        function getMaxSlots() {
            const gridVal = document.getElementById('grid-preset').value;
            let maxSlots = 3; 
            if (gridVal === '4x4' || gridVal === '4x6' || gridVal === '4x6m') maxSlots = 4; 
            if (gridVal === '6x9') maxSlots = 6;
            if (gridVal === '4x8') maxSlots = 3;
            return maxSlots * 2; 
        }

        function getRowUsage(rowArr) {
            let u = 0;
            rowArr.forEach(item => u += getSlots(item));
            return u;
        }

        function saveWidget() {
            const w = {
                type: document.getElementById('w-type').value,
                id: document.getElementById('w-id').value,
                dash: document.getElementById('w-dash').value,
                name: document.getElementById('w-name').value,
                size: document.getElementById('w-size').value,
                icon: document.getElementById('w-icon').value,
                icon_on: document.getElementById('w-icon-on').value,
                icon_off: document.getElementById('w-icon-off').value,
                was_edited: true
            };
            if(w.type === 'navigate') w.id = 'navigate.' + w.dash;
            if(w.type === 'spacer') w.id = 'spacer';

            let targetRowIdx = rows.length - 1;
            if (editIdx) targetRowIdx = editIdx.r;
            else if (selectedRowIdx !== null && selectedRowIdx < rows.length) targetRowIdx = selectedRowIdx;
            
            let currentRow = [...rows[targetRowIdx]];
            if (editIdx) currentRow.splice(editIdx.w, 1); 
            
            if (getRowUsage(currentRow) + getSlots(w) > getMaxSlots()) {
                alert(TRANSLATIONS[currentLang].alert_full); return;
            }

            if(editIdx) { rows[editIdx.r][editIdx.w] = w; cancelEdit(); }
            else { rows[targetRowIdx].push(w); clearForm(); blockSmart = false; }
            renderPreview();
        }

        function updateIconPreview() {
            const i1 = document.getElementById('w-icon').value;
            const i2 = document.getElementById('w-icon-on').value;
            const i3 = document.getElementById('w-icon-off').value;
            const final = i1 || i2 || i3 || 'mdi-help-circle-outline';
            document.getElementById('preview-icon').className = `mdi ${final} icon-preview`;
        }

        function toggleInputs() {
            const type = document.getElementById('w-type').value;
            const isNav = type === 'navigate';
            const hideEntity = ['clock', 'label', 'spacer'].includes(type);
            document.getElementById('grp-entity').style.display = (isNav || hideEntity) ? 'none' : 'block';
            document.getElementById('grp-nav').style.display = isNav ? 'block' : 'none';
            document.getElementById('grp-nav').classList.toggle('hidden', !isNav);
        }

        function updateTitleLimit() {
            const size = document.getElementById('w-size').value;
            const input = document.getElementById('w-name');
            const counter = document.getElementById('char-count');
            let max = 20;
            if(size === '(1x1)' || size === '(1x2)') max = 15;
            input.maxLength = max;
            const txt = max === 15 ? TRANSLATIONS[currentLang].limit_15 : TRANSLATIONS[currentLang].limit_20;
            counter.innerText = `${input.value.length}/${max} (${txt})`;
            if(input.value.length >= max) counter.classList.add('limit'); else counter.classList.remove('limit');
        }
        function checkTitleLimit() { updateTitleLimit(); }

        function editWidget(r, w) {
            blockSmart = true; editIdx = {r, w}; selectedRowIdx = r; 
            const data = rows[r][w];
            document.getElementById('editor-box').classList.add('editing');
            document.getElementById('btn-cancel').classList.remove('hidden');
            document.getElementById('editor-title').innerText = TRANSLATIONS[currentLang].sec_edit;
            document.getElementById('btn-submit').innerText = TRANSLATIONS[currentLang].btn_update;
            document.getElementById('w-type').value = data.type;
            toggleInputs();
            if(data.type === 'navigate') document.getElementById('w-dash').value = data.id.replace('navigate.', '');
            else document.getElementById('w-id').value = data.id;
            document.getElementById('w-name').value = data.name;
            document.getElementById('w-size').value = data.size || '(2x1)';
            document.getElementById('w-icon').value = data.icon || '';
            document.getElementById('w-icon-on').value = data.icon_on || '';
            document.getElementById('w-icon-off').value = data.icon_off || '';
            manualIconOverride = true;
            updateIconPreview(); updateTitleLimit();
            setTimeout(() => blockSmart = false, 500); renderPreview(); 
        }

        function cancelEdit() {
            editIdx = null; blockSmart = false;
            document.getElementById('editor-box').classList.remove('editing');
            document.getElementById('btn-cancel').classList.add('hidden');
            document.getElementById('editor-title').innerText = TRANSLATIONS[currentLang].sec_add;
            document.getElementById('btn-submit').innerText = TRANSLATIONS[currentLang].btn_add;
            clearForm(); renderPreview(); 
        }

        function clearForm() {
            document.getElementById('w-id').value = ''; document.getElementById('w-name').value = '';
            document.getElementById('w-icon').value = ''; document.getElementById('w-icon-on').value = ''; document.getElementById('w-icon-off').value = '';
            manualIconOverride = false; updateIconPreview(); updateTitleLimit();
        }

        function deleteWidget(r, w, e) { e.stopPropagation(); rows[r].splice(w, 1); if(editIdx && editIdx.r === r && editIdx.w === w) cancelEdit(); renderPreview(); }
        function deleteRow(r) { if(confirm("UsunÄ…Ä‡ caÅ‚y wiersz?")) { rows.splice(r, 1); if(rows.length === 0) rows.push([]); if(editIdx && editIdx.r === r) cancelEdit(); if(selectedRowIdx === r) selectedRowIdx = null; renderPreview(); } }
        
        function moveRow(idx, direction) {
            if (direction === -1 && idx > 0) { [rows[idx], rows[idx - 1]] = [rows[idx - 1], rows[idx]]; if(selectedRowIdx === idx) selectedRowIdx = idx - 1; } 
            else if (direction === 1 && idx < rows.length - 1) { [rows[idx], rows[idx + 1]] = [rows[idx + 1], rows[idx]]; if(selectedRowIdx === idx) selectedRowIdx = idx + 1; }
            renderPreview();
        }
        function addRow() { rows.push([]); renderPreview(); }

        function getRealState(w) {
            const isPL = currentLang === 'pl'; const id = (w.id || ''); const ent = entitiesData.find(e => e.id === id);
            if (!ent) return "---";
            const val = String(ent.state); const unit = ent.unit || "";
            if (val === 'on') return isPL ? "WÅÄ„CZONE" : "ON";
            if (val === 'off') return isPL ? "WYÅÄ„CZONE" : "OFF";
            if (val === 'open') return isPL ? "OTWARTE" : "OPEN";
            if (val === 'closed') return isPL ? "ZAMKNIÄ˜TE" : "CLOSED";
            if (!isNaN(parseFloat(val)) && val.includes('.')) return parseFloat(val).toFixed(1) + " " + unit;
            return val + " " + unit;
        }

        function getRealIcon(w) {
            const id = (w.id || ''); const ent = entitiesData.find(e => e.id === id);
            let defaultIcon = w.icon || w.icon_on || '';
            if (!ent) return defaultIcon;
            const s = String(ent.state).toLowerCase();
            if (['on', 'open', 'home', 'unlocked', 'playing'].includes(s)) return w.icon_on || w.icon || '';
            if (['off', 'closed', 'not_home', 'away', 'locked', 'paused', 'idle'].includes(s)) return w.icon_off || w.icon || '';
            return w.icon || '';
        }

        function handleDragStart(e, r, w) {
            dragSrc = { r, w };
            e.dataTransfer.effectAllowed = 'move';
            e.target.style.opacity = '0.4';
        }

        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault(); 
            e.dataTransfer.dropEffect = 'move';
            const row = e.target.closest('.eink-row');
            if(row) row.classList.add('drag-over');
            return false;
        }

        function handleDragLeave(e) {
            const row = e.target.closest('.eink-row');
            if(row) row.classList.remove('drag-over');
        }

        function handleDrop(e, targetR) {
            e.stopPropagation(); e.preventDefault();
            const row = e.target.closest('.eink-row');
            if(row) row.classList.remove('drag-over');
            if (dragSrc === null) return;
            const movedWidget = rows[dragSrc.r][dragSrc.w];
            rows[dragSrc.r].splice(dragSrc.w, 1);
            if (getRowUsage(rows[targetR]) + getSlots(movedWidget) > getMaxSlots()) {
                rows[dragSrc.r].splice(dragSrc.w, 0, movedWidget);
                alert(TRANSLATIONS[currentLang].alert_full);
                renderPreview(); return;
            }
            rows[targetR].push(movedWidget);
            dragSrc = null; renderPreview();
        }

        function handleDragEnd(e) {
            e.target.style.opacity = '1';
            document.querySelectorAll('.eink-row').forEach(r => r.classList.remove('drag-over'));
        }

        function renderPreview() {
            const container = document.getElementById('preview-container'); container.innerHTML = '';
            const activeRowIndex = editIdx ? editIdx.r : selectedRowIdx;

            rows.forEach((row, rI) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'eink-row';
                if (rI === selectedRowIdx) rowDiv.classList.add('row-selected');
                if (editIdx && editIdx.r === rI) rowDiv.classList.add('row-active');
                
                rowDiv.ondragover = handleDragOver;
                rowDiv.ondragleave = handleDragLeave;
                rowDiv.ondrop = (e) => handleDrop(e, rI);
                
                rowDiv.onclick = (e) => { if(e.target === rowDiv || e.target.className === 'row-label') selectRow(rI); };

                const controls = document.createElement('div'); controls.className = 'row-controls';
                const label = document.createElement('span'); label.className = 'row-label';
                label.innerText = (currentLang === 'pl' ? 'WIERSZ ' : 'ROW ') + (rI + 1);
                controls.appendChild(label);

                const upBtn = document.createElement('button'); upBtn.className = 'btn-tool btn-move-row'; upBtn.innerText = 'â–²';
                upBtn.onclick = (e) => { e.stopPropagation(); moveRow(rI, -1); };
                if (rI === 0) upBtn.style.opacity = 0.3; controls.appendChild(upBtn);

                const downBtn = document.createElement('button'); downBtn.className = 'btn-tool btn-move-row'; downBtn.innerText = 'â–¼';
                downBtn.onclick = (e) => { e.stopPropagation(); moveRow(rI, 1); };
                if (rI === rows.length - 1) downBtn.style.opacity = 0.3; controls.appendChild(downBtn);

                const delBtn = document.createElement('button'); delBtn.className = 'btn-tool btn-del-row'; delBtn.innerText = 'X';
                delBtn.onclick = (e) => { e.stopPropagation(); deleteRow(rI); }; controls.appendChild(delBtn);

                rowDiv.appendChild(controls);

                row.forEach((w, wI) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'widget-wrapper';
                    wrapper.draggable = true;
                    wrapper.ondragstart = (e) => handleDragStart(e, rI, wI);
                    wrapper.ondragend = handleDragEnd;

                    const typeLabel = document.createElement('div'); typeLabel.className = 'ew-type-label'; typeLabel.innerText = w.type;
                    wrapper.appendChild(typeLabel);

                    const div = document.createElement('div'); div.className = 'eink-widget';
                    if(editIdx && editIdx.r === rI && editIdx.w === wI) div.classList.add('editing');

                    let cols = 2, rw = 1;
                    if(w.size) { const parts = w.size.replace(/[()]/g, '').split('x'); cols = parseInt(parts[0]) || 1; rw = parseInt(parts[1]) || 1; }
                    const width = (cols * 117) + ((cols - 1) * 8); const height = (rw * 117) + ((rw - 1) * 8);
                    div.style.width = width + 'px'; div.style.height = height + 'px';

                    if(w.type === 'spacer') {
                        div.style.border = '1px dashed #aaa'; div.style.boxShadow = 'none'; div.style.opacity = '0.5';
                        div.innerHTML = '<span style="font-size:10px; color:#999;">SPACER</span>';
                    } else {
                        const icon = getRealIcon(w); const realState = getRealState(w);
                        const iconHtml = icon ? `<i class="mdi ${icon} ew-icon"></i>` : `<div style="height:38px;"></div>`;
                        div.innerHTML = `<div class="ew-title">${w.name || w.id}</div>${iconHtml}<div class="ew-value">${realState}</div><div class="ew-del" onclick="deleteWidget(${rI}, ${wI}, event)">X</div>`;
                    }
                    div.onclick = (e) => { e.stopPropagation(); editWidget(rI, wI); };
                    wrapper.appendChild(div); rowDiv.appendChild(wrapper);
                });
                container.appendChild(rowDiv);
            });
            applyGrid();
        }

        function submitData() { document.getElementById('layout_json').value = JSON.stringify(rows); document.getElementById('custom_defs').value = JSON.stringify(rawImportedDefs); document.getElementById('main-form').submit(); }

        function importYaml() {
            const text = document.getElementById('import-code').value; if(!text) return; blockSmart = true;
            const lines = text.split('\n'); const newRows = []; let inLayout = false; let rawDefs = {}; let currentDefKey = null; let currentDefLines = [];
            lines.forEach(line => {
                if (line.match(/^\S+:/) && !line.startsWith('layout:') && !line.startsWith('global_parameters:')) { if (currentDefKey) rawDefs[currentDefKey] = currentDefLines.join('\n'); currentDefKey = line.split(':')[0].trim(); currentDefLines = []; }
                else if (currentDefKey) { if (!line.startsWith('layout:') && !line.startsWith('#')) currentDefLines.push(line); }
            });
            if(currentDefKey) rawDefs[currentDefKey] = currentDefLines.join('\n'); rawImportedDefs = rawDefs;
            lines.forEach(line => {
                const tr = line.trim();
                if(tr.startsWith('layout:')) { inLayout = true; return; }
                if(inLayout && tr.startsWith('-')) {
                    const content = tr.substring(1).trim(); const widgets = content.split(',').map(s => s.trim()); const rowData = [];
                    widgets.forEach(wStr => {
                        let id = wStr; let size = '(2x1)'; const sizeMatch = wStr.match(/\(\d+x\d+\)/);
                        if(sizeMatch) { size = sizeMatch[0]; id = wStr.replace(size, '').trim(); }
                        let type = 'switch'; let name = id; let icon = ''; let icon_on = ''; let icon_off = '';
                        if(rawDefs[id]) {
                            const d = rawDefs[id]; const tMatch = d.match(/widget_type:\s*(.*)/); if(tMatch) type = tMatch[1].trim();
                            const nMatch = d.match(/title:\s*(.*)/); if(nMatch) name = nMatch[1].trim().replace(/['"]/g, '');
                            const iMatch = d.match(/icon:\s*(.*)/); if(iMatch) icon = iMatch[1].trim();
                            const ionMatch = d.match(/icon_on:\s*(.*)/); if(ionMatch) icon_on = ionMatch[1].trim();
                            const ioffMatch = d.match(/icon_off:\s*(.*)/); if(ioffMatch) icon_off = ioffMatch[1].trim();
                        } else { if(id === 'spacer') type = 'spacer'; else if(id.startsWith('navigate.')) type = 'navigate'; else if(id.startsWith('sensor.')) type = 'sensor'; }
                        rowData.push({ id, type, size, name, icon, icon_on, icon_off, was_edited: false });
                    });
                    newRows.push(rowData);
                }
                if(inLayout && tr.length > 0 && !tr.startsWith('-') && !tr.startsWith(' ') && !tr.startsWith('layout:')) inLayout = false;
            });
            if(newRows.length > 0) { rows = newRows; renderPreview(); alert(currentLang === 'pl' ? "PomyÅ›lnie zaimportowano ukÅ‚ad." : "Import successful."); } else alert(currentLang === 'pl' ? "BÅ‚Ä…d: Nie znaleziono layoutu." : "Error: Layout not found.");
            setTimeout(() => blockSmart = false, 1000);
        }

        function setLang(lang) {
            currentLang = lang; document.getElementById('input-lang').value = lang;
            document.getElementById('btn-pl').className = lang === 'pl' ? 'active' : ''; document.getElementById('btn-en').className = lang === 'en' ? 'active' : '';
            const t = TRANSLATIONS[lang];
            document.querySelectorAll('[data-i18n]').forEach(el => { const key = el.getAttribute('data-i18n'); if (t[key]) { if (el.tagName === 'INPUT' && el.type === 'submit') el.value = t[key]; else el.innerText = t[key]; } });
            document.querySelectorAll('option[data-i18n]').forEach(el => { const key = el.getAttribute('data-i18n'); if (t[key]) el.text = t[key]; });
            updateTitleLimit(); renderPreview();
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark-mode');
            localStorage.setItem('joan_theme', isDark ? 'dark' : 'light');
            document.getElementById('btn-theme').innerText = isDark ? 'â˜€ï¸' : 'ðŸŒ™';
        }

        window.addEventListener('DOMContentLoaded', () => {
            const host = window.location.hostname; const pathEl = document.getElementById('path-code'); const linkEl = document.getElementById('dashboard-link');
            if(pathEl) pathEl.innerText = pathEl.innerText.replace('IP_HA', host);
            if(linkEl) { const rawHref = linkEl.getAttribute('href'); if (rawHref.includes('[HOST]')) { const newHref = rawHref.replace(/\[HOST\]/g, host); linkEl.setAttribute('href', newHref); linkEl.innerText = newHref; } }
            setLang('pl'); const savedTheme = localStorage.getItem('joan_theme') || 'light'; document.getElementById('btn-theme').innerText = savedTheme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
            updateTitleLimit();
            const dl = document.getElementById('icon-list'); POPULAR_ICONS.forEach(icon => { const opt = document.createElement('option'); opt.value = icon; dl.appendChild(opt); });
            if(!rows.length || (rows.length===1 && !rows[0].length)) { } else { renderPreview(); }
        });
    </script>
</body>
</html>
