<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Joan 6 E-Ink Generator</title>
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root { --bg-color:#e0e0e0; --container-bg:#ffffff; --text-color:#333; --border-color:#ddd; --accent-color:#d32f2f; --input-bg:#fff; --section-bg:#fafafa; --preview-bg:#f0f0f0; }
    body{font-family:'Roboto',sans-serif;background-color:var(--bg-color);color:var(--text-color);padding:20px;}
    .container{max-width:1200px;margin:0 auto;background:var(--container-bg);padding:25px;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,0.1);}
    .header-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;border-bottom:2px solid var(--border-color);padding-bottom:15px;}
    h1{color:var(--accent-color);margin:0;font-size:24px;}
    .controls{display:flex;gap:10px;align-items:center;}
    .status-bar{padding:10px;margin-bottom:20px;border-radius:4px;text-align:center;font-weight:bold;}
    .section{margin-bottom:30px;border:1px solid var(--border-color);padding:20px;border-radius:8px;background:var(--section-bg);}
    .section-title{font-size:1.2em;font-weight:bold;margin-bottom:15px;border-bottom:2px solid var(--accent-color);display:inline-block;}
    .import-box{background:#fff3e0;border:1px solid #ffe0b2;color:#000;display:none;}
    .import-box.visible{display:block;}
    .add-widget-box{background:#e3f2fd;padding:15px;border-radius:8px;margin-bottom:20px;border:1px solid #2196f3;color:#000;}
    .flex-row{display:flex;gap:15px;align-items:flex-end;margin-bottom:10px;flex-wrap:wrap;}
    .flex-col{flex:1;min-width:150px;}
    label{display:block;margin-top:10px;font-weight:bold;font-size:.9em;margin-bottom:5px;}
    input,select,textarea{width:100%;padding:10px;border:1px solid var(--border-color);border-radius:4px;background:var(--input-bg);color:var(--text-color);}
    .icon-preview-box{width:42px;height:42px;background:#fff;border:1px solid #ccc;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:24px;color:#333;}
    .btn{padding:10px 20px;border:none;cursor:pointer;border-radius:4px;font-weight:bold;text-transform:uppercase;}
    .btn-add{background:#4caf50;color:#fff;width:100%;}
    .btn-cancel{background:#9e9e9e;color:#fff;margin-left:10px;}
    .btn-row{background:#2196f3;color:#fff;margin-top:10px;}
    .btn-import{background:#ff9800;color:#fff;margin-bottom:10px;}
    .btn-primary{background:var(--accent-color);color:#fff;width:100%;font-size:18px;margin-top:20px;}
    .preview-area{background:var(--preview-bg);padding:24px;border-radius:8px;border:2px solid var(--border-color);overflow-x:auto;min-height:220px;}
    .eink-row{display:flex;gap:12px;margin-bottom:12px;padding:18px 12px;border:2px dashed #999;background:transparent;border-radius:6px;align-items:center;position:relative;min-height:120px;cursor:pointer;}
    .eink-row.active{border-color:#2196f3;background:rgba(33,150,243,0.08);}
    .eink-widget{background:#FFFFFF;border:2px solid #000;color:#000;display:flex;flex-direction:column;align-items:center;justify-content:space-between;padding:8px 4px;box-sizing:border-box;position:relative;cursor:pointer;box-shadow:2px 2px 5px rgba(0,0,0,0.1);border-radius:6px;}
    .eink-widget.being-edited{border:3px solid #ff9800;transform:scale(1.03);z-index:10;}
    .ew-title{font-size:12px;font-weight:700;text-align:center;width:100%;line-height:1.2;min-height:30px;padding:0 4px;display:flex;align-items:center;justify-content:center;}
    .ew-icon{font-size:32px;}
    .ew-state{font-size:11px;font-weight:700;text-transform:uppercase;min-height:18px;display:flex;align-items:center;}
    .ew-delete{position:absolute;top:4px;right:4px;background:red;color:#fff;width:20px;height:20px;text-align:center;line-height:20px;font-size:12px;border-radius:4px;display:none;}
    .eink-widget:hover .ew-delete{display:block;}
    textarea.output{width:100%;min-height:500px;font-family:monospace;background:#263238;color:#eceff1;border:none;padding:15px;border-radius:4px;white-space:pre;}
    .file-path-info code{display:block;white-space:pre;line-height:1.4;}
  </style>
</head>
<body>
  <div class="container">
    <div class="header-row">
      <h1>Joan 6 E-Ink Generator</h1>
      <div class="controls">
        <div class="theme-switch"><button type="button" onclick="toggleTheme()" id="btn-theme">üåô</button></div>
        <div class="lang-switch">
          <button type="button" onclick="setLang('pl')" id="btn-pl" class="active">PL</button>
          <button type="button" onclick="setLang('en')" id="btn-en">EN</button>
        </div>
      </div>
    </div>

    {% if entities %}
      <div class="status-bar" style="background:#d4edda;color:#155724;">
        <span data-i18n="status_ok">‚úì Po≈ÇƒÖczono z Home Assistant</span> ({{ entities|length }})
      </div>
    {% else %}
      <div class="status-bar" style="background:#f8d7da;color:#721c24;">
        <span data-i18n="status_error">‚ö† Brak po≈ÇƒÖczenia z API. Sprawd≈∫ token.</span>
      </div>
    {% endif %}

    <button type="button" class="btn btn-import" onclick="toggleImport()">
      <span data-i18n="btn_import_toggle">üìÇ Importuj / Edytuj Kod</span>
    </button>

    <div id="import-area" class="section import-box">
      <h4 style="margin-top:0" data-i18n="header_paste_code">Wklej kod pliku .dash tutaj:</h4>
      <textarea id="import-code" style="height:150px;background:#fff;color:#000;" placeholder="Wklej ca≈Çy plik .dash (Joan2)"></textarea>
      <button type="button" class="btn btn-add" style="margin-top:10px;" onclick="importYaml()">
        <span data-i18n="btn_load_dash">Wczytaj Dashboard</span>
      </button>
    </div>

    <form method="POST" id="main-form" onsubmit="prepareAndSubmit(event)">
      <input type="hidden" name="ui_language" id="ui_language" value="pl">
      <input type="hidden" name="ui_theme" id="ui_theme" value="light">
      <input type="hidden" name="layout_data_json" id="layout_data_json">
      <input type="hidden" name="widgets_full_json" id="widgets_full_json">
      <input type="hidden" name="generated_yaml_client" id="generated_yaml_client">

      <div class="section">
        <div class="section-title" data-i18n="sec_settings">1. Ustawienia</div>
        <div class="flex-row">
          <div class="flex-col">
            <label data-i18n="dash_title">Tytu≈Ç Dashboardu (Nazwa pliku)</label>
            <input type="text" name="title" id="dash-title" value="Joan2">
          </div>
        </div>
      </div>

      <div class="add-widget-box" id="widget-form-box">
        <h4 style="margin-top:0" id="form-header" data-i18n="sec_add">2. Dodaj Widget</h4>
        <div class="flex-row">
          <div class="flex-col">
            <label data-i18n="label_type">Typ Widgetu</label>
            <select id="new-widget-type" onchange="toggleInputs()">
              <option value="switch">Switch / Light</option>
              <option value="sensor">Sensor</option>
              <option value="binary_sensor">Binary Sensor</option>
              <option value="cover">Cover / Gate</option>
              <option value="media_player">Media Player</option>
              <option value="climate">Climate</option>
              <option value="script">Script</option>
              <option value="navigate">Navigate</option>
              <option value="fan">Fan</option>
              <option value="label">Label (Text)</option>
            </select>
          </div>
          <div class="flex-col" id="group-entity">
            <label data-i18n="label_entity">Wybierz Encjƒô (Home Assistant)</label>
            <input list="entities-list" id="new-entity-id" placeholder="np. light.swiatlo_kuchnia" oninput="smartAutoFill()" onchange="smartAutoFill()" autocomplete="off">
            <datalist id="entities-list">
              {% for entity in entities %}
              <option value="{{ entity.id }}">{{ entity.id }}</option>
              {% endfor %}
            </datalist>
          </div>
          <div class="flex-col">
            <label data-i18n="label_name">Tytu≈Ç na ekranie</label>
            <input type="text" id="new-widget-name" placeholder="np. Kuchnia">
          </div>
        </div>

        <div class="flex-row" style="margin-top:10px;align-items:flex-end;">
          <div class="flex-col" style="max-width:150px;">
            <label data-i18n="label_size">Rozmiar</label>
            <select id="new-widget-size">
              <option value="">Domy≈õlny (2x1)</option>
              <option value="(1x1)">1x1</option>
              <option value="(2x1)">2x1</option>
              <option value="(2x2)">2x2</option>
              <option value="(3x1)">3x1</option>
              <option value="(1x2)">1x2</option>
              <option value="(3x2)">3x2</option>
            </select>
          </div>
          <div style="width:50px;">
            <label data-i18n="label_preview">PodglƒÖd</label>
            <div class="icon-preview-box"><i id="icon-preview-i" class="mdi mdi-help-circle-outline"></i></div>
          </div>
          <div class="flex-col">
            <label data-i18n="label_icon">Ikona</label>
            <input list="icons-list" id="new-widget-icon" placeholder="np. mdi-home" oninput="userEditedIcon();updateIconPreview()" autocomplete="off">
            <datalist id="icons-list"></datalist>
          </div>
          <div class="flex-col">
            <label>Ikona ON</label>
            <input list="icons-list" id="new-widget-icon-on" placeholder="np. mdi-lightbulb-on" oninput="userEditedIconPair();updateIconPreview()" autocomplete="off">
          </div>
          <div class="flex-col">
            <label>Ikona OFF</label>
            <input list="icons-list" id="new-widget-icon-off" placeholder="np. mdi-lightbulb-outline" oninput="userEditedIconPair();updateIconPreview()" autocomplete="off">
          </div>
        </div>

        <div class="flex-row" style="display:flex;align-items:flex-end;gap:10px;">
          <button type="button" id="btn-action" class="btn btn-add" onclick="saveWidget()"><span data-i18n="btn_add">+ DODAJ DO WIERSZA</span></button>
          <button type="button" id="btn-cancel" class="btn btn-cancel hidden" onclick="cancelEdit()"><span data-i18n="btn_cancel">Anuluj</span></button>
        </div>
      </div>

      <div class="section">
        <div class="section-title" data-i18n="sec_preview">3. PodglƒÖd Dashboardu (Kliknij, aby edytowaƒá)</div>
        <div id="rows-container" class="preview-area"></div>
        <button type="button" class="btn btn-row" onclick="addNewRow()"><span data-i18n="btn_new_row">+ Dodaj Nowy Wiersz</span></button>
      </div>

      <button type="submit" class="btn btn-primary"><span data-i18n="btn_generate">GENERUJ KOD .DASH</span></button>
    </form>

    {% if generated_yaml %}
    <div class="section">
      <h3 data-i18n="sec_code">Tw√≥j kod YAML:</h3>
      <div class="file-path-info">
        <strong data-i18n="info_step1">1. Zapisz kod w pliku:</strong>
        <code id="path-code">\\IP_HA\addon_configs\appdaemon\dashboards\{{ filename }}</code>
        <strong data-i18n="info_step2">2. Uruchom ponownie AppDaemon i sprawd≈∫ dashboard:</strong>
        <a href="#" id="dashboard-link" target="_blank">http://IP_HA:5050/{{ dash_name }}</a>
      </div>
      <textarea class="output" readonly id="server-yaml">{{ generated_yaml }}</textarea>
    </div>
    {% endif %}

    <div class="section" id="client-yaml-section" style="display:none;">
      <h3>Wygenerowany kod (Klient ‚Äì skopiuj do pliku .dash)</h3>
      <div class="file-path-info">
        <strong>Plik docelowy:</strong>
        <code id="client-path-code">\\IP_HA\addon_configs\appdaemon\dashboards\Joan2.dash</code>
      </div>
      <textarea class="output" id="client-yaml-output" readonly></textarea>
    </div>
  </div>

  <script>
    const translations={pl:{status_ok:"‚úì Po≈ÇƒÖczono z Home Assistant",status_error:"‚ö† Brak po≈ÇƒÖczenia z API. Sprawd≈∫ token.",sec_settings:"1. Ustawienia",sec_add:"2. Dodaj Widget",sec_edit:"2. Edytuj Widget",sec_preview:"3. PodglƒÖd Dashboardu (Kliknij, aby edytowaƒá)",sec_code:"Tw√≥j kod YAML:",dash_title:"Tytu≈Ç Dashboardu (Nazwa pliku)",label_entity:"Wybierz Encjƒô (Home Assistant)",label_type:"Typ Widgetu",label_name:"Tytu≈Ç na ekranie",label_icon:"Ikona (Automatyczna)",label_preview:"Ikona",label_size:"Rozmiar",btn_add:"+ DODAJ DO WIERSZA",btn_update:"ZAPISZ ZMIANY",btn_new_row:"+ Dodaj Nowy Wiersz",btn_generate:"GENERUJ KOD .DASH",btn_cancel:"Anuluj",state_on:"W≈ÅƒÑCZONE",state_off:"WY≈ÅƒÑCZONE",state_open:"OTWARTE",state_closed:"ZAMKNIƒòTE",info_step1:"1. Zapisz kod w pliku:",info_step2:"2. Uruchom ponownie AppDaemon i sprawd≈∫ dashboard:",btn_import_toggle:"üìÇ Importuj / Edytuj Kod",header_paste_code:"Wklej kod pliku .dash tutaj:",btn_load_dash:"Wczytaj Dashboard"},en:{status_ok:"‚úì Connected to Home Assistant",status_error:"‚ö† No API Connection. Check Token.",sec_settings:"1. Settings",sec_add:"2. Add Widget",sec_edit:"2. Edit Widget",sec_preview:"3. Dashboard Preview (Click to Edit)",sec_code:"Your YAML Code:",dash_title:"Dashboard Title (Filename)",label_entity:"Select Entity (Home Assistant)",label_type:"Widget Type",label_name:"Title on Screen",label_icon:"Icon (Automatic)",label_preview:"Icon",label_size:"Size",btn_add:"+ ADD TO ROW",btn_update:"UPDATE WIDGET",btn_new_row:"+ Add New Row",btn_generate:"GENERATE .DASH CODE",btn_cancel:"Cancel",state_on:"ON",state_off:"OFF",state_open:"OPEN",state_closed:"CLOSED",info_step1:"1. Save code to file:",info_step2:"2. Restart AppDaemon and check dashboard:",btn_import_toggle:"üìÇ Import / Edit Code",header_paste_code:"Paste .dash file code here:",btn_load_dash:"Load Dashboard"}};
    const entitiesData={{ entities | tojson }};
    let currentLang='pl',rows=[],activeRowIndex=0,editingIndices=null,importedDefsMap={};
    let lastAutoName='',userEditedName=false,lastAutoIcon='',userEditedIconFlag=false,userEditedIconPairFlag=false;

    function formatNameFromId(id){ if(!id)return ""; const last=id.includes('.')?id.split('.').pop():id; return last.replace(/_/g,' ').replace(/\b\w/g,l=>l.toUpperCase()); }
    function ensureMdi(i){ return i && !i.startsWith('mdi-') ? 'mdi-'+i : i; }
    function setLang(lang){ currentLang=lang; localStorage.setItem('joan_lang',lang); document.getElementById('ui_language').value=lang; document.getElementById('btn-pl').className=lang==='pl'?'active':''; document.getElementById('btn-en').className=lang==='en'?'active':''; refreshUIText(); renderRows(); }
    function refreshUIText(){ const d=translations[currentLang]; document.querySelectorAll('[data-i18n]').forEach(el=>{const k=el.getAttribute('data-i18n'); if(d[k]) el.innerText=d[k];}); const btn=document.getElementById('btn-action'); if(btn){ btn.querySelector('span').innerText=(editingIndices?d.btn_update:`${d.btn_add} (${currentLang==='pl'?'Wiersz':'Row'} ${activeRowIndex+1})`);} const header=document.getElementById('form-header'); if(header) header.innerText=editingIndices?d.sec_edit:d.sec_add; }
    function toggleTheme(){ const dark=document.body.classList.toggle('dark-mode'); localStorage.setItem('joan_theme',dark?'dark':'light'); document.getElementById('ui_theme').value=dark?'dark':'light'; document.getElementById('btn-theme').innerText=dark?'‚òÄÔ∏è':'üåô'; }

    function getEntityData(id){ return entitiesData.find(e=>e.id===id)||null; }
    function normalizeState(s){ if(s==null) return null; const v=String(s).toLowerCase().trim(); const T=translations[currentLang]; if(['1','true','on'].includes(v)) return T.state_on; if(['0','false','off'].includes(v)) return T.state_off; if(v==='open') return T.state_open; if(v==='closed') return T.state_closed; return null; }
    function getDisplayState(id,type){ const ent=getEntityData(id); if(!ent) return ''; if(['label','navigate'].includes(type)) return ''; const norm=normalizeState(ent.state); if(type==='sensor'){ const raw=String(ent.state).trim(); if((raw==='1'||raw==='0')&&!ent.unit) return ''; if(!isNaN(parseFloat(raw))&&raw.includes('.')){ const f=parseFloat(raw).toFixed(1); return ent.unit?`${f} ${ent.unit}`:f; } return ent.unit?`${raw} ${ent.unit}`:raw; } return norm||String(ent.state).toUpperCase(); }

    function iconPairFor(id){
      const v=(id||'').toLowerCase();
      if(v.startsWith('light.')||v.includes('swiatlo')||v.includes('light')) return ['mdi-lightbulb-on','mdi-lightbulb-outline'];
      if(v.startsWith('cover.')||v.includes('brama')||v.includes('gate')||v.includes('roleta')||v.includes('window')) return ['mdi-window-shutter-open','mdi-window-shutter'];
      if(v.includes('garage')||v.includes('garaz')||v.includes('gara≈º')) return ['mdi-garage-open','mdi-garage'];
      if(v.includes('radiator')||v.includes('ogrzew')||v.includes('grzejnik')) return ['mdi-radiator','mdi-radiator-off'];
      if(v.includes('cwu')||v.includes('woda')||v.includes('water')) return ['mdi-water-outline','mdi-water-off'];
      if(v.startsWith('fan.')||v.includes('wentyl')) return ['mdi-fan','mdi-fan-off'];
      if(v.startsWith('input_boolean.')||v.startsWith('script.')||v.startsWith('switch.')) return ['mdi-toggle-switch','mdi-toggle-switch-off'];
      if(v.startsWith('media_player.')) return ['mdi-speaker','mdi-speaker-off'];
      if(v.startsWith('climate.')) return ['mdi-thermometer','mdi-thermometer-off'];
      return ['mdi-toggle-switch','mdi-toggle-switch-off'];
    }
    function pickAutoIcon(type,id){
      const v=(id||'').toLowerCase();
      const map=[{k:['hydrofor','storage','zbiornik','tank'],i:'mdi-storage-tank'},{k:['cwu','woda','water'],i:'mdi-water-outline'},{k:['ogrzew','grzejnik','radiator','heat'],i:'mdi-radiator'},{k:['brama','gate'],i:'mdi-gate'},{k:['garaz','gara≈º','garage'],i:'mdi-garage'},{k:['wilgotn','humidity'],i:'mdi-water-percent'},{k:['bateria','battery'],i:'mdi-battery'},{k:['temp','temperatur','temperature'],i:'mdi-thermometer'},{k:['swiatlo','light','bulb','lamp'],i:'mdi-lightbulb'},{k:['media_player','radio','speaker'],i:'mdi-speaker'},{k:['klima','climate','hvac'],i:'mdi-home-thermometer'},{k:['sensor','czujnik'],i:'mdi-gauge'},{k:['door','drzwi'],i:'mdi-door'},{k:['window','roleta','blind'],i:'mdi-window-shutter'},{k:['fan','wentyl'],i:'mdi-fan'}];
      for(const m of map) if(m.k.some(kw=>v.includes(kw))) return m.i;
      const fallback={switch:'mdi-toggle-switch',sensor:'mdi-gauge',cover:'mdi-window-shutter',media_player:'mdi-speaker',climate:'mdi-home-thermometer',binary_sensor:'mdi-alert-circle-outline',script:'mdi-script-text-outline',navigate:'mdi-arrow-left-circle',label:'mdi-label',fan:'mdi-fan'};
      return fallback[type]||'mdi-help-circle-outline';
    }
    function pickPreviewIcon(w){
      const ent=getEntityData(w.id);
      const actionable=['switch','cover','binary_sensor','media_player','climate','script','fan'].includes(w.type) || w.id.startsWith('input_boolean.');
      if(actionable){
        let on=w.icon_on,off=w.icon_off;
        if(!on||!off){ const p=iconPairFor(w.id); on=on||p[0]; off=off||p[1]; }
        const st=ent?String(ent.state).toLowerCase().trim():'off';
        const isOn=['on','true','1','open','unlocked','playing','heat','cool','auto'].includes(st);
        return isOn?on:off;
      }
      return (w.icon&&w.icon.trim())?w.icon:pickAutoIcon(w.type,w.id);
    }

    function userEditedIcon(){ userEditedIconFlag=true; }
    function userEditedIconPair(){ userEditedIconPairFlag=true; }
    function userEditedNameCheck(){ userEditedName=true; }
    document.getElementById('new-widget-name').addEventListener('input', userEditedNameCheck);

    function updateIconPreview(){
      const iconOn=(document.getElementById('new-widget-icon-on')?.value||'').trim();
      const iconOff=(document.getElementById('new-widget-icon-off')?.value||'').trim();
      const base=document.getElementById('new-widget-icon').value.trim();
      const val=iconOn||iconOff||base;
      document.getElementById('icon-preview-i').className=(val && val.startsWith('mdi-'))?'mdi '+val:'mdi mdi-help-circle-outline';
    }

    function smartAutoFill(){
      const idField=document.getElementById('new-entity-id');
      const nameInput=document.getElementById('new-widget-name');
      const typeSel=document.getElementById('new-widget-type');
      const iconInput=document.getElementById('new-widget-icon');
      const iconOnInput=document.getElementById('new-widget-icon-on');
      const iconOffInput=document.getElementById('new-widget-icon-off');
      const sizeInput=document.getElementById('new-widget-size');
      const raw=(idField.value||'').trim(); if(!raw) return;
      const id=raw.toLowerCase();

      if(id.startsWith('sensor.')) typeSel.value='sensor';
      else if(id.startsWith('binary_sensor.')) typeSel.value='binary_sensor';
      else if(id.startsWith('cover.')) typeSel.value='cover';
      else if(id.startsWith('media_player.')) typeSel.value='media_player';
      else if(id.startsWith('climate.')) typeSel.value='climate';
      else if(id.startsWith('fan.')) typeSel.value='fan';
      else if(id.startsWith('switch.')||id.startsWith('light.')||id.startsWith('input_boolean.')||id.startsWith('script.')) typeSel.value='switch';
      else typeSel.value='switch';

      if((typeSel.value==='media_player'||typeSel.value==='climate') && !sizeInput.value) sizeInput.value='(2x2)';

      const autoName=formatNameFromId(id);
      if(!userEditedName || nameInput.value===lastAutoName || nameInput.value.trim()===''){
        nameInput.value=autoName; lastAutoName=autoName;
      }

      const actionable=['switch','cover','binary_sensor','media_player','climate','script','fan'].includes(typeSel.value) || id.startsWith('input_boolean.');
      if(actionable){
        if(!userEditedIconPairFlag){ const p=iconPairFor(id); iconOnInput.value=p[0]; iconOffInput.value=p[1]; }
        if(!userEditedIconFlag){ iconInput.value=''; }
      }else{
        if(!userEditedIconFlag || iconInput.value===lastAutoIcon || iconInput.value.trim()===''){
          const autoIcon=pickAutoIcon(typeSel.value,id); iconInput.value=autoIcon; lastAutoIcon=autoIcon;
        }
        if(!userEditedIconPairFlag){ iconOnInput.value=''; iconOffInput.value=''; }
      }
      updateIconPreview();
    }

    function renderRows(){
      const container=document.getElementById('rows-container');
      container.innerHTML='';
      rows.forEach((rowWidgets,index)=>{
        const rowDiv=document.createElement('div'); rowDiv.className='eink-row'; rowDiv.id='row-'+index;
        rowDiv.onclick=()=>{ if(editingIndices) cancelEdit(); activeRowIndex=index; refreshUIText(); highlightActiveRow(); };

        const rowLabel=document.createElement('div');
        rowLabel.style.position='absolute'; rowLabel.style.top='-10px'; rowLabel.style.left='5px';
        rowLabel.style.fontWeight='bold'; rowLabel.style.fontSize='10px'; rowLabel.style.color='#666';
        rowLabel.innerText=(currentLang==='pl'?'WIERSZ ':'ROW ')+(index+1);
        rowDiv.appendChild(rowLabel);

        rowWidgets.forEach((widget,wIndex)=>{
          const wDiv=document.createElement('div'); wDiv.className='eink-widget';
          if(editingIndices && editingIndices.r===index && editingIndices.w===wIndex) wDiv.classList.add('being-edited');

          let width=160, height=120;
          if(widget.size){
            const dims=widget.size.replace(/[()]/g,'').split('x'); const cols=parseInt(dims[0])||2; const rowsVal=parseInt(dims[1])||1;
            width=(cols*80)+((cols-1)*8);
            height=(rowsVal*80)+((rowsVal-1)*8);
          }
          wDiv.style.width=width+'px'; wDiv.style.height=height+'px';
          wDiv.onclick=(e)=>{ e.stopPropagation(); editWidget(index,wIndex); };

          const safeName=widget.name && widget.name.trim() ? widget.name : formatNameFromId(widget.id);
          const iconClass=pickPreviewIcon(widget);
          const iconHtml=iconClass?`<i class="mdi ${iconClass} ew-icon"></i>`:`<div style="height:38px"></div>`;
          const displayState=getDisplayState(widget.id,widget.type);
          wDiv.innerHTML = `
            <div class="ew-title">${safeName}</div>
            ${iconHtml}
            ${displayState?`<div class="ew-state">${displayState}</div>`:`<div style="height:14px"></div>`}
            <div class="ew-delete" onclick="removeWidget(${index},${wIndex});event.stopPropagation();">X</div>
          `;
          rowDiv.appendChild(wDiv);
        });

        container.appendChild(rowDiv);
      });
      highlightActiveRow();
    }
    function highlightActiveRow(){ document.querySelectorAll('.eink-row').forEach(el=>el.classList.remove('active')); const act=document.getElementById('row-'+activeRowIndex); if(act) act.classList.add('active'); }

    function editWidget(r,w){
      editingIndices={r,w};
      const widget=rows[r][w];
      activeRowIndex=r; highlightActiveRow();
      document.getElementById('new-widget-type').value=widget.type;
      document.getElementById('new-entity-id').value=widget.id;
      document.getElementById('new-widget-name').value=widget.name||'';
      document.getElementById('new-widget-icon').value=widget.icon||'';
      document.getElementById('new-widget-icon-on').value=widget.icon_on||'';
      document.getElementById('new-widget-icon-off').value=widget.icon_off||'';
      document.getElementById('new-widget-size').value=widget.size||'';
      updateIconPreview();
      document.getElementById('widget-form-box').classList.add('editing');
      document.getElementById('btn-cancel').classList.remove('hidden');
      refreshUIText(); renderRows();
    }
    function cancelEdit(){ editingIndices=null; clearForm(); document.getElementById('widget-form-box').classList.remove('editing'); document.getElementById('btn-cancel').classList.add('hidden'); refreshUIText(); renderRows(); }
    function saveWidget(){
      const type=document.getElementById('new-widget-type').value;
      let id=document.getElementById('new-entity-id').value.trim();
      if(!id){ alert(currentLang==='pl'?'Wymagana encja':'Entity required'); return; }
      let name=document.getElementById('new-widget-name').value.trim();
      let icon=document.getElementById('new-widget-icon').value.trim();
      let icon_on=document.getElementById('new-widget-icon-on').value.trim();
      let icon_off=document.getElementById('new-widget-icon-off').value.trim();
      const size=document.getElementById('new-widget-size').value;

      if(!name) name=formatNameFromId(id);

      const actionable=['switch','cover','binary_sensor','media_player','climate','script','fan'].includes(type) || id.startsWith('input_boolean.');
      if(actionable && (!icon_on||!icon_off)){
        const pair=iconPairFor(id);
        icon_on=ensureMdi(icon_on||pair[0]);
        icon_off=ensureMdi(icon_off||pair[1]);
      }
      if(!actionable && !icon){ icon=ensureMdi(pickAutoIcon(type,id)); } else { icon=ensureMdi(icon); }
      const newWidget={id,type,name,icon,icon_on:ensureMdi(icon_on),icon_off:ensureMdi(icon_off),size};
      if(editingIndices){ rows[editingIndices.r][editingIndices.w]=newWidget; cancelEdit(); }
      else { if(!rows.length) addNewRow(); rows[activeRowIndex].push(newWidget); clearForm(); }
      renderRows();
      lastAutoName=''; userEditedName=false; lastAutoIcon=''; userEditedIconFlag=false; userEditedIconPairFlag=false;
    }
    function clearForm(){ ['new-entity-id','new-widget-name','new-widget-icon','new-widget-icon-on','new-widget-icon-off','new-widget-size'].forEach(id=>document.getElementById(id).value=''); updateIconPreview(); userEditedName=false; userEditedIconFlag=false; userEditedIconPairFlag=false; lastAutoName=''; lastAutoIcon=''; }
    function removeWidget(r,w){ if(editingIndices && editingIndices.r===r && editingIndices.w===w) cancelEdit(); rows[r].splice(w,1); renderRows(); }
    function addNewRow(){ rows.push([]); activeRowIndex=rows.length-1; renderRows(); refreshUIText(); highlightActiveRow(); }

    function toggleImport(){ document.getElementById('import-area').classList.toggle('visible'); }

    // FIX 1: solid parsing of Title from 'title:' line with leading spaces and quotes
    // FIX 2: prefer widget 'title:' from definitions over formatted entity id
    // FIX 3: keep icon_on/icon_off from definitions; auto-complete missing with smart pair
    function importYaml(){
      const code=document.getElementById('import-code').value;
      if(!code) return;
      try{
        const lines=code.split('\n');
        const rawDefs={};
        let currentKey=null;
        let parsingLayout=false;
        const layoutLines=[];
        const ignore=['global_parameters','widget_dimensions','widget_size','widget_margins','columns','rows','skin'];

        // Parse file
        for(let rawLine of lines){
          const lineLeadingTrim=rawLine.replace(/^\s+/,''); // remove leading spaces
          const line=lineLeadingTrim.split('#')[0].trim();  // strip comments
          if(!line) continue;

          // Title
          if(/^title\s*:/i.test(lineLeadingTrim)){
            let val=lineLeadingTrim.split(':').slice(1).join(':').trim();
            val=val.replace(/^["']|["']$/g,'');
            if(val) document.getElementById('dash-title').value=val;
            continue;
          }

          // Start layout
          if(/^layout\s*:/i.test(lineLeadingTrim)){ parsingLayout=true; continue; }

          // Layout rows
          if(parsingLayout){
            if(/^\s*-\s+/.test(lineLeadingTrim)){
              layoutLines.push(lineLeadingTrim);
              continue;
            }
            // next root key encountered
            if(/^[A-Za-z0-9_.-]+\s*:/i.test(lineLeadingTrim)){
              parsingLayout=false;
              // fallthrough to defs parsing
            }
          }

          // Definitions
          const rootMatch=lineLeadingTrim.match(/^([A-Za-z0-9_.-]+)\s*:/);
          if(rootMatch){
            const key=rootMatch[1];
            if(!ignore.includes(key)){
              currentKey=key;
              if(!rawDefs[currentKey]) rawDefs[currentKey]={};
            }else{
              currentKey=null;
            }
            continue;
          }
          if(currentKey && lineLeadingTrim.includes(':')){
            const k=lineLeadingTrim.split(':')[0].trim();
            let v=lineLeadingTrim.substring(lineLeadingTrim.indexOf(':')+1).trim();
            v=v.replace(/^["']|["']$/g,''); // strip surrounding quotes
            rawDefs[currentKey][k]=v;
          }
        }

        // Build defs map by both widget id and entity
        importedDefsMap={};
        Object.entries(rawDefs).forEach(([k,def])=>{
          importedDefsMap[k]=def;
          if(def.entity) importedDefsMap[def.entity]=def;
        });

        // Build rows array
        rows=[];
        layoutLines.forEach(l=>{
          // Remove dash and leading spaces
          let content=l.replace(/^\s*-\s*/,'').trim();
          if(!content) return;
          const parts=content.split(',').map(x=>x.trim()).filter(Boolean);
          const rowWidgets=[];
          parts.forEach(item=>{
            const sizeMatch=item.match(/\(\d+x\d+\)/);
            const size=sizeMatch?sizeMatch[0]:'';
            const id=item.replace(size,'').trim();
            const def=importedDefsMap[id]||importedDefsMap[id.split('.').pop()]||{};
            // Determine type
            let type=def.widget_type;
            if(!type){
              if(id.startsWith('sensor.')) type='sensor';
              else if(id.startsWith('binary_sensor.')) type='binary_sensor';
              else if(id.startsWith('cover.')) type='cover';
              else if(id.startsWith('media_player.')) type='media_player';
              else if(id.startsWith('climate.')) type='climate';
              else if(id.startsWith('navigate.')) type='navigate';
              else if(id.startsWith('fan.')) type='fan';
              else if(id.startsWith('switch.')||id.startsWith('input_boolean.')||id.startsWith('light.')||id.startsWith('script.')) type='switch';
              else type='switch';
            }

            // Prefer 'title' from code; fallback to formatted id
            let name = def.title ? def.title : formatNameFromId(id);

            // Icons
            let icon=def.icon||def.icon_inactive||'';
            let icon_on=def.icon_on||def.icon_active||'';
            let icon_off=def.icon_off||def.icon_inactive||'';
            const actionable=['switch','cover','binary_sensor','media_player','climate','script','fan'].includes(type) || id.startsWith('input_boolean.');
            if(actionable && (!icon_on||!icon_off)){
              const p=iconPairFor(id); icon_on=icon_on||p[0]; icon_off=icon_off||p[1];
            }
            icon=ensureMdi(icon); icon_on=ensureMdi(icon_on); icon_off=ensureMdi(icon_off);

            rowWidgets.push({id,type,name,icon,icon_on,icon_off,size});
          });
          if(rowWidgets.length) rows.push(rowWidgets);
        });

        if(!rows.length){ alert("Nie znaleziono layout w imporcie."); return; }

        renderRows(); activeRowIndex=rows.length-1; refreshUIText(); highlightActiveRow(); toggleImport();
        alert("Import zako≈Ñczony powodzeniem.");
      }catch(e){
        alert("B≈ÇƒÖd importu: "+e.message);
      }
    }

    // YAML generation
    function buildHeader(title){
      return [
        "# --- JOAN 6 E-INK DASHBOARD ---",
        `# File: ${title.toLowerCase()}.dash`,
        "# Location: \\\\IP_HA\\addon_configs\\appdaemon\\dashboards\\",
        "# --------------------------------",
        "",
        `title: ${title}`,
        "widget_dimensions: [117, 117]",
        "widget_size: [2, 1]",
        "widget_margins: [8, 8]",
        "columns: 6",
        "rows: "+(rows.length || 8)+" #9",
        "global_parameters:",
        "  use_comma: 0",
        "  precision: 1",
        "  use_hass_icon: 1",
        "  namespace: default",
        "  state_text: 1",
        `  title_style: "color: #000000; font-size: 20px; font-weight: 700; text-align: center; padding-top: 5px; width: 100%; font-family: 'Roboto', 'Arial Black', sans-serif;"`,
        `  text_style: "color: #000000 !important; font-weight: 700 !important;"`,
        `  state_text_style: "color: #000000 !important; font-weight: 700 !important; font-size: 14px; text-transform: uppercase; margin-top: 5px;"`,
        `  widget_style: "color: #000000 !important; background-color: #FFFFFF !important; border: 2px solid #000000 !important;"`,
        `  icon_style_active: "color: #000000 !important;"`,
        `  icon_style_inactive: "color: #000000 !important;"`,
        "skin: simplyred",
        "",
        "layout:"
      ].join("\n");
    }
    function buildLayout(){ return rows.map(r=> "  - " + r.map(w=> w.id + (w.size? ` ${w.size}`:"")).join(", ")).join("\n"); }
    function widgetYaml(w){
      const lines=[]; const titleEsc=(w.name||formatNameFromId(w.id)).replace(/"/g,'\\"');
      lines.push(`${w.id}:`);
      const wt=w.type==='fan'?'switch':w.type;
      lines.push(`  widget_type: ${wt}`);
      if(w.type==='navigate'){
        lines.push(`  title: "${titleEsc}"`);
        lines.push(`  dashboard: ${w.id.replace('navigate.','')}`);
        lines.push(`  icon_inactive: ${ensureMdi(w.icon || 'mdi-arrow-left-circle')}`);
        lines.push(`  title_style: "color: #000000; font-size: 24px; font-weight: 700; text-align: center; padding-top: 5px; width: 100%; font-family: 'Roboto', 'Arial Black', sans-serif;"`);
        lines.push(`  widget_style: "background-color: #FFFFFF !important; border-radius: 8px !important; padding: 10px !important; color: #000000 !important;"`);
        return lines.join("\n");
      }
      lines.push(`  entity: ${w.id}`);
      lines.push(`  title: "${titleEsc}"`);
      const actionable=['switch','cover','binary_sensor','media_player','climate','script','fan'].includes(w.type) || w.id.startsWith('input_boolean.');
      if(actionable){
        const p=iconPairFor(w.id);
        const ion=ensureMdi(w.icon_on||p[0]);
        const ioff=ensureMdi(w.icon_off||p[1]);
        lines.push(`  icon_on: ${ion}`);
        lines.push(`  icon_off: ${ioff}`);
        lines.push(`  title_style: "color: #000000; font-size: 20px; font-weight: 700; text-align: center; padding-top: 5px; width: 100%; font-family: 'Roboto', 'Arial Black', sans-serif;"`);
        lines.push(`  state_text: 1`);
        lines.push(`  text_style: "color: #000000 !important; font-weight: 700 !important;"`);
        lines.push(`  widget_style: "color: #000000 !important; background-color: #FFFFFF !important; border: 2px solid #000000 !important;"`);
        lines.push(`  state_map:`);
        if(w.type==='cover'){
          lines.push(`    "open": "OTWARTA"`);
          lines.push(`    "closed": "ZAMKNIƒòTA"`);
          lines.push(`    "opening": "OTWIERANIE"`);
          lines.push(`    "closing": "ZAMYKANIE"`);
        }else if(w.type==='climate'){
          lines.push(`    "off": "WY≈ÅƒÑCZONA"`);
          lines.push(`    "auto": "AUTO"`);
          lines.push(`    "heat": "GRZANIE"`);
          lines.push(`    "cool": "CH≈ÅODZENIE"`);
          lines.push(`    "dry": "OSUSZANIE"`);
          lines.push(`    "fan_only": "WENTYLATOR"`);
        }else{
          lines.push(`    "on": "${translations[currentLang].state_on}"`);
          lines.push(`    "off": "${translations[currentLang].state_off}"`);
        }
        lines.push(`  icon_style_active: "color: #000000 !important;"`);
        lines.push(`  icon_style_inactive: "color: #000000 !important;"`);
      }else if(w.type==='sensor'){
        const base=ensureMdi(w.icon || pickAutoIcon('sensor',w.id));
        lines.push(`  title_style: "color: #000000; font-size: 20px; font-weight: 700; text-align: center; padding-top: 5px; width: 100%; font-family: 'Roboto', 'Arial Black', sans-serif;"`);
        lines.push(`  text_style: "color: #000000 !important;"`);
        lines.push(`  value_style: "color: #000000 !important; font-size: 44px !important; font-weight: 700 !important;"`);
        lines.push(`  unit_style: "color: #000000 !important;"`);
        lines.push(`  widget_style: "color: #000000 !important; background-color: #FFFFFF !important;"`);
        lines.push(`  icon: ${base}`);
      }else{
        const base=ensureMdi(w.icon || pickAutoIcon(w.type,w.id));
        lines.push(`  icon: ${base}`);
        lines.push(`  title_style: "color: #000000; font-size: 20px; font-weight: 700; text-align: center; padding-top: 5px; width: 100%; font-family: 'Roboto', 'Arial Black', sans-serif;"`);
        lines.push(`  widget_style: "color: #000000 !important; background-color: #FFFFFF !important;"`);
      }
      return lines.join("\n");
    }
    function buildWidgetsSection(){
      let out="\n# -------------------\n# DEFINICJE WID≈ªET√ìW\n# -------------------\n\n";
      rows.forEach(r=> r.forEach(w=> out+=widgetYaml(w)+"\n\n"));
      return out.trimEnd();
    }
    function buildFullYaml(){
      const title=(document.getElementById('dash-title').value||'Joan2').replace(/"/g,'');
      const header=buildHeader(title);
      const layout=buildLayout();
      const widgets=buildWidgetsSection();
      return [header,layout,widgets].join("\n");
    }

    function prepareAndSubmit(e){
      e.preventDefault();
      const yaml=buildFullYaml();
      document.getElementById('generated_yaml_client').value=yaml;
      document.getElementById('layout_data_json').value=JSON.stringify(rows.map(r=>r.map(w=>w.id+(w.size? " "+w.size:""))));
      document.getElementById('widgets_full_json').value=JSON.stringify(rows);
      document.getElementById('client-yaml-section').style.display='block';
      document.getElementById('client-yaml-output').value=yaml;
      const host=window.location.hostname;
      document.getElementById('client-path-code').innerText=`\\\\${host}\\addon_configs\\appdaemon\\dashboards\\${(document.getElementById('dash-title').value||'Joan2').toLowerCase()}.dash`;
      // e.target.submit(); // w≈ÇƒÖcz je≈õli chcesz wysy≈Çaƒá na backend
    }

    async function fetchIcons(){
      const dl=document.getElementById('icons-list');
      try{
        const res=await fetch('https://raw.githubusercontent.com/Templarian/MaterialDesign/master/meta.json');
        const icons=await res.json();
        dl.innerHTML='';
        icons.forEach(i=>{ const opt=document.createElement('option'); opt.value='mdi-'+i.name; dl.appendChild(opt); });
      }catch(e){}
    }
    fetchIcons();

    function toggleInputs(){}

    window.addEventListener('DOMContentLoaded',()=>{
      const host=window.location.hostname;
      const codePath=document.getElementById('path-code');
      const linkDash=document.getElementById('dashboard-link');
      if(codePath) codePath.innerHTML=codePath.innerHTML.replace('IP_HA',host);
      if(linkDash){
        const href=`http://${host}:5050/{{ dash_name }}`;
        linkDash.href=href; linkDash.innerText=href;
      }
      const savedLang=localStorage.getItem('joan_lang')||'pl';
      setLang(savedLang);
      const themeInput=document.getElementById('ui_theme');
      const persisted=themeInput && themeInput.value ? themeInput.value : (localStorage.getItem('joan_theme')||'light');
      if(persisted==='dark') document.body.classList.add('dark-mode');
      document.getElementById('btn-theme').innerText=document.body.classList.contains('dark-mode')?'‚òÄÔ∏è':'üåô';
      if(themeInput) themeInput.value=document.body.classList.contains('dark-mode')?'dark':'light';
      if(!rows.length) addNewRow();
    });
  </script>
</body>
</html>
