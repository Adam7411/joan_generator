<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joan Dashboard Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #e0e0e0; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        h1 { color: #d32f2f; margin: 0; }
        .lang-switch button { padding: 8px 15px; border: 1px solid #ccc; background: #f0f0f0; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .lang-switch button.active { background: #d32f2f; color: white; border-color: #b71c1c; }
        .section { margin-bottom: 30px; border: 1px solid #ddd; padding: 20px; border-radius: 8px; background: #fafafa; }
        .section-title { font-size: 1.2em; font-weight: bold; color: #555; margin-bottom: 15px; border-bottom: 2px solid #d32f2f; display: inline-block; }
        
        /* IMPORT BOX */
        .import-box { background: #fff3e0; border: 1px solid #ffe0b2; display: none; }
        .import-box.visible { display: block; }

        label { display: block; margin-top: 10px; font-weight: bold; font-size: 0.9em; }
        input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .add-widget-box { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #2196f3; }
        .flex-row { display: flex; gap: 15px; align-items: flex-end; }
        .flex-col { flex: 1; }
        .icon-preview-box { width: 42px; height: 42px; background: #fff; border: 1px solid #ccc; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #333; margin-bottom: 1px; }
        
        .btn { padding: 10px 20px; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; text-transform: uppercase; }
        .btn-primary { background-color: #d32f2f; color: white; width: 100%; font-size: 18px; margin-top: 20px; }
        .btn-add { background-color: #4caf50; color: white; width: 100%; }
        .btn-row { background-color: #2196f3; color: white; margin-top: 10px; }
        .btn-import { background-color: #ff9800; color: white; margin-bottom: 10px; }
        
        .preview-area { background-color: #f0f0f0; padding: 20px; border-radius: 8px; border: 2px solid #ccc; overflow-x: auto; min-height: 150px; }
        .eink-row { display: flex; gap: 8px; margin-bottom: 8px; padding: 10px; border: 2px dashed #bbb; background: #fff; border-radius: 4px; align-items: center; position: relative; }
        .eink-row.active { border-color: #2196f3; background: #e3f2fd; }
        .eink-widget { width: 140px; height: 100px; background-color: #FFFFFF; border: 2px solid #000; color: #000; display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 5px; box-sizing: border-box; position: relative; cursor: pointer; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); }
        .ew-title { font-size: 14px; font-weight: 700; text-align: center; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .ew-icon { font-size: 36px; }
        .ew-state { font-size: 12px; font-weight: 700; text-transform: uppercase; }
        .ew-delete { position: absolute; top: 0; right: 0; background: red; color: white; width: 20px; height: 20px; text-align: center; line-height: 20px; font-size: 12px; display: none; }
        .eink-widget:hover .ew-delete { display: block; }
        
        textarea.output { width: 100%; height: 500px; font-family: monospace; background: #263238; color: #eceff1; border: none; padding: 15px; border-radius: 4px; }
        .status-bar { padding: 10px; margin-bottom: 20px; border-radius: 4px; text-align: center; font-weight: bold; }
        .hidden { display: none !important; }
        .file-path-info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; padding: 15px; margin-bottom: 15px; border-radius: 4px; font-family: monospace; font-size: 14px; }
        .file-path-info code { background: rgba(255,255,255,0.5); padding: 2px 5px; border-radius: 3px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-row">
            <h1>Joan 6 E-Ink Generator</h1>
            <div class="lang-switch">
                <button type="button" onclick="setLang('pl')" id="btn-pl" class="active">PL</button>
                <button type="button" onclick="setLang('en')" id="btn-en">EN</button>
            </div>
        </div>

        {% if entities %}
            <div class="status-bar" style="background: #d4edda; color: #155724;">
                <span data-i18n="status_ok">âœ“ PoÅ‚Ä…czono z Home Assistant</span> ({{ entities|length }})
            </div>
        {% else %}
            <div class="status-bar" style="background: #f8d7da; color: #721c24;">
                <span data-i18n="status_error">âš  Brak poÅ‚Ä…czenia z API. SprawdÅº token.</span>
            </div>
        {% endif %}

        <!-- IMPORT SECTION -->
        <button type="button" class="btn btn-import" onclick="toggleImport()">ðŸ“‚ Importuj / Edytuj Kod</button>
        <div id="import-area" class="section import-box">
            <h4 style="margin-top:0">Wklej stary kod .dash tutaj:</h4>
            <textarea id="import-code" style="height: 150px; background: #fff; color: #000;" placeholder="Wklej zawartoÅ›Ä‡ pliku YAML..."></textarea>
            <button type="button" class="btn btn-add" style="margin-top: 10px;" onclick="importYaml()">Wczytaj Dashboard</button>
        </div>

        <form method="POST" id="main-form">
            <input type="hidden" name="ui_language" id="ui_language" value="pl">
            
            <div class="section">
                <div class="section-title" data-i18n="sec_settings">1. Ustawienia</div>
                <div class="flex-row">
                    <div class="flex-col">
                        <label data-i18n="dash_title">TytuÅ‚ Dashboardu (Nazwa pliku)</label>
                        <input type="text" name="title" id="dash-title" value="JoanDashboard">
                    </div>
                </div>
            </div>

            <div class="add-widget-box">
                <h4 style="margin-top:0" data-i18n="sec_add">2. Dodaj Widget</h4>
                <div class="flex-row">
                    <div class="flex-col">
                        <label data-i18n="label_type">Typ Widgetu</label>
                        <select id="new-widget-type" onchange="toggleInputs()">
                            <option value="switch">Switch / Light</option>
                            <option value="navigate">Navigate / Dashboard Button</option>
                            <option value="sensor">Sensor</option>
                            <option value="binary_sensor">Binary Sensor</option>
                            <option value="cover">Cover / Gate</option>
                            <option value="media_player">Media Player</option>
                            <option value="climate">Climate</option>
                            <option value="script">Script</option>
                        </select>
                    </div>
                    
                    <div class="flex-col" id="group-entity">
                        <label data-i18n="label_entity">Wybierz EncjÄ™ (Home Assistant)</label>
                        <input list="entities-list" id="new-entity-id" placeholder="np. light.salon..." oninput="megaAutoConfig()">
                        <datalist id="entities-list">
                            {% for entity in entities %}
                            <option value="{{ entity }}">
                            {% endfor %}
                        </datalist>
                    </div>

                    <div class="flex-col hidden" id="group-nav">
                        <label data-i18n="label_dashboard">Nazwa pliku dashboardu</label>
                        <input type="text" id="new-dashboard-name" placeholder="np. joan3 (bez .dash)">
                    </div>

                    <div class="flex-col">
                        <label data-i18n="label_name">TytuÅ‚ na ekranie</label>
                        <input type="text" id="new-widget-name" placeholder="np. Kuchnia">
                    </div>
                </div>
                
                <div class="flex-row" style="margin-top: 10px; align-items: flex-end;">
                    <div class="flex-col" style="max-width: 150px;">
                        <label data-i18n="label_size">Rozmiar</label>
                        <select id="new-widget-size">
                            <option value="">DomyÅ›lny (2x1)</option>
                            <option value="(1x1)">1x1 (MaÅ‚y)</option>
                            <option value="(2x1)">2x1 (Standard)</option>
                            <option value="(2x2)">2x2 (DuÅ¼y)</option>
                            <option value="(3x1)">3x1 (Szeroki)</option>
                            <option value="(1x2)">1x2 (Wysoki)</option>
                            <option value="(3x2)">3x2 (Bardzo duÅ¼y)</option>
                        </select>
                    </div>

                    <div style="width: 50px;">
                        <label data-i18n="label_preview">PodglÄ…d</label>
                        <div class="icon-preview-box">
                            <i id="icon-preview-i" class="mdi mdi-help-circle-outline"></i>
                        </div>
                    </div>
                    
                    <div class="flex-col">
                        <label data-i18n="label_icon">Ikona</label>
                        <input list="icons-list" id="new-widget-icon" placeholder="np. mdi-home" oninput="updateIconPreview()">
                        <datalist id="icons-list"></datalist>
                    </div>
                    
                    <div class="flex-col">
                        <button type="button" class="btn btn-add" onclick="addWidgetToStaging()">
                            <span data-i18n="btn_add">+ DODAJ DO WIERSZA</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title" data-i18n="sec_preview">3. PodglÄ…d Dashboardu (E-Ink Preview)</div>
                <div id="rows-container" class="preview-area"></div>
                <button type="button" class="btn btn-row" onclick="addNewRow()">
                    <span data-i18n="btn_new_row">+ Dodaj Nowy Wiersz</span>
                </button>
            </div>

            <input type="hidden" name="layout_data_json" id="layout_data_json">
            <button type="button" class="btn btn-primary" onclick="submitForm()">
                <span data-i18n="btn_generate">GENERUJ KOD .DASH</span>
            </button>
        </form>

        {% if generated_yaml %}
        <div class="section">
            <h3 data-i18n="sec_code">TwÃ³j kod YAML:</h3>
            <div class="file-path-info">
                <strong data-i18n="info_save">Zapisz ten kod w pliku:</strong><br>
                <code style="font-size: 16px;">\\IP_HA\addon_configs\appdaemon\dashboards\{{ filename }}</code>
            </div>
            <textarea class="output" readonly>{{ generated_yaml }}</textarea>
        </div>
        {% endif %}
    </div>

    <script>
        const translations = {
            pl: {
                status_ok: "âœ“ PoÅ‚Ä…czono z Home Assistant", status_error: "âš  Brak poÅ‚Ä…czenia z API. SprawdÅº token.",
                sec_settings: "1. Ustawienia", sec_add: "2. Dodaj Widget", sec_preview: "3. PodglÄ…d Dashboardu (E-Ink)", sec_code: "TwÃ³j kod YAML:",
                dash_title: "TytuÅ‚ Dashboardu (Nazwa pliku)", label_entity: "Wybierz EncjÄ™ (Home Assistant)",
                label_dashboard: "Nazwa pliku dashboardu (np. joan3)", label_type: "Typ Widgetu", label_name: "TytuÅ‚ na ekranie",
                label_icon: "Ikona (Automatyczna)", label_preview: "Ikona", label_size: "Rozmiar",
                btn_add: "+ DODAJ DO WIERSZA", btn_new_row: "+ Dodaj Nowy Wiersz", btn_generate: "GENERUJ KOD .DASH",
                state_on: "WÅÄ„CZONE", state_open: "OTWARTE", info_save: "Zapisz ten kod w pliku:"
            },
            en: {
                status_ok: "âœ“ Connected to Home Assistant", status_error: "âš  No API Connection. Check Token.",
                sec_settings: "1. Settings", sec_add: "2. Add Widget", sec_preview: "3. Dashboard Preview (E-Ink)", sec_code: "Your YAML Code:",
                dash_title: "Dashboard Title (Filename)", label_entity: "Select Entity (Home Assistant)",
                label_dashboard: "Dashboard Filename (e.g. joan3)", label_type: "Widget Type", label_name: "Title on Screen",
                label_icon: "Icon (Automatic)", label_preview: "Icon", label_size: "Size",
                btn_add: "+ ADD TO ROW", btn_new_row: "+ Add New Row", btn_generate: "GENERATE .DASH CODE",
                state_on: "ON", state_open: "OPEN", info_save: "Save this code to file:"
            }
        };

        let currentLang = 'pl';
        function setLang(lang) {
            currentLang = lang;
            document.getElementById('ui_language').value = lang;
            document.getElementById('btn-pl').className = lang === 'pl' ? 'active' : '';
            document.getElementById('btn-en').className = lang === 'en' ? 'active' : '';
            
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(translations[lang][key]) el.innerText = translations[lang][key];
            });
            renderRows();
        }

        // --- IMPORT LOGIC ---
        function toggleImport() {
            const box = document.getElementById('import-area');
            box.classList.toggle('visible');
        }

        function importYaml() {
            const code = document.getElementById('import-code').value;
            if (!code) return;

            try {
                const lines = code.split('\n');
                const widgetDefs = {};
                let currentWidgetId = null;
                
                // 1. Zczytanie tytuÅ‚u globalnego
                for(let line of lines) {
                    const l = line.trim();
                    if (l.startsWith('title:') && !l.includes('style')) {
                        // SprawdÅº czy to nie jest title widgetu (z wciÄ™ciem)
                        if (!line.startsWith(' ') && !line.startsWith('\t')) {
                            const t = l.split(':')[1].trim().replace(/['"]/g, '');
                            document.getElementById('dash-title').value = t;
                            break;
                        }
                    }
                }

                // 2. Parsowanie definicji widgetÃ³w
                lines.forEach(line => {
                    if (line.match(/^\S+:/)) { // Top level key (widget ID), np. light.kurnik:
                        const key = line.split(':')[0].trim();
                        if (key !== 'layout' && key !== 'global_parameters' && key !== 'skin' && key !== 'title' && key !== 'widget_dimensions' && key !== 'widget_size' && key !== 'widget_margins' && key !== 'columns' && key !== 'rows') {
                            currentWidgetId = key;
                            widgetDefs[currentWidgetId] = {};
                        } else {
                            currentWidgetId = null; // System keys ignored
                        }
                    } else if (currentWidgetId && line.includes(':')) {
                        const parts = line.split(':');
                        const key = parts[0].trim();
                        let val = parts.slice(1).join(':').trim().replace(/['"]/g, '');
                        widgetDefs[currentWidgetId][key] = val;
                    }
                });

                // 3. Parsowanie Layoutu (POPRAWIONE)
                rows = [];
                let layoutStarted = false;
                
                for(let i=0; i<lines.length; i++) {
                    const line = lines[i];
                    const l = line.trim();
                    
                    if (l.startsWith('layout:')) { 
                        layoutStarted = true; 
                        continue; 
                    }
                    
                    if (layoutStarted) {
                        // JeÅ›li linia jest pusta, ignoruj (NIE KOÅƒCZ)
                        if (l === '') continue;
                        
                        // Koniec sekcji layout: jeÅ›li linia nie ma wciÄ™cia i nie zaczyna siÄ™ od myÅ›lnika
                        if (!line.startsWith(' ') && !line.startsWith('\t') && !l.startsWith('-')) {
                            layoutStarted = false;
                            continue;
                        }

                        if (l.startsWith('-')) {
                            const rowItems = l.substring(1).split(',');
                            const newRow = [];
                            rowItems.forEach(item => {
                                let raw = item.trim();
                                // WyciÄ…ganie rozmiaru (2x2)
                                let size = "";
                                const sizeMatch = raw.match(/\(\d+x\d+\)/);
                                if (sizeMatch) {
                                    size = sizeMatch[0];
                                    raw = raw.replace(size, '');
                                }
                                
                                const id = raw;
                                const def = widgetDefs[id] || {};
                                
                                let type = def.widget_type || 'switch';
                                // Poprawka dla Navigate: ID czÄ™sto wyglÄ…da jak navigate.cos
                                if (id.startsWith('navigate.')) { type = 'navigate'; }

                                let icon = def.icon || def.icon_on || def.icon_inactive || 'mdi-help-circle-outline';

                                newRow.push({
                                    id: id,
                                    type: type,
                                    name: def.title || id,
                                    icon: icon,
                                    size: size
                                });
                            });
                            rows.push(newRow);
                        }
                    }
                }

                if (rows.length === 0) {
                    alert("Nie znaleziono sekcji 'layout' lub jest pusta.");
                    return;
                }

                renderRows();
                toggleImport();
                alert("Zaimportowano pomyÅ›lnie!");

            } catch (e) {
                alert("BÅ‚Ä…d importu: " + e.message);
                console.error(e);
            }
        }

        // --- RENDER LOGIC WITH SIZING ---
        function renderRows() {
            const container = document.getElementById('rows-container');
            container.innerHTML = '';
            
            rows.forEach((rowWidgets, index) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'eink-row';
                rowDiv.id = 'row-' + index;
                rowDiv.onclick = () => { activeRowIndex = index; highlightActiveRow(); };

                const rowLabel = document.createElement('div');
                rowLabel.style.position = 'absolute'; rowLabel.style.top = '-10px'; rowLabel.style.left='5px'; 
                rowLabel.style.fontWeight = 'bold'; rowLabel.style.fontSize = '10px'; rowLabel.style.color='#666';
                rowLabel.innerText = (currentLang === 'pl' ? 'WIERSZ ' : 'ROW ') + (index + 1);
                rowDiv.appendChild(rowLabel);

                rowWidgets.forEach((widget, wIndex) => {
                    const wDiv = document.createElement('div');
                    wDiv.className = 'eink-widget';
                    
                    // --- SIZE CALCULATION ---
                    let w = 125; // Default 2x1 width
                    let h = 60;  // Default 2x1 height
                    
                    if (widget.size) {
                        const dims = widget.size.replace(/[()]/g, '').split('x');
                        const cols = parseInt(dims[0]);
                        const rows = parseInt(dims[1]);
                        w = (cols * 60) + ((cols - 1) * 5);
                        h = (rows * 60) + ((rows - 1) * 5);
                    }

                    wDiv.style.width = w + 'px';
                    wDiv.style.height = h + 'px';
                    if (h < 70) wDiv.style.fontSize = '0.9em';

                    const iconClass = widget.icon ? widget.icon : 'mdi-help-circle-outline';
                    
                    wDiv.innerHTML = `
                        <div class="ew-title">${widget.name}</div>
                        <i class="mdi ${iconClass} ew-icon"></i>
                        <div class="ew-state"> ${widget.size || ''}</div>
                        <div class="ew-delete" onclick="removeWidget(${index}, ${wIndex}); event.stopPropagation();">X</div>
                    `;
                    rowDiv.appendChild(wDiv);
                });

                if(rows.length > 1) {
                    const del = document.createElement('button');
                    del.innerText = 'USUÅƒ'; del.className='btn-remove-row btn';
                    del.style.position='absolute'; del.style.right='5px'; del.style.top='5px';
                    del.onclick = (e) => { e.stopPropagation(); deleteRow(index); };
                    rowDiv.appendChild(del);
                }
                container.appendChild(rowDiv);
            });
            highlightActiveRow();
        }

        // --- REST OF LOGIC ---
        function toggleInputs() {
            const type = document.getElementById('new-widget-type').value;
            const groupEntity = document.getElementById('group-entity');
            const groupNav = document.getElementById('group-nav');
            const iconInput = document.getElementById('new-widget-icon');
            const sizeInput = document.getElementById('new-widget-size');

            if (type === 'navigate') {
                groupEntity.classList.add('hidden');
                groupNav.classList.remove('hidden');
                if(!iconInput.value) { iconInput.value = 'mdi-arrow-right-circle'; updateIconPreview(); }
            } else {
                groupEntity.classList.remove('hidden');
                groupNav.classList.add('hidden');
            }

            if(type === 'media_player' || type === 'climate') { sizeInput.value = '(2x2)'; }
            else if (sizeInput.value === '(2x2)') { sizeInput.value = ''; }
        }

        async function fetchIcons() {
            const dataList = document.getElementById('icons-list');
            try {
                const response = await fetch('https://raw.githubusercontent.com/Templarian/MaterialDesign/master/meta.json');
                const icons = await response.json();
                dataList.innerHTML = '';
                icons.forEach(i => {
                    const opt = document.createElement('option');
                    opt.value = 'mdi-' + i.name;
                    dataList.appendChild(opt);
                });
            } catch (e) {}
        }
        fetchIcons();

        function updateIconPreview() {
            const val = document.getElementById('new-widget-icon').value;
            const preview = document.getElementById('icon-preview-i');
            preview.className = (val && val.startsWith('mdi-')) ? 'mdi ' + val : 'mdi mdi-help-circle-outline';
        }

        function highlightActiveRow() {
            document.querySelectorAll('.eink-row').forEach(el => el.classList.remove('active'));
            const active = document.getElementById('row-' + activeRowIndex);
            if(active) active.classList.add('active');
        }

        function addNewRow() { rows.push([]); renderRows(); activeRowIndex = rows.length - 1; highlightActiveRow(); }
        function removeWidget(r, w) { rows[r].splice(w, 1); renderRows(); }
        function deleteRow(i) { rows.splice(i, 1); if(activeRowIndex >= rows.length) activeRowIndex = rows.length - 1; renderRows(); }
        function submitForm() {
            document.getElementById('layout_data_json').value = JSON.stringify(rows);
            document.getElementById('main-form').submit();
        }

        function addWidgetToStaging() {
            const type = document.getElementById('new-widget-type').value;
            const nameInput = document.getElementById('new-widget-name');
            const iconInput = document.getElementById('new-widget-icon');
            const sizeInput = document.getElementById('new-widget-size');
            
            let id = '';
            let name = nameInput.value;
            let icon = iconInput.value;
            let size = sizeInput.value;

            if (type === 'navigate') {
                const dashName = document.getElementById('new-dashboard-name').value.trim();
                if (!dashName) { alert("Wpisz nazwÄ™ dashboardu!"); return; }
                id = 'navigate.' + dashName;
                if (!name) name = dashName.charAt(0).toUpperCase() + dashName.slice(1);
            } else {
                id = document.getElementById('new-entity-id').value;
                if(!id) { alert("Wybierz encjÄ™!"); return; }
                if(!name) name = id.split('.')[1] || id;
            }

            if(icon && !icon.startsWith('mdi-')) icon = 'mdi-' + icon;

            if (rows.length === 0) addNewRow();
            rows[activeRowIndex].push({ id, type, name, icon, size });
            renderRows();
            
            document.getElementById('new-entity-id').value = '';
            document.getElementById('new-dashboard-name').value = '';
            nameInput.value = '';
            iconInput.value = '';
            if(type !== 'media_player') sizeInput.value = '';
            updateIconPreview();
        }

        function megaAutoConfig() {
            const id = document.getElementById('new-entity-id').value.toLowerCase();
            const typeSelect = document.getElementById('new-widget-type');
            const iconInput = document.getElementById('new-widget-icon');
            const sizeInput = document.getElementById('new-widget-size');

            if(typeSelect.value === 'navigate') return; 

            let detectedType = '';
            if(id.startsWith('sensor.')) detectedType = 'sensor';
            else if(id.startsWith('binary_sensor.')) detectedType = 'binary_sensor';
            else if(id.startsWith('cover.')) detectedType = 'cover';
            else if(id.startsWith('media_player.')) detectedType = 'media_player';
            else if(id.startsWith('climate.')) detectedType = 'climate';
            else if(id.startsWith('light.') || id.startsWith('switch.')) detectedType = 'switch';
            
            if(detectedType) {
                typeSelect.value = detectedType;
                if(detectedType === 'media_player' || detectedType === 'climate') sizeInput.value = '(2x2)';
                else sizeInput.value = '';
            }
            
            if(iconInput.value) return; 

            const keywords = {
                'battery': 'mdi-battery', 'temp': 'mdi-thermometer', 'light': 'mdi-lightbulb',
                'garage': 'mdi-garage', 'lock': 'mdi-lock', 'fan': 'mdi-fan'
            };
            for (const [key, icon] of Object.entries(keywords)) {
                if (id.includes(key)) { iconInput.value = icon; updateIconPreview(); break; }
            }
        }
        
        if(rows.length === 0) addNewRow();
    </script>
</body>
</html>
