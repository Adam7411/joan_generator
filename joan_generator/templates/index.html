<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joan Dashboard Generator 2.0</title>
    <!-- Pobieramy font Roboto dla ładnego wyglądu -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #e0e0e0; padding: 20px; color: #333; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #d32f2f; margin-bottom: 30px; }
        
        .section { margin-bottom: 30px; border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: #fafafa; }
        .section h3 { margin-top: 0; color: #555; border-bottom: 2px solid #d32f2f; padding-bottom: 10px; display: inline-block; }
        
        label { display: block; margin-top: 10px; font-weight: bold; font-size: 0.9em; }
        input, select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        /* Stylizacja kreatora wierszy */
        .row-builder { margin-top: 15px; }
        .dashboard-row { 
            background: #fff; border: 1px dashed #999; padding: 10px; margin-bottom: 10px; 
            display: flex; gap: 10px; flex-wrap: wrap; align-items: center; min-height: 60px;
            border-radius: 4px;
        }
        .row-label { font-weight: bold; margin-right: 10px; color: #d32f2f; }
        
        .widget-card {
            background: #333; color: #fff; padding: 5px 10px; border-radius: 4px; font-size: 0.85em;
            display: flex; align-items: center; gap: 5px; cursor: pointer; border: 1px solid transparent;
        }
        .widget-card:hover { border-color: #d32f2f; }
        .widget-card span { font-weight: bold; }
        .btn-del-widget { color: #ff5252; cursor: pointer; font-weight: bold; margin-left: 5px; }

        /* Formularz dodawania widgetu */
        .add-widget-box { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #2196f3; }
        .flex-row { display: flex; gap: 15px; align-items: flex-end; }
        .flex-col { flex: 1; }

        .btn { padding: 10px 20px; border: none; cursor: pointer; border-radius: 4px; font-size: 14px; font-weight: bold; text-transform: uppercase; }
        .btn-primary { background-color: #d32f2f; color: white; width: 100%; font-size: 18px; margin-top: 20px; }
        .btn-add { background-color: #4caf50; color: white; }
        .btn-row { background-color: #2196f3; color: white; margin-top: 10px; }
        .btn-remove-row { background-color: #757575; color: white; font-size: 10px; padding: 5px; margin-left: auto; }

        textarea.output { width: 100%; height: 500px; font-family: monospace; background: #263238; color: #eceff1; border: none; padding: 15px; margin-top: 20px; border-radius: 4px; }
        
        .hint { font-size: 0.8em; color: #666; margin-top: 2px; }
        a { color: #d32f2f; text-decoration: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Generator Joan E-Ink</h1>
        
        <!-- Formularz dodawania widgetu -->
        <div class="add-widget-box">
            <h4>Kreator Widgetu</h4>
            <div class="flex-row">
                <div class="flex-col" style="flex: 2;">
                    <label>Wybierz Encję (z Home Assistant)</label>
                    <input list="entities-list" id="new-entity-id" placeholder="Wpisz np. light.kuchnia..." onchange="guessType()">
                    <datalist id="entities-list">
                        {% for entity in entities %}
                        <option value="{{ entity }}">
                        {% endfor %}
                    </datalist>
                </div>
                <div class="flex-col">
                    <label>Typ Widgetu</label>
                    <select id="new-widget-type">
                        <option value="switch">Przełącznik/Światło (Switch)</option>
                        <option value="sensor">Sensor (Tekst/Liczba)</option>
                        <option value="cover">Roleta/Brama</option>
                        <option value="navigate">Nawigacja</option>
                        <option value="script">Skrypt/Przycisk</option>
                    </select>
                </div>
                <div class="flex-col">
                    <label>Nazwa na ekranie</label>
                    <input type="text" id="new-widget-name" placeholder="np. Kuchnia">
                </div>
            </div>
            <div class="flex-row" style="margin-top: 10px;">
                <div class="flex-col">
                    <label>Ikona (MDI) <a href="https://pictogrammers.com/library/mdi/" target="_blank">(Lista ikon)</a></label>
                    <input type="text" id="new-widget-icon" placeholder="np. mdi-lightbulb">
                    <div class="hint">Wpisz nazwę z przedrostkiem mdi-</div>
                </div>
                <div class="flex-col">
                    <button type="button" class="btn btn-add" onclick="addWidgetToStaging()">Dodaj do wybranego wiersza</button>
                </div>
            </div>
        </div>

        <form method="POST" id="main-form">
            <div class="section">
                <h3>Układ Dashboardu (Layout)</h3>
                <p>Dodawaj wiersze, a następnie wybierz wiersz i kliknij "Dodaj do wybranego wiersza" w panelu powyżej.</p>
                
                <div id="rows-container"></div>
                
                <button type="button" class="btn btn-row" onclick="addNewRow()">+ Dodaj Nowy Wiersz</button>
            </div>

            <div class="section">
                <label>Tytuł Dashboardu</label>
                <input type="text" name="title" value="JoanDashboard">
            </div>

            <!-- Ukryte pole przesyłające JSON -->
            <input type="hidden" name="layout_data_json" id="layout_data_json">
            
            <button type="button" class="btn btn-primary" onclick="submitForm()">GENERUJ KOD .DASH</button>
        </form>

        {% if generated_yaml %}
        <div class="section">
            <h3>Twój kod:</h3>
            <textarea class="output" readonly>{{ generated_yaml }}</textarea>
        </div>
        {% endif %}
    </div>

    <script>
        let rows = [];
        let activeRowIndex = 0;

        function addNewRow() {
            rows.push([]);
            renderRows();
            activeRowIndex = rows.length - 1; // Auto select new row
            highlightActiveRow();
        }

        function renderRows() {
            const container = document.getElementById('rows-container');
            container.innerHTML = '';
            
            rows.forEach((rowWidgets, index) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'dashboard-row';
                rowDiv.id = 'row-' + index;
                rowDiv.onclick = () => { activeRowIndex = index; highlightActiveRow(); };
                
                // Label
                const label = document.createElement('span');
                label.className = 'row-label';
                label.innerText = `Wiersz ${index + 1}:`;
                rowDiv.appendChild(label);

                // Widgets
                rowWidgets.forEach((widget, wIndex) => {
                    const wCard = document.createElement('div');
                    wCard.className = 'widget-card';
                    wCard.innerHTML = `<span>${widget.name}</span> <small>(${widget.type})</small> <span class="btn-del-widget" onclick="removeWidget(${index}, ${wIndex}); event.stopPropagation();">x</span>`;
                    rowDiv.appendChild(wCard);
                });

                // Remove Row Button
                if(rows.length > 1) {
                    const btnRem = d
