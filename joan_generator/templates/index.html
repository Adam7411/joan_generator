<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joan Dashboard Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #e0e0e0; padding: 20px; color: #333; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #d32f2f; margin-bottom: 30px; }
        .section { margin-bottom: 30px; border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: #fafafa; }
        label { display: block; margin-top: 10px; font-weight: bold; font-size: 0.9em; }
        input, select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        .dashboard-row { 
            background: #fff; border: 1px dashed #999; padding: 10px; margin-bottom: 10px; 
            display: flex; gap: 10px; flex-wrap: wrap; align-items: center; min-height: 60px;
            border-radius: 4px; cursor: pointer;
        }
        .row-label { font-weight: bold; margin-right: 10px; color: #d32f2f; }
        
        .widget-card {
            background: #333; color: #fff; padding: 5px 10px; border-radius: 4px; font-size: 0.85em;
            display: flex; align-items: center; gap: 5px; border: 1px solid transparent;
        }
        .btn-del-widget { color: #ff5252; cursor: pointer; font-weight: bold; margin-left: 5px; }

        .add-widget-box { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #2196f3; }
        .flex-row { display: flex; gap: 15px; align-items: flex-end; }
        .flex-col { flex: 1; }

        .btn { padding: 10px 20px; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; text-transform: uppercase; }
        .btn-primary { background-color: #d32f2f; color: white; width: 100%; font-size: 18px; margin-top: 20px; }
        .btn-add { background-color: #4caf50; color: white; }
        .btn-row { background-color: #2196f3; color: white; margin-top: 10px; }
        .btn-remove-row { background-color: #757575; color: white; font-size: 10px; padding: 5px; margin-left: auto; }
        
        textarea.output { width: 100%; height: 500px; font-family: monospace; background: #263238; color: #eceff1; border: none; padding: 15px; margin-top: 20px; border-radius: 4px; }
        .status-bar { padding: 10px; margin-bottom: 10px; border-radius: 4px; text-align: center; font-weight: bold; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Joan Dashboard Generator</h1>

        {% if entities %}
            <div class="status-bar" style="background: #d4edda; color: #155724; display: block;">
                ✓ Połączono z Home Assistant (Znaleziono {{ entities|length }} encji)
            </div>
        {% else %}
            <div class="status-bar" style="background: #f8d7da; color: #721c24; display: block;">
                ⚠ Brak połączenia z Home Assistant API (Lista encji pusta). <br>
                Odinstaluj i zainstaluj dodatek ponownie, aby nadać uprawnienia.
            </div>
        {% endif %}
        
        <div class="add-widget-box">
            <h4>Kreator Widgetu</h4>
            <div class="flex-row">
                <div class="flex-col" style="flex: 2;">
                    <label>Wybierz Encję</label>
                    <input list="entities-list" id="new-entity-id" placeholder="Zacznij pisać..." onchange="guessType()">
                    <datalist id="entities-list">
                        {% for entity in entities %}
                        <option value="{{ entity }}">
                        {% endfor %}
                    </datalist>
                </div>
                <div class="flex-col">
                    <label>Typ Widgetu</label>
                    <select id="new-widget-type">
                        <option value="switch">Przełącznik (Switch/Light)</option>
                        <option value="sensor">Sensor (Wartość)</option>
                        <option value="cover">Roleta/Brama</option>
                        <option value="navigate">Nawigacja</option>
                        <option value="script">Skrypt</option>
                    </select>
                </div>
                <div class="flex-col">
                    <label>Nazwa (Tytuł)</label>
                    <input type="text" id="new-widget-name" placeholder="np. Salon">
                </div>
            </div>
            <div class="flex-row" style="margin-top: 10px;">
                <div class="flex-col">
                    <label>Ikona (MDI)</label>
                    <input list="icons-list" id="new-widget-icon" placeholder="np. mdi-lightbulb">
                    <datalist id="icons-list"></datalist>
                </div>
                <div class="flex-col">
                    <button type="button" class="btn btn-add" onclick="addWidgetToStaging()">Dodaj do wiersza</button>
                </div>
            </div>
        </div>

        <form method="POST" id="main-form">
            <div class="section">
                <h3>Układ (Kliknij na wiersz, aby go wybrać)</h3>
                <div id="rows-container"></div>
                <button type="button" class="btn btn-row" onclick="addNewRow()">+ Dodaj Wiersz</button>
            </div>

            <div class="section">
                <label>Tytuł pliku .dash</label>
                <input type="text" name="title" value="JoanDashboard">
            </div>

            <input type="hidden" name="layout_data_json" id="layout_data_json">
            <button type="button" class="btn btn-primary" onclick="submitForm()">GENERUJ KOD</button>
        </form>

        {% if generated_yaml %}
        <div class="section">
            <h3>Wynikowy kod YAML:</h3>
            <textarea class="output" readonly>{{ generated_yaml }}</textarea>
        </div>
        {% endif %}
    </div>

    <script>
        let rows = [];
        let activeRowIndex = 0;

        async function fetchIcons() {
            const dataList = document.getElementById('icons-list');
            try {
                const response = await fetch('https://raw.githubusercontent.com/Templarian/MaterialDesign/master/meta.json');
                const icons = await response.json();
                dataList.innerHTML = '';
                icons.forEach(i => {
                    const opt = document.createElement('option');
                    opt.value = 'mdi-' + i.name;
                    dataList.appendChild(opt);
                });
            } catch (e) { console.log("Błąd ikon"); }
        }
        fetchIcons();

        function addNewRow() { rows.push([]); renderRows(); activeRowIndex = rows.length - 1; highlightActiveRow(); }

        function renderRows() {
            const container = document.getElementById('rows-container');
            container.innerHTML = '';
            rows.forEach((rowWidgets, index) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'dashboard-row';
                rowDiv.id = 'row-' + index;
                rowDiv.onclick = () => { activeRowIndex = index; highlightActiveRow(); };
                
                const label = document.createElement('span');
                label.className = 'row-label';
                label.innerText = `Wiersz ${index + 1}:`;
                rowDiv.appendChild(label);

                rowWidgets.forEach((widget, wIndex) => {
                    const wCard = document.createElement('div');
                    wCard.className = 'widget-card';
                    wCard.innerHTML = `<span style="font-size:16px;">${widget.icon ? '<i class="mdi '+widget.icon+'"></i> ' : ''}</span> <span>${widget.name}</span> <span class="btn-del-widget" onclick="removeWidget(${index}, ${wIndex}); event.stopPropagation();">x</span>`;
                    rowDiv.appendChild(wCard);
                });

                if(rows.length > 1) {
                    const btnRem = document.createElement('button');
                    btnRem.className = 'btn btn-remove-row';
                    btnRem.innerText = 'USUŃ';
                    btnRem.onclick = (e) => { e.stopPropagation(); deleteRow(index); };
                    rowDiv.appendChild(btnRem);
                }
                container.appendChild(rowDiv);
            });
            highlightActiveRow();
        }

        function highlightActiveRow() {
            document.querySelectorAll('.dashboard-row').forEach(el => el.style.borderColor = '#999');
            const active = document.getElementById('row-' + activeRowIndex);
            if(active) active.style.borderColor = '#2196f3';
        }

        function addWidgetToStaging() {
            const id = document.getElementById('new-entity-id').value;
            const type = document.getElementById('new-widget-type').value;
            const name = document.getElementById('new-widget-name').value;
            let icon = document.getElementById('new-widget-icon').value;

            if(!id) { alert("Musisz wybrać encję!"); return; }
            if(icon && !icon.startsWith('mdi-')) icon = 'mdi-' + icon;

            if (rows.length === 0) addNewRow();
            rows[activeRowIndex].push({ id, type, name: name || id, icon });
            renderRows();
            
            document.getElementById('new-entity-id').value = '';
            document.getElementById('new-widget-name').value = '';
            document.getElementById('new-widget-icon').value = '';
        }

        function removeWidget(r, w) { rows[r].splice(w, 1); renderRows(); }
        function deleteRow(i) { rows.splice(i, 1); if(activeRowIndex >= rows.length) activeRowIndex = rows.length - 1; renderRows(); }
        function submitForm() {
            document.getElementById('layout_data_json').value = JSON.stringify(rows);
            document.getElementById('main-form').submit();
        }
        function guessType() {
            const id = document.getElementById('new-entity-id').value;
            const typeSelect = document.getElementById('new-widget-type');
            if(id.startsWith('sensor.')) typeSelect.value = 'sensor';
            else if(id.startsWith('cover.')) typeSelect.value = 'cover';
            else if(id.startsWith('light.') || id.startsWith('switch.')) typeSelect.value = 'switch';
            else if(id.startsWith('navigate.')) typeSelect.value = 'navigate';
        }
        if(rows.length === 0) addNewRow();
    </script>
</body>
</html>
