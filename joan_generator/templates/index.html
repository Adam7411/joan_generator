<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Joan 6 E-Ink Generator</title>
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color:#e0e0e0; --container-bg:#ffffff; --text-color:#333; --border-color:#ddd; --accent-color:#d32f2f;
      --input-bg:#fff; --section-bg:#fafafa; --preview-bg:#f0f0f0; --link-bg:#ffffff; --link-color:#0056b3; --link-border:#bee5eb;
    }
    body.dark-mode {
      --bg-color:#121212; --container-bg:#1e1e1e; --text-color:#e0e0e0; --border-color:#333; --accent-color:#ff5252;
      --input-bg:#2c2c2c; --section-bg:#252525; --preview-bg:#121212; --link-bg:#1e1e1e; --link-color:#80d8ff; --link-border:#37474f;
    }
    body{font-family:'Roboto',sans-serif;background:var(--bg-color);color:var(--text-color);padding:20px;transition:.3s;}
    .container{max-width:1250px;margin:0 auto;background:var(--container-bg);padding:25px;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,.1);transition:.3s;}
    .header-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;border-bottom:2px solid var(--border-color);padding-bottom:15px;}
    h1{color:var(--accent-color);margin:0;font-size:24px;font-weight:900;}
    .controls{display:flex;gap:10px;}
    .controls button{padding:8px 14px;border:1px solid var(--border-color);background:var(--section-bg);color:var(--text-color);cursor:pointer;border-radius:6px;font-weight:700;}
    .controls button.active{background:var(--accent-color);color:#fff;border-color:var(--accent-color);}
    .status-bar{padding:10px;border-radius:6px;font-weight:700;margin-bottom:20px;}
    .section{margin-bottom:28px;padding:20px;border:1px solid var(--border-color);border-radius:10px;background:var(--section-bg);}
    .section-title{font-weight:900;font-size:1.15em;margin:0 0 15px;padding:0 0 6px;border-bottom:2px solid var(--accent-color);}
    .import-box{display:none}
    .import-box.visible{display:block}
    label{display:block;font-size:.85em;font-weight:700;margin:10px 0 6px;}
    input,select,textarea{width:100%;padding:10px;border:1px solid var(--border-color);border-radius:6px;background:var(--input-bg);color:var(--text-color);font-family:inherit;font-size:.95em;}
    textarea.output{min-height:520px;font-family:monospace;background:#263238;color:#eceff1;border:none;resize:vertical;border-radius:6px;padding:14px;}
    .add-widget-box{background:#e3f2fd;border:1px solid #2196f3;border-radius:10px;padding:16px;transition:.3s;}
    body.dark-mode .add-widget-box{background:#0d47a1;border-color:#1565c0;}
    .add-widget-box.editing{background:#fff8e1;border-color:#ffc107;}
    body.dark-mode .add-widget-box.editing{background:#3e2723;border-color:#ffb300;}
    .flex-row{display:flex;flex-wrap:wrap;gap:16px;align-items:flex-end;}
    .flex-col{flex:1;min-width:170px}
    .icon-preview-box{width:46px;height:46px;border:1px solid #bbb;border-radius:8px;display:flex;align-items:center;justify-content:center;background:#fff;font-size:26px;}
    .btn{padding:10px 18px;border:none;border-radius:6px;font-weight:700;cursor:pointer;letter-spacing:.5px;}
    .btn-primary{background:var(--accent-color);color:#fff;width:100%;font-size:18px;margin-top:10px;}
    .btn-add{background:#4caf50;color:#fff;}
    .btn-cancel{background:#9e9e9e;color:#fff;}
    .btn-row{background:#2196f3;color:#fff;margin-top:10px;}
    .btn-import{background:#ff9800;color:#fff;margin-bottom:10px;}
    .btn-remove-row{background:#757575;color:#fff;font-size:11px;padding:4px 8px;border-radius:4px;position:absolute;right:6px;top:6px;z-index:30;}
    .preview-area{background:var(--preview-bg);border:2px solid var(--border-color);border-radius:10px;min-height:240px;padding:20px;overflow-x:auto;}
    .eink-row{display:flex;gap:10px;margin-bottom:12px;padding:14px 10px;border:2px dashed #999;border-radius:8px;position:relative;transition:.2s;cursor:pointer;}
    .eink-row.active{border-color:#2196f3;background:rgba(33,150,243,.12);}
    .eink-row:hover{border-color:#2196f3;}
    .eink-widget{background:#fff;border:2px solid #000;color:#000;border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:space-between;padding:6px 4px;min-width:120px;min-height:108px;position:relative;box-shadow:2px 2px 5px rgba(0,0,0,.15);transition:.15s;}
    .eink-widget.being-edited{border:3px solid #ff9800;transform:scale(1.03);z-index:5;}
    .eink-widget:hover{transform:translateY(-2px);box-shadow:4px 4px 8px rgba(0,0,0,.25);}
    .ew-title{font-size:12px;font-weight:700;line-height:1.2;text-align:center;width:100%;padding:0 4px;min-height:30px;display:flex;align-items:center;justify-content:center;}
    .ew-icon{font-size:30px;margin:6px 0;}
    .ew-state{font-size:11px;font-weight:700;text-transform:uppercase;min-height:18px;display:flex;align-items:center;}
    .ew-delete{position:absolute;top:4px;right:4px;background:#d50000;color:#fff;width:20px;height:20px;font-size:11px;border-radius:4px;display:none;align-items:center;justify-content:center;cursor:pointer;}
    .eink-widget:hover .ew-delete{display:flex;}
    .file-path-info{background:#d1ecf1;border:1px solid #bee5eb;color:#0c5460;padding:18px;border-radius:8px;font-size:.9em;line-height:1.55;font-family:monospace;}
    body.dark-mode .file-path-info{background:#263238;border-color:#37474f;color:#eceff1;}
    .file-path-info code{display:block;background:rgba(255,255,255,.6);padding:6px 10px;border-radius:6px;font-weight:700;word-break:break-all;color:#d63384;margin-top:4px;}
    body.dark-mode .file-path-info code{background:rgba(0,0,0,.35);color:#f48fb1;}
    .dashboard-link-btn{background:var(--link-bg);border:2px solid var(--link-border);color:var(--link-color);text-decoration:none;padding:10px 14px;border-radius:6px;display:block;margin-top:10px;font-weight:700;transition:.2s;}
    .dashboard-link-btn:hover{background:#f0f0f0;}
    body.dark-mode .dashboard-link-btn:hover{background:#444;}
    .hidden{display:none!important;}
  </style>
</head>
<body>
  <div class="container">
    <div class="header-row">
      <h1>Joan 6 E-Ink Generator</h1>
      <div class="controls">
        <button id="btn-theme" title="Theme">üåô</button>
        <button id="btn-pl" class="active">PL</button>
        <button id="btn-en">EN</button>
      </div>
    </div>

    {% if entities %}
      <div class="status-bar" style="background:#d4edda;color:#155724;">
        <span data-i18n="status_ok">‚úì Po≈ÇƒÖczono z Home Assistant</span> ({{ entities|length }})
      </div>
    {% else %}
      <div class="status-bar" style="background:#f8d7da;color:#721c24;">
        <span data-i18n="status_error">‚ö† Brak po≈ÇƒÖczenia z API. Sprawd≈∫ token.</span>
      </div>
    {% endif %}

    <button type="button" class="btn btn-import" id="btn-toggle-import"><span data-i18n="btn_import_toggle">üìÇ Importuj / Edytuj Kod</span></button>
    <div id="import-area" class="section import-box">
      <h4 data-i18n="header_paste_code" style="margin-top:0;">Wklej kod pliku .dash tutaj:</h4>
      <textarea id="import-code" style="height:150px" placeholder="title: Joan2&#10;layout:&#10;  - sensor.temp, switch.light ..."></textarea>
      <button type="button" class="btn btn-add" id="btn-import"><span data-i18n="btn_load_dash">Wczytaj Dashboard</span></button>
    </div>

    <form id="main-form" onsubmit="prepareAndSubmit(event)">
      <input type="hidden" name="ui_language" id="ui_language" value="pl">
      <input type="hidden" name="ui_theme" id="ui_theme" value="light">
      <input type="hidden" name="layout_data_json" id="layout_data_json">
      <input type="hidden" name="widgets_full_json" id="widgets_full_json">
      <input type="hidden" name="generated_yaml_client" id="generated_yaml_client">

      <div class="section">
        <div class="section-title" data-i18n="sec_settings">1. Ustawienia</div>
        <div class="flex-row">
          <div class="flex-col">
            <label data-i18n="dash_title">Tytu≈Ç Dashboardu (Nazwa pliku)</label>
            <input type="text" id="dash-title" value="Joan2">
          </div>
        </div>
      </div>

      <div class="add-widget-box" id="widget-form-box">
        <h4 id="form-header" data-i18n="sec_add" style="margin-top:0;">2. Dodaj / Edytuj Widget</h4>
        <div class="flex-row">
          <div class="flex-col">
            <label data-i18n="label_type">Typ Widgetu</label>
            <select id="new-widget-type">
              <option value="switch">Switch / Light</option>
              <option value="sensor">Sensor</option>
              <option value="binary_sensor">Binary Sensor</option>
              <option value="cover">Cover / Gate</option>
              <option value="media_player">Media Player</option>
              <option value="climate">Climate</option>
              <option value="script">Script</option>
              <option value="navigate">Navigate</option>
              <option value="fan">Fan</option>
              <option value="label">Label</option>
            </select>
          </div>
          <div class="flex-col" id="group-entity">
            <label data-i18n="label_entity">Wybierz Encjƒô (Home Assistant)</label>
            <input list="entities-list" id="new-entity-id" placeholder="np. light.salon" autocomplete="off">
            <datalist id="entities-list">
              {% for entity in entities %}
              <option value="{{ entity.id }}">{{ entity.id }}</option>
              {% endfor %}
            </datalist>
          </div>
          <div class="flex-col hidden" id="group-nav">
            <label data-i18n="label_dashboard">Nazwa pliku dashboardu</label>
            <input id="new-dashboard-name" placeholder="np. joan3">
          </div>
          <div class="flex-col">
            <label data-i18n="label_name">Tytu≈Ç na ekranie</label>
            <input id="new-widget-name" placeholder="Automatycznie">
          </div>
        </div>
        <div class="flex-row" style="align-items:flex-end;margin-top:10px;">
          <div class="flex-col" style="max-width:150px;">
            <label data-i18n="label_size">Rozmiar</label>
            <select id="new-widget-size">
              <option value="">Domy≈õlny (2x1)</option>
              <option value="(1x1)">1x1</option>
              <option value="(2x1)">2x1</option>
              <option value="(2x2)">2x2</option>
              <option value="(3x1)">3x1</option>
              <option value="(1x2)">1x2</option>
              <option value="(3x2)">3x2</option>
            </select>
          </div>
          <div style="width:56px;">
            <label data-i18n="label_preview">PodglƒÖd</label>
            <div class="icon-preview-box"><i id="icon-preview-i" class="mdi mdi-help-circle-outline"></i></div>
          </div>
          <div class="flex-col">
            <label data-i18n="label_icon">Ikona</label>
            <input id="new-widget-icon" list="icons-list" placeholder="np. mdi-lightbulb">
          </div>
          <div class="flex-col" style="display:flex;gap:10px;align-items:flex-end;">
            <button type="button" id="btn-action" class="btn btn-add"><span data-i18n="btn_add">+ DODAJ DO WIERSZA</span></button>
            <button type="button" id="btn-cancel" class="btn btn-cancel hidden"><span data-i18n="btn_cancel">Anuluj</span></button>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title" data-i18n="sec_preview">3. PodglƒÖd Dashboardu (Kliknij, aby edytowaƒá)</div>
        <div id="rows-container" class="preview-area"></div>
        <button type="button" class="btn btn-row" id="btn-new-row"><span data-i18n="btn_new_row">+ Dodaj Nowy Wiersz</span></button>
      </div>

      <button class="btn btn-primary" type="submit"><span data-i18n="btn_generate">GENERUJ KOD .DASH</span></button>
    </form>

    <div class="section hidden" id="client-yaml-section">
      <h3 data-i18n="sec_code">Tw√≥j kod YAML (Klient):</h3>
      <div class="file-path-info">
        <strong data-i18n="info_step1">1. Zapisz kod w pliku:</strong>
        <code id="client-path-code">\\IP_HA\addon_configs\appdaemon\dashboards\joan2.dash</code>
        <strong data-i18n="info_step2">2. PodglƒÖd dashboardu:</strong>
        <a id="client-dashboard-link" class="dashboard-link-btn" target="_blank" href="http://IP_HA:5050/joan2">http://IP_HA:5050/joan2</a>
      </div>
      <textarea id="client-yaml-output" class="output" readonly></textarea>
    </div>
  </div>

  <script>
    const entitiesData = {{ entities | tojson }};
    let currentLang='pl', rows=[], activeRowIndex=0, editingIndices=null, importedDefsMap={};

    const i18n={pl:{status_ok:"‚úì Po≈ÇƒÖczono z Home Assistant",status_error:"‚ö† Brak po≈ÇƒÖczenia z API. Sprawd≈∫ token.",sec_settings:"1. Ustawienia",sec_add:"2. Dodaj / Edytuj Widget",sec_preview:"3. PodglƒÖd Dashboardu (Kliknij, aby edytowaƒá)",sec_code:"Tw√≥j kod YAML (Klient):",dash_title:"Tytu≈Ç Dashboardu (Nazwa pliku)",label_entity:"Wybierz Encjƒô (Home Assistant)",label_dashboard:"Nazwa pliku dashboardu (np. joan3)",label_type:"Typ Widgetu",label_name:"Tytu≈Ç na ekranie",label_icon:"Ikona",label_preview:"PodglƒÖd",label_size:"Rozmiar",btn_add:"+ DODAJ DO WIERSZA",btn_update:"ZAPISZ ZMIANY",btn_cancel:"Anuluj",btn_new_row:"+ Dodaj Nowy Wiersz",btn_generate:"GENERUJ KOD .DASH",btn_import_toggle:"üìÇ Importuj / Edytuj Kod",header_paste_code:"Wklej kod pliku .dash tutaj:",btn_load_dash:"Wczytaj Dashboard",info_step1:"1. Zapisz kod w pliku:",info_step2:"2. PodglƒÖd dashboardu:",state_on:"W≈ÅƒÑCZONE",state_off:"WY≈ÅƒÑCZONE",state_open:"OTWARTA",state_closed:"ZAMKNIƒòTA"},en:{status_ok:"‚úì Connected to Home Assistant",status_error:"‚ö† No API Connection. Check Token.",sec_settings:"1. Settings",sec_add:"2. Add / Edit Widget",sec_preview:"3. Dashboard Preview (Click to Edit)",sec_code:"Your YAML Code (Client):",dash_title:"Dashboard Title (Filename)",label_entity:"Select Entity (Home Assistant)",label_dashboard:"Dashboard filename (e.g. joan3)",label_type:"Widget Type",label_name:"Title on Screen",label_icon:"Icon",label_preview:"Preview",label_size:"Size",btn_add:"+ ADD TO ROW",btn_update:"SAVE CHANGES",btn_cancel:"Cancel",btn_new_row:"+ Add New Row",btn_generate:"GENERATE .DASH CODE",btn_import_toggle:"üìÇ Import / Edit Code",header_paste_code:"Paste .dash file here:",btn_load_dash:"Load Dashboard",info_step1:"1. Save code to file:",info_step2:"2. Dashboard preview:",state_on:"ON",state_off:"OFF",state_open:"OPEN",state_closed:"CLOSED"}};

    function formatNameFromId(id){ if(!id) return ""; const last=id.includes('.')?id.split('.').pop():id; return last.replace(/_/g,' ').replace(/\b\w/g,l=>l.toUpperCase()); }
    function ensureMdi(icon){ if(!icon) return ""; return icon.startsWith('mdi-')?icon:'mdi-'+icon; }

    function toggleTheme(){ const toDark=!document.body.classList.contains('dark-mode'); document.body.classList.toggle('dark-mode',toDark); document.getElementById('ui_theme').value=toDark?'dark':'light'; document.getElementById('btn-theme').innerText=toDark?'‚òÄÔ∏è':'üåô'; localStorage.setItem('joan_theme',toDark?'dark':'light'); }
    function setLang(lang){ currentLang=lang; localStorage.setItem('joan_lang',lang); document.getElementById('ui_language').value=lang; document.getElementById('btn-pl').classList.toggle('active',lang==='pl'); document.getElementById('btn-en').classList.toggle('active',lang==='en'); applyTranslations(); renderRows(); }
    function applyTranslations(){ const t=i18n[currentLang]; document.querySelectorAll('[data-i18n]').forEach(el=>{const k=el.getAttribute('data-i18n'); if(t[k]) el.innerText=t[k];}); const act=document.getElementById('btn-action').querySelector('span'); act.innerText=editingIndices?i18n[currentLang].btn_update:`${i18n[currentLang].btn_add} (${currentLang==='pl'?'Wiersz':'Row'} ${activeRowIndex+1})`; document.getElementById('form-header').innerText=editingIndices?i18n[currentLang].btn_update:i18n[currentLang].sec_add; }

    function iconPairFor(id){
      const v=id.toLowerCase();
      if(v.startsWith('light.')||v.includes('swiatlo')||v.includes('light')) return ['mdi-lightbulb-on','mdi-lightbulb-outline'];
      if(v.startsWith('cover.')||v.includes('roleta')||v.includes('blind')||v.includes('brama')||v.includes('gate')||v.includes('window')) return ['mdi-window-shutter-open','mdi-window-shutter'];
      if(v.includes('garaz')||v.includes('garage')) return ['mdi-garage-open','mdi-garage'];
      if(v.includes('radiator')||v.includes('grzejnik')||v.includes('ogrzew')) return ['mdi-radiator','mdi-radiator-off'];
      if(v.includes('cwu')||v.includes('woda')||v.includes('water')) return ['mdi-water-outline','mdi-water-off'];
      if(v.startsWith('fan.')||v.includes('wentyl')) return ['mdi-fan','mdi-fan-off'];
      if(v.startsWith('media_player.')) return ['mdi-speaker','mdi-speaker-off'];
      if(v.startsWith('climate.')) return ['mdi-thermometer','mdi-thermometer-off'];
      return ['mdi-toggle-switch','mdi-toggle-switch-off'];
    }
    function autoBaseIcon(type,id){
      const v=id.toLowerCase();
      const map=[
        {k:['hydrofor','tank','zbiornik'],i:'mdi-water-pump'},
        {k:['cwu','woda','water'],i:'mdi-water-outline'},
        {k:['ogrzew','grzejnik','radiator'],i:'mdi-radiator'},
        {k:['brama','gate'],i:'mdi-gate'},
        {k:['garaz','garage'],i:'mdi-garage'},
        {k:['wilgotn','humid'],i:'mdi-water-percent'},
        {k:['temp','temperatur','temperature'],i:'mdi-thermometer'},
        {k:['bateria','battery'],i:'mdi-battery'},
        {k:['swiatlo','light','bulb'],i:'mdi-lightbulb'},
        {k:['speaker','radio','media_player'],i:'mdi-speaker'},
        {k:['klima','climate','hvac'],i:'mdi-home-thermometer'},
        {k:['sensor','czujnik'],i:'mdi-gauge'},
        {k:['fan','wentyl'],i:'mdi-fan'}
      ];
      for(const m of map) if(m.k.some(kw=>v.includes(kw))) return m.i;
      const fallback={switch:'mdi-toggle-switch',binary_sensor:'mdi-alert-circle-outline',sensor:'mdi-gauge',cover:'mdi-window-shutter',media_player:'mdi-speaker',climate:'mdi-thermometer',script:'mdi-script-text-outline',navigate:'mdi-arrow-right-circle',fan:'mdi-fan',label:'mdi-label-outline'};
      return fallback[type]||'mdi-help-circle-outline';
    }
    function getLiveStateText(ent,type){
      if(!ent) return '';
      const raw=String(ent.state).toLowerCase();
      const t=i18n[currentLang];
      if(type==='sensor'){
        let val=ent.state;
        if(!isNaN(parseFloat(val)) && String(val).includes('.')) val=parseFloat(val).toFixed(1);
        return ent.unit?`${val} ${ent.unit}`:val;
      }
      if(type==='cover'){
        if(raw==='open') return t.state_open;
        if(raw==='closed') return t.state_closed;
        return raw.toUpperCase();
      }
      if(['switch','binary_sensor','script','media_player','climate','fan','light'].includes(type) || ent.id.startsWith('input_boolean.')){
        if(['on','playing','open','unlocked','heat','cool','true','1'].includes(raw)) return t.state_on;
        if(['off','closed','locked','idle','stopped','standby','false','0'].includes(raw)) return t.state_off;
        return raw.toUpperCase();
      }
      return '';
    }
    function pickPreviewIcon(widget){
      const ent=entitiesData.find(e=>e.id===widget.id);
      const actionable=['switch','binary_sensor','cover','media_player','climate','script','fan','light'].includes(widget.type) || widget.id.startsWith('input_boolean.');
      if(actionable){
        const pair=iconPairFor(widget.id);
        const state=ent?String(ent.state).toLowerCase():'off';
        const isOn=['on','open','playing','unlocked','heat','cool','true','1','opening'].includes(state);
        return ensureMdi(isOn?(widget.icon_on||pair[0]):(widget.icon_off||pair[1]));
      }
      return ensureMdi(widget.icon||autoBaseIcon(widget.type,widget.id));
    }

    function toggleImport(){document.getElementById('import-area').classList.toggle('visible');}
    function importYaml(){
      const code=document.getElementById('import-code').value; if(!code) return;
      try{
        const lines=code.split('\n');
        let parsingLayout=false,currentKey=null,globalTitleSet=false;
        const layoutLines=[]; const defs={};
        const ignore=['global_parameters','widget_dimensions','widget_size','widget_margins','columns','rows','skin'];

        for(const raw of lines){
          const cut=raw.split('#')[0]; const line=(cut||'').trim(); if(!line) continue;
          if(!parsingLayout && /^title\s*:/i.test(line) && !globalTitleSet){
            const val=line.split(':').slice(1).join(':').trim().replace(/^["']|["']$/g,'');
            if(val) document.getElementById('dash-title').value=val; globalTitleSet=true; continue;
          }
          if(/^layout\s*:/i.test(line)){ parsingLayout=true; continue; }
          if(parsingLayout){
            if(line.startsWith('-')){ layoutLines.push(line); continue; }
            if(/^[A-Za-z0-9_.-]+\s*:/i.test(line)){ parsingLayout=false; }
          }
          const root=line.match(/^([A-Za-z0-9_.-]+)\s*:/);
          if(root){
            const key=root[1];
            if(!ignore.includes(key)){ currentKey=key; defs[key]=defs[key]||{}; } else currentKey=null;
            continue;
          }
          if(currentKey && line.includes(':')){
            const k=line.split(':')[0].trim();
            let v=line.substring(line.indexOf(':')+1).trim().replace(/^["']|["']$/g,'');
            defs[currentKey][k]=v;
          }
        }

        importedDefsMap={};
        Object.entries(defs).forEach(([k,v])=>{ importedDefsMap[k]=v; if(v.entity) importedDefsMap[v.entity]=v; });

        rows=[];
        layoutLines.forEach(l=>{
          const content=l.replace(/^-+\s*/,'').trim();
          const items=content.split(',').map(x=>x.trim()).filter(Boolean);
          const rowWidgets=[];
          items.forEach(item=>{
            const sizeMatch=item.match(/\(\d+x\d+\)/); const size=sizeMatch?sizeMatch[0]:'';
            const id=item.replace(size,'').trim();
            const def=importedDefsMap[id]||importedDefsMap[id.split('.').pop()]||{};
            // type detect
            let type=def.widget_type;
            if(!type){
              const lower=id.toLowerCase();
              if(lower.startsWith('sensor.')) type='sensor';
              else if(lower.startsWith('binary_sensor.')) type='binary_sensor';
              else if(lower.startsWith('cover.')) type='cover';
              else if(lower.startsWith('media_player.')) type='media_player';
              else if(lower.startsWith('climate.')) type='climate';
              else if(lower.startsWith('fan.')) type='fan';
              else if(lower.startsWith('script.')) type='script';
              else if(lower.startsWith('navigate.')) type='navigate';
              else type='switch';
            }
            // CRITICAL: preserve title from file
            let name = def.title ? def.title : formatNameFromId(id);

            // icons: keep from file; else smart
            let icon = ensureMdi(def.icon||def.icon_inactive||'');
            let icon_on = ensureMdi(def.icon_on||def.icon_active||'');
            let icon_off = ensureMdi(def.icon_off||def.icon_inactive||'');

            const actionable=['switch','binary_sensor','cover','media_player','climate','script','fan','light'].includes(type) || id.startsWith('input_boolean.');
            if(actionable){
              const pair=iconPairFor(id);
              if(!icon_on) icon_on=ensureMdi(pair[0]);
              if(!icon_off) icon_off=ensureMdi(pair[1]);
              // optional base icon not used in preview for actionable
            }else{
              if(!icon) icon=ensureMdi(autoBaseIcon(type,id));
              icon_on=''; icon_off='';
            }

            rowWidgets.push({id,type,name,icon,icon_on,icon_off,size});
          });
          if(rowWidgets.length) rows.push(rowWidgets);
        });

        if(!rows.length){ alert(currentLang==='pl'?'Brak layout w imporcie':'No layout found'); return; }
        activeRowIndex=rows.length-1; renderRows(); applyTranslations(); toggleImport();
        alert(currentLang==='pl'?'Import zako≈Ñczony':'Import completed');
      }catch(e){ alert((currentLang==='pl'?'B≈ÇƒÖd importu: ':'Import error: ')+e.message); }
    }

    function autoFillForm(){
      const typeSel=document.getElementById('new-widget-type');
      const entityInput=document.getElementById('new-entity-id');
      const nameInput=document.getElementById('new-widget-name');
      const iconInput=document.getElementById('new-widget-icon');
      const navName=document.getElementById('new-dashboard-name');
      const groupEntity=document.getElementById('group-entity');
      const groupNav=document.getElementById('group-nav');
      const sizeInput=document.getElementById('new-widget-size');
      let id=(entityInput.value||'').trim();

      if(typeSel.value==='navigate'){
        groupEntity.classList.add('hidden'); groupNav.classList.remove('hidden');
        if(!iconInput.value) iconInput.value='mdi-arrow-right-circle';
        if(!navName.value && id) navName.value=id;
        updateIconPreview(); return;
      }else{
        groupEntity.classList.remove('hidden'); groupNav.classList.add('hidden');
      }

      if(!id){ updateIconPreview(); return; }

      const lower=id.toLowerCase();
      if(lower.startsWith('sensor.')) typeSel.value='sensor';
      else if(lower.startsWith('binary_sensor.')) typeSel.value='binary_sensor';
      else if(lower.startsWith('cover.')) typeSel.value='cover';
      else if(lower.startsWith('media_player.')) typeSel.value='media_player';
      else if(lower.startsWith('climate.')) typeSel.value='climate';
      else if(lower.startsWith('fan.')) typeSel.value='fan';
      else if(lower.startsWith('script.')) typeSel.value='script';
      else typeSel.value='switch';

      if((typeSel.value==='media_player'||typeSel.value==='climate') && !sizeInput.value) sizeInput.value='(2x2)';

      // SMART: only set name if empty (do not override imported names)
      if(!nameInput.value.trim()) nameInput.value=formatNameFromId(id);

      const actionable=['switch','binary_sensor','cover','media_player','climate','script','fan','light'].includes(typeSel.value) || lower.startsWith('input_boolean.');
      if(actionable){
        const pair=iconPairFor(id);
        if(!iconInput.value) iconInput.value=pair[0]; // preview ON icon
      }else{
        if(!iconInput.value) iconInput.value=autoBaseIcon(typeSel.value,id);
      }
      updateIconPreview();
    }

    function updateIconPreview(){
      const icon=document.getElementById('new-widget-icon').value.trim();
      document.getElementById('icon-preview-i').className=(icon && icon.startsWith('mdi-'))?'mdi '+icon:'mdi mdi-help-circle-outline';
    }

    function saveWidget(){
      const type=document.getElementById('new-widget-type').value;
      let id='';
      if(type==='navigate'){
        const dashName=document.getElementById('new-dashboard-name').value.trim();
        if(!dashName){ alert(currentLang==='pl'?'Wymagana nazwa dashboardu':'Dashboard name required'); return; }
        id='navigate.'+dashName;
      }else{
        id=document.getElementById('new-entity-id').value.trim();
        if(!id){ alert(currentLang==='pl'?'Wymagana encja':'Entity required'); return; }
      }
      let name=document.getElementById('new-widget-name').value.trim();
      if(!name) name=formatNameFromId(id);
      let icon=ensureMdi(document.getElementById('new-widget-icon').value.trim());
      const size=document.getElementById('new-widget-size').value;

      const actionable=['switch','binary_sensor','cover','media_player','climate','script','fan','light'].includes(type) || id.startsWith('input_boolean.');
      let icon_on='',icon_off='';
      if(actionable){
        const pair=iconPairFor(id);
        icon_on=ensureMdi(pair[0]); icon_off=ensureMdi(pair[1]);
      }else{
        if(!icon) icon=ensureMdi(autoBaseIcon(type,id));
      }

      const widget={id,type,name,icon,icon_on,icon_off,size};
      if(editingIndices){
        rows[editingIndices.r][editingIndices.w]=widget;
        editingIndices=null;
        document.getElementById('btn-cancel').classList.add('hidden');
        document.getElementById('widget-form-box').classList.remove('editing');
      }else{
        if(!rows.length) addNewRow();
        rows[activeRowIndex].push(widget);
      }
      clearFormInputs();
      renderRows(); applyTranslations();
    }

    function editWidget(r,w){
      editingIndices={r,w};
      const widget=rows[r][w];
      activeRowIndex=r;
      document.getElementById('new-widget-type').value=widget.type;
      if(widget.type==='navigate'){
        document.getElementById('new-dashboard-name').value=widget.id.replace('navigate.','');
        document.getElementById('new-entity-id').value='';
      }else{
        document.getElementById('new-dashboard-name').value='';
        document.getElementById('new-entity-id').value=widget.id;
      }
      document.getElementById('new-widget-name').value=widget.name; // keep imported name
      document.getElementById('new-widget-icon').value=widget.icon||widget.icon_on||widget.icon_off||'';
      document.getElementById('new-widget-size').value=widget.size||'';
      document.getElementById('btn-cancel').classList.remove('hidden');
      document.getElementById('widget-form-box').classList.add('editing');
      autoFillForm(); // fills missing only
      applyTranslations(); renderRows();
    }

    function cancelEdit(){
      editingIndices=null;
      document.getElementById('btn-cancel').classList.add('hidden');
      document.getElementById('widget-form-box').classList.remove('editing');
      clearFormInputs(); applyTranslations(); renderRows();
    }
    function clearFormInputs(){
      ['new-dashboard-name','new-entity-id','new-widget-name','new-widget-icon','new-widget-size'].forEach(id=>document.getElementById(id).value='');
      updateIconPreview();
    }

    function removeWidget(r,w){ if(editingIndices && editingIndices.r===r && editingIndices.w===w) cancelEdit(); rows[r].splice(w,1); renderRows(); }
    function addNewRow(){ rows.push([]); activeRowIndex=rows.length-1; renderRows(); applyTranslations(); }
    function deleteRow(rowIndex){ if(editingIndices && editingIndices.r===rowIndex) cancelEdit(); rows.splice(rowIndex,1); if(activeRowIndex>=rows.length) activeRowIndex=rows.length-1; renderRows(); applyTranslations(); }

    function highlightActiveRow(){ document.querySelectorAll('.eink-row').forEach(el=>el.classList.remove('active')); const act=document.getElementById('row-'+activeRowIndex); if(act) act.classList.add('active'); }

    function renderRows(){
      const container=document.getElementById('rows-container'); container.innerHTML='';
      rows.forEach((rowWidgets,index)=>{
        const rowDiv=document.createElement('div'); rowDiv.className='eink-row'; rowDiv.id='row-'+index;
        rowDiv.onclick=()=>{ if(editingIndices) cancelEdit(); activeRowIndex=index; highlightActiveRow(); applyTranslations(); };
        const label=document.createElement('div');
        label.style.position='absolute';label.style.top='-10px';label.style.left='5px';label.style.fontSize='10px';label.style.fontWeight='900';label.style.color='#666';
        label.textContent=(currentLang==='pl'?'WIERSZ ':'ROW ')+(index+1);
        rowDiv.appendChild(label);

        if(rows.length>1){
          const del=document.createElement('button'); del.className='btn-remove-row'; del.textContent=currentLang==='pl'?'USU≈É':'DELETE';
          del.onclick=(e)=>{e.stopPropagation(); deleteRow(index);}; rowDiv.appendChild(del);
        }

        rowWidgets.forEach((widget,wIndex)=>{
          const wDiv=document.createElement('div'); wDiv.className='eink-widget';
          if(editingIndices && editingIndices.r===index && editingIndices.w===wIndex) wDiv.classList.add('being-edited');

          let width=140,height=110;
          if(widget.size){
            const dims=widget.size.replace(/[()]/g,'').split('x'); const cols=parseInt(dims[0])||2; const rowsSpan=parseInt(dims[1])||1;
            width=(cols*70)+((cols-1)*6); height=(rowsSpan*90)+((rowsSpan-1)*6);
          }
          wDiv.style.width=width+'px'; wDiv.style.height=height+'px';
          wDiv.onclick=(e)=>{e.stopPropagation(); editWidget(index,wIndex);};

          const ent=entitiesData.find(e=>e.id===widget.id);
          const stateText=getLiveStateText(ent,widget.type);
          const iconClass=pickPreviewIcon(widget);

          wDiv.innerHTML=`
            <div class="ew-title">${widget.name}</div>
            <i class="mdi ${iconClass} ew-icon"></i>
            <div class="ew-state">${stateText||' '}</div>
            <div class="ew-delete" onclick="removeWidget(${index},${wIndex});event.stopPropagation();">X</div>
          `;
          rowDiv.appendChild(wDiv);
        });

        container.appendChild(rowDiv);
      });
      highlightActiveRow();
    }

    function buildHeader(title){
      return [
        "# --- JOAN 6 E-INK DASHBOARD ---",
        `# File: ${title.toLowerCase()}.dash`,
        "# Location: \\\\IP_HA\\addon_configs\\appdaemon\\dashboards\\",
        "# --------------------------------",
        "",
        `title: ${title}`,
        "widget_dimensions: [117, 117]",
        "widget_size: [2, 1]",
        "widget_margins: [8, 8]",
        "columns: 6",
        `rows: ${(rows.length||8)} # auto`,
        "global_parameters:",
        "  refresh: 0",
        "  use_comma: 0",
        "  precision: 1",
        "  use_hass_icon: 1",
        "  namespace: default",
        "  white_text_style: \"color: #000000 !important; font-weight: 700 !important;\"",
        "  state_text_style: \"color: #000000 !important; font-weight: 700 !important; font-size: 16px !important;\"",
        "skin: simplyred",
        "",
        "layout:"
      ].join("\n");
    }
    function buildLayout(){ return rows.map(r=>"  - "+r.map(w=>w.id+(w.size? " "+w.size:"")).join(", ")).join("\n"); }
    function widgetYaml(w){
      const t=i18n[currentLang]; const lines=[];
      lines.push(`${w.id}:`);
      lines.push(`  widget_type: ${w.type==='fan'?'switch':w.type}`);
      if(w.type==='navigate'){
        lines.push(`  title: "${w.name.replace(/"/g,'\\"')}"`);
        lines.push(`  dashboard: ${w.id.replace('navigate.','')}`);
        lines.push(`  icon_inactive: ${ensureMdi(w.icon||'mdi-arrow-right-circle')}`);
        lines.push(`  title_style: "color:#000; font-size:24px; font-weight:700; text-align:center; padding-top:5px; width:100%;"`);
        lines.push(`  widget_style: "background-color:#FFFFFF !important; border-radius:8px !important; padding:10px !important; color:#000 !important;"`);
        return lines.join("\n");
      }
      lines.push(`  entity: ${w.id}`);
      lines.push(`  title: "${w.name.replace(/"/g,'\\"')}"`);
      const actionable=['switch','binary_sensor','cover','media_player','climate','script','fan','light'].includes(w.type)||w.id.startsWith('input_boolean.');
      if(actionable){
        lines.push(`  icon_on: ${ensureMdi(w.icon_on||iconPairFor(w.id)[0])}`);
        lines.push(`  icon_off: ${ensureMdi(w.icon_off||iconPairFor(w.id)[1])}`);
        lines.push(`  state_text: 1`);
        lines.push(`  title_style: "color:#000; font-size:20px; font-weight:700; text-align:center; padding-top:3px; width:100%;"`);
        lines.push(`  text_style: "color:#000 !important; font-weight:700 !important;"`);
        lines.push(`  widget_style: "color:#000 !important; background-color:#FFFFFF !important; border:2px solid #000 !important;"`);
        lines.push(`  state_map:`);
        if(w.type==='cover'){
          lines.push(`    "open": "${t.state_open}"`);
          lines.push(`    "closed": "${t.state_closed}"`);
          lines.push(`    "opening": "${currentLang==='pl'?'OTWIERA':'OPENING'}"`);
          lines.push(`    "closing": "${currentLang==='pl'?'ZAMYKA':'CLOSING'}"`);
        }else{
          lines.push(`    "on": "${t.state_on}"`);
          lines.push(`    "off": "${t.state_off}"`);
        }
        lines.push(`  icon_style_active: "color:#000 !important;"`);
        lines.push(`  icon_style_inactive: "color:#000 !important;"`);
      }else if(w.type==='sensor'){
        lines.push(`  icon: ${ensureMdi(w.icon||autoBaseIcon('sensor',w.id))}`);
        lines.push(`  title_style: "color:#000; font-size:20px; font-weight:700; text-align:center; padding-top:5px; width:100%;"`);
        lines.push(`  text_style: "color:#000 !important;"`);
        lines.push(`  value_style: "color:#000 !important; font-size:44px !important; font-weight:700 !important;"`);
        lines.push(`  unit_style: "color:#000 !important;"`);
        lines.push(`  widget_style: "color:#000 !important; background-color:#FFFFFF !important;"`);
      }else{
        lines.push(`  icon: ${ensureMdi(w.icon||autoBaseIcon(w.type,w.id))}`);
        lines.push(`  title_style: "color:#000; font-size:20px; font-weight:700; text-align:center; padding-top:3px; width:100%;"`);
        lines.push(`  widget_style: "color:#000 !important; background-color:#FFFFFF !important;"`);
      }
      return lines.join("\n");
    }
    function buildWidgetsSection(){ let out="\n# -------------------\n# DEFINICJE WID≈ªET√ìW\n# -------------------\n\n"; rows.forEach(r=>r.forEach(w=>{ out+=widgetYaml(w)+"\n\n"; })); return out.trimEnd(); }

    function prepareAndSubmit(e){
      e.preventDefault();
      const title=(document.getElementById('dash-title').value||'Joan2').replace(/"/g,'');
      const yaml=[buildHeader(title),buildLayout(),buildWidgetsSection()].join("\n");
      document.getElementById('generated_yaml_client').value=yaml;
      document.getElementById('widgets_full_json').value=JSON.stringify(rows);
      document.getElementById('layout_data_json').value=JSON.stringify(rows.map(r=>r.map(w=>w.id+(w.size? " "+w.size:""))));
      const host=window.location.hostname;
      document.getElementById('client-yaml-section').classList.remove('hidden');
      document.getElementById('client-yaml-output').value=yaml;
      document.getElementById('client-path-code').innerText=`\\\\${host}\\addon_configs\\appdaemon\\dashboards\\${title.toLowerCase()}.dash`;
      const link=`http://${host}:5050/${title}`; const linkEl=document.getElementById('client-dashboard-link'); linkEl.href=link; linkEl.innerText=link;
    }

    // Events
    document.getElementById('btn-theme').addEventListener('click',toggleTheme);
    document.getElementById('btn-pl').addEventListener('click',()=>setLang('pl'));
    document.getElementById('btn-en').addEventListener('click',()=>setLang('en'));
    document.getElementById('btn-toggle-import').addEventListener('click',toggleImport);
    document.getElementById('btn-import').addEventListener('click',importYaml);
    document.getElementById('btn-action').addEventListener('click',saveWidget);
    document.getElementById('btn-cancel').addEventListener('click',cancelEdit);
    document.getElementById('btn-new-row').addEventListener('click',addNewRow);
    document.getElementById('new-entity-id').addEventListener('input',autoFillForm);
    document.getElementById('new-widget-type').addEventListener('change',autoFillForm);
    document.getElementById('new-widget-icon').addEventListener('input',updateIconPreview);

    // Icons datalist
    async function fetchIcons(){ const dl=document.getElementById('icons-list'); try{ const res=await fetch('https://raw.githubusercontent.com/Templarian/MaterialDesign/master/meta.json'); const icons=await res.json(); dl.innerHTML=''; icons.forEach(i=>{ const opt=document.createElement('option'); opt.value='mdi-'+i.name; dl.appendChild(opt); }); }catch(e){} }

    window.addEventListener('DOMContentLoaded',()=>{
      const host=window.location.hostname;
      const codePath=document.getElementById('path-code');
      const linkDash=document.getElementById('dashboard-link');
      if(codePath) codePath.innerHTML=codePath.innerHTML.replace('IP_HA',host);
      if(linkDash){ linkDash.href=linkDash.href.replace('IP_HA',host); linkDash.innerText=linkDash.innerText.replace('IP_HA',host); }
      const savedLang=localStorage.getItem('joan_lang')||'pl';
      const savedTheme=localStorage.getItem('joan_theme')||'light';
      setLang(savedLang);
      if(savedTheme==='dark'){ document.body.classList.add('dark-mode'); document.getElementById('btn-theme').innerText='‚òÄÔ∏è'; }
      fetchIcons();
      if(!rows.length) addNewRow();
      renderRows();
    });
  </script>
</body>
</html>
