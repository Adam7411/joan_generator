<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joan 6 Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; background: #e0e0e0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; align-items: flex-end; }
        .col { flex: 1; min-width: 140px; }
        label { font-weight: bold; font-size: 12px; display: block; margin-bottom: 4px; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn { padding: 10px 20px; border: none; cursor: pointer; background: #2196f3; color: white; font-weight: bold; border-radius: 4px; }
        .btn-green { background: #4caf50; }
        .btn-red { background: #f44336; }
        
        /* PREVIEW AREA - E-INK SIMULATION */
        .preview-box { background: #f0f0f0; padding: 20px; border: 2px solid #ccc; min-height: 200px; margin-top: 20px; border-radius: 8px; overflow-x: auto; }
        .p-row { display: flex; gap: 8px; margin-bottom: 8px; border: 1px dashed #999; padding: 10px; min-height: 130px; align-items: center; }
        
        /* WIDGET STYLES */
        .widget { 
            background: #fff; border: 2px solid #000; color: #000; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; cursor: pointer; box-shadow: 2px 2px 0 #000; transition: transform 0.1s;
        }
        .widget:hover { transform: translateY(-2px); z-index: 10; border-color: #2196f3; }
        .w-title { font-weight: 900; font-size: 14px; text-align: center; line-height: 1.1; margin-bottom: 5px; }
        .w-icon { font-size: 40px; }
        .w-state { font-size: 12px; border: 1px solid #000; padding: 1px 4px; margin-top: 5px; text-transform: uppercase; font-weight: bold; }
        .del-btn { position: absolute; top: -8px; right: -8px; background: red; color: white; width: 20px; height: 20px; border-radius: 50%; text-align: center; line-height: 20px; font-weight: bold; display: none; }
        .widget:hover .del-btn { display: block; }

        /* HIGHLIGHT EDITING */
        .editing-mode { border: 2px solid #ff9800; background: #fff8e1; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Joan 6 Smart Generator</h1>
        
        <!-- IMPORT -->
        <details>
            <summary style="cursor:pointer; font-weight:bold; margin-bottom:10px;">ðŸ“‚ Import / Eksport Kodu</summary>
            <textarea id="import-code" style="height:150px;" placeholder="Wklej tutaj zawartoÅ›Ä‡ .dash..."></textarea>
            <button class="btn btn-green" onclick="importYaml()" style="margin-top:5px;">Wczytaj Kod</button>
        </details>
        <hr>

        <!-- FORMULARZ -->
        <div id="form-container" style="background: #e3f2fd; padding: 15px; border-radius: 6px; border: 1px solid #2196f3;">
            <div class="row">
                <div class="col">
                    <label>Typ Widgetu</label>
                    <select id="i-type" onchange="toggleFields()">
                        <option value="switch">Switch / Light (WÅ‚Ä…cznik)</option>
                        <option value="cover">Cover / Brama / Roleta</option>
                        <option value="sensor">Sensor (Info)</option>
                        <option value="binary_sensor">Binary Sensor (Stan)</option>
                        <option value="lock">Lock (Zamek)</option>
                        <option value="person">Person (ObecnoÅ›Ä‡)</option>
                        <option value="navigate">Navigate (Przycisk Menu)</option>
                        <option value="climate">Climate (Termostat)</option>
                        <option value="media_player">Media Player</option>
                        <option value="spacer">Spacer (Pusty)</option>
                    </select>
                </div>
                <div class="col" id="grp-entity">
                    <label>Encja (Home Assistant)</label>
                    <input list="dl-entities" id="i-entity" placeholder="np. light.salon" oninput="runSmartLogic(this.value)" autocomplete="off">
                    <datalist id="dl-entities">
                        {% for e in entities %}
                        <!-- Tu przechowujemy dane dla logiki JS -->
                        <option value="{{ e.id }}" data-dclass="{{ e.device_class }}" data-name="{{ e.friendly_name }}">{{ e.id }}</option>
                        {% endfor %}
                    </datalist>
                </div>
                <div class="col" id="grp-dash" style="display:none;">
                    <label>Nazwa Dashboardu (cel)</label>
                    <input type="text" id="i-dash" oninput="autoNameNav()">
                </div>
                <div class="col">
                    <label>TytuÅ‚ na ekranie</label>
                    <input type="text" id="i-name">
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <label>Rozmiar (Kolumny x Wiersze)</label>
                    <select id="i-size">
                        <option value="(1x1)">1x1 (MaÅ‚y Kwadrat)</option>
                        <option value="(2x1)">2x1 (Szeroki Przycisk)</option>
                        <option value="(2x2)">2x2 (DuÅ¼y Kwadrat)</option>
                        <option value="(3x1)">3x1 (Bardzo Szeroki)</option>
                    </select>
                </div>
                <div class="col">
                    <label>Ikona (Statyczna)</label>
                    <input type="text" id="i-icon" placeholder="mdi-home" oninput="updatePreview()">
                </div>
                <div class="col">
                    <label>Ikona ON / Open</label>
                    <input type="text" id="i-icon-on" placeholder="mdi-lightbulb-on" oninput="updatePreview()">
                </div>
                <div class="col">
                    <label>Ikona OFF / Closed</label>
                    <input type="text" id="i-icon-off" placeholder="mdi-lightbulb-outline" oninput="updatePreview()">
                </div>
            </div>
            <div class="row">
                <button class="btn btn-green" onclick="addWidget()">+ DODAJ</button>
                <button class="btn btn-red" onclick="cancelEdit()" id="btn-cancel" style="display:none;">ANULUJ</button>
            </div>
        </div>

        <form method="POST" id="main-form">
            <input type="hidden" name="layout_data_json" id="layout_json">
            <input type="hidden" name="title" value="MyDashboard">
            
            <div class="preview-box" id="preview-container"></div>
            
            <button type="button" class="btn" onclick="addRow()">+ Dodaj Wiersz</button>
            <button type="button" class="btn btn-green" style="float:right; font-size:18px;" onclick="submitForm()">GENERUJ KOD</button>
        </form>

        {% if generated_yaml %}
        <div style="margin-top:20px;">
            <h3>TwÃ³j kod YAML:</h3>
            <textarea style="width:100%; height:400px; font-family:monospace;">{{ generated_yaml }}</textarea>
        </div>
        {% endif %}
    </div>

    <script>
        let rows = [[]];
        let editIdx = null; // {r, w}
        let blockSmart = false; // Blokada automatyki przy imporcie/edycji

        // MAPY IKON I TYPÃ“W (SMART LOGIC)
        const SMART_MAP = {
            'light': { type: 'switch', size: '(2x1)', iconOn: 'mdi-lightbulb-on', iconOff: 'mdi-lightbulb-outline' },
            'switch': { type: 'switch', size: '(2x1)', iconOn: 'mdi-toggle-switch', iconOff: 'mdi-toggle-switch-off' },
            'cover': { type: 'cover', size: '(2x1)', iconOn: 'mdi-window-shutter-open', iconOff: 'mdi-window-shutter' },
            'garage': { type: 'cover', size: '(2x1)', iconOn: 'mdi-garage-open', iconOff: 'mdi-garage' },
            'binary_sensor': { type: 'binary_sensor', size: '(1x1)', iconOn: 'mdi-checkbox-marked-circle', iconOff: 'mdi-checkbox-blank-circle-outline' },
            'sensor': { type: 'sensor', size: '(1x1)', icon: 'mdi-eye' },
            'lock': { type: 'lock', size: '(2x1)', iconOn: 'mdi-lock-open', iconOff: 'mdi-lock' },
            'climate': { type: 'climate', size: '(2x2)', icon: '' },
            'media_player': { type: 'media_player', size: '(2x2)', icon: '' },
            'person': { type: 'person', size: '(1x1)', icon: 'mdi-account' }
        };

        const DEVICE_CLASS_ICONS = {
            'temperature': 'mdi-thermometer',
            'humidity': 'mdi-water-percent',
            'battery': 'mdi-battery',
            'power': 'mdi-flash',
            'energy': 'mdi-lightning-bolt',
            'door': ['mdi-door-open', 'mdi-door-closed'],
            'window': ['mdi-window-open-variant', 'mdi-window-closed-variant'],
            'garage': ['mdi-garage-open', 'mdi-garage'],
            'moisture': 'mdi-water',
            'safety': 'mdi-shield-alert'
        };

        function runSmartLogic(val) {
            if(blockSmart) return; // Nie zmieniaj nic jeÅ›li edytujemy/importujemy!
            
            const id = val.toLowerCase();
            if(id.length < 3) return;

            // ZnajdÅº dane w datalist
            const option = document.querySelector(`#dl-entities option[value="${val}"]`);
            const dClass = option ? option.getAttribute('data-dclass') : '';
            const fName = option ? option.getAttribute('data-name') : '';
            const domain = id.split('.')[0];

            // 1. Nazwa (TytuÅ‚)
            const nameField = document.getElementById('i-name');
            if(!nameField.value) {
                nameField.value = fName || id.split('.').pop().replace(/_/g, ' ');
            }

            // 2. Typ i Rozmiar Bazowy
            let config = SMART_MAP[domain] || SMART_MAP['sensor']; // Fallback
            
            // Nadpisz jeÅ›li device_class sugeruje coÅ› innego (np. sensor garage door)
            if(dClass === 'garage' || id.includes('garage')) config = SMART_MAP['garage'];
            if(dClass === 'door') config = { type: 'binary_sensor', size: '(1x1)', iconOn: 'mdi-door-open', iconOff: 'mdi-door-closed' };
            
            document.getElementById('i-type').value = config.type;
            document.getElementById('i-size').value = config.size;

            // 3. Ikony (Precyzyjne dobieranie)
            const iconField = document.getElementById('i-icon');
            const onField = document.getElementById('i-icon-on');
            const offField = document.getElementById('i-icon-off');

            // Reset
            iconField.value = ''; onField.value = ''; offField.value = '';

            let specificIcon = DEVICE_CLASS_ICONS[dClass];
            
            if(config.type === 'sensor') {
                iconField.value = (typeof specificIcon === 'string') ? specificIcon : (config.icon || 'mdi-eye');
            } else {
                // Typy On/Off (Switch, Binary, Cover)
                if(Array.isArray(specificIcon)) {
                    onField.value = specificIcon[0];
                    offField.value = specificIcon[1];
                } else {
                    onField.value = config.iconOn || '';
                    offField.value = config.iconOff || '';
                }
            }

            toggleFields();
        }

        function toggleFields() {
            const type = document.getElementById('i-type').value;
            const isNav = type === 'navigate';
            const isSpacer = type === 'spacer';
            
            document.getElementById('grp-entity').style.display = (isNav || isSpacer) ? 'none' : 'block';
            document.getElementById('grp-dash').style.display = isNav ? 'block' : 'none';
        }

        function addWidget() {
            const w = {
                type: document.getElementById('i-type').value,
                id: document.getElementById('i-entity').value,
                dash: document.getElementById('i-dash').value,
                name: document.getElementById('i-name').value,
                size: document.getElementById('i-size').value,
                icon: document.getElementById('i-icon').value,
                icon_on: document.getElementById('i-icon-on').value,
                icon_off: document.getElementById('i-icon-off').value,
            };

            if(w.type === 'navigate') w.id = 'navigate.' + w.dash;
            if(w.type === 'spacer') w.id = 'spacer';

            if(editIdx) {
                rows[editIdx.r][editIdx.w] = w;
                cancelEdit();
            } else {
                rows[rows.length-1].push(w);
                // Clear form for next entry (enables smart logic again)
                clearForm();
            }
            render();
        }

        function edit(r, w) {
            blockSmart = true; // ZABLOKUJ SMART, Å¼eby nie nadpisaÄ‡ danych!
            editIdx = {r, w};
            const data = rows[r][w];
            
            document.getElementById('form-container').classList.add('editing-mode');
            document.getElementById('btn-cancel').style.display = 'inline-block';

            document.getElementById('i-type').value = data.type;
            toggleFields();

            if(data.type === 'navigate') {
                document.getElementById('i-dash').value = data.id.replace('navigate.', '');
            } else {
                document.getElementById('i-entity').value = data.id;
            }
            
            document.getElementById('i-name').value = data.name;
            document.getElementById('i-size').value = data.size || '(1x1)';
            document.getElementById('i-icon').value = data.icon || '';
            document.getElementById('i-icon-on').value = data.icon_on || '';
            document.getElementById('i-icon-off').value = data.icon_off || '';
        }

        function cancelEdit() {
            editIdx = null;
            blockSmart = false;
            document.getElementById('form-container').classList.remove('editing-mode');
            document.getElementById('btn-cancel').style.display = 'none';
            clearForm();
        }

        function clearForm() {
            document.getElementById('i-entity').value = '';
            document.getElementById('i-name').value = '';
            document.getElementById('i-icon').value = '';
            document.getElementById('i-icon-on').value = '';
            document.getElementById('i-icon-off').value = '';
        }

        function render() {
            const box = document.getElementById('preview-container');
            box.innerHTML = '';
            
            rows.forEach((row, rI) => {
                const rDiv = document.createElement('div');
                rDiv.className = 'p-row';
                
                row.forEach((w, wI) => {
                    const div = document.createElement('div');
                    div.className = 'widget';
                    
                    // OBLICZANIE ROZMIARU (AppDaemon Logic)
                    // Baza: 115px. Margines: 8px.
                    // WzÃ³r: (Base * Col) + (Margin * (Col-1))
                    const dims = w.size.replace(/[()]/g, '').split('x');
                    const c = parseInt(dims[0]);
                    const r = parseInt(dims[1]);
                    
                    const width = (c * 115) + ((c-1) * 8);
                    const height = (r * 115) + ((r-1) * 8);
                    
                    div.style.width = width + 'px';
                    div.style.height = height + 'px';
                    
                    if(w.type === 'spacer') {
                        div.style.border = '1px dashed #999';
                        div.style.boxShadow = 'none';
                        div.innerHTML = '<span style="color:#999; font-size:10px;">SPACER</span>';
                    } else {
                        // WybÃ³r ikony do podglÄ…du
                        let iconHtml = '';
                        const showIcon = w.icon_on || w.icon || 'mdi-help-circle-outline';
                        if(showIcon) iconHtml = `<i class="mdi ${showIcon} w-icon"></i>`;
                        
                        div.innerHTML = `
                            <div class="w-title">${w.name || w.id}</div>
                            ${iconHtml}
                            <div class="w-state">${w.type}</div>
                            <div class="del-btn" onclick="delWidget(${rI}, ${wI}, event)">X</div>
                        `;
                    }
                    div.onclick = () => edit(rI, wI);
                    rDiv.appendChild(div);
                });
                box.appendChild(rDiv);
            });
        }

        function delWidget(r, w, e) {
            e.stopPropagation();
            rows[r].splice(w, 1);
            render();
        }

        function addRow() { rows.push([]); render(); }

        function submitForm() {
            document.getElementById('layout_json').value = JSON.stringify(rows);
            document.getElementById('main-form').submit();
        }

        function autoNameNav() {
            if(blockSmart) return;
            const val = document.getElementById('i-dash').value;
            document.getElementById('i-name').value = val.toUpperCase();
        }
        
        // Import Logic (uproszczony parser)
        function importYaml() {
            const text = document.getElementById('import-code').value;
            // Tutaj powinna byÄ‡ logika parsujÄ…ca YAML do struktury 'rows'
            // PoniewaÅ¼ nie mam peÅ‚nego parsera YAML w JS w tym przykÅ‚adzie,
            // kluczowe jest to, Å¼e przy wczytywaniu danych do struktury 'rows'
            // NIE woÅ‚amy funkcji runSmartLogic().
            // Po prostu przepisujemy: icon: yamlData.icon, size: yamlData.widget_size...
            alert("Funkcja importu musi sparsowaÄ‡ YAML i wypeÅ‚niÄ‡ tablicÄ™ 'rows'. Upewnij siÄ™, Å¼e przypisujesz 'w.size' bezpoÅ›rednio z kodu (np. (2x1)) i nie uruchamiasz logiki smart.");
        }

        // Init
        render();
    </script>
</body>
</html>
