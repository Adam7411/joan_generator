<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joan 6 E-Ink Generator (Final Monster Edition)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    
    <script>
        (function() {
            try {
                const savedTheme = localStorage.getItem('joan_theme') || 'light';
                if (savedTheme === 'dark') { document.documentElement.classList.add('dark-mode'); }
            } catch(e) { console.error(e); }
        })();
    </script>

    <style>
        :root {
            --bg-body: #e0e0e0; --bg-container: #ffffff; --bg-section: #fafafa; --bg-input: #ffffff;
            --text-main: #333333; --border: #cccccc; --accent: #d32f2f; --highlight: #e3f2fd;
            --preview-bg: #f0f0f0; --link-bg: #e1f5fe; --link-color: #0277bd; --shadow: 0 4px 15px rgba(0,0,0,0.1);
            --btn-text: #ffffff;
        }
        html.dark-mode {
            --bg-body: #121212; --bg-container: #1e1e1e; --bg-section: #252525; --bg-input: #2c2c2c;
            --text-main: #e0e0e0; --border: #444444; --accent: #ff5252; --highlight: #0d47a1;
            --preview-bg: #000000; --link-bg: #013655; --link-color: #81d4fa; --shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        body { font-family: 'Roboto', sans-serif; background-color: var(--bg-body); color: var(--text-main); padding: 20px; transition: background-color 0.3s; }
        .container { max-width: 1400px; margin: 0 auto; background: var(--bg-container); padding: 30px; border-radius: 10px; box-shadow: var(--shadow); }
        .header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border); padding-bottom: 20px; margin-bottom: 25px; }
        h1 { margin: 0; color: var(--accent); font-size: 28px; font-weight: 900; text-transform: uppercase; }
        .controls button { padding: 8px 16px; border: 1px solid var(--border); background: var(--bg-section); color: var(--text-main); border-radius: 4px; cursor: pointer; font-weight: bold; margin-left: 5px; }
        .controls button.active { background: var(--accent); color: var(--btn-text); border-color: var(--accent); }
        .section { background: var(--bg-section); padding: 25px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 30px; }
        .section-title { font-size: 1.4em; font-weight: 900; border-bottom: 3px solid var(--accent); display: inline-block; margin-bottom: 20px; color: var(--text-main); }
        
        .file-path-info { background-color: var(--link-bg); color: var(--link-color); border: 1px solid var(--border); padding: 20px; margin-bottom: 20px; border-radius: 6px; font-family: monospace; }
        .file-info-block { margin-bottom: 15px; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 15px; }
        .file-path-info strong { display: block; margin-bottom: 5px; color: var(--text-main); }
        .file-path-info code { display: block; background: rgba(255,255,255,0.4); padding: 8px; border-radius: 4px; font-weight: bold; }

        .link-box {
            background-color: #ffffff;
            border: 2px solid var(--accent);
            padding: 10px;
            border-radius: 4px;
            display: inline-block;
            color: #000000;
            font-weight: bold;
            margin-top: 5px;
        }
        .link-box a { color: #0277bd; text-decoration: underline; font-size: 16px; }

        .add-widget-box { background: var(--highlight); padding: 25px; border-radius: 8px; border: 1px solid var(--accent); margin-bottom: 30px; }
        .add-widget-box.editing { border: 3px solid #ff9800; background: rgba(255, 152, 0, 0.15); }
        .flex-row { display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 15px; }
        .flex-col { flex: 1; min-width: 160px; }
        label { display: block; font-weight: bold; font-size: 0.9em; margin-bottom: 8px; color: var(--text-main); }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); background: var(--bg-input); color: var(--text-main); border-radius: 4px; box-sizing: border-box; }
        #w-id { border: 2px solid var(--accent); font-weight: bold; }
        
        .btn { padding: 12px 24px; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; text-transform: uppercase; color: var(--btn-text); font-size: 14px; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-add { background: #4caf50; width: 100%; }
        .btn-gen { background: var(--accent); width: 100%; font-size: 20px; padding: 15px; margin-top: 20px; }
        .btn-cancel { background: #757575; }
        .btn-row { background: #2196f3; margin-top: 15px; }
        .btn-del-row { background: #d32f2f; padding: 4px 8px; font-size: 12px; margin-left: 10px; border-radius: 4px; cursor: pointer; color: white; border: none; }
        .btn-import { background: #ff9800; color: white; margin-top: 10px; }

        /* PODGLƒÑD Z KRATOWNICƒÑ */
        .preview-area { 
            background: var(--preview-bg); 
            padding: 30px; 
            border: 2px solid var(--border); 
            border-radius: 8px; 
            overflow-x: auto; 
            min-height: 400px; 
        }
        
        .eink-row { 
            display: flex; gap: 8px; margin-bottom: 15px; padding: 15px; 
            border: 2px dashed #999; border-radius: 6px; min-height: 140px; 
            align-items: flex-end; position: relative; 
            background-image: linear-gradient(to right, rgba(0,0,0,0.05) 1px, transparent 1px), linear-gradient(to bottom, rgba(0,0,0,0.05) 1px, transparent 1px);
            background-size: 125px 125px;
            transition: border-color 0.3s, box-shadow 0.3s, background-color 0.3s;
            cursor: pointer;
        }
        .eink-row.row-active {
            border: 2px solid #2196f3;
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.3);
            background-color: rgba(33, 150, 243, 0.05);
        }
        
        .row-controls { position: absolute; top: -12px; left: 10px; display: flex; align-items: center; }
        .row-label { font-size: 11px; background: var(--bg-body); padding: 2px 8px; color: var(--text-main); border: 1px solid var(--border); border-radius: 4px; font-weight: bold; }
        
        .widget-wrapper { display: flex; flex-direction: column; align-items: center; margin-right: 0; position: relative; flex-shrink: 0; }
        .ew-type-label { font-size: 10px; text-transform: uppercase; color: var(--text-main); margin-bottom: 4px; font-weight: bold; opacity: 0.7; text-align: center; }

        .eink-widget {
            background: #FFFFFF; border: 3px solid #000000; color: #000000;
            display: flex; flex-direction: column; align-items: center; justify-content: space-between;
            padding: 8px; box-sizing: border-box; cursor: pointer; position: relative;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.25); transition: transform 0.1s; flex-shrink: 0; overflow: hidden;
        }
        .eink-widget:hover { transform: translateY(-3px); z-index: 10; border-color: var(--accent); }
        .eink-widget.editing { border: 4px solid #ff9800; transform: scale(1.05); z-index: 20; box-shadow: 0 0 15px rgba(255, 152, 0, 0.5); }

        .ew-title { font-weight: 900; font-size: 13px; text-align: center; width: 100%; line-height: 1.2; margin-top: 12px; margin-bottom: 2px; white-space: normal; text-transform: uppercase; pointer-events: none; }
        .ew-icon { font-size: 38px; display: block; margin: 2px 0; pointer-events: none; }
        .ew-value { font-weight: 900; font-size: 15px; text-transform: uppercase; margin-bottom: 5px; text-align: center; border-top: 2px solid #000; width: 90%; padding-top: 3px; margin-top: auto; pointer-events: none; }
        .ew-del { position: absolute; top: -8px; right: -8px; background: red; color: white; width: 20px; height: 20px; border-radius: 50%; text-align: center; line-height: 20px; font-weight: bold; display: none; box-shadow: 1px 1px 3px rgba(0,0,0,0.5); z-index: 30; }
        .eink-widget:hover .ew-del { display: block; }
        
        .icon-preview { font-size: 32px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-input); }
        .hidden { display: none !important; }
        textarea.output { width: 100%; height: 500px; font-family: 'Consolas', 'Monaco', monospace; background: #263238; color: #eceff1; border: none; padding: 20px; border-radius: 8px; font-size: 14px; line-height: 1.5; }
        .char-counter { font-size: 11px; text-align: right; margin-top: 4px; color: #666; font-weight: bold; }
        .char-counter.limit { color: red; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-row">
            <h1 data-i18n="title_main">Joan 6 E-Ink Generator (MONUMENTAL)</h1>
            <div class="controls">
                <button type="button" onclick="toggleTheme()" id="btn-theme">üåô</button>
                <button type="button" onclick="setLang('pl')" id="btn-pl" class="active">PL</button>
                <button type="button" onclick="setLang('en')" id="btn-en">EN</button>
            </div>
        </div>

        <!-- 1. USTAWIENIA SIATKI -->
        <div class="section">
            <div class="section-title" data-i18n="sec_settings">1. Ustawienia Dashboardu</div>
            <div class="flex-row">
                <div class="flex-col">
                    <label data-i18n="lbl_dash_title">Tytu≈Ç Dashboardu</label>
                    <input type="text" id="dash-title" oninput="syncTitle()" value="JoanDashboard">
                </div>
                <div class="flex-col">
                    <label data-i18n="lbl_grid">Uk≈Çad Siatki (Smart Grid)</label>
                    <select id="grid-preset" onchange="applyGrid()">
                        <option value="4x8" data-i18n="grid_std_plus" selected>Standard+ (3 kolumny x 8 wierszy) - DOMY≈öLNY</option>
                        <option value="4x6" data-i18n="grid_std">Standard (3 kolumny x 6 wierszy)</option>
                        <option value="4x4" data-i18n="grid_large">Du≈ºy (4 kolumny x 4 wiersze)</option>
                        <option value="4x6m" data-i18n="grid_med">≈öredni (4 kolumny x 6 wierszy)</option>
                        <option value="6x9" data-i18n="grid_small">Ma≈Çy (6 kolumn x 9 wierszy)</option>
                    </select>
                </div>
                <input type="hidden" id="h-cols" value="4">
                <input type="hidden" id="h-rows" value="8">
            </div>
        </div>

        <!-- 2. IMPORT -->
        <div class="section" id="import-section">
            <details>
                <summary style="cursor: pointer; font-weight: bold; font-size: 1.1em;" data-i18n="sec_import">üìÇ Import / Eksport Kodu .DASH</summary>
                <div style="margin-top: 15px;">
                    <textarea id="import-code" style="height: 150px;" placeholder="Wklej tutaj zawarto≈õƒá pliku .dash..."></textarea>
                    <button type="button" class="btn btn-import" onclick="importYaml()" data-i18n="btn_import">Wczytaj Kod</button>
                </div>
            </details>
        </div>

        <form method="POST" id="main-form">
            <input type="hidden" name="title" id="form-title" value="JoanDashboard">
            <input type="hidden" name="ui_language" id="input-lang" value="pl">
            <input type="hidden" name="grid_columns" id="form-cols" value="4">
            <input type="hidden" name="grid_rows" id="form-rows" value="8">
            
            <!-- 3. EDYTOR WIDGETU -->
            <div class="add-widget-box" id="editor-box">
                <div class="section-title" id="editor-title" data-i18n="sec_add">2. Dodaj Widget</div>
                
                <div class="flex-row">
                    <div class="flex-col">
                        <label data-i18n="lbl_type">Typ Widgetu</label>
                        <select id="w-type" onchange="toggleInputs()">
                            <option value="switch" data-i18n="opt_switch">Switch / Light</option>
                            <option value="cover" data-i18n="opt_cover">Cover / Gate</option>
                            <option value="sensor" data-i18n="opt_sensor">Sensor</option>
                            <option value="binary_sensor" data-i18n="opt_binary">Binary Sensor</option>
                            <option value="lock" data-i18n="opt_lock">Lock</option>
                            <option value="person" data-i18n="opt_person">Person / Tracker</option>
                            <option value="media_player" data-i18n="opt_media">Media Player</option>
                            <option value="climate" data-i18n="opt_climate">Climate</option>
                            <option value="input_select" data-i18n="opt_input_select">Input Select</option>
                            <option value="input_number" data-i18n="opt_input_number">Input Number</option>
                            <option value="script" data-i18n="opt_script">Script</option>
                            <option value="navigate" data-i18n="opt_navigate">Navigate / Button</option>
                            <option value="label" data-i18n="opt_label">Label (Text)</option>
                            <option value="clock" data-i18n="opt_clock">Clock</option>
                            <option value="spacer" data-i18n="opt_spacer">Spacer (Empty)</option>
                        </select>
                    </div>
                    <div class="flex-col" id="grp-entity">
                        <label data-i18n="lbl_entity">Encja (Wyszukaj po nazwie lub ID)</label>
                        <input list="entity-list" id="w-id" placeholder="np. g≈Ço≈õnik kuchnia..." oninput="searchEntities(this.value)" autocomplete="off">
                        <datalist id="entity-list"></datalist>
                    </div>
                    <div class="flex-col hidden" id="grp-nav">
                        <label data-i18n="lbl_dash_name">Nazwa Dashboardu (target)</label>
                        <input type="text" id="w-dash" placeholder="np. main" oninput="autoNameNav()">
                    </div>
                    <div class="flex-col">
                        <label data-i18n="lbl_name">Tytu≈Ç na ekranie</label>
                        <input type="text" id="w-name" placeholder="np. Salon" oninput="checkTitleLimit(); searchEntities(this.value, true)">
                        <div id="char-count" class="char-counter">0/20</div>
                    </div>
                </div>

                <div class="flex-row">
                    <div class="flex-col">
                        <label data-i18n="lbl_size">Rozmiar</label>
                        <select id="w-size" onchange="updateTitleLimit()">
                            <option value="(2x1)" data-i18n="size_2x1">2x1 (Szeroki Przycisk)</option>
                            <option value="(1x1)" data-i18n="size_1x1">1x1 (Ma≈Çy)</option>
                            <option value="(2x2)" data-i18n="size_2x2">2x2 (Du≈ºy)</option>
                            <option value="(3x1)" data-i18n="size_3x1">3x1 (Bardzo Szeroki)</option>
                            <option value="(1x2)" data-i18n="size_1x2">1x2 (Wysoki)</option>
                            <option value="(3x2)" data-i18n="size_3x2">3x2 (Ogromny)</option>
                        </select>
                    </div>
                    <div class="flex-col" style="flex: 0 0 60px;">
                        <label data-i18n="lbl_preview">PodglƒÖd</label>
                        <div style="display:flex; justify-content:center;">
                            <i id="preview-icon" class="mdi mdi-help-circle-outline icon-preview"></i>
                        </div>
                    </div>
                    <div class="flex-col">
                        <label data-i18n="lbl_icon">Ikona (Standard)</label>
                        <input type="text" id="w-icon" oninput="updateIconPreview()" placeholder="mdi-home">
                    </div>
                    <div class="flex-col">
                        <label data-i18n="lbl_icon_on">Ikona ON</label>
                        <input type="text" id="w-icon-on" oninput="updateIconPreview()" placeholder="mdi-lightbulb-on">
                    </div>
                    <div class="flex-col">
                        <label data-i18n="lbl_icon_off">Ikona OFF</label>
                        <input type="text" id="w-icon-off" oninput="updateIconPreview()" placeholder="mdi-lightbulb-outline">
                    </div>
                </div>

                <div class="flex-row" style="margin-top: 20px;">
                    <button type="button" class="btn btn-add" id="btn-submit" onclick="saveWidget()" data-i18n="btn_add">+ DODAJ WIDGET</button>
                    <button type="button" class="btn btn-cancel hidden" id="btn-cancel" onclick="cancelEdit()" data-i18n="btn_cancel">ANULUJ</button>
                </div>
            </div>

            <!-- 4. PODGLƒÑD E-INK -->
            <div class="section">
                <div class="section-title" data-i18n="sec_preview">3. PodglƒÖd Dashboardu</div>
                <div class="preview-area" id="preview-container"></div>
                <button type="button" class="btn btn-row" onclick="addRow()" data-i18n="btn_row">+ Dodaj Wiersz</button>
            </div>

            <input type="hidden" name="layout_data_json" id="layout_json">
            <input type="hidden" name="custom_definitions_json" id="custom_defs">
            <button type="button" class="btn btn-gen" onclick="submitData()" data-i18n="btn_gen">GENERUJ KOD .DASH</button>
        </form>

        <!-- 5. WYNIK YAML -->
        {% if generated_yaml %}
        <div class="section" style="margin-top:30px;">
            <div class="section-title" data-i18n="sec_result">Wynikowy Kod YAML</div>
            <div class="file-path-info">
                <div class="file-info-block">
                    <strong data-i18n="lbl_save_path">1. Zapisz kod w pliku:</strong>
                    <code id="path-code">\\IP_HA\addon_configs\appdaemon\dashboards\{{ filename }}</code>
                </div>
                <div class="file-info-block">
                    <strong data-i18n="lbl_open_link">2. Uruchom ponownie AppDaemon i sprawd≈∫:</strong>
                    <div class="link-box">
                        <a href="http://[HOST]:5050/{{ dash_name }}" id="dashboard-link" target="_blank">http://[HOST]:5050/{{ dash_name }}</a>
                    </div>
                </div>
            </div>
            <textarea class="output" readonly>{{ generated_yaml }}</textarea>
        </div>
        {% endif %}
    </div>

    <!-- LOGIKA JS -->
    <script>
        const entitiesData = {{ entities | tojson | safe }};
        let rows = [[]]; 
        let editIdx = null; 
        let blockSmart = false; 
        let currentLang = 'pl';
        let rawImportedDefs = {}; 
        let activeRowIndex = 0;

        const TRANSLATIONS = { /* jak wcze≈õniej, bez zmian */ };
        const SMART_MAP = { /* jak wcze≈õniej, bez zmian */ };

        function normalizeString(str) { return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase(); }

        function searchEntities(val, forceSmartTitle = false) { /* jak wcze≈õniej, bez zmian */ }

        function runSmartLogic(val, isTitleSearch) { /* jak wcze≈õniej, bez zmian */ }

        function applyGrid() {
            const val = document.getElementById('grid-preset').value;
            const parts = val.replace('m','').split('x');
            document.getElementById('h-cols').value = parts[0];
            document.getElementById('h-rows').value = parts[1];
            document.getElementById('form-cols').value = parts[0];
            document.getElementById('form-rows').value = parts[1];
        }

        function syncTitle() { document.getElementById('form-title').value = document.getElementById('dash-title').value; }
        function autoNameNav() { if(blockSmart) return; const val = document.getElementById('w-dash').value; document.getElementById('w-name').value = val.toUpperCase(); }

        // Smart Fit ‚Äì dopasuj w aktualnym wierszu; NIE tw√≥rz nowego wiersza je≈õli da siƒô dopasowaƒá
        function smartFitRow(targetRowIdx, newCols, newWidgetType, newWidgetObj) {
            const gridVal = document.getElementById('grid-preset').value;
            let maxSlots = 3;
            if (gridVal === '4x4') maxSlots = 4;
            const maxUnits = maxSlots * 2;

            const row = rows[targetRowIdx];
            const calcWidth = () => row.reduce((acc, itm) => {
                const p = (itm.size || '(2x1)').replace(/[()]/g, '').split('x');
                const w = parseInt(p[0]) || 2;
                return acc + w;
            }, 0);

            let currentRowWidth = calcWidth();

            // 1) Je≈õli nowy to sensor/binary_sensor: ustaw 1x1 je≈õli brakuje miejsca
            if (currentRowWidth + newCols > maxUnits) {
                if ((newWidgetType === 'sensor' || newWidgetType === 'binary_sensor') && newCols > 1) {
                    newWidgetObj.size = '(1x1)';
                    newCols = 1;
                }
            }
            currentRowWidth = calcWidth();

            // 2) KOMPRESJA istniejƒÖcych sensor√≥w/binary z 2x1 -> 1x1 tylko tyle ile potrzeba
            if (currentRowWidth + newCols > maxUnits) {
                let deficit = (currentRowWidth + newCols) - maxUnits;
                for (let i = 0; i < row.length && deficit > 0; i++) {
                    const itm = row[i];
                    const parts = (itm.size || '(2x1)').replace(/[()]/g, '').split('x');
                    const sizeW = parseInt(parts[0]) || 2;
                    if ((itm.type === 'sensor' || itm.type === 'binary_sensor') && sizeW > 1) {
                        row[i].size = '(1x1)';
                        deficit -= 1;
                    }
                }
                currentRowWidth = calcWidth();
            }

            // Po wszystkich pr√≥bach ‚Äì true je≈õli zmie≈õci siƒô, false je≈õli nie
            return (currentRowWidth + newCols) <= maxUnits;
        }

        function saveWidget() {
            const w = {
                type: document.getElementById('w-type').value,
                id: document.getElementById('w-id').value,
                dash: document.getElementById('w-dash').value,
                name: document.getElementById('w-name').value,
                size: document.getElementById('w-size').value,
                icon: document.getElementById('w-icon').value,
                icon_on: document.getElementById('w-icon-on').value,
                icon_off: document.getElementById('w-icon-off').value,
                was_edited: true
            };
            if(w.type === 'navigate') w.id = 'navigate.' + w.dash;
            if(w.type === 'spacer') w.id = 'spacer';

            let targetRowIdx = typeof activeRowIndex === 'number' ? activeRowIndex : (rows.length - 1);
            if (!rows[targetRowIdx]) targetRowIdx = rows.length - 1;

            // Je≈õli edytujemy w tym wierszu, tymczasowo usu≈Ñ stary element z kalkulacji
            let prevItem = null;
            if (editIdx && editIdx.r === targetRowIdx) {
                prevItem = rows[targetRowIdx][editIdx.w];
                rows[targetRowIdx].splice(editIdx.w, 1);
            }

            let newCols = 2;
            if (w.size) newCols = parseInt(w.size.replace(/[()]/g, '').split('x')[0]) || 1;

            // Spr√≥buj dopasowaƒá w tym wierszu
            const fitsHere = smartFitRow(targetRowIdx, newCols, w.type, w);

            if (fitsHere) {
                // Wstaw z powrotem edytowany stary element je≈õli by≈Ç (ale zamieniamy na nowy w miejscu)
                if (prevItem) {
                    rows[targetRowIdx].splice(editIdx.w, 0, w);
                    cancelEdit();
                } else {
                    rows[targetRowIdx].push(w);
                }
                clearForm();
                blockSmart = false;
            } else {
                // Je≈õli nie da siƒô dopasowaƒá ‚Äì dopiero teraz utw√≥rz nowy wiersz
                rows.splice(targetRowIdx + 1, 0, []);
                activeRowIndex = targetRowIdx + 1;
                rows[activeRowIndex].push(w);
                // je≈õli by≈Ç edytowany element ‚Äì nie przywracamy go (zosta≈Ç zastƒÖpiony)
                if (prevItem) cancelEdit();
                clearForm();
                blockSmart = false;
            }

            renderPreview();
        }

        function updateIconPreview() {
            const i1 = document.getElementById('w-icon').value;
            const i2 = document.getElementById('w-icon-on').value;
            const i3 = document.getElementById('w-icon-off').value;
            const final = i1 || i2 || i3 || 'mdi-help-circle-outline';
            document.getElementById('preview-icon').className = `mdi ${final} icon-preview`;
        }

        function toggleInputs() {
            const type = document.getElementById('w-type').value;
            const isNav = type === 'navigate';
            const isSpacer = type === 'spacer';
            document.getElementById('grp-entity').style.display = (isNav || isSpacer) ? 'none' : 'block';
            document.getElementById('grp-nav').style.display = isNav ? 'block' : 'none';
            document.getElementById('grp-nav').classList.toggle('hidden', !isNav);
        }

        function updateTitleLimit() {
            const size = document.getElementById('w-size').value;
            const input = document.getElementById('w-name');
            const counter = document.getElementById('char-count');
            let max = 20;
            if(size === '(1x1)' || size === '(1x2)') max = 15;
            input.maxLength = max;
            const txt = max === 15 ? TRANSLATIONS[currentLang].limit_15 : TRANSLATIONS[currentLang].limit_20;
            counter.innerText = `${input.value.length}/${max} (${txt})`;
            if(input.value.length >= max) counter.classList.add('limit'); else counter.classList.remove('limit');
        }
        function checkTitleLimit() { updateTitleLimit(); }

        function editWidget(r, w) {
            blockSmart = true;
            editIdx = {r, w};
            activeRowIndex = r;
            const data = rows[r][w];
            document.getElementById('editor-box').classList.add('editing');
            document.getElementById('btn-cancel').classList.remove('hidden');
            const t = TRANSLATIONS[currentLang];
            document.getElementById('editor-title').innerText = t.sec_edit;
            document.getElementById('btn-submit').innerText = t.btn_update;

            document.getElementById('w-type').value = data.type;
            toggleInputs();

            if(data.type === 'navigate') document.getElementById('w-dash').value = data.id.replace('navigate.', '');
            else document.getElementById('w-id').value = data.id;

            document.getElementById('w-name').value = data.name;
            document.getElementById('w-size').value = data.size || '(2x1)';
            document.getElementById('w-icon').value = data.icon || '';
            document.getElementById('w-icon-on').value = data.icon_on || '';
            document.getElementById('w-icon-off').value = data.icon_off || '';
            updateIconPreview();
            updateTitleLimit();
            setTimeout(() => blockSmart = false, 500);
            renderPreview();
        }

        function cancelEdit() {
            editIdx = null;
            blockSmart = false;
            document.getElementById('editor-box').classList.remove('editing');
            document.getElementById('btn-cancel').classList.add('hidden');
            const t = TRANSLATIONS[currentLang];
            document.getElementById('editor-title').innerText = t.sec_add;
            document.getElementById('btn-submit').innerText = t.btn_add;
            clearForm();
            renderPreview();
        }

        function clearForm() {
            document.getElementById('w-id').value = '';
            document.getElementById('w-name').value = '';
            document.getElementById('w-icon').value = '';
            document.getElementById('w-icon-on').value = '';
            document.getElementById('w-icon-off').value = '';
            updateIconPreview();
            updateTitleLimit();
        }

        function deleteWidget(r, w, e) {
            e.stopPropagation();
            rows[r].splice(w, 1);
            if(editIdx && editIdx.r === r && editIdx.w === w) cancelEdit();
            renderPreview();
        }

        function deleteRow(r) {
            if(confirm(currentLang === 'pl' ? "UsunƒÖƒá ca≈Çy wiersz?" : "Delete entire row?")) {
                rows.splice(r, 1);
                if(rows.length === 0) rows.push([]);
                if(editIdx && editIdx.r === r) cancelEdit();
                activeRowIndex = Math.max(0, Math.min(activeRowIndex, rows.length - 1));
                renderPreview();
            }
        }

        function addRow() {
            rows.push([]);
            activeRowIndex = rows.length - 1;
            renderPreview();
        }

        function getRealState(w) {
            const isPL = currentLang === 'pl';
            const id = (w.id || '');
            const ent = entitiesData.find(e => e.id === id);
            if (!ent) return "---";
            const val = String(ent.state);
            const unit = ent.unit || "";
            if (val === 'on') return isPL ? "W≈ÅƒÑCZONE" : "ON";
            if (val === 'off') return isPL ? "WY≈ÅƒÑCZONE" : "OFF";
            if (val === 'open') return isPL ? "OTWARTE" : "OPEN";
            if (val === 'closed') return isPL ? "ZAMKNIƒòTE" : "CLOSED";
            if (!isNaN(parseFloat(val)) && val.includes('.')) return parseFloat(val).toFixed(1) + " " + unit;
            return val + " " + unit;
        }

        function renderPreview() {
            const container = document.getElementById('preview-container');
            container.innerHTML = '';

            rows.forEach((row, rI) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'eink-row';
                if(rI === activeRowIndex) rowDiv.classList.add('row-active');

                rowDiv.onclick = (ev) => {
                    if (ev.target.closest('.eink-widget')) return;
                    activeRowIndex = rI;
                    renderPreview();
                };
                
                const controls = document.createElement('div');
                controls.className = 'row-controls';
                
                const label = document.createElement('span');
                label.className = 'row-label';
                const txt = currentLang === 'pl' ? 'WIERSZ ' : 'ROW ';
                label.innerText = txt + (rI + 1);
                controls.appendChild(label);

                const delBtn = document.createElement('button');
                delBtn.className = 'btn-del-row';
                delBtn.innerText = 'X';
                delBtn.onclick = (e) => { e.stopPropagation(); deleteRow(rI); };
                controls.appendChild(delBtn);

                rowDiv.appendChild(controls);

                row.forEach((w, wI) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'widget-wrapper';
                    const typeLabel = document.createElement('div');
                    typeLabel.className = 'ew-type-label';
                    typeLabel.innerText = w.type;
                    wrapper.appendChild(typeLabel);

                    const div = document.createElement('div');
                    div.className = 'eink-widget';
                    if(editIdx && editIdx.r === rI && editIdx.w === wI) div.classList.add('editing');

                    let cols = 2, rw = 1;
                    if(w.size) {
                        const parts = w.size.replace(/[()]/g, '').split('x');
                        cols = parseInt(parts[0]) || 1;
                        rw = parseInt(parts[1]) || 1;
                    }
                    const width = (cols * 117) + ((cols - 1) * 8);
                    const height = (rw * 117) + ((rw - 1) * 8);
                    div.style.width = width + 'px';
                    div.style.height = height + 'px';

                    if(w.type === 'spacer') {
                        div.style.border = '1px dashed #aaa'; div.style.boxShadow = 'none'; div.style.opacity = '0.5';
                        div.innerHTML = '<span style="font-size:10px; color:#999;">SPACER</span>';
                    } else {
                        const icon = w.icon || w.icon_on || 'mdi-cube-outline';
                        const realState = getRealState(w);
                        div.innerHTML = `<div class="ew-title">${w.name || w.id}</div><i class="mdi ${icon} ew-icon"></i><div class="ew-value">${realState}</div><div class="ew-del" onclick="deleteWidget(${rI}, ${wI}, event)">X</div>`;
                    }
                    div.onclick = (e) => { e.stopPropagation(); editWidget(rI, wI); };
                    wrapper.appendChild(div);
                    rowDiv.appendChild(wrapper);
                });
                container.appendChild(rowDiv);
            });
        }

        function submitData() {
            document.getElementById('layout_json').value = JSON.stringify(rows);
            document.getElementById('custom_defs').value = JSON.stringify(rawImportedDefs);
            document.getElementById('main-form').submit();
        }

        function importYaml() {
            const text = document.getElementById('import-code').value;
            if(!text) return;
            blockSmart = true;
            const lines = text.split('\n');
            const newRows = [];
            let inLayout = false;
            let rawDefs = {};
            let currentDefKey = null;
            let currentDefLines = [];

            lines.forEach(line => {
                if (line.match(/^\S+:/) && !line.startsWith('layout:') && !line.startsWith('global_parameters:')) {
                    if (currentDefKey) { rawDefs[currentDefKey] = currentDefLines.join('\n'); }
                    currentDefKey = line.split(':')[0].trim();
                    currentDefLines = [];
                } else if (currentDefKey) {
                    if (!line.startsWith('layout:') && !line.startsWith('#')) { currentDefLines.push(line); }
                }
            });
            if(currentDefKey) rawDefs[currentDefKey] = currentDefLines.join('\n');
            rawImportedDefs = rawDefs;

            lines.forEach(line => {
                const tr = line.trim();
                if(tr.startsWith('layout:')) { inLayout = true; return; }
                if(inLayout && tr.startsWith('-')) {
                    const content = tr.substring(1).trim();
                    const widgets = content.split(',').map(s => s.trim());
                    const rowData = [];
                    widgets.forEach(wStr => {
                        let id = wStr;
                        let size = '(2x1)'; 
                        const sizeMatch = wStr.match(/\(\d+x\d+\)/);
                        if(sizeMatch) { size = sizeMatch[0]; id = wStr.replace(size, '').trim(); }
                        let type = 'switch'; let name = id; let icon = ''; let icon_on = ''; let icon_off = '';
                        
                        if(rawDefs[id]) {
                            const d = rawDefs[id];
                            const tMatch = d.match(/widget_type:\s*(.*)/);
                            if(tMatch) type = tMatch[1].trim();
                            const nMatch = d.match(/title:\s*(.*)/);
                            if(nMatch) name = nMatch[1].trim().replace(/['"]/g, '');
                            const iMatch = d.match(/icon:\s*(.*)/);
                            if(iMatch) icon = iMatch[1].trim();
                            const ionMatch = d.match(/icon_on:\s*(.*)/);
                            if(ionMatch) icon_on = ionMatch[1].trim();
                            const ioffMatch = d.match(/icon_off:\s*(.*)/);
                            if(ioffMatch) icon_off = ioffMatch[1].trim();
                        } else {
                            if(id === 'spacer') type = 'spacer';
                            else if(id.startsWith('navigate.')) type = 'navigate';
                            else if(id.startsWith('sensor.')) type = 'sensor';
                        }
                        
                        if(name === id && type !== 'spacer') name = formatSmartName(id, '');
                        rowData.push({ id, type, size, name, icon, icon_on, icon_off, was_edited: false });
                    });
                    newRows.push(rowData);
                }
                if(inLayout && tr.length > 0 && !tr.startsWith('-') && !tr.startsWith(' ') && !tr.startsWith('layout:')) { inLayout = false; }
            });

            if(newRows.length > 0) {
                rows = newRows;
                activeRowIndex = 0;
                renderPreview();
                alert(currentLang === 'pl' ? "Pomy≈õlnie zaimportowano uk≈Çad." : "Import successful.");
            } else {
                alert(currentLang === 'pl' ? "B≈ÇƒÖd: Nie znaleziono layoutu." : "Error: Layout not found.");
            }
            setTimeout(() => blockSmart = false, 1000);
        }

        function setLang(lang) {
            currentLang = lang;
            document.getElementById('input-lang').value = lang;
            document.getElementById('btn-pl').className = lang === 'pl' ? 'active' : '';
            document.getElementById('btn-en').className = lang === 'en' ? 'active' : '';
            const t = TRANSLATIONS[lang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) {
                    if (el.tagName === 'INPUT' && el.type === 'submit') el.value = t[key];
                    else el.innerText = t[key];
                }
            });
            document.querySelectorAll('option[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.text = t[key];
            });
            updateTitleLimit();
            renderPreview();
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark-mode');
            localStorage.setItem('joan_theme', isDark ? 'dark' : 'light');
            document.getElementById('btn-theme').innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        window.addEventListener('DOMContentLoaded', () => {
            const host = window.location.hostname;
            const pathEl = document.getElementById('path-code');
            const linkEl = document.getElementById('dashboard-link');
            if(pathEl) pathEl.innerText = pathEl.innerText.replace('IP_HA', host);
            if(linkEl) {
                const rawHref = linkEl.getAttribute('href');
                if (rawHref.includes('[HOST]')) {
                    const newHref = rawHref.replace(/\[HOST\]/g, host);
                    linkEl.setAttribute('href', newHref);
                    linkEl.innerText = newHref;
                }
            }
            setLang('pl');
            const savedTheme = localStorage.getItem('joan_theme') || 'light';
            document.getElementById('btn-theme').innerText = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            updateTitleLimit();
            activeRowIndex = 0;
            renderPreview();
        });
    </script>
</body>
</html>
